diff --git a/node_modules/@balancer-labs/sdk/dist/index.js b/node_modules/@balancer-labs/sdk/dist/index.js
index e4aca95..af33d6a 100644
--- a/node_modules/@balancer-labs/sdk/dist/index.js
+++ b/node_modules/@balancer-labs/sdk/dist/index.js
@@ -504,5 +504,5 @@ ${vo`
     }
   }
 }
-    `,gi=(e,t,a)=>e();function xi(e){return jo(new l.GraphQLClient(e))}function _i(e){return function(e,t=gi){return{GaugeShare:(a,n)=>t((t=>e.request(mi,a,{...n,...t})),"GaugeShare","query"),GaugeShares:(a,n)=>t((t=>e.request(fi,a,{...n,...t})),"GaugeShares","query"),LiquidityGauges:(a,n)=>t((t=>e.request(Ti,a,{...n,...t})),"LiquidityGauges","query"),Pools:(a,n)=>t((t=>e.request(hi,a,{...n,...t})),"Pools","query"),PoolGauges:(a,n)=>t((t=>e.request(Ii,a,{...n,...t})),"PoolGauges","query")}}(new l.GraphQLClient(e))}class wi{constructor(t,a,n={}){this.options=n,this.calls=[],this.paths=[],this.address="0xcA11bde05977b3631167028862bE2a173976CA11",this.interface=new e.Interface(t),this.multicall=na.connect(this.address,a)}call(e,t,a,n){return this.calls.push([t,a,n]),this.paths.push(e),this}async execute(e={},t=1024){const a=e;return(await this.executeMulticall(t)).forEach(((e,t)=>s.set(a,this.paths[t],e.length>1?e:e[0]))),this.calls=[],this.paths=[],a}async executeMulticall(e){const t=Math.ceil(this.calls.length/e),a=[],n=[];for(let a=0;a<t;a++){const t=this.calls.slice(a*e,(a+1)*e).map((([e,t,a])=>({target:e,allowFailure:!0,callData:this.interface.encodeFunctionData(t,a)})));n.push(this.multicall.callStatic.aggregate3(t,this.options))}return(await Promise.all(n)).forEach(((t,n)=>{const o=n*e;for(let e=0;e<t.length;e++){const n=o+e,{success:i,returnData:s}=t[e];if(i)try{const e=this.interface.decodeFunctionResult(this.calls[n][1],s);a[n]=e}catch(e){console.error("Multicall error",this.paths[n]),a[n]=[]}else console.error("Failed request in multicall",this.paths[n]),a[n]=[]}})),a}}const Pi=["function getSwapFeePercentage() view returns (uint256)","function percentFee() view returns (uint256)","function protocolPercentFee() view returns (uint256)","function getNormalizedWeights() view returns (uint256[])","function totalSupply() view returns (uint256)","function getVirtualSupply() view returns (uint256)","function getActualSupply() view returns (uint256)","function getTargets() view returns (uint256 lowerTarget, uint256 upperTarget)","function getTokenRates() view returns (uint256, uint256)","function getWrappedTokenRate() view returns (uint256)","function getAmplificationParameter() view returns (uint256 value, bool isUpdating, uint256 precision)","function getPausedState() view returns (bool)","function inRecoveryMode() view returns (bool)","function getRate() view returns (uint256)","function getScalingFactors() view returns (uint256[] memory)","function getPoolTokens(bytes32) view returns (address[], uint256[])"],Ei=(e,t,a)=>{a.call(`${e}.weights`,t,"getNormalizedWeights")},vi=(e,t,a)=>{a.call(`${e}.targets`,t,"getTargets"),a.call(`${e}.wrappedTokenRate`,t,"getWrappedTokenRate")},Si=(e,t,a)=>{a.call(`${e}.amp`,t,"getAmplificationParameter")},Ai=(e,t,a)=>{a.call(`${e}.tokenRates`,t,"getTokenRates")},ki=async(e,t,a)=>{if(0===e.length)return{};const n=new wi(Pi,a);e.forEach((({id:e,address:a,poolType:o,poolTypeVersion:i})=>{((e,t,a,n,o)=>{o.call(`${e}.poolTokens`,a,"getPoolTokens",[e]),o.call(`${e}.totalShares`,t,(e=>e.includes("Linear")||["StablePhantom"].includes(e)?"getVirtualSupply":"ComposableStable"===e?"getActualSupply":"totalSupply")(n)),o.call(`${e}.swapFee`,t,(e=>"Element"===e?"percentFee":"FX"===e?"protocolPercentFee":"getSwapFeePercentage")(n))})(e,a,t,o,n),((e,t=1)=>{const a=()=>({});switch(e){case"Weighted":case"LiquidityBootstrapping":case"Investment":return Ei;case"Stable":case"StablePhantom":case"MetaStable":case"ComposableStable":return Si;case"GyroE":return 2===t?Ai:a;case"AaveLinear":return 1===t?vi:a;default:return a}})(o,i)(e,a,n)}));return await n.execute({},128)};async function Oi(e,t,n,o){if(0===e.length)return e;const i=[],s=await ki(e,n,o);return e.forEach((e=>{const t=s[e.id];i.push(((e,t)=>({...e,tokens:e.tokens.map((n=>{const o=t.poolTokens[0].map((e=>e.toLowerCase())).indexOf(n.address),i=e.wrappedIndex&&e.tokensList[e.wrappedIndex];return{...n,balance:a.formatFixed(t.poolTokens[1][o],n.decimals||18),weight:t.weights&&a.formatFixed(t.weights[o],18)||n.weight,priceRate:t.wrappedTokenRate&&i&&i.toLowerCase()===n.address.toLowerCase()&&a.formatFixed(t.wrappedTokenRate,18)||n.priceRate}})),totalShares:t.totalShares?a.formatFixed(t.totalShares,18):e.totalShares,swapFee:a.formatFixed(t.swapFee,18),amp:t.amp&&t.amp[0]&&a.formatFixed(t.amp[0],String(t.amp[2]).length-1)||e.amp,lowerTarget:t.targets&&a.formatFixed(t.targets[0],18)||e.lowerTarget,upperTarget:t.targets&&a.formatFixed(t.targets[1],18)||e.upperTarget,tokenRates:t.tokenRates&&t.tokenRates.map((e=>a.formatFixed(e,18)))||e.tokenRates}))(e,t))})),i}class Ci{constructor(e,t,a,n,o){this.client=e,this.provider=t,this.network=a,this.sorConfig=n,this.defaultArgs=(null==o?void 0:o.args)||{orderBy:yo.TotalLiquidity,orderDirection:so.Desc,where:{swapEnabled:{eq:!0},totalShares:{gt:1e-12}}}}async getPools(e){const t=function(e){return e.map((e=>({...e,poolType:e.poolType||"",tokens:(e.tokens||[]).map((e=>({...e,weight:e.weight||null}))),totalWeight:e.totalWeight||void 0,amp:e.amp||void 0,expiryTime:e.expiryTime?s.parseInt(e.expiryTime):void 0,unitSeconds:e.unitSeconds?s.parseInt(e.unitSeconds):void 0,principalToken:e.principalToken||void 0,baseToken:e.baseToken||void 0})))}((await this.getSubgraphPools(e)).filter((e=>{if(!this.network.poolsToIgnore)return!0;return-1===this.network.poolsToIgnore.findIndex((t=>Je(t,e.address)))})));if(this.sorConfig&&!1===this.sorConfig.fetchOnChainBalances)return t;const a=X.getInstance();a.time(`fetching on-chain balances for ${t.length} pools`);const n=await Oi(t,this.network.addresses.contracts.multicall,this.network.addresses.contracts.vault,this.provider);return a.timeEnd(`fetching on-chain balances for ${t.length} pools`),n}async getSubgraphPools(e){const t=new nt(e||this.defaultArgs).format(new at);if(t.first){const{pools:e}=await this.client.Pools(t);return e}const{pool0:a,pool1000:n,pool2000:o}=await this.client.AllPools(t);return[...a,...n,...o]}}class Bi{constructor(e){this.chainId=e}async getNativeAssetPriceInToken(e){const t=await this.getTokenPriceInNativeAsset(e);return""+1/parseFloat(t)}async getTokenPriceInNativeAsset(e){const t=`https://api.coingecko.com/api/v3/simple/token_price/${this.platformId}?contract_addresses=${e}&vs_currencies=${this.nativeAssetId}`,{data:a}=await P.default.get(t,{headers:{Accept:"application/json","Content-Type":"application/json"}});if(void 0===a[e.toLowerCase()]||void 0===a[e.toLowerCase()][this.nativeAssetId])throw Error("No price returned from Coingecko");return a[e.toLowerCase()][this.nativeAssetId]}get platformId(){return ka[this.chainId].thirdParty.coingecko.platformId||"2"}get nativeAssetId(){return ka[this.chainId].thirdParty.coingecko.nativeAssetId||""}}class Mi{constructor(e,t){this.client=e,this.weth=t.toLowerCase()}async getNativeAssetPriceInToken(e){const t=await this.getLatestPriceInEthFromSubgraph(e);if(!t)throw Error("No price found in the subgraph");return""+1/t}async getLatestPriceInEthFromSubgraph(e){e=e.toLowerCase();const{latestPrices:t}=await this.client.TokenLatestPrices({where:{asset_in:[e,this.weth]}}),a=s.keyBy(t,"id");if(a[`${e}-${this.weth}`])return parseFloat(a[`${e}-${this.weth}`].price);const n=t.filter((t=>t.asset===e));for(const e of n){const t=a[`${e.pricingAsset}-${this.weth}`];if(t)return parseFloat(e.price)*parseFloat(t.price)}return null}}function Fi(e){var t,a;if("number"==typeof e.network){const a=ka[e.network];return{...a,urls:{...a.urls,subgraph:null!==(t=e.customSubgraphUrl)&&void 0!==t?t:a.urls.subgraph},tenderly:e.tenderly}}return{...e.network,urls:{...e.network.urls,subgraph:null!==(a=e.customSubgraphUrl)&&void 0!==a?a:e.network.urls.subgraph},tenderly:e.network.tenderly}}const Ri=["0x00c2a4be503869fa751c2dbcb7156cc970b5a8da000000000000000000000477","0x02d928e68d8f10c0358566152677db51e1e2dc8c00000000000000000000051e","0x04248aabca09e9a1a3d5129a7ba05b7f17de768400000000000000000000050e","0x05513ca725b6ce035ca2641075474eb469f05f4c00020000000000000000041f","0x0a0fb4ff697de5ac5b6770cd8ee1b72af80b57cf000000000000000000000496","0x0afbd58beca09545e4fb67772faf3858e610bcd00000000000000000000004b9","0x0d05aac44ac7dd3c7ba5d50be93eb884a057d23400000000000000000000051c","0x11839d635e2f0270da37e8ef4324d4d5d54329570002000000000000000004d8","0x126e7643235ec0ab9c103c507642dc3f4ca23c66000000000000000000000468","0x133d241f225750d2c92948e464a5a80111920331000000000000000000000476","0x159cb00338fb63f263fd6f621df619cef71da9540000000000000000000004d5","0x173063a30e095313eee39411f07e95a8a806014e0002000000000000000003ab","0x1bd2f176a812e312077bca87e37c08432bb09f3e0000000000000000000005a1","0x20b156776114e8a801e9767d90c6ccccc8adf398000000000000000000000499","0x246ffb4d928e394a02e45761fecdba6c2e79b8eb000000000000000000000541","0x25accb7943fd73dda5e23ba6329085a3c24bfb6a000200000000000000000387","0x26c2b83fc8535deead276f5cc3ad9c1a2192e02700020000000000000000056b","0x2b218683178d029bab6c9789b1073aa6c96e517600000000000000000000058c","0x2ba7aa2213fa2c909cd9e46fed5a0059542b36b00000000000000000000003a3","0x2bbf681cc4eb09218bee85ea2a5d3d13fa40fc0c0000000000000000000000fd","0x2e52c64fd319e380cdbcfc4577ea1fda558a32e40002000000000000000005ba","0x2f4eb100552ef93840d5adc30560e5513dfffacb000000000000000000000334","0x2ff1a9dbdacd55297452cfd8a4d94724bc22a5f7000000000000000000000484","0x3035917be42af437cbdd774be26b9ec90a2bd677000200000000000000000543","0x331d50e0b00fc1c32742f151e56b9b616227e23e00000000000000000000047c","0x334c96d792e4b26b841d28f53235281cec1be1f200020000000000000000038a","0x335d1709d4da9aca59d16328db5cd4ea66bfe06b0000000000000000000004d6","0x395d8a1d9ad82b5abe558f8abbfe183b27138af40000000000000000000004e5","0x3bb22fc9033b802f2ac47c18885f63476f158afc000000000000000000000483","0x3c640f0d3036ad85afa2d5a9e32be651657b874f00000000000000000000046b","0x3cdae4f12a67ba563499e102f309c73213cb241c000000000000000000000335","0x3dbb8d974b82e82ce79c20c0f5995f4f1f533ede000000000000000000000470","0x3f7a7fd7f214be45ec26820fd01ac3be4fc75aa70002000000000000000004c5","0x3fcb7085b8f2f473f80bf6d879cae99ea4de934400000000000000000000056d","0x41503c9d499ddbd1dcdf818a1b05e9774203bf46000000000000000000000594","0x4228290ee9cab692938ff0b4ba303fbcdb68e9f200020000000000000000057d","0x454ed96955d04d2f5cdd05e0fd1c77975bfe5307000000000000000000000410","0x481c5fc05d63a58aa2f0f2aa417c021b5d419cb200000000000000000000056a","0x483006684f422a9448023b2382615c57c5ecf18f000000000000000000000488","0x4a82b580365cff9b146281ab72500957a849abdc000000000000000000000494","0x4c81255cc9ed7062180ea99962fe05ac0d57350b0000000000000000000005a3","0x4c8d2e60863e8d7e1033eda2b3d84e92a641802000000000000000000000040f","0x4cbde5c4b4b53ebe4af4adb85404725985406163000000000000000000000595","0x4ce0bd7debf13434d3ae127430e9bd4291bfb61f00020000000000000000038b","0x4ce277df0feb5b4d07a0ca2adcf5326e4005239d000000000000000000000518","0x4fd4687ec38220f805b6363c3c1e52d0df3b5023000200000000000000000473","0x4fd63966879300cafafbb35d157dc5229278ed230000000000000000000000e9","0x50cf90b954958480b8df7958a9e965752f62712400000000000000000000046f","0x53bc3cba3832ebecbfa002c12023f8ab1aa3a3a0000000000000000000000411","0x5a6a8cffb4347ff7fc484bf5f0f8a2e234d34255000200000000000000000275","0x5b3240b6be3e7487d61cd1afdfc7fe4fa1d81e6400000000000000000000037b","0x60683b05e9a39e3509d8fdb9c959f23170f8a0fa000000000000000000000489","0x60d604890feaa0b5460b28a424407c24fe89374a0000000000000000000004fc","0x639883476960a23b38579acfd7d71561a0f408cf000200000000000000000505","0x652d486b80c461c397b0d95612a404da936f3db30000000000000000000000e7","0x6667c6fa9f2b3fc1cc8d85320b62703d938e43850000000000000000000004fb","0x6a1eb2e9b45e772f55bd9a34659a04b6f75da68700000000000000000000040d","0x6c56e72c551b5ac4bf54a620a76077ca768c8fe40002000000000000000004da","0x70b7d3b3209a59fb0400e17f67f3ee8c37363f4900020000000000000000018f","0x7337224d59cb16c2dc6938cd45a7b2c60c865d6a0000000000000000000004d4","0x74cbfaf94a3577c539a9dcee9870a6349a33b34f000000000000000000000534","0x779d01f939d78a918a3de18cc236ee89221dfd4e0000000000000000000004c7","0x7b50775383d3d6f0215a8f290f2c9e2eebbeceb20000000000000000000000fe","0x804cdb9116a10bb78768d3252355a1b18067bf8f0000000000000000000000fb","0x813e3fe1761f714c502d1d2d3a7cceb33f37f59d00000000000000000000040c","0x82698aecc9e28e9bb27608bd52cf57f704bd1b83000000000000000000000336","0x8a6b25e33b12d1bb6929a8793961076bd1f9d3eb0002000000000000000003e8","0x8e6ec57a822c2f527f2df7c7d7d361df3e7530a1000000000000000000000498","0x8f4063446f5011bc1c9f79a819efe87776f23704000000000000000000000197","0x9001cbbd96f54a658ff4e6e65ab564ded76a543100000000000000000000050a","0x9210f1204b5a24742eba12f710636d76240df3d00000000000000000000000fc","0x9516a2d25958edb8da246a320f2c7d94a0dbe25d000000000000000000000519","0x959216bb492b2efa72b15b7aacea5b5c984c3cca000200000000000000000472","0x968024662b9566b42d78af23a0f441bc8723fa83000200000000000000000418","0x99c88ad7dc566616548adde8ed3effa730eb6c3400000000000000000000049a","0x9b1c8407a360443a9e5eca004713e4088fab8ac0000000000000000000000497","0x9b692f571b256140a39a34676bffa30634c586e100000000000000000000059d","0x9d7f992c900fbea0ec314bdd71b7cc1becf76a33000200000000000000000573","0x9fb771d530b0ceba5160f7bfe2dd1e8b8aa1340300000000000000000000040e","0xa13a9247ea42d743238089903570127dda72fe4400000000000000000000035d","0xa1697f9af0875b63ddc472d6eebada8c1fab85680000000000000000000004f9","0xa3823e50f20982656557a4a6a9c06ba5467ae9080000000000000000000000e6","0xa718042e5622099e5f0ace4e7122058ab39e1bbe000200000000000000000475","0xa8b103a10a94f4f2d7ed2fdcd5545e807557330700000000000000000000048e","0xac5b4ef7ede2f2843a704e96dcaa637f4ba3dc3f00000000000000000000051d","0xac976bb42cb0c85635644e8c7c74d0e0286aa61c0000000000000000000003cb","0xae37d54ae477268b9997d4161b96b8200755935c000000000000000000000337","0xae8535c23afedda9304b03c68a3563b75fc8f92b0000000000000000000005a0","0xb0f75e97a114a4eb4a425edc48990e6760726709000000000000000000000198","0xb5e3de837f869b0248825e0175da73d4e8c3db6b000200000000000000000474","0xb841b062ea8ccf5c4cb78032e91de4ae875560420002000000000000000005b7","0xb9bd68a77ccf8314c0dfe51bc291c77590c4e9e6000200000000000000000385","0xbb6881874825e60e1160416d6c426eae65f2459e000000000000000000000592","0xbc0f2372008005471874e426e86ccfae7b4de79d000000000000000000000485","0xbf2ef8bdc2fc0f3203b3a01778e3ec5009aeef3300000000000000000000058d","0xbfa413a2ff0f20456d57b643746133f54bfe0cd20000000000000000000004c3","0xc2b021133d1b0cf07dba696fd5dd89338428225b000000000000000000000598","0xc443c15033fcb6cf72cc24f1bda0db070ddd9786000000000000000000000593","0xc50d4347209f285247bda8a09fc1c12ce42031c3000000000000000000000590","0xc5dc1316ab670a2eed5716d7f19ced321191f38200000000000000000000056e","0xc8c79fcd0e859e7ec81118e91ce8e4379a481ee6000000000000000000000196","0xcaa052584b462198a5a9356c28bce0634d65f65c0000000000000000000004db","0xcbfa4532d8b2ade2c261d3dd5ef2a2284f7926920000000000000000000004fa","0xcfae6e251369467f465f13836ac8135bd42f8a56000000000000000000000591","0xd4e7c1f3da1144c9e2cfd1b015eda7652b4a439900000000000000000000046a","0xd6e355036f41dc261b3f1ed3bbc6003e87aadb4f000000000000000000000495","0xd7edb56f63b2a0191742aea32df1f98ca81ed9c600000000000000000000058e","0xd997f35c9b1281b82c8928039d14cddab5e13c2000000000000000000000019c","0xdba274b4d04097b90a72b62467d828cefd708037000000000000000000000486","0xdc063deafce952160ec112fa382ac206305657e60000000000000000000004c4","0xdec02e6642e2c999af429f5ce944653cad15e093000000000000000000000469","0xe03af00fabe8401560c1ff7d242d622a5b601573000000000000000000000493","0xe0fcbf4d98f0ad982db260f86cf28b49845403c5000000000000000000000504","0xe2d16b0a39f3fbb4389a0e8f1efcbecfb3d1e6e10000000000000000000005a7","0xe4dc3c1998ac693d68f4c77476d7c815694c3e94000200000000000000000416","0xe6bcc79f328eec93d4ec8f7ed35534d9ab549faa0000000000000000000000e8","0xe8c56405bc405840154d9b572927f4197d110de10000000000000000000005a4","0xeb486af868aeb3b6e53066abc9623b1041b42bc000000000000000000000046c","0xeb567dde03f3da7fe185bdacd5ab495ab220769d000000000000000000000548","0xec3626fee40ef95e7c0cbb1d495c8b67b34d398300000000000000000000053d","0xf22ff21e17157340575158ad7394e068048dd98b0000000000000000000004b8","0xf57c794f42da72b38c8f610ff3b5e8502e48cbde00000000000000000000055c","0xf71d0774b214c4cf51e33eb3d30ef98132e4dbaa00000000000000000000046e","0xfa24a90a3f2bbe5feea92b95cd0d14ce709649f900000000000000000000058f","0xfd11ccdbdb7ab91cb9427a6d6bf570c95876d1950000000000000000000004c2","0xfebb0bbf162e64fb9d0dfe186e517d84c395f016000000000000000000000502","0xfef969638c52899f91781f1be594af6f40b99bad00000000000000000000047b","0x02e139d53ebf4033bf78ab66c6a1e7f1f204487f0002000000000000000009f9","0x03090a9811181a2afe830a3a0b467698ccf3a8b1000000000000000000000bf5","0x0320c1c5b6df19a194d48882aaec1c72940081d9000000000000000000000a7d","0x04b54ea92d73de2d62d651db7d9778f0c49157d8000200000000000000000ba2","0x0503dd6b2d3dd463c9bef67fb5156870af63393e00000000000000000000042e","0x0889b240a5876aae745ac19f1771853671dc5d36000000000000000000000b3f","0x0bc54e914f53f98d16035f4f0d948f3e09c2fac0000200000000000000000bac","0x0c06e87c7b88d998f645b91c1f53b51294b12bca000100000000000000000bb9","0x10b040038f87219d9b42e025e3bd9b8095c87dd9000000000000000000000b11","0x117a3d474976274b37b7b94af5dcade5c90c6e85000000000000000000000aca","0x11884da90fb4221b3aa288a7741c51ec4fc43b2f000000000000000000000a5f","0x1379b816b9be611431d693290289c204720ca56d000100000000000000000b6f","0x150e7b885bdfce974f2abe88a72fdbd692175c6f0002000000000000000009fd","0x178e029173417b1f9c8bc16dcec6f697bc323746000000000000000000000758","0x1aafc31091d93c3ff003cff5d2d8f7ba2e7284250000000000000000000003b3","0x216690738aac4aa0c4770253ca26a28f0115c595000000000000000000000b2c","0x216d6db0c28204014618482c369d7fbf0a8f3232000100000000000000000b60","0x230ecdb2a7cee56d6889965a023aa0473d6da507000000000000000000000bf3","0x252ff6a3a6fd7b5e8e999de8e3f5c3b306ed1401000200000000000000000bec","0x25e57f4612912614e6c99616bd2abb9b5ae71e99000000000000000000000bf0","0x2645b13fd2c5295296e94a76280b968bdcbbdfed000000000000000000000c11","0x284eb68520c8fa83361c1a3a5910aec7f873c18b000000000000000000000ac9","0x2c8dbe8eb86135d9f2f26d196748c088d47f73e7000200000000000000000a29","0x31bccf9e28b94e5dacebaa67fe8bc1603cecd904000000000000000000000a01","0x341068a547c3cde3c09e338714010dd01b32f93f000200000000000000000a34","0x3db543faf7a92052de7860c5c9debabee59ed5bd000000000000000000000a62","0x3dd0843a028c86e0b760b1a76929d1c5ef93a2dd00000000000000000000070d","0x3efb91c4f9b103ee45885695c67794591916f34e000200000000000000000b43","0x402cfdb7781fa85d52f425352661128250b79e12000000000000000000000be3","0x43894de14462b421372bcfe445fa51b1b4a0ff3d000000000000000000000b36","0x4739e50b59b552d490d3fdc60d200977a38510c0000000000000000000000b10","0x48e6b98ef6329f8f0a30ebb8c7c960330d64808500000000000000000000075b","0x4a0b73f0d13ff6d43e304a174697e3d5cfd310a400020000000000000000091c","0x4a77ef015ddcd972fd9ba2c7d5d658689d090f1a000000000000000000000b38","0x4ae3661afa119892f0cc8c43edaf6a94989ac171000000000000000000000c06","0x4ccb966d8246240afb7a1a24628efb930870b1c40002000000000000000009fc","0x52cc8389c6b93d740325729cc7c958066cee4262000000000000000000000b0f","0x5b77107fcdf2b41903bab2bc555d4fc14cf7667d000000000000000000000b32","0x5bae72b75caab1f260d21bc028c630140607d6e8000000000000000000000ac6","0x600bd01b6526611079e12e1ff93aba7a3e34226f0000000000000000000009e4","0x63ce19ccd39930725b8a3d2733627804718ab83d000000000000000000000bf2","0x64efad69f099813021b41f4cac6e749fd55e188f000000000000000000000b39","0x6933ec1ca55c06a894107860c92acdfd2dd8512f000000000000000000000428","0x6abe4e7a497b8293c258389c1b00d177e4f257ed00010000000000000000080d","0x6c8c7fc50247a47038015eb1fd5dc105d05dafba000200000000000000000ba0","0x7079a25dec33be61bbd81b2fb69b468e80d3e72c0000000000000000000009ff","0x71bd10c2a590b5858f5576550c163976a48af906000000000000000000000b27","0x7c82a23b4c48d796dee36a9ca215b641c6a8709d000000000000000000000acd","0x7f4f4942f2a14b6ab7b08b10ada1aacede4ee8d4000200000000000000000b44","0x86aef31951e0a3a54333bd9e72f9a95587d058c5000200000000000000000912","0x882c7a84231484b3e9f3fd45ac04b1eb5d35b076000200000000000000000a91","0x894c82800526e0391e709c0983a5aea3718b7f6d000000000000000000000ac5","0x89b28a9494589b09dbccb69911c189f74fdadc5a000000000000000000000b33","0x89bb15076c9f2d86aa98ec6cffc1a71e31c38953000000000000000000000bf1","0x89f1146fee52b5d9166e9c83cc388b6d8f69f1380001000000000000000009e7","0x8a819a4cabd6efcb4e5504fe8679a1abd831dd8f00000000000000000000042d","0x8b58a1e7fff52001c22386c2918d45938a6a9be30001000000000000000008d9","0x8b8225bfedebaf1708c55743acb4ad43fd4d0f21000200000000000000000918","0x8fbd0f8e490735cfc3abf4f29cbddd5c3289b9a7000000000000000000000b5b","0x8fd39252d683fdb60bddd4df4b53c9380b496d59000200000000000000000b45","0x9321e2250767d79bab5aa06daa8606a2b3b7b4c5000000000000000000000bf4","0x949a12b95ec5b80c375b98963a5d6b33b0d0efff0002000000000000000009fe","0x9a020bdc2faff5bd24c6acc2020d01ff9f2c627a000000000000000000000ae2","0x9cf9358300e34bf9373d30129a1e718d8d058b54000200000000000000000913","0x9e34631547adcf2f8cefa0f5f223955c7b137571000000000000000000000ad5","0xa5a935833f6a5312715f182733eab088452335d7000100000000000000000bee","0xa5fe91dde37d8bf2dacacc0168b115d28ed03f84000000000000000000000b35","0xa8bf1c584519be0184311c48adbdc4c15cb2e8c1000000000000000000000bf6","0xab269164a10fab22bc87c39946da06c870b172d6000000000000000000000bfc","0xac2cae8d2f78a4a8f92f20dbe74042cd0a8d5af3000000000000000000000be2","0xae646817e458c0be890b81e8d880206710e3c44e000000000000000000000acb","0xaef2c171dbe64b0c18977e16e70bfd29d4ee0256000000000000000000000ac8","0xb0c830dceb4ef55a60192472c20c8bf19df03488000000000000000000000be1","0xb266ac3b7c98d7bcb28731dac0ef42dba1b276be000000000000000000000be4","0xb371aa09f5a110ab69b39a84b5469d29f9b22b76000000000000000000000b37","0xb3d658d5b95bf04e2932370dd1ff976fe18dd66a000000000000000000000ace","0xb54b2125b711cd183edd3dd09433439d5396165200000000000000000000075e","0xb59be8f3c85a9dd6e2899103b6fbf6ea405b99a4000000000000000000000b34","0xb878ecce26838fbba4f78cb5b791a0e09152c067000000000000000000000427","0xb973ca96a3f0d61045f53255e319aedb6ed4924000000000000000000000042f","0xbd4e35784c832d0f9049b54cb3609e5907c5b495000100000000000000000b14","0xc55ec796a4debe625d95436a3531f4950b11bdcf000000000000000000000b3e","0xc7e6389e364f4275eb442ef215ed21877028e2af000000000000000000000ac7","0xc83b55bbd005f1f84906545fcdb145dee53523e0000200000000000000000b30","0xcb21a9e647c95127ed784626485b3104cb28d0e7000000000000000000000425","0xd00f9ca46ce0e4a63067c4657986f0167b0de1e5000000000000000000000b42","0xd2f3b9e67c69762dd1c88f1d3dadd1649a190761000200000000000000000bf7","0xd4accb350f9cf59fe3cf7a5ee6ed9ace6a568ea9000200000000000000000b75","0xda1cd1711743e57dd57102e9e61b75f3587703da000000000000000000000acc","0xdae301690004946424e41051ace1791083be42a1000000000000000000000b40","0xde0a77ab6689b980c30306b10f9131a007e1af81000200000000000000000ba1","0xe051605a83deae38d26a7346b100ef1ac2ef8a0b0000000000000000000003ce","0xe1fb90d0d3b47e551d494d7ebe8f209753526b01000000000000000000000ac4","0xe2272cddb2cc408e79e02a73d1db9acc24a843d5000200000000000000000ba7","0xe2dc0e0f2c358d6e31836dee69a558ab8d1390e70000000000000000000009fa","0xe4885ed2818cc9e840a25f94f9b2a28169d1aea7000000000000000000000b29","0xe6909c2f18a29d97217a6146f045e1780606991f000100000000000000000bfe","0xe78b25c06db117fdf8f98583cdaaa6c92b79e917000000000000000000000b2b","0xea11645ac7d8f2def94c9d8d86bd766296c9b6b6000000000000000000000b3a","0xeb480dbbdd921cd6c359e4cc4c65ddea6395e2a1000200000000000000000946","0xed35f28f837e96f81240ebb82e0e3f518c7e8a2f000100000000000000000bb5","0xf0211cceebe6fcc45052b4e57ee95d233f5669d2000100000000000000000c01","0xf22a66046b5307842f21b311ecb4c462c24c0635000000000000000000000b15","0xf28f17be00f8ca3c9b7f66a4aad5513757fb3341000200000000000000000b5a","0xf42ed61450458ee4620f5ef4f29adb25a6ef0fb6000000000000000000000bf8","0xf48f01dcb2cbb3ee1f6aab0e742c2d3941039d56000000000000000000000445","0xf93579002dbe8046c43fefe86ec78b1112247bb8000000000000000000000759","0xf984eb2b8a7ef780245a797a2fccd82f346409ca000000000000000000000a59","0xfa2c0bd8327c99db5bde4c9e9e5cbf30946351bb000000000000000000000948","0xff4ce5aaab5a627bf82f4a571ab1ce94aa365ea600000000000000000000075a","0x1ac55c31dac78ca943cb8ebfca5945ce09e036e2000000000000000000000024","0x225e0047671939a8d78e08ebd692788abe63f15c000000000000000000000009","0x41211bba6d37f5a74b22e667533f080c7c7f3f1300000000000000000000000b","0x4de21b365d6543661d0e105e579a34b963862497000200000000000000000045","0x581ec1f5e7ced12b186deae32256adb53bdd5b08000000000000000000000001","0x66f33ae36dd80327744207a48122f874634b3ada000100000000000000000013","0xa3ed6f78edc29f69df8a0d16b1d1ccf9871f918c000000000000000000000032","0xa611a551b95b205ccd9490657acf7899daee5db700000000000000000000002e","0xb95829adbacd8af89e291dee78bc09e24de51d6b000000000000000000000043","0xb973ca96a3f0d61045f53255e319aedb6ed49240000200000000000000000011","0xba1a5b19d09a79dada039b1f974015c5a989d5fd000100000000000000000046","0xbb9cd48d33033f5effbedec9dd700c7d7e1dcf5000000000000000000000000e","0xd16f72b02da5f51231fde542a8b9e2777a478c8800000000000000000000000f","0xd4015683b8153666190e0b2bec352580ebc4caca00000000000000000000000d","0xe15cac1df3621e001f76210ab12a7f1a1691481f000000000000000000000044","0xe7f88d7d4ef2eb18fcf9dd7216ba7da1c46f3dd600000000000000000000000a","0xf48f01dcb2cbb3ee1f6aab0e742c2d3941039d56000200000000000000000012","0xfedb19ec000d38d92af4b21436870f115db22725000000000000000000000010","0xffff76a3280e95dc855696111c2562da09db2ac000000000000000000000000c","0x00fcd3d55085e998e291a0005cedecf58ac14c4000020000000000000000047f","0x077794c30afeccdf5ad2abc0588e8cee7197b71a000000000000000000000352","0x117a3d474976274b37b7b94af5dcade5c90c6e85000000000000000000000381","0x11884da90fb4221b3aa288a7741c51ec4fc43b2f000000000000000000000353","0x19b1c92631405a0a9495ccba0becf4f2e8e908bd000000000000000000000410","0x1e550b7764da9638fdd32c8a701364de31f45ee800000000000000000000047c","0x1fa7f727934226aedab636d62a084931b97d366b000000000000000000000411","0x23ca0306b21ea71552b148cf3c4db4fc85ae19290000000000000000000000c9","0x284eb68520c8fa83361c1a3a5910aec7f873c18b000000000000000000000380","0x2a96254ca32020b20ed3506f8f75318da24709f9000200000000000000000456","0x36942963e3b6f37ecc45a4e72349558514233f0000000000000000000000048a","0x3f53a862919ccfa023cb6ace91378a79fb0f6bf500000000000000000000040f","0x40af308e3d07ec769d85eb80afb116525ff4ac99000000000000000000000485","0x418de00ae109e6f874d872658767866d680eaa1900000000000000000000047d","0x45c4d1376943ab28802b995acffc04903eb5223f000000000000000000000470","0x4689122d360c4725d244c5cfea22861333d862e6000100000000000000000468","0x4739e50b59b552d490d3fdc60d200977a38510c0000000000000000000000409","0x49a0e3334496442a9706e481617724e7e37eaa080000000000000000000003ff","0x519cce718fcd11ac09194cff4517f12d263be067000000000000000000000382","0x52cc8389c6b93d740325729cc7c958066cee4262000000000000000000000408","0x567ecfcb22205d279bb8eed3e066989902bf03d5000000000000000000000452","0x585d95df0231fa08aeee35ff0c16b92fd0ecdc3300020000000000000000045f","0x5a7f39435fd9c381e4932fa2047c9a5136a5e3e7000000000000000000000400","0x5bae72b75caab1f260d21bc028c630140607d6e8000000000000000000000350","0x6cb787a419c3e6ee2e9ff365856c29cd10659113000000000000000000000474","0x7c82a23b4c48d796dee36a9ca215b641c6a8709d000000000000000000000406","0x81fc12c60ee5b753cf5fd0adc342dfb5f3817e3200000000000000000000035d","0x894c82800526e0391e709c0983a5aea3718b7f6d00000000000000000000034f","0x970712708a08e8fb152be4d81b2dc586923f5369000200000000000000000479","0x9bf7c3b63c77b4b4f2717776f15a4bec1b532a280000000000000000000000c8","0x9cebf13bb702f253abf1579294694a1edad00eaa000000000000000000000486","0x9e34631547adcf2f8cefa0f5f223955c7b137571000000000000000000000407","0x9fb7d6dcac7b6aa20108bad226c35b85a9e31b63000200000000000000000412","0xa1ea76c42b2938cfa9abea12357881006c52851300000000000000000000048f","0xa50f89e9f439fde2a6fe05883721a00475da3c4500000000000000000000048b","0xa612b6aed2e7ca1a3a4f23fbca9128461bbb7718000000000000000000000274","0xa8af146d79ac0bb981e4e0d8b788ec5711b1d5d000000000000000000000047b","0xad28940024117b442a9efb6d0f25c8b59e1c950b00000000000000000000046f","0xae646817e458c0be890b81e8d880206710e3c44e00000000000000000000039d","0xaef2c171dbe64b0c18977e16e70bfd29d4ee0256000000000000000000000351","0xbbf9d705b75f408cfcaee91da32966124d2c6f7d00000000000000000000047e","0xbd724eb087d4cc0f61a5fed1fffaf937937e14de000000000000000000000473","0xbe0f30217be1e981add883848d0773a86d2d2cd4000000000000000000000471","0xc46be4b8bb6b5a3d3120660efae9c5416318ed40000000000000000000000472","0xc69771058481551261709d8db44977e9afde645000010000000000000000042a","0xc6eee8cb7643ec2f05f46d569e9ec8ef8b41b389000000000000000000000475","0xcba9ff45cfb9ce238afde32b0148eb82cbe635620000000000000000000003fd","0xcf8b555b7754556cf2ac2165e77ee23ed8517d7900020000000000000000045e","0xd0dc20e6342db2de82692b8dc842301ff9121805000200000000000000000454","0xd3d5d45f4edf82ba0dfaf061d230766032a10e07000200000000000000000413","0xd6d20527c7b0669989ee082b9d3a1c63af742290000000000000000000000483","0xda1cd1711743e57dd57102e9e61b75f3587703da0000000000000000000003fc","0xe1fb90d0d3b47e551d494d7ebe8f209753526b0100000000000000000000034e","0xee02583596aee94cccb7e8ccd3921d955f17982a00000000000000000000040a","0xf984eb2b8a7ef780245a797a2fccd82f346409ca00000000000000000000034d","0xff8f84e8c87532af96aef5582ee451572233678b000200000000000000000478","0x054e7b0c73e1ee5aed6864fa511658fc2b54bcaa000000000000000000000015","0x3f1a2c4a3a751f6626bd90ef16e104f0772d4d6b00020000000000000000001b","0x7275c131b1f67e8b53b4691f92b0e35a4c1c6e22000000000000000000000010","0xa154009870e9b6431305f19b09f9cfd7284d4e7a000000000000000000000013","0xa1d14d922a575232066520eda11e27760946c991000000000000000000000012","0xa826a114b0c7db4d1ff4a4be845a78998c64564c000000000000000000000008","0xea67626e1f0b59e0d172a04f5702ef90bcdf440c00000000000000000000000f","0xeb496161099d45b3ea4892408ef745c6182eb56e00000000000000000000000e","0xece571847897fd61e764d455dc15cf1cd9de8d6f000000000000000000000014","0xed3e2f496cbcd8e212192fb8d1499842f04a0d19000000000000000000000009","0x02c9dcb975262719a61f9b40bdf0987ead9add3a000000000000000000000006","0x16c9a4d841e88e52b51936106010f27085a529ec00000000000000000000000c","0x32be2d0ddeaf3333501b24a28668ce373ba8e763000200000000000000000014","0x32f03464fdf909fdf3798f87ff3712b10c59bd86000000000000000000000005","0x4b718e0e2fea1da68b763cd50c446fba03ceb2ea00000000000000000000000b","0x68a69c596b3839023c0e08d09682314f582314e5000200000000000000000011","0x6f34a44fce1506352a171232163e7716dd073ade000200000000000000000015","0x9e2d87f904862671eb49cb358e74284762cc9f42000200000000000000000013","0xac4b72c01072a52b73ca71105504f1372efcce0d000000000000000000000003","0xbfd65c6160cfd638a85c645e6e6d8acac5dac935000000000000000000000004","0xe274c9deb6ed34cfe4130f8d0a8a948dea5bb28600000000000000000000000d"];class Ni extends p.SOR{constructor(e){const t=Fi(e),a=Ni.getSorConfig(e),n=Ni.getSorNetworkConfig(t),o=new d.JsonRpcProvider(e.rpcUrl,e.network),i=xi(t.urls.subgraph);super(o,n,Ni.getPoolDataService(t,a,o,i),Ni.getTokenPriceService(t,a,i))}static getSorConfig(e){return{tokenPriceService:"coingecko",poolDataService:"subgraph",fetchOnChainBalances:!0,...e.sor}}static getSorNetworkConfig(e){var t;return{...e,vault:e.addresses.contracts.vault,weth:e.addresses.tokens.wrappedNativeAsset,lbpRaisingTokens:null===(t=e.addresses.tokens)||void 0===t?void 0:t.lbpRaisingTokens,wETHwstETH:e.pools.wETHwstETH,connectingTokens:e.sorConnectingTokens,triPathMidPoolIds:e.sorTriPathMidPoolIds}}static getPoolDataService(e,t,a,n){const o=Ri.map((e=>R(e))),i=e.poolsToIgnore?[...e.poolsToIgnore,...o]:o;return"object"==typeof t.poolDataService?t.poolDataService:new Ci(n,a,{...e,poolsToIgnore:i},t)}static getTokenPriceService(e,t,a){return"object"==typeof t.tokenPriceService?t.tokenPriceService:("subgraph"===t.tokenPriceService&&new Mi(a,e.addresses.tokens.wrappedNativeAsset),new Bi(e.chainId))}}function Di(e){if(e.poolIds.length>2)throw new Error("Simple flash swap only supports a maximum of two pools");if(e.assets.length>2)throw new Error("Simple flash swap only supports a maximum of to two assets (tokens)")}function Li(e,t){return[{poolId:e[0],assetInIndex:0,assetOutIndex:1,amount:t,userData:"0x"},{poolId:e[1],assetInIndex:1,assetOutIndex:0,amount:"0",userData:"0x"}]}function Ui(e){return-1*Number(e)}function Vi(e){return s.sum(e)}const Gi={"0xae7ab96520de3a18e5e111b5eaab095312d7fe84":"0x7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0","0xd46ba6d942050d489dbd938a2c909a5d5039a161":"0xedb171c18ce90b633db442f2a6f72874093b49ef","0x1e6bb68acec8fefbd87d192be09bb274170a0548":"0xF03387d8d0FF326ab586A58E0ab4121d106147DF"};function qi(e){let t=e;return Gi.hasOwnProperty(e)&&(t=Gi[e]),t}var Wi;function $i(e,t,a){const{tokens:n,contracts:o}=Oa(a);let i={id:Wi.vault,address:o.vault};return n.stETH&&o.lidoRelayer&&[e,t].includes(n.stETH)&&(i={id:Wi.lido,address:o.lidoRelayer}),i}function Hi(e){return e.id===Wi.lido?xt.abi.filter((e=>"function"===e.type&&e.name&&["swap","batchSwap"].includes(e.name))):da.abi.filter((e=>"function"===e.type&&e.name&&["swap","batchSwap"].includes(e.name)))}function Ki(e){return{amount:e,max:t=>e.mul(1e4+t).div(1e4),min:t=>e.mul(1e4-t).div(1e4)}}function Ji(e,t){const a=t===exports.SwapType.SwapExactIn?e.swapAmount:e.returnAmount,n=t===exports.SwapType.SwapExactIn?e.returnAmount:e.swapAmount,o=t===exports.SwapType.SwapExactIn?e.swapAmountForSwaps||e.swapAmount:e.returnAmountFromSwaps||e.returnAmount,i=t===exports.SwapType.SwapExactIn?e.returnAmountFromSwaps||e.returnAmount:e.swapAmountForSwaps||e.swapAmount,s=qi(e.tokenIn),r=qi(e.tokenOut);return{...e,amountIn:a,amountOut:n,amountInForLimits:Ki(o),amountOutForLimits:Ki(i),tokenInForSwaps:s,tokenOutFromSwaps:r}}!function(e){e[e.vault=1]="vault",e[e.lido=2]="lido"}(Wi||(Wi={}));class Xi{constructor(e,t,a){this.kind=t,this.chainId=a,this.functionName="swap",this.swapInfo=Ji(e,t),this.relayer=$i(this.swapInfo.tokenIn,this.swapInfo.tokenOut,this.chainId)}setFunds(e,t){this.funds={sender:e,recipient:t||e,fromInternalBalance:!1,toInternalBalance:!1}}setDeadline(e){this.deadline=e}get amount(){return this.kind===exports.SwapType.SwapExactOut?this.swapInfo.amountOutForLimits.amount:this.swapInfo.amountInForLimits.amount}setLimits(e){this.limit=this.kind===exports.SwapType.SwapExactIn?this.swapInfo.amountOutForLimits.min(e).toString():this.swapInfo.amountInForLimits.max(e).toString()}get singleSwap(){return{poolId:this.swapInfo.swaps[0].poolId,kind:this.kind,assetIn:this.swapInfo.tokenInForSwaps,assetOut:this.swapInfo.tokenOutFromSwaps,amount:this.amount.toString(),userData:"0x"}}attributes(){var e;if(!this.funds||!this.limit||!this.deadline)throw new Error("Uninitialized arguments");let t={request:this.singleSwap,funds:this.funds,limit:this.limit,deadline:this.deadline};const a=this.fragment();return a[0].inputs&&(null===(e=a[0].inputs)||void 0===e?void 0:e.length)>4&&(t={...t,value:"0",outputReference:"0"}),t}data(){return new e.Interface(this.fragment()).encodeFunctionData("swap",Object.values(this.attributes()))}value(e){let n=a.BigNumber.from(0);return this.swapInfo.tokenIn===t.AddressZero&&(n=this.kind===exports.SwapType.SwapExactIn?this.swapInfo.amountIn:this.swapInfo.amountInForLimits.max(e)),n}to(){return this.relayer.address}fragment(){return Hi(this.relayer).filter((e=>e.name===this.functionName))}}class Yi{constructor(e,t,a){this.kind=t,this.chainId=a,this.functionName="batchSwap",this.swapInfo=Ji(e,t),this.relayer=$i(this.swapInfo.tokenIn,this.swapInfo.tokenOut,this.chainId)}setFunds(e,t){this.funds={sender:e,recipient:t||e,fromInternalBalance:!1,toInternalBalance:!1}}setDeadline(e){this.deadline=e}minAmountOut(e){return this.kind===exports.SwapType.SwapExactIn?this.swapInfo.amountOutForLimits.min(e):this.swapInfo.amountOutForLimits.amount}maxAmountIn(e){return this.kind===exports.SwapType.SwapExactOut?this.swapInfo.amountInForLimits.max(e):this.swapInfo.amountInForLimits.amount}setLimits(e){this.limits=this.swapInfo.tokenAddresses.map((t=>{let n=a.BigNumber.from(0);return t===this.swapInfo.tokenInForSwaps&&(n=this.maxAmountIn(e)),t===this.swapInfo.tokenOutFromSwaps&&(n=this.minAmountOut(e).mul(-1)),n})).map((e=>e.toString().split(".")[0]))}attributes(){var e;if(!this.funds||!this.limits||!this.deadline)throw new Error("Uninitialized arguments");let t={kind:this.kind,swaps:this.swapInfo.swaps,assets:this.swapInfo.tokenAddresses,funds:this.funds,limits:this.limits,deadline:this.deadline};const a=this.fragment();return a[0].inputs&&(null===(e=a[0].inputs)||void 0===e?void 0:e.length)>6&&(t={...t,value:"0",outputReferences:[]}),t}data(){return new e.Interface(this.fragment()).encodeFunctionData("batchSwap",Object.values(this.attributes()))}value(e){let n=a.BigNumber.from(0);return this.swapInfo.tokenIn===t.AddressZero&&(n=this.maxAmountIn(e)),n}to(){return this.relayer.address}fragment(){return Hi(this.relayer).filter((e=>e.name===this.functionName))}}const ji={maxPools:4,gasPrice:"1",deadline:"999999999999999999",maxSlippage:10};class zi{constructor(e){e instanceof p.SOR?(this.sor=e,this.chainId=this.sor.provider._network.chainId):(this.sor=new Ni(e),"number"==typeof e.network?this.chainId=e.network:this.chainId=e.network.chainId),this.vaultContract=da.connect(Aa,this.sor.provider)}static getLimitsForSlippage(e,t,a,n,o,i){return va(e,t,a,n,o,i).map((e=>e.toString()))}async findRouteGivenIn({tokenIn:e,tokenOut:t,amount:a,gasPrice:n,maxPools:o=4}){return this.sor.getSwaps(e,t,p.SwapTypes.SwapExactIn,a,{gasPrice:n,maxPools:o})}async findRouteGivenOut({tokenIn:e,tokenOut:t,amount:a,gasPrice:n,maxPools:o=4}){return this.sor.getSwaps(e,t,p.SwapTypes.SwapExactOut,a,{gasPrice:n,maxPools:o})}buildSwap({userAddress:e,recipient:t,swapInfo:a,kind:n,deadline:o,maxSlippage:i}){if(!this.chainId)throw"Missing network configuration";const s=a.swaps.length>1?new Yi(a,n,this.chainId):new Xi(a,n,this.chainId);s.setFunds(e,t),s.setDeadline(o),s.setLimits(i);const r=s.to(),{functionName:p}=s;return{to:r,functionName:p,attributes:s.attributes(),data:s.data(),value:s.value(i)}}async buildRouteExactIn(e,t,n,o,i,s=ji){const r={...ji,...s},p=await this.findRouteGivenIn({tokenIn:n,tokenOut:o,amount:a.BigNumber.from(i),gasPrice:a.BigNumber.from(r.gasPrice),maxPools:r.maxPools});return this.buildSwap({userAddress:e,recipient:t,swapInfo:p,kind:exports.SwapType.SwapExactIn,deadline:r.deadline,maxSlippage:r.maxSlippage})}static encodeBatchSwap(e){return da.createInterface().encodeFunctionData("batchSwap",[e.kind,e.swaps,e.assets,e.funds,e.limits,e.deadline])}static encodeSimpleFlashSwap(e){return this.encodeBatchSwap(function({poolIds:e,assets:t,flashLoanAmount:a,walletAddress:n}){Di({poolIds:e,assets:t});const o=Li(e,a),i={sender:n,fromInternalBalance:!1,recipient:n,toInternalBalance:!1};return{kind:exports.SwapType.SwapExactIn,swaps:o,assets:t,funds:i,limits:["0","0"],deadline:"999999999999999999"}}(e))}async fetchPools(e){return this.sor.fetchPools(e)}getPools(){return this.sor.getPools()}async queryBatchSwap(e){return await Rn(this.vaultContract,e.kind,e.swaps,e.assets)}async querySimpleFlashSwap(e){return await async function(e){Di(e);const[t,a]=e.assets;try{const n=await Rn(e.vaultContract,exports.SwapType.SwapExactIn,Li(e.poolIds,e.flashLoanAmount),e.assets),o={[t]:Ui(n[0]).toString(),[a]:Ui(n[1]).toString()};return{profits:o,isProfitable:Vi([o[t],o[a]])>0}}catch(e){throw`Failed to querySimpleFlashSwap: ${e}`}}({...e,vaultContract:this.vaultContract})}async getSorSwap(e){return await async function(e,t,a,n,o){const i=a===exports.SwapType.SwapExactIn?p.SwapTypes.SwapExactIn:p.SwapTypes.SwapExactOut;return await o.getSwaps(e.toLowerCase(),t.toLowerCase(),i,n)}(e.tokenIn,e.tokenOut,e.swapType,e.amount,this.sor)}async queryExactIn(e){const t=await this.query(e,exports.SwapType.SwapExactIn);return this.assetDeltas(t.map(String),e.tokenAddresses)}async queryExactOut(e){const t=await this.query(e,exports.SwapType.SwapExactOut);return this.assetDeltas(t.map(String),e.tokenAddresses)}query(e,a){const{swaps:n,tokenAddresses:o}=e,i={sender:t.AddressZero,recipient:t.AddressZero,fromInternalBalance:!1,toInternalBalance:!1};return this.vaultContract.callStatic.queryBatchSwap(a,n,o,i)}assetDeltas(e,t){return Object.fromEntries(e.map(((e,a)=>[t[a],e])))}}var Zi;exports.PoolKind=void 0,(Zi=exports.PoolKind||(exports.PoolKind={}))[Zi.WEIGHTED=0]="WEIGHTED",Zi[Zi.LEGACY_STABLE=1]="LEGACY_STABLE",Zi[Zi.COMPOSABLE_STABLE=2]="COMPOSABLE_STABLE",Zi[Zi.COMPOSABLE_STABLE_V2=3]="COMPOSABLE_STABLE_V2";const Qi=xt.createInterface();class es{static encodeApproveVault(e,t){return Qi.encodeFunctionData("approveVault",[e,t])}static encodeSetRelayerApproval(e,t,a){return Qi.encodeFunctionData("setRelayerApproval",[e,t,a])}static encodeGaugeWithdraw(e,t,a,n){return Qi.encodeFunctionData("gaugeWithdraw",[e,t,a,n])}static encodeGaugeDeposit(e,t,a,n){return Qi.encodeFunctionData("gaugeDeposit",[e,t,a,n])}static encodeSwap(e){return Qi.encodeFunctionData("swap",[e.request,e.funds,e.limit,e.deadline,e.value,e.outputReference])}static encodeBatchSwap(e){return Qi.encodeFunctionData("batchSwap",[e.swapType,e.swaps,e.assets,e.funds,e.limits,e.deadline,e.value,e.outputReferences])}static encodeExitPool(e){return Qi.encodeFunctionData("exitPool",[e.poolId,e.poolKind,e.sender,e.recipient,e.exitPoolRequest,e.outputReferences])}static encodeJoinPool(e){return Qi.encodeFunctionData("joinPool",[e.poolId,e.kind,e.sender,e.recipient,e.joinPoolRequest,e.value,e.outputReference])}static encodeWrapAaveDynamicToken(e){return Qi.encodeFunctionData("wrapAaveDynamicToken",[e.staticToken,e.sender,e.recipient,e.amount,e.fromUnderlying,e.outputReference])}static encodeUnwrapAaveStaticToken(e){return Qi.encodeFunctionData("unwrapAaveStaticToken",[e.staticToken,e.sender,e.recipient,e.amount,e.toUnderlying,e.outputReference])}static encodeUnwrapWstETH(e){return Qi.encodeFunctionData("unwrapWstETH",[e.sender,e.recipient,e.amount,e.outputReference])}static encodeUnwrap(e,t){let a;switch(t){case"AaveLinear":return this.encodeUnwrapAaveStaticToken({staticToken:e.wrappedToken,sender:e.sender,recipient:e.recipient,amount:e.amount,toUnderlying:!0,outputReference:e.outputReference});case"BeefyLinear":case"ERC4626Linear":a="unwrapERC4626";break;case"EulerLinear":a="unwrapEuler";break;case"GearboxLinear":a="unwrapGearbox";break;case"ReaperLinear":a="unwrapReaperVaultToken";break;case"TetuLinear":a="unwrapTetu";break;case"YearnLinear":a="unwrapYearn";break;case"MidasLinear":a="unwrapCompoundV2";break;case"SiloLinear":a="unwrapShareToken";break;default:throw new Error("Unwrapping not supported for this pool type: "+t)}return Qi.encodeFunctionData(a,[e.wrappedToken,e.sender,e.recipient,e.amount,e.outputReference])}static encodePeekChainedReferenceValue(e){return Qi.encodeFunctionData("peekChainedReferenceValue",[e])}static toChainedReference(e,t=!0){const n=t?es.CHAINED_REFERENCE_TEMP_PREFIX:es.CHAINED_REFERENCE_READONLY_PREFIX,o=`0x${n}${"0".repeat(64-n.length)}`;return a.BigNumber.from(o).add(e)}static fromChainedReference(e,t=!0){const n=t?es.CHAINED_REFERENCE_TEMP_PREFIX:es.CHAINED_REFERENCE_READONLY_PREFIX,o=`0x${n}${"0".repeat(64-n.length)}`;return a.BigNumber.from(e).sub(a.BigNumber.from(o))}static isChainedReference(e){const t=a.BigNumber.from(e),n=a.BigNumber.from("0xfff0000000000000000000000000000000000000000000000000000000000000"),o=t.toBigInt()&n.toBigInt();return"0xba10000000000000000000000000000000000000000000000000000000000000"===a.BigNumber.from(o)._hex.toString()}static formatExitPoolInput(e){const{assets:t,minAmountsOut:a,userData:n,toInternalBalance:o,poolId:i,poolKind:s,sender:r,recipient:p,outputReferences:d}=e;return{poolId:i,poolKind:s,sender:r,recipient:p,outputReferences:d,exitPoolRequest:{assets:t,minAmountsOut:a,userData:n,toInternalBalance:o}}}static formatJoinPoolInput(e){const{assets:t,maxAmountsIn:a,userData:n,fromInternalBalance:o,poolId:i,kind:s,sender:r,recipient:p,value:d,outputReference:l}=e;return{poolId:i,kind:s,sender:r,recipient:p,value:d,outputReference:l,joinPoolRequest:{assets:t,maxAmountsIn:a,userData:n,fromInternalBalance:o}}}}es.CHAINED_REFERENCE_TEMP_PREFIX="ba10",es.CHAINED_REFERENCE_READONLY_PREFIX="ba11",es.signRelayerApproval=async(e,a,n,o)=>{const i=o.interface.encodeFunctionData("setRelayerApproval",[a,e,!0]),s=await te.signSetRelayerApprovalAuthorization(o,n,e,i);return te.encodeCalldataAuthorization("0x",t.MaxUint256,s)};class ts{constructor(e){this.url=Fi(e).urls.subgraph,this.client=this.initClient()}initClient(){return jo(new l.GraphQLClient(this.url))}}class as{constructor(e,t){this.swaps=t||new zi(e)}async fetchPools(){return this.swaps.fetchPools()}getPools(){return this.swaps.getPools()}async getSpotPrice(e,t,a=[]){0===a.length&&(await this.fetchPools(),a=this.getPools());const n=p.parseToPoolsDict(a,0),o=this.swaps.sor.routeProposer.getCandidatePathsFromDict(e,t,0,n,4);if(0===o.length)throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_PAIR);return p.getSpotPriceAfterSwapForPath(o[0],0,p.ZERO).toString()}}const ns=["function getPoolId() view returns (bytes32)","function getSwapFeePercentage() view returns (uint256)","function getProtocolFeesCollector() view returns (address)","function inRecoveryMode() view returns (bool)"];class os{constructor(t,a,n={}){this.multicall=t,this.options=n,this.calls=[],this.paths=[],this.interface=new e.Interface(a)}call(e,t,a,n){return this.calls.push([t,a,n]),this.paths.push(e),this}async execute(e={}){const t=e;return(await this.executeMulticall()).forEach(((e,a)=>s.set(t,this.paths[a],e.length>1?e:e[0]))),this.calls=[],this.paths=[],t}async executeMulticall(){const[,e]=await this.multicall.callStatic.aggregate(this.calls.map((([e,t,a])=>({target:e,callData:this.interface.encodeFunctionData(t,a)}))),this.options);return e.map(((e,t)=>this.interface.decodeFunctionResult(this.calls[t][1],e)))}}function is(e){return Math.round(Date.now()/1e3)-e<86400}class ss{constructor(e,t){this.veBalAddress=e,this.multicall=t}async getLockInfo(e){if(!this.veBalAddress)throw new Error("veBal address must be defined");const t=new os(this.multicall,[...xa.abi]);t.call("locked",this.veBalAddress,"locked",[e]),t.call("epoch",this.veBalAddress,"epoch"),t.call("totalSupply",this.veBalAddress,"totalSupply()");const a=await t.execute();return this.formatLockInfo(a)}formatLockInfo(e){const[t,a]=e.locked,n=t.gt(0),o=1e3*a.toNumber();const i=n&&Date.now()>o;return{lockedEndDate:o,lockedAmount:Oe(t),totalSupply:Oe(e.totalSupply),epoch:Oe(e.epoch,0),hasExistingLock:n,isExpired:i}}}class rs{constructor(e,t){if(!e.veBalProxy)throw new Error("veBalProxy address must be defined");this.instance=wa.connect(e.veBalProxy,t)}async getAdjustedBalance(e){return Oe(await this.instance.adjustedBalanceOf(e))}}class ps{constructor(e,t){this.getLiquidityGauge=Qt.connect,this.contractAddresses="number"==typeof e?ka[e].addresses.contracts:e;const a=da.connect(this.contractAddresses.vault,t),n=yt.connect(this.contractAddresses.balancerHelpers,t);let o;this.contractAddresses.lidoRelayer&&(o=Yt.connect(this.contractAddresses.lidoRelayer,t));const i=ta.connect(this.contractAddresses.multicall,t),s=It.connect(this.contractAddresses.balancerRelayer,t);let r,p,d,l,u,c,y,b,m,f,T;this.contractAddresses.veBal&&(r=new ss(this.contractAddresses.veBal,i)),this.contractAddresses.veBalProxy&&(p=new rs(this.contractAddresses,t)),this.contractAddresses.gaugeClaimHelper&&(d=Gt.connect(this.contractAddresses.gaugeClaimHelper,t)),this.contractAddresses.composableStablePoolFactory&&(l=Et.connect(this.contractAddresses.composableStablePoolFactory,t)),this.contractAddresses.weightedPoolFactory&&(u=ya.connect(this.contractAddresses.weightedPoolFactory,t)),this.contractAddresses.aaveLinearPoolFactory&&(c=rt.connect(this.contractAddresses.aaveLinearPoolFactory,t)),this.contractAddresses.erc4626LinearPoolFactory&&(y=Mt.connect(this.contractAddresses.erc4626LinearPoolFactory,t)),this.contractAddresses.eulerLinearPoolFactory&&(b=Dt.connect(this.contractAddresses.eulerLinearPoolFactory,t)),this.contractAddresses.gearboxLinearPoolFactory&&(m=Ht.connect(this.contractAddresses.gearboxLinearPoolFactory,t)),this.contractAddresses.yearnLinearPoolFactory&&(f=Ta.connect(this.contractAddresses.yearnLinearPoolFactory,t)),this.contractAddresses.gyroConfigProxy&&(T=Jt.connect(this.contractAddresses.gyroConfigProxy,t)),this.instances={aaveLinearPoolFactory:c,balancerHelpers:n,BasePool:this.getBasePool,composableStablePoolFactory:l,ERC20:this.getErc20,erc4626LinearPoolFactory:y,eulerLinearPoolFactory:b,gaugeClaimHelper:d,gearboxLinearPoolFactory:m,gyroConfig:T,liquidityGauge:this.getLiquidityGauge,lidoRelayer:o,multicall:i,relayer:s,veBal:r,veBalProxy:p,weightedPoolFactory:u,yearnLinearPoolFactory:f,vault:a}}get contracts(){return this.instances}getErc20(e,t){return kt.connect(e,t)}getBasePool(e,t){return((e,t)=>new y.Contract(e,ns,t))(e,t)}}class ds{constructor(e,t){this.tokenPrices=e,this.tokenHistoricalPrices=t}async calcImpLoss(e,t){if(1e3*e>=Date.now())throw console.error(`[ImpermanentLossService][calcImpLoss]Error: ${Ba.getMessage(exports.BalancerErrorCode.TIMESTAMP_IN_THE_FUTURE)}`),new Ba(exports.BalancerErrorCode.TIMESTAMP_IN_THE_FUTURE);const a=await this.prepareData(e,t),n=this.getPoolValueDelta(a),o=this.getHoldValueDelta(a);return this.calculateImpermanentLoss(n,o)}calculateImpermanentLoss(e,t){return Math.floor(100*Math.abs(e/t-1)*100)/100}getPoolValueDelta(e){return e.reduce(((e,t)=>e*Math.pow(Math.abs(t.priceDelta+1),t.weight)),1)}getHoldValueDelta(e){return e.reduce(((e,t)=>e+Math.abs(t.priceDelta+1)*t.weight),0)}async prepareData(e,t){const a=t.tokens.filter((e=>e.address!==t.address)),n=this.getWeights(a),o=a.map((e=>e.address)),i=await this.getEntryPrices(e,o),s=await this.getExitPrices(a);return this.getAssets(a,s,i,n)}getAssets(e,t,a,n){return e.map(((e,o)=>({priceDelta:this.getDelta(a[e.address],t[e.address]),weight:n[o]})))}getDelta(e,t){if(0===e)throw console.error(`[ImpermanentLossService][getDelta]Error: ${Ba.getMessage(exports.BalancerErrorCode.ILLEGAL_PARAMETER)}: entry price is 0`),new Ba(exports.BalancerErrorCode.ILLEGAL_PARAMETER);return(t-e)/e}getWeights(e){const t=e.every((e=>!e.weight)),a=Math.round(1/e.length*100)/100,n=t?e.map((()=>a)):e.map((e=>{var t;return Number(null!==(t=e.weight)&&void 0!==t?t:0)}));if(n.some((e=>0===e)))throw console.error(`[ImpermanentLossService][getWeights]Error: ${Ba.getMessage(exports.BalancerErrorCode.MISSING_WEIGHT)}`),new Ba(exports.BalancerErrorCode.MISSING_WEIGHT);return n}async getExitPrices(e){var t;const a=await Promise.all(e.map((e=>this.tokenPrices.find(e.address)))).catch((()=>[]));if(!a.length||a.some((e=>void 0===(null==e?void 0:e.usd))))throw console.error(`[ImpermanentLossService][getExitPrices]Error: ${Ba.getMessage(exports.BalancerErrorCode.MISSING_PRICE_RATE)}`),new Ba(exports.BalancerErrorCode.MISSING_PRICE_RATE);const n=e.map(((e,t)=>({...e,price:a[t]}))),o={};for(const e of n)(null===(t=e.price)||void 0===t?void 0:t.usd)&&(o[e.address]=+e.price.usd);return o}async getEntryPrices(e,t){const a={};for(const n of t){const t=await this.tokenHistoricalPrices.findBy(n,e).catch((e=>{X.getInstance().warn(`[ImpermanentLossService][getEntryPrices]Error: ${e.message}`)}));if(!(null==t?void 0:t.usd)){throw X.getInstance().warn(`[ImpermanentLossService][getEntryPrices]Error: ${Ba.getMessage(exports.BalancerErrorCode.MISSING_PRICE_RATE)}`),new Ba(exports.BalancerErrorCode.MISSING_PRICE_RATE)}a[n]=+t.usd}return a}}const ls=145e3,us=1648465251,cs=31536e3,ys=2**(1/4),bs=(e=Math.round((new Date).getTime()/1e3))=>{const t=Math.floor((e-us)/cs);return ls*ys**-t},ms=e=>365*(ls*ys**-e/7);var fs=Object.freeze({__proto__:null,INITIAL_RATE:ls,START_EPOCH_TIME:us,weekly:bs,total:ms,between:(e,t)=>{if(e<us)throw"start timestamp before emission schedule deployment";if(t<e)throw"cannot finish before starting";let a=0;const n=Math.floor((e-us)/cs),o=Math.floor((t-us)/cs);for(let e=n;e<=o;e++)a+=ms(e);const i=us+cs*(n+1)-e,s=t-(us+cs*o);return a-=ms(n)*(cs-i)/cs,a-=ms(o)*(cs-s)/cs,a}});class Ts{constructor(e,t){this.repository=e,this.tokenPrices=t}async data(e=Date.now()){const t=await this.repository.multicallData(e),a=await this.tokenPrices.find(t.balAddress);if(!a||!a.usd)throw"No BAL USD price found";return{lastWeekBalRevenue:t.balAmount*parseFloat(a.usd),lastWeekBBAUsdRevenue:t.bbAUsdAmount*t.bbAUsdPrice,veBalSupply:t.veBalSupply}}}class hs{constructor(e){this.yesterdaysPools=e}async last24h(e){let t;return this.yesterdaysPools&&(t=await this.yesterdaysPools.find(e.id)),e.totalSwapFee?(null==t?void 0:t.totalSwapFee)?parseFloat(e.totalSwapFee)-parseFloat(t.totalSwapFee):e.createTime&&is(e.createTime)?parseFloat(e.totalSwapFee):0:0}}class Is{constructor(e,t,a,n,o,i,s,r,p){this.pools=e,this.tokenPrices=t,this.tokenMeta=a,this.tokenYields=n,this.feeCollector=o,this.yesterdaysPools=i,this.liquidityGauges=s,this.feeDistributor=r,this.gyroConfigRepository=p}async swapFees(e){const t=await this.last24hFees(e),a=await this.totalLiquidity(e);if(!t||!a)return 0;const n=t*(1-await this.protocolSwapFeePercentage(e))/parseFloat(a)*1e4;return Math.round(365*n)}async tokenAprs(e){if(!e.tokens)return{total:0,breakdown:{}};const t=await this.totalLiquidity(e),a=e.tokens.filter((t=>t.address!==e.address)),n=await Promise.all(a.map((async t=>{let a=0;const n=await this.tokenYields.find(t.address);if(n)a="MetaStable"===e.poolType||e.poolType.includes("Gyro")?n*(1-await this.protocolSwapFeePercentage(e)):"ComposableStable"===e.poolType||"Weighted"===e.poolType&&e.poolTypeVersion>=2?t.isExemptFromYieldProtocolFee?n:n*(1-parseFloat(e.protocolYieldFeeCache||"0.5")):n;else{const n=await this.pools.findBy("address",t.address);if(n){const o=await this.swapFees(n);let i=(await this.tokenAprs(n)).total;("ComposableStable"===e.poolType||"Weighted"===e.poolType&&2===e.poolTypeVersion)&&(t.isExemptFromYieldProtocolFee||(i*=1-parseFloat(e.protocolYieldFeeCache||"0.5"))),a=o+i}}return a}))),o=async e=>{var a,n,o,i,s;let r;if(e.weight)return parseFloat(e.weight);if(null===(n=null===(a=e.token)||void 0===a?void 0:a.pool)||void 0===n?void 0:n.poolType){const t=await this.pools.findBy("address",e.address);t&&(r=(await this.bptPrice(t)).toString())}else r=(null===(o=e.price)||void 0===o?void 0:o.usd)||(null===(i=await this.tokenPrices.find(e.address))||void 0===i?void 0:i.usd)||(null===(s=e.token)||void 0===s?void 0:s.latestUSDPrice);if(r){return parseFloat(e.balance)*parseFloat(r)/parseFloat(t)}throw`No price for ${e.address}`},i=await Promise.all(a.map((async(e,t)=>{if(0===n[t])return 0;try{const a=await o(e);return Math.round(n[t]*a)}catch(e){return X.getInstance().error(e),0}})));return{total:i.reduce(((e,t)=>e+t),0),breakdown:s.pickBy(s.zipObject(a.map((e=>e.address)),i),s.identity)}}async stakingApr(e,t=1){if(!this.liquidityGauges)return 0;const a=await this.liquidityGauges.findBy("poolId",e.id);if(!a||1==e.chainId&&0===a.workingSupply||e.chainId>1&&0===a.totalSupply||e.chainId>1&&0===a.balInflationRate)return 0;const n=ka[e.chainId].addresses.tokens.bal;if(!n)return 0;const[o,i]=await Promise.all([this.tokenPrices.find(n),this.bptPrice(e)]);if(!(null==o?void 0:o.usd))throw"Missing BAL price";if(a.balInflationRate){const e=86400*a.balInflationRate*365*parseFloat(o.usd)/(a.totalSupply*i);return Math.round(1e4*t*e)}if(e.chainId>1){if(!a.rewardTokens)return 0;const e=n&&a.rewardTokens[n];if(e){const t=await this.rewardTokenApr(n,e),o=a.totalSupply*i,s=t.value/o;return Math.round(1e4*s)}return 0}const s=parseFloat(o.usd),r=Math.round((new Date).getTime()/1e3),p=bs(r)/7*365*a.relativeWeight*s,d=(a.workingSupply+.4)/.4*i;return Math.round(1e4*t*p/d)}async rewardAprs(e){if(!this.liquidityGauges)return{total:0,breakdown:{}};const t=await this.liquidityGauges.findBy("poolId",e.id);if(!t||!t.rewardTokens||Object.keys(t.rewardTokens).length<1)return{total:0,breakdown:{}};const a=ka[e.chainId].addresses.tokens.bal,n=Object.keys(t.rewardTokens).filter((e=>e!=a)).map((async e=>{const a=t.rewardTokens[e];return this.rewardTokenApr(e,a)})),o=await this.bptPrice(e),i=t.totalSupply*o;if(0==i)return{total:0,breakdown:{}};const s={};let r=0;for await(const e of Object.values(n)){const t=e.value/i,a=Math.round(1e4*t);r+=a,s[e.address]=a}return{total:r,breakdown:s}}async protocolApr(e){if("0x5c6ee304399dbdb9c8ef030ab642b10820db8f56000200000000000000000014"!=e.id||!this.feeDistributor)return 0;const t=new Ts(this.feeDistributor,this.tokenPrices),{lastWeekBalRevenue:a,lastWeekBBAUsdRevenue:n,veBalSupply:o}=await t.data(),i=await this.bptPrice(e);if(!i)throw"bptPrice for veBal pool missing";const s=(a+n)/7;return Math.round(365*s*1e4/(i*o))}async apr(e){if(Ri.includes(e.id))return{swapFees:0,tokenAprs:{total:0,breakdown:{}},stakingApr:{min:0,max:0},rewardAprs:{total:0,breakdown:{}},protocolApr:0,min:0,max:0};const[t,a,n,o,i,s]=await Promise.all([this.swapFees(e),this.tokenAprs(e),this.stakingApr(e),this.stakingApr(e,2.5),this.rewardAprs(e),this.protocolApr(e)]);return{swapFees:t,tokenAprs:a,stakingApr:{min:n,max:o},rewardAprs:i,protocolApr:s,min:t+a.total+i.total+n,max:t+a.total+i.total+s+o}}async last24hFees(e){return new hs(this.yesterdaysPools).last24h(e)}async totalLiquidity(e){try{const t=new vn(this.pools,this.tokenPrices);return await t.getLiquidity(e)}catch(t){return X.getInstance().warn("Liquidity calculcation failed, falling back to subgraph"),e.totalLiquidity}}async bptPrice(e){return parseFloat(await this.totalLiquidity(e))/parseFloat(e.totalShares)}async protocolSwapFeePercentage(e){let t;return t="ComposableStable"==e.poolType||"Weighted"==e.poolType&&2==e.poolTypeVersion?0:e.poolType.includes("Gyro")&&this.gyroConfigRepository?await this.gyroConfigRepository.getGyroProtocolFee(e.address):e.protocolSwapFeeCache?parseFloat(e.protocolSwapFeeCache):await this.feeCollector.find("")||0,t}async rewardTokenApr(e,t){if(t.period_finish.toNumber()<Date.now()/1e3)return{address:e,value:0};{const a=t.rate.mul(86400).mul(365),n=await this.tokenPrices.find(e);if(n&&n.usd){let o=18;if(t.decimals)o=t.decimals;else{const t=await this.tokenMeta.find(e);o=(null==t?void 0:t.decimals)||18}return{address:e,value:parseFloat(Oe(a,o))*parseFloat(n.usd)}}throw`No USD price for ${e}`}}}const gs=Object.values(exports.PoolType),xs=new Map;gs.forEach((e=>{e.includes("Linear")&&gs.includes(e)&&xs.set(e,"batchSwap")})),xs.set(exports.PoolType.Element,"batchSwap"),xs.set(exports.PoolType.Investment,"joinPool"),xs.set(exports.PoolType.LiquidityBootstrapping,"joinPool"),xs.set(exports.PoolType.MetaStable,"joinPool"),xs.set(exports.PoolType.Stable,"joinPool"),xs.set(exports.PoolType.StablePhantom,"batchSwap"),xs.set(exports.PoolType.Weighted,"joinPool"),xs.set(exports.PoolType.ComposableStable,"joinPool");const _s=new Map;gs.forEach((e=>{e.includes("Linear")&&gs.includes(e)&&_s.set(e,"batchSwap")})),_s.set(exports.PoolType.Element,"batchSwap"),_s.set(exports.PoolType.Investment,"exitPool"),_s.set(exports.PoolType.LiquidityBootstrapping,"exitPool"),_s.set(exports.PoolType.MetaStable,"exitPool"),_s.set(exports.PoolType.Stable,"exitPool"),_s.set(exports.PoolType.StablePhantom,"batchSwap"),_s.set(exports.PoolType.Weighted,"exitPool"),_s.set(exports.PoolType.ComposableStable,"exitPool");class ws{constructor(e){this.pools=e,this.getGraphNodes=async(e,t,a)=>{if(!await this.pools.find(t))throw new Ba(exports.BalancerErrorCode.POOL_DOESNT_EXIST);const n=await this.buildGraphFromRootPool(t,a);if(n.id!==t)throw new Error("Error creating graph nodes");return e?ws.orderByBfs(n).reverse():ws.orderByBfs(n)}}async buildGraphFromRootPool(e,a){const n=await this.pools.find(e);if(!n)throw new Ba(exports.BalancerErrorCode.POOL_DOESNT_EXIST);return(await this.buildGraphFromPool(n.address,0,void 0,t.WeiPerEther,a))[0]}getTokenTotal(e){const a=e.tokensList.indexOf(e.address);let n=t.Zero;const{balancesEvm:o}=be(e);return o.forEach(((e,t)=>{a!==t&&(n=n.add(e))})),n}async buildGraphFromPool(e,n,o,i,s){var r;const p=await this.pools.findBy("address",e);if(!p){if(o){const t=await this.pools.findBy("address",o.address),a=t.tokensList.indexOf(e),s=null!==(r=t.tokens[a].decimals)&&void 0!==r?r:18,{balancesEvm:p}=be(t);return ws.createInputTokenNode(n,e,s,o,i,p[a].toString())}throw new Ba(exports.BalancerErrorCode.POOL_DOESNT_EXIST)}const d=xs.get(p.poolType),l=_s.get(p.poolType);if(!d||!l)throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE);const u=this.getTokenTotal(p),{spotPriceCalculator:c}=En.from(p.poolType),y={};let b=18;p.tokens.forEach((e=>{if(Je(e.address,p.address))return void(b=e.decimals?e.decimals:18);const t=c.calcPoolSpotPrice(e.address,p.address,p);y[e.address]=t}));let m={address:p.address,id:p.id,type:p.poolType,joinAction:d,exitAction:l,isProportionalExit:!1,children:[],marked:!1,index:n.toString(),parent:o,proportionOfParent:i,isLeaf:!1,spotPrices:y,decimals:b,balance:p.totalShares,priceRate:t.WeiPerEther.toString()};if(this.updateNodeIfProportionalExit(p,m),n++,p.poolType.toString().includes("Linear"))[m,n]=this.createLinearNodeChildren(m,n,p,s);else{const{balancesEvm:e}=be(p);for(let t=0;t<p.tokens.length;t++){if(Je(p.tokens[t].address,p.address))continue;let o;if("Weighted"===p.poolType){const e=p.tokens[t].weight;o=a.parseFixed(e,18)}else o=a.BigNumber.from(e[t]).mul(1e18.toString()).div(u);const r=o.mul(i).div(1e18.toString()),d=await this.buildGraphFromPool(p.tokens[t].address,n,m,r,s);n=d[1],d[0]&&m.children.push(d[0])}}return[m,n]}updateNodeIfProportionalExit(e,t){(e.poolType===exports.PoolType.Weighted||e.poolType===exports.PoolType.ComposableStable&&e.poolTypeVersion>2)&&(t.isProportionalExit=!0)}createLinearNodeChildren(e,t,a,n){var o;if(void 0===a.mainIndex)throw new Error("Issue With Linear Pool");if(n.map((e=>e.toLowerCase())).includes(a.tokensList[a.mainIndex].toLowerCase())){const n=this.createWrappedTokenNode(a,t,e,e.proportionOfParent);return e.children.push(n[0]),[e,n[1]]}{const{balancesEvm:n}=be(a),i=null!==(o=a.tokens[a.mainIndex].decimals)&&void 0!==o?o:18,s=ws.createInputTokenNode(t,a.tokensList[a.mainIndex],i,e,e.proportionOfParent,n[a.mainIndex].toString());return e.children.push(s[0]),[e,t=s[1]]}}createWrappedTokenNode(e,t,a,n){var o;if(void 0===e.wrappedIndex||void 0===e.mainIndex)throw new Error("Issue With Linear Pool");const{balancesEvm:i,upScaledBalances:s,scalingFactorsRaw:r,priceRates:p}=be(e),d={type:"WrappedToken",address:e.tokensList[e.wrappedIndex],id:"N/A",children:[],marked:!1,joinAction:"wrap",exitAction:"unwrap",isProportionalExit:!1,index:t.toString(),parent:a,proportionOfParent:n,isLeaf:!1,spotPrices:{},decimals:18,balance:i[e.wrappedIndex].toString(),priceRate:p[e.wrappedIndex].toString()};t++;const l=null!==(o=e.tokens[e.mainIndex].decimals)&&void 0!==o?o:18,u=le(s[e.wrappedIndex],r[e.mainIndex]).toString(),c=ws.createInputTokenNode(t,e.tokensList[e.mainIndex],l,d,n,u);return d.children=[c[0]],[d,t=c[1]]}static createInputTokenNode(e,a,n,o,i,s){return[{address:a,id:"N/A",type:"Input",children:[],marked:!1,joinAction:"input",exitAction:"output",isProportionalExit:!1,index:e.toString(),parent:o,proportionOfParent:i,isLeaf:!0,spotPrices:{},decimals:n,balance:s,priceRate:t.WeiPerEther.toString()},e+1]}static orderByBfs(e){const t=[],a=[];for(e.marked=!0,t.push(e);t.length>0;){const e=t.shift();e&&a.push(e),null==e||e.children.forEach((e=>{e.marked||(e.marked=!0,t.push(e))}))}return a}static getLeafAddresses(e){return e.filter((e=>e.isLeaf)).map((e=>e.address))}static isProportionalPools(e){return e.every((e=>!(e.children.length>1)||e.isProportionalExit))}}class Ps{constructor(){}}Ps.joinInit=t=>e.defaultAbiCoder.decode(["uint256","uint256[]"],t),Ps.joinExactTokensInForBPTOut=t=>e.defaultAbiCoder.decode(["uint256","uint256[]","uint256"],t),Ps.joinTokenInForExactBPTOut=t=>e.defaultAbiCoder.decode(["uint256","uint256","uint256"],t),Ps.joinAllTokensInForExactBPTOut=t=>e.defaultAbiCoder.decode(["uint256","uint256"],t),Ps.exitExactBPTInForOneTokenOut=t=>e.defaultAbiCoder.decode(["uint256","uint256","uint256"],t),Ps.exitExactBPTInForTokensOut=t=>e.defaultAbiCoder.decode(["uint256","uint256"],t),Ps.exitBPTInForExactTokensOut=t=>e.defaultAbiCoder.decode(["uint256","uint256[]","uint256"],t);class Es{constructor(e){this.relayerModel=e}joinKind(t){const a=e.defaultAbiCoder.decode(["uint256"],t)[0];if(!a)throw new Error("No exit kind.");return a.toNumber()}decodeJoinData(e,t){if(t===exports.WeightedPoolJoinKind.ALL_TOKENS_IN_FOR_EXACT_BPT_OUT){return Ps.joinAllTokensInForExactBPTOut(e).toString()}if(t===exports.WeightedPoolJoinKind.EXACT_TOKENS_IN_FOR_BPT_OUT){const[,t]=Ps.joinExactTokensInForBPTOut(e);return t}if(t===exports.WeightedPoolJoinKind.TOKEN_IN_FOR_EXACT_BPT_OUT){const[,t,a]=Ps.joinTokenInForExactBPTOut(e);return[t.toString(),a]}throw new Error("Non supported join data")}allTokensInForExactBPTOut(){throw new Error("joinAllTokensInForExactBPTOut not supported")}joinExactTokensInForBPTOut(e,t){const n=this.decodeJoinData(e,exports.WeightedPoolJoinKind.EXACT_TOKENS_IN_FOR_BPT_OUT),o=this.relayerModel.doChainedRefReplacements(n),i=t._calcBptOutGivenExactTokensIn(o.map((e=>a.BigNumber.from(e))));if("StablePhantom"==t.SubgraphType||"ComposableStable"==t.SubgraphType){const e=t.tokens.find((e=>Je(e.address,t.address)));if(!e)throw new Error("Pool does not contain BPT as a token");const n=a.parseFixed(e.balance.toString(),e.decimals);t.updateTokenBalanceForPool(t.address,n.sub(i))}else t.updateTokenBalanceForPool(t.address,t.totalShares.add(i));const s=t.tokens.filter((e=>!Je(e.address,t.address)));return o.forEach(((e,n)=>{const o=a.parseFixed(s[n].balance.toString(),s[n].decimals);t.updateTokenBalanceForPool(s[n].address,o.add(e))})),[i.toString(),s.map((e=>e.address)),o]}joinTokenInForExactBPTOut(e,t){const[n,o]=this.decodeJoinData(e,exports.WeightedPoolJoinKind.TOKEN_IN_FOR_EXACT_BPT_OUT),i=this.relayerModel.doChainedRefReplacement(n),s=t.parsePoolPairData(t.tokensList[Number(o)],t.address),r=a.formatFixed(i,18),d=t._tokenInForExactTokenOut(s,p.bnum(r.toString())).dp(s.decimalsIn),l=a.parseFixed(d.toString(),s.decimalsIn);return t.updateTokenBalanceForPool(s.tokenIn,s.balanceIn.add(l)),t.updateTokenBalanceForPool(s.tokenOut,s.balanceOut.add(i)),[l.toString(),s.tokenIn,l.toString()]}async doJoinPool(e,a){const n=a[e.poolId],o=this.joinKind(e.encodedUserData);let i="0",s=[],r=[];if(o===exports.WeightedPoolJoinKind.ALL_TOKENS_IN_FOR_EXACT_BPT_OUT)i=this.allTokensInForExactBPTOut();else if(o===exports.WeightedPoolJoinKind.EXACT_TOKENS_IN_FOR_BPT_OUT)[i,s,r]=this.joinExactTokensInForBPTOut(e.encodedUserData,n);else{if(o!==exports.WeightedPoolJoinKind.TOKEN_IN_FOR_EXACT_BPT_OUT)throw new Error("Exit type not implemented");{let t,a;[i,t,a]=this.joinTokenInForExactBPTOut(e.encodedUserData,n),s.push(t),r.push(a)}}return s.push(n.address),r.push(t.Zero.sub(i).toString()),e.outputReference&&es.isChainedReference(e.outputReference)&&this.relayerModel.setChainedReferenceValue(e.outputReference,i),[s,r]}}class vs{constructor(e){this.relayerModel=e}exitKind(t,a){const n=e.defaultAbiCoder.decode(["uint256"],a)[0];if(!n)throw new Error("No exit kind.");return"ComposableStable"===t?n.toNumber()===exports.ComposableStablePoolExitKind.BPT_IN_FOR_EXACT_TOKENS_OUT?exports.WeightedPoolExitKind.BPT_IN_FOR_EXACT_TOKENS_OUT:n.toNumber()===exports.ComposableStablePoolExitKind.EXACT_BPT_IN_FOR_ALL_TOKENS_OUT?exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_TOKENS_OUT:exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_ONE_TOKEN_OUT:n.toNumber()}decodeExitData(e,t){if(t===exports.WeightedPoolExitKind.BPT_IN_FOR_EXACT_TOKENS_OUT){const[,t,a]=Ps.exitBPTInForExactTokensOut(e);return[t.toString(),a.toString()]}if(t===exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_ONE_TOKEN_OUT){const[,t,a]=Ps.exitExactBPTInForOneTokenOut(e);return[t.toString(),a.toString()]}if(t===exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_TOKENS_OUT){const[,t]=Ps.exitExactBPTInForTokensOut(e);return[t.toString()]}throw new Error("Non supported exit data")}exactBptInForTokensOut(e,t){const[n]=this.decodeExitData(e,exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_TOKENS_OUT),o=this.relayerModel.doChainedRefReplacement(n),i=t._calcTokensOutGivenExactBptIn(a.BigNumber.from(o)).map((e=>e.toString()));if("StablePhantom"==t.SubgraphType||"ComposableStable"==t.SubgraphType){const e=t.tokens.find((e=>Je(e.address,t.address)));if(!e)throw new Error("Pool does not contain BPT as a token");const n=a.parseFixed(e.balance.toString(),e.decimals);t.updateTokenBalanceForPool(t.address,n.add(o))}else t.updateTokenBalanceForPool(t.address,t.totalShares.sub(o));const s=t.tokens.filter((e=>!Je(e.address,t.address)));return i.forEach(((e,n)=>{const o=a.parseFixed(s[n].balance.toString(),s[n].decimals);t.updateTokenBalanceForPool(s[n].address,o.sub(e))})),[o,s.map((e=>e.address)),i]}exactBptInForOneTokenOut(e,t){const[n,o]=this.decodeExitData(e,exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_ONE_TOKEN_OUT),i=this.relayerModel.doChainedRefReplacement(n),s=t.parsePoolPairData(t.address,t.tokensList[Number(o)]),r=a.formatFixed(i,s.decimalsIn),d=t._exactTokenInForTokenOut(s,p.bnum(r)).dp(s.decimalsOut),l=a.parseFixed(d.toString(),s.decimalsOut),u=function(e,t){const n=[];return t.forEach((t=>{const o=e.tokens.findIndex((e=>Je(e.address,t)));if(o<0)throw"Pool does not contain tokenIn";n.push(a.parseFixed(e.tokens[o].balance,e.tokens[o].decimals).toString())})),n}(t,[t.address,s.tokenOut]);t.updateTokenBalanceForPool(s.tokenOut,a.BigNumber.from(u[1]).sub(l)),"StablePhantom"==t.SubgraphType||"ComposableStable"==t.SubgraphType?t.updateTokenBalanceForPool(t.address,a.BigNumber.from(u[0]).add(i)):t.updateTokenBalanceForPool(t.address,t.totalShares.sub(i));const c=t.tokensList.filter((e=>!Je(e,t.address))),y=new Array(c.length).fill("0");return y[Number(o)]=l.toString(),[i,c,y]}async doExitPool(e,a){const n=a[e.poolId],o=this.exitKind(n.SubgraphType,e.encodedUserData);let i,s=[],r=[];const p=[],d=[];if(o===exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_TOKENS_OUT)[i,r,s]=this.exactBptInForTokensOut(e.encodedUserData,n);else{if(o!==exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_ONE_TOKEN_OUT)throw new Error("Exit type not implemented");[i,r,s]=this.exactBptInForOneTokenOut(e.encodedUserData,n)}for(let t=0;t<e.outputReferences.length;t++){const a=n.tokensList[e.outputReferences[t].index],o=r.indexOf(a);if(-1===o)throw new Error("Token out not found");this.relayerModel.setChainedReferenceValue(e.outputReferences[t].key.toString(),s[o])}return p.push(n.address,...r),d.push(i,...s.map((e=>t.Zero.sub(e).toString()))),[p,d]}}class Ss{constructor(e){this.relayerModel=e}async doSingleSwap(e,a){const n=this.relayerModel.doChainedRefReplacement(e.request.amount.toString()),o=a[e.request.poolId],[,i]=this.doSwap(e.request.assetIn,e.request.assetOut,o,e.request.kind,n),s=t.Zero.sub(i);if(!e.outputReference)throw new Error("Missing outputReference");return this.relayerModel.setChainedReferenceValue(e.outputReference.toString(),s.abs().toString()),[s.toString(),n]}async doBatchSwap(e,a){const n=e.assets,o=new Array(n.length).fill(t.Zero);let i;for(let t=0;t<e.swaps.length;++t){const a=e.swaps[t].amount;es.isChainedReference(a)&&(e.swaps[t].amount=this.relayerModel.getChainedReferenceValue(a))}e.swaps.forEach((t=>{const s=n[t.assetInIndex],r=n[t.assetOutIndex],p=a[t.poolId];let d=t.amount;"0"===d&&(d=i);const[l,u]=this.doSwap(s,r,p,e.swapType,d);i=e.swapType===exports.SwapType.SwapExactIn?u.toString():l.toString(),o[t.assetInIndex]=o[t.assetInIndex].add(l),o[t.assetOutIndex]=o[t.assetOutIndex].sub(u)}));for(let t=0;t<e.outputReferences.length;t++)this.relayerModel.setChainedReferenceValue(e.outputReferences[t].key.toString(),o[e.outputReferences[t].index].abs().toString());return o.map((e=>e.toString()))}doSwap(e,n,o,i,s){const r=o.parsePoolPairData(e,n),d=i===exports.SwapType.SwapExactIn;let l=d?a.BigNumber.from(s):t.Zero,u=d?t.Zero:a.BigNumber.from(s);const c=a.formatFixed(l,r.decimalsIn),y=a.formatFixed(u,r.decimalsOut);if(d){const e=o._exactTokenInForTokenOut(r,p.bnum(c.toString())).dp(r.decimalsOut);u=a.parseFixed(e.toString(),r.decimalsOut)}else{const e=o._tokenInForExactTokenOut(r,p.bnum(y.toString())).dp(r.decimalsIn);l=a.parseFixed(e.toString(),r.decimalsIn)}return o.updateTokenBalanceForPool(r.tokenIn,r.balanceIn.add(l)),o.updateTokenBalanceForPool(r.tokenOut,r.balanceOut.sub(u)),[l,u]}}class As{constructor(e){this.relayerModel=e}async doUnwrap(e,n){const o=n[e.poolId],i=o.tokens[o.wrappedIndex],s=o.tokens[o.mainIndex],r=this.relayerModel.doChainedRefReplacement(e.amount.toString()),p=ce.divDownFixed(ce.mulDownFixed(BigInt(r),a.parseFixed(i.priceRate,18).toBigInt()),t.WeiPerEther.toBigInt()).toString();this.relayerModel.setChainedReferenceValue(e.outputReference.toString(),p);return[[i.address,s.address],[r,t.Zero.sub(p).toString()]]}}class ks{constructor(e){this.relayerModel=e,this.joinModel=new Es(e),this.exitModel=new vs(e),this.swapModel=new Ss(e),this.unwrapModel=new As(e)}async doJoin(e,t){return this.joinModel.doJoinPool(e,t)}async doExit(e,t){return this.exitModel.doExitPool(e,t)}async doBatchSwap(e,t){return this.swapModel.doBatchSwap(e,t)}async doSingleSwap(e,t){return this.swapModel.doSingleSwap(e,t)}async doUnwrap(e,t){return this.unwrapModel.doUnwrap(e,t)}}class Os{constructor(){this.chainedRefs={}}setChainedReferenceValue(e,t){this.chainedRefs[e]=t}getChainedReferenceValue(e){return this.chainedRefs[e]}doChainedRefReplacement(e){return es.isChainedReference(e.toString())?this.getChainedReferenceValue(e.toString()):e}doChainedRefReplacements(e){return e.map((e=>this.doChainedRefReplacement(e).toString()))}}class Cs{constructor(e,t){this.poolDataService=e,this.wrappedNativeAsset=t,this.poolsArray=[],this.poolsDict={}}dataSource(){return this.poolDataService}async all(e=!1){if(e||0===this.poolsArray.length){const e=s.cloneDeep(await this.dataSource().getPools());for(const t of e)if(["Weighted","Investment","Stable","LiquidityBootstrapping"].includes(t.poolType)){const e={address:t.address,balance:t.totalShares,decimals:18,priceRate:"1",weight:"0"};t.tokens.push(e),t.tokensList.push(t.address)}this.poolsArray=e}return this.poolsArray}parseToPoolsDict(e){return Object.fromEntries(s.cloneDeep(e).filter((e=>e.tokensList.length>0&&"0"!==e.tokens[0].balance)).map((e=>[e.id,this.parseNewPool(e)])).filter((([,e])=>void 0!==e)))}parseNewPool(e){if(!e.swapEnabled)return;let t={};try{if(["Weighted","Investment","LiquidityBootstrapping"].includes(e.poolType)){t=p.WeightedPool.fromPool(e,!1)}else if("Stable"===e.poolType){t=p.StablePool.fromPool(e)}else if("MetaStable"===e.poolType){t=p.MetaStablePool.fromPool(e)}else if(e.poolType.toString().includes("Linear")){t=p.LinearPool.fromPool(e)}else if("StablePhantom"===e.poolType){t=p.PhantomStablePool.fromPool(e)}else{if("ComposableStable"!==e.poolType){return void X.getInstance().warn(`Unknown pool type or type field missing: ${e.poolType} ${e.id}`)}t=p.ComposableStablePool.fromPool(e)}if(!t)throw new Error("Issue with Pool");t.SubgraphType=e.poolType}catch(e){return void console.error("Error parseNewPool")}return t}async poolsDictionary(e=!1){if(e||0===Object.keys(this.poolsDict).length){const t=await this.all(e);this.poolsDict=this.parseToPoolsDict(t)}return this.poolsDict}}var Bs,Ms;!function(e){e[e.BatchSwap=0]="BatchSwap",e[e.Join=1]="Join",e[e.Exit=2]="Exit",e[e.Swap=3]="Swap",e[e.Unwrap=4]="Unwrap"}(Bs||(Bs={}));class Fs{constructor(e,t){this.poolsSource=new Cs(e,t)}updateDeltas(e,a,n){return a.forEach(((a,o)=>{e[a]||(e[a]=t.Zero),e[a]=e[a].add(n[o])})),e}async multicall(e,t=!1){const a=new Os,n=new ks(a),o=await this.poolsSource.poolsDictionary(t),i={};for(const t of e){let e=[],a=[];switch(t.actionType){case Bs.Join:[e,a]=await n.doJoin(t,o);break;case Bs.Exit:[e,a]=await n.doExit(t,o);break;case Bs.BatchSwap:e=t.assets,a=await n.doBatchSwap(t,o);break;case Bs.Swap:e=[t.request.assetOut,t.request.assetIn],a=await n.doSingleSwap(t,o);break;case Bs.Unwrap:[e,a]=await n.doUnwrap(t,o)}this.updateDeltas(i,e,a)}return i}static mapSwapRequest(e){return{actionType:Bs.Swap,request:e.request,funds:e.funds,outputReference:e.outputReference}}static mapBatchSwapRequest(e){return{actionType:Bs.BatchSwap,swaps:e.swaps,assets:e.assets,funds:e.funds,swapType:e.swapType,outputReferences:e.outputReferences}}static mapJoinPoolRequest(e){return{actionType:Bs.Join,poolId:e.poolId,encodedUserData:e.joinPoolRequest.userData,outputReference:e.outputReference}}static mapExitPoolRequest(e){return{actionType:Bs.Exit,poolId:e.poolId,encodedUserData:e.exitPoolRequest.userData,outputReferences:e.outputReferences}}static mapUnwrapRequest(e,t,a){return{actionType:Bs.Unwrap,poolId:a,amount:e,outputReference:t}}}const Rs=It.createInterface();function Ns(e){X.getInstance()}class Ds{constructor(e,n,o){this.poolGraph=e,this.simulationService=o,this.createCalls=async(e,t,a,n,o)=>{const{multiRequests:i,encodedCalls:s,outputIndexes:r,deltas:p}=this.createActionCalls(e,t,a,n);o&&s.unshift(this.createSetRelayerApproval(o));return{multiRequests:i,encodedCall:Rs.encodeFunctionData("multicall",[s]),outputIndexes:o?r.map((e=>e+1)):r,deltas:p}},this.amountsOutByJoinPath=async(e,n,o,i,s,r,p,d)=>{const l=await this.simulationService.simulateGeneralisedJoin(this.relayer,n,o,s,e,i,r,p,d),u=l.reduce(((e,t)=>e.add(a.BigNumber.from(t))),t.Zero).toString();return{amountsOut:l,totalAmountOut:u}},this.minAmountsOutByJoinPath=(e,t,n)=>({minAmountsOut:t.map((t=>He(a.BigNumber.from(t),a.BigNumber.from(e)).toString())),totalMinAmountOut:He(a.BigNumber.from(n),a.BigNumber.from(e)).toString()}),this.createActionCalls=(e,t,a,n)=>{const o=[],i=[],s=[],r=!n,p={};return e.forEach(((e,d)=>{const l=e[0].isLeaf,u=[];if(e.forEach(((o,s)=>{var c,y;if(o.children.length>0&&0===o.children.filter((e=>this.shouldBeConsidered(e))).length)return void(o.index="0");const b=o.children.filter((e=>this.shouldBeConsidered(e))).some((e=>"input"===e.joinAction))?t:this.relayer,m=s===e.length-1,f=null!==(y=l&&(null===(c=o.parent)||void 0===c?void 0:c.children.filter((e=>this.shouldBeConsidered(e))).some((e=>"input"===e.joinAction))))&&void 0!==y&&y,T=m||f?t:this.relayer,h=m&&n?n[d]:"0";switch(o.joinAction){case"batchSwap":{const{modelRequest:e,encodedCall:t,assets:n,amounts:s}=this.createSwap(o,d,h,b,T,a,r);u.push(e),i.push(t),this.updateDeltas(p,n,s)}break;case"joinPool":{const{modelRequest:e,encodedCall:t,assets:n,amounts:s,minBptOut:l}=this.createJoinPool(o,d,h,b,T,a,r);u.push(e),i.push(t),this.updateDeltas(p,[o.address,...n],[l,...s])}break;default:return}})),r){const e=100*d,t=es.encodePeekChainedReferenceValue(es.toChainedReference(e,!1));i.push(t),s.push(i.indexOf(t))}o.push(u)})),{multiRequests:o,encodedCalls:i,outputIndexes:s,deltas:p}},this.createSetRelayerApproval=e=>es.encodeSetRelayerApproval(this.relayer,!0,e),this.createSwap=(e,n,o,i,s,r,p)=>{var d;if(1!==e.children.length)throw new Error("Unsupported swap");const l=e.children[0].address,u=this.getOutputRefValue(n,e.children[0]),c=o,y=r&&!p?this.replaceWrappedNativeAsset([l])[0]:l,b={poolId:e.id,kind:exports.SwapType.SwapExactIn,assetIn:y,assetOut:e.address,amount:u.value,userData:"0x"},m={sender:i,recipient:s,fromInternalBalance:this.allImmediateChildrenSendToInternal(e),toInternalBalance:this.allSiblingsSendToInternal(e)},f=a.BigNumber.from(this.getOutputRefValue(n,e).value),T=r&&!p?Ue([y],[u.value]):t.Zero,h={request:b,funds:m,limit:c,deadline:a.BigNumber.from(Math.ceil(Date.now()/1e3)+3600),value:T,outputReference:f},I=es.encodeSwap(h);Ns(),Ns(JSON.stringify(h)),Ns(JSON.stringify(null===(d=h.value)||void 0===d?void 0:d.toString()));const g=Fs.mapSwapRequest(h),x=e.children.some((e=>"input"===e.joinAction))?u.value:"0",_=null!=e.parent?"0":a.BigNumber.from(o).mul(-1).toString();return{modelRequest:g,encodedCall:I,assets:[e.address,l],amounts:[_,x]}},this.createJoinPool=(e,a,n,o,i,s,r)=>{var p;const d=[],l=[];e.children.forEach((e=>{d.push(e.address),this.shouldBeConsidered(e)?l.push(this.getOutputRefValue(a,e).value):l.push("0")})),e.type===exports.PoolType.ComposableStable&&(d.push(e.address),l.push("0"));const u=new j(this.wrappedNativeAsset),[c,y]=u.sortTokens(d,l);let b=[];const m=c.map((e=>e.toLowerCase())).indexOf(e.address.toLowerCase());let f;b=-1===m?y:[...y.slice(0,m),...y.slice(m+1)],f=e.type===exports.PoolType.Weighted?S.joinExactTokensInForBPTOut(b,n):v.joinExactTokensInForBPTOut(b,n);const T=s&&!r?Ue(this.replaceWrappedNativeAsset(c),y):t.Zero,h=this.allImmediateChildrenSendToInternal(e),I=es.formatJoinPoolInput({poolId:e.id,kind:0,sender:o,recipient:i,value:T,outputReference:this.getOutputRefValue(a,e).value,joinPoolRequest:{},assets:s&&!r?this.replaceWrappedNativeAsset(c):c,maxAmountsIn:y,userData:f,fromInternalBalance:h}),g=es.encodeJoinPool(I);Ns(),Ns(JSON.stringify(I)),Ns(JSON.stringify(null===(p=I.value)||void 0===p?void 0:p.toString()));const x=Fs.mapJoinPoolRequest(I),_=y.map((e=>es.isChainedReference(e)?"0":e)),w=es.isChainedReference(n)?"0":n,P=e.children.filter((e=>this.shouldBeConsidered(e))).some((e=>"input"===e.joinAction));return{modelRequest:x,encodedCall:g,assets:P?c:[],amounts:P?_:[],minBptOut:null!=e.parent?t.Zero.toString():t.Zero.sub(w).toString()}},this.getOutputRefValue=(e,t)=>"input"===t.joinAction?{value:t.index,isRef:!1}:"0"===t.index&&t.parent?{value:"0",isRef:!0}:{value:es.toChainedReference(a.BigNumber.from(t.index).add(100*e)).toString(),isRef:!0},this.shouldBeConsidered=e=>"0"!==e.index,this.sendsToInternalBalance=e=>"input"!==e.joinAction&&"joinPool"!==e.joinAction,this.allImmediateChildrenSendToInternal=e=>{const t=e.children.filter((e=>this.shouldBeConsidered(e)));return 0!==t.length&&t.filter((e=>this.sendsToInternalBalance(e))).length===t.length},this.allSiblingsSendToInternal=e=>{if(!e.parent)return!1;const t=e.parent.children.filter((e=>this.shouldBeConsidered(e)));return t.filter((e=>this.sendsToInternalBalance(e))).length===t.length},this.replaceWrappedNativeAsset=e=>{const a=e.findIndex((e=>e.toLowerCase()===this.wrappedNativeAsset.toLowerCase()));return Ye(e,a,t.AddressZero)};const{tokens:i,contracts:s}=Oa(n.chainId);this.relayer=s.balancerRelayer,this.wrappedNativeAsset=i.wrappedNativeAsset}checkInputs(e,a){if(0===e.length)throw new Ba(exports.BalancerErrorCode.MISSING_TOKENS);if(a.every((e=>"0"===e)))throw new Ba(exports.BalancerErrorCode.JOIN_WITH_ZERO_AMOUNT);if(e.length!=a.length)throw new Ba(exports.BalancerErrorCode.INPUT_LENGTH_MISMATCH);if(e.some((e=>e===t.AddressZero))&&e.some((e=>e.toLowerCase()===this.wrappedNativeAsset.toLowerCase())))throw new Ba(exports.BalancerErrorCode.INPUT_TOKEN_INVALID)}async joinPool(e,a,n,o,i,s,r,p){this.checkInputs(a,n);const d=await this.poolGraph.getGraphNodes(!0,e,[]),l=a.findIndex((e=>e===t.AddressZero)),u=-1!==l,c=Ye(a,l,this.wrappedNativeAsset.toLowerCase()),y=Ds.getJoinPaths(d,c,n),b=Ds.totalBptZeroPriceImpact(y);Ns();const{multiRequests:m,encodedCall:f,outputIndexes:T}=await this.createCalls(y,o,u,void 0,p),{amountsOut:h,totalAmountOut:I}=await this.amountsOutByJoinPath(o,m,f,c,T,s,r,"0"),{minAmountsOut:g,totalMinAmountOut:x}=this.minAmountsOutByJoinPath(i,h,I),_=Ma(BigInt(I),b.toBigInt(),!0).toString();Ns();const{encodedCall:w,deltas:P}=await this.createCalls(y,o,u,g,p),E=u?P[this.wrappedNativeAsset.toLowerCase()]:t.Zero;return Ns(E.toString()),this.assertDeltas(e,P,c,n,x),{to:this.relayer,encodedCall:w,expectedOut:I,minOut:x,priceImpact:_,value:E}}assertDeltas(e,t,n,o,i){var s;const r=R(e);if(t[r.toLowerCase()].add(i).abs().gt(3))throw console.error("join assertDeltas, bptOut: ",r,i,null===(s=t[r.toLowerCase()])||void 0===s?void 0:s.toString()),new Ba(exports.BalancerErrorCode.JOIN_DELTA_AMOUNTS);delete t[r.toLowerCase()],n.forEach(((e,n)=>{var i,s;if(!a.BigNumber.from(o[n]).eq(0)&&(null===(i=t[e.toLowerCase()])||void 0===i?void 0:i.toString())!==o[n])throw console.error("join assertDeltas, tokenIn: ",e,o[n],null===(s=t[e.toLowerCase()])||void 0===s?void 0:s.toString()),new Ba(exports.BalancerErrorCode.JOIN_DELTA_AMOUNTS);delete t[e.toLowerCase()]}));for(const e in t)if("0"!==t[e].toString())throw console.error("join assertDeltas, non-input token should be 0: ",e,t[e].toString()),new Ba(exports.BalancerErrorCode.JOIN_DELTA_AMOUNTS)}updateDeltas(e,a,n){return a.forEach(((a,o)=>{const i=a.toLowerCase();e[i]||(e[i]=t.Zero),e[i]=e[i].add(n[o])})),e}}Ms=Ds,Ds.getJoinPaths=(e,n,o)=>{const i=[],r=e.filter((e=>n.filter(((e,t)=>a.BigNumber.from(o[t]).gt(0))).map((e=>e.toLowerCase())).includes(e.address.toLowerCase())));r.some((e=>e.isLeaf))&&i.push(e);const p=r.filter((e=>!e.isLeaf));return p.forEach((e=>{const r=o.find(((t,a)=>Je(n[a],e.address))),d=p.filter((t=>Je(t.address,e.address))).reduce(((e,t)=>e.add(t.proportionOfParent)),a.BigNumber.from(0)),l=a.BigNumber.from(r).mul(e.proportionOfParent).div(d).toString(),[u]=ws.createInputTokenNode(0,e.address,e.decimals,e.parent,t.WeiPerEther,e.balance);u.index=l,u.isLeaf=!1;const c=[u];let y=u.parent,b=u;for(;y;){const e=s.cloneDeep(y);e.children=e.children.map((e=>e.address===b.address?b:{...e,index:"0"})),c.push(e),b=e,y=e.parent}i.push(c)})),Ms.updateInputAmounts(i,n,o),i},Ds.updateInputAmounts=(e,t,n)=>{const o=(e,t)=>{if(e.length>1){const n=e.reduce(((e,t)=>e.add(t.index)),a.BigNumber.from(0)),o=a.BigNumber.from(t).sub(n);e[0].index=o.add(e[0].index).toString()}},i=e.find((e=>e[0].isLeaf));if(i){const e=Ms.updateTotalProportions(i);i.forEach((a=>{"input"===a.joinAction&&(a=Ms.updateNodeAmount(a,t,n,e))})),t.forEach(((e,t)=>{const a=i.filter((t=>t.isLeaf&&Je(t.address,e)));o(a,n[t])}))}const s=e.filter((e=>!e[0].isLeaf));s.length>1&&t.forEach(((e,t)=>{const a=s.map((e=>e[0])).filter((t=>Je(t.address,e)));o(a,n[t])}))},Ds.totalBptZeroPriceImpact=e=>{let t=a.BigNumber.from("0");return e.forEach((e=>{if(e[0].isLeaf){e.filter((e=>e.isLeaf)).forEach((e=>{const a=Ms.bptOutZeroPiForInputNode(e);t=t.add(a)}))}else{const a=Ms.bptOutZeroPiForInputNode(e[0]);t=t.add(a)}})),t},Ds.bptOutZeroPiForInputNode=e=>{if("0"===e.index||"input"!==e.joinAction)return BigInt(0);let t=1,n=e.parent,o=e.address;for(;void 0!==n;){if("batchSwap"===n.joinAction||"joinPool"===n.joinAction){const e=n.spotPrices[o.toLowerCase()];t*=parseFloat(e),o=n.address}n=n.parent}const i=a.parseFixed(t.toFixed(18),18),s=re(BigInt(e.decimals)),r=pe(BigInt(e.index),s);return ce.divDownFixed(r,i.toBigInt())},Ds.updateTotalProportions=e=>{const t={};return e.forEach((e=>{t[e.address]?t[e.address]=t[e.address].add(e.proportionOfParent):t[e.address]=e.proportionOfParent})),t},Ds.updateNodeAmount=(e,t,a,n)=>{const o=t.map((e=>e.toLowerCase())).indexOf(e.address.toLowerCase());if(-1===o)return e.index="0",e;const i=n[e.address],s=e.proportionOfParent.mul(1e18.toString()).div(i).mul(a[o]).div(1e18.toString());return e.index=s.toString(),e};class Ls{constructor(e,n){this.chainId=e,this.simulateMulticall=async(e,t,a,n,o="0")=>{const i={...await this.encodeBalanceAndAllowanceOverrides(a,n),...await this.encodeRelayerApprovalOverride(a,e)};return this.simulateTransaction(e,t,a,i,o)},this.simulateTransaction=async(e,t,n,o,i)=>{const s=Object.fromEntries(Object.keys(o).map((e=>[e,{storage:o[e].value}]))),r={...s,[n]:{balance:a.parseFixed("100",18).toHexString()}},p={network_id:this.chainId.toString(),block_number:this.blockNumber,from:n,to:e,input:t,value:i,save_if_fails:!0,simulation_type:"quick",state_objects:r},d=this.tenderlyUrl+"simulate";return(await P.default.post(d,p,this.opts)).data.transaction.transaction_info.call_trace.output},this.encodeRelayerApprovalOverride=async(e,t)=>{const a={[`${this.vaultAddress}`]:{value:{[`_approvedRelayers[${e}][${t}]`]:(!0).toString()}}};return await this.requestStateOverrides(a)},this.encodeBalanceAndAllowanceOverrides=async(e,a)=>{const n=a.filter((e=>e!==t.AddressZero));if(0===n.length)return{};let o={};n.forEach((a=>o={...o,[`${a}`]:{value:{[`_balances[${e}]`]:t.MaxInt256.toString(),[`_allowances[${e}][${this.vaultAddress}]`]:t.MaxInt256.toString(),[`balanceOf[${e}]`]:t.MaxInt256.toString(),[`allowance[${e}][${this.vaultAddress}]`]:t.MaxInt256.toString(),[`balances[${e}]`]:t.MaxInt256.toString(),[`allowed[${e}][${this.vaultAddress}]`]:t.MaxInt256.toString()}}}));const i=await this.requestStateOverrides(o);if(Object.keys(i).some((e=>2!==Object.keys(i[e].value).length)))throw new Error("Couldn't encode state overrides - states should match the ones in the contracts");return i},this.requestStateOverrides=async e=>{const t=this.tenderlyUrl+"contracts/encode-states",a={networkID:this.chainId.toString(),stateOverrides:e},n=(await P.default.post(t,a,this.opts)).data.stateOverrides;if(!n||Object.keys(n).length!==Object.keys(e).length)throw new Error("Couldn't encode state overrides - contracts should be verified and whitelisted on Tenderly");return n};const{contracts:o}=Oa(this.chainId);this.vaultAddress=o.vault,this.tenderlyUrl=`https://api.tenderly.co/api/v1/account/${n.user}/project/${n.project}/`,this.opts={headers:{"X-Access-Key":n.accessKey}},this.blockNumber=n.blockNumber}}var Us;exports.SimulationType=void 0,(Us=exports.SimulationType||(exports.SimulationType={}))[Us.Tenderly=0]="Tenderly",Us[Us.VaultModel=1]="VaultModel",Us[Us.Static=2]="Static";class Vs{constructor(t,a){this.simulateGeneralisedJoin=async(e,t,a,n,o,i,s,r,p)=>{const d=[];switch(r){case exports.SimulationType.Tenderly:{if(!this.tenderlyHelper)throw new Error("Missing Tenderly config");const t=await this.tenderlyHelper.simulateMulticall(e,a,o,i,p);d.push(...this.decodeResult(t,n));break}case exports.SimulationType.VaultModel:{const e=await this.simulateRequests(t);d.push(...e);break}case exports.SimulationType.Static:{const t=await s.call({to:e,data:a,value:p});try{d.push(...this.decodeResult(t,n))}catch(e){const a=Buffer.from(t.split("x")[1],"hex").toString("utf8");throw new Error(`Transaction reverted with error: ${a}`)}break}default:throw new Error("Simulation type not supported")}return d},this.simulateGeneralisedExit=async(e,t,a,n,o,i,s,r)=>{const p=[];switch(r){case exports.SimulationType.Tenderly:{if(!this.tenderlyHelper)throw new Error("Missing Tenderly config");const t=await this.tenderlyHelper.simulateMulticall(e,a,o,[i]);p.push(...this.decodeResult(t,n));break}case exports.SimulationType.VaultModel:{const e=await this.simulateRequests(t);p.push(...e);break}case exports.SimulationType.Static:{const t=await s.call({to:e,data:a});try{p.push(...this.decodeResult(t,n))}catch(e){const a=Buffer.from(t.split("x")[1],"hex").toString("utf8");throw new Error(`Transaction reverted with error: ${a}`)}break}default:throw new Error("Simulation type not supported")}return p},this.decodeResult=(t,a)=>{const n=e.defaultAbiCoder.decode(["bytes[]"],t)[0];return a.map((t=>e.defaultAbiCoder.decode(["uint256"],n[t]).toString()))},this.simulateRequests=async e=>{if(void 0===this.vaultModel)throw new Error("Missing Vault Model Config.");const t=[];for(const[a,n]of e.entries()){const e=await this.vaultModel.multicall(n,0===a),o=Object.values(e).filter((e=>e.lt(0)));if(0===o.length)throw new Error("No delta found for token out.");t.push(...o.map((e=>e.mul(-1).toString())))}return t},t.tenderly&&(this.tenderlyHelper=new Ls(t.chainId,t.tenderly)),this.vaultModel=a?new Fs(a,t.addresses.tokens.wrappedNativeAsset):void 0}}const Gs=It.createInterface();function qs(e){X.getInstance()}class Ws{constructor(e,n,o){this.poolGraph=e,this.simulationService=o,this.amountsOutByExitPath=async(e,t,a,n,o,i,s)=>await this.simulationService.simulateGeneralisedExit(this.relayer,t,a,o,e,n,i,s),this.amountsOutByTokenOut=(e,a,n)=>{const o={};a.forEach(((e,a)=>{var i;return o[e]=(null!==(i=o[e])&&void 0!==i?i:t.Zero).add(n[a])}));return e.map((e=>o[e].toString()))},this.minAmountsOut=(e,t,n)=>({minAmountsOutByExitPath:e.map((e=>He(a.BigNumber.from(e),a.BigNumber.from(n)).toString())),minAmountsOutByTokenOut:t.map((e=>He(a.BigNumber.from(e),a.BigNumber.from(n)).toString()))}),this.getExitPaths=(e,n)=>{const o=e.map((e=>{const a=[e];for(;a[0].parent;)a.unshift(s.cloneDeep(a[0].parent));return a[0].index=a[a.length-1].proportionOfParent.mul(n).div(t.WeiPerEther).toString(),a})),i=o.reduce(((e,t)=>{const n=t[0].index;return a.BigNumber.from(n).add(e)}),t.Zero),r=a.BigNumber.from(n).sub(i);return o[o.length-1][0].index=r.add(o[o.length-1][0].index).toString(),o},this.createUnwrap=(e,a,n,o,i,s)=>{var r,p;const d=es.toChainedReference(this.getOutputRef(n,e.index)).toString(),l=es.toChainedReference(this.getOutputRef(n,a.index)),u=null===(r=e.parent)||void 0===r?void 0:r.type,c={wrappedToken:e.address,sender:i,recipient:s,amount:d,outputReference:l},y=es.encodeUnwrap(c,u);qs(),qs(),qs(JSON.stringify(c));return{modelRequest:Fs.mapUnwrapRequest(d,l,null===(p=e.parent)||void 0===p?void 0:p.id),encodedCall:y,assets:[a.address],amounts:[t.Zero.sub(o).toString()]}},this.getOutputRef=(e,t)=>100*e+parseInt(t),this.receivesFromInternal=e=>!!e.parent&&("output"!==e.exitAction&&"unwrap"!==e.exitAction&&"exitPool"!==e.exitAction);const{tokens:i,contracts:r}=Oa(n.chainId);this.wrappedNativeAsset=i.wrappedNativeAsset,this.relayer=r.balancerRelayer}async getExitInfo(e,t,a,n){qs();const o=await this.getExit(e,t,a,n,[],exports.SimulationType.VaultModel);return{tokensOut:o.tokensOut,estimatedAmountsOut:o.expectedAmountsOut,priceImpact:o.priceImpact,tokensToUnwrap:o.tokensToUnwrap}}async buildExitCall(e,t,a,n,o,i,s,r){qs();const p=await this.getExit(e,t,a,o,null!=r?r:[],i,s),{minAmountsOutByExitPath:d,minAmountsOutByTokenOut:l}=this.minAmountsOut(p.expectedAmountsOutByExitPath,p.expectedAmountsOut,n);qs();const{encodedCall:u,deltas:c}=await this.createCalls(p.exitPaths,a,p.isProportional,d,s);return this.assertDeltas(e,c,t,p.tokensOut,l),{to:this.relayer,encodedCall:u,tokensOut:p.tokensOut,expectedAmountsOut:p.expectedAmountsOut,minAmountsOut:l,priceImpact:p.priceImpact}}async getExit(e,t,n,o,i,s,r){const p=await this.poolGraph.getGraphNodes(!1,e,i),d=ws.isProportionalPools(p);qs();let l=[],u=[],c=[];const y=p.filter((e=>"output"===e.exitAction));if(u=y.map((e=>e.address.toLowerCase())),c=[...new Set(u)].sort(),d){const e=p.map(((e,a)=>(0===a&&(e.index=t),e)));l[0]=e}else l=this.getExitPaths(y,t);const{multiRequests:b,encodedCall:m,outputIndexes:f}=await this.createCalls(l,n,d,void 0,r),T=await this.amountsOutByExitPath(n,b,m,p[0].address,f,o,s),h=y.filter(((e,t)=>a.BigNumber.from(T[t]).gt(e.balance))).map((e=>e.address.toLowerCase()));if(i.some((e=>h.includes(e.toLowerCase()))))throw new Error("Insufficient pool balance to perform generalised exit - try exitting with smaller amounts");if(h.length>0)return await this.getExit(e,t,n,o,[...new Set(h)].sort(),s,r);{const a=this.amountsOutByTokenOut(c,u,T),n=await this.calculatePriceImpact(e,this.poolGraph,c,a,t);return{tokensToUnwrap:i,tokensOut:c,exitPaths:l,isProportional:d,expectedAmountsOut:a,expectedAmountsOutByExitPath:T,priceImpact:n}}}async calculatePriceImpact(e,t,a,n,o){const i=await t.getGraphNodes(!0,e,[]),s=Ds.getJoinPaths(i,a,n),r=Ds.totalBptZeroPriceImpact(s);return Ma(BigInt(o),r.toBigInt(),!1).toString()}assertDeltas(e,t,a,n,o){var i;const s=R(e);if(t[s.toLowerCase()].sub(a).abs().gt(3))throw console.error("exit assertDeltas, bptIn: ",s,a,null===(i=t[s.toLowerCase()])||void 0===i?void 0:i.toString()),new Ba(exports.BalancerErrorCode.EXIT_DELTA_AMOUNTS);delete t[s.toLowerCase()],n.forEach(((e,a)=>{var n;if(t[e.toLowerCase()].add(o[a]).abs().gt(1))throw console.error("exit assertDeltas, tokenOut: ",e,o[a],null===(n=t[e.toLowerCase()])||void 0===n?void 0:n.toString()),new Ba(exports.BalancerErrorCode.EXIT_DELTA_AMOUNTS);delete t[e.toLowerCase()]}));for(const e in t)if("0"!==t[e].toString())throw console.error("exit assertDeltas, non-input token should be 0: ",e,t[e].toString()),new Ba(exports.BalancerErrorCode.EXIT_DELTA_AMOUNTS)}async createCalls(e,t,a,n,o){const{multiRequests:i,calls:r,outputIndexes:p,deltas:d}=this.createActionCalls(s.cloneDeep(e),t,a,n);o&&r.unshift(es.encodeSetRelayerApproval(this.relayer,!0,o));return{multiRequests:i,encodedCall:Gs.encodeFunctionData("multicall",[r]),outputIndexes:o?p.map((e=>e+1)):p,deltas:d}}updateDeltas(e,a,n){return a.forEach(((a,o)=>{const i=a.toLowerCase();e[i]||(e[i]=t.Zero),e[i]=e[i].add(n[o])})),e}createActionCalls(e,a,n,o){const i=[],s=[],r=[],p=!o,d={},l=(e,t)=>t.children.filter((t=>e.map((e=>e.index)).includes(t.index))).some((e=>"output"===e.exitAction))?a:this.relayer;return e.forEach(((e,u)=>{const c=[],y=e.filter((e=>"output"===e.exitAction));e.forEach((i=>{const b=i.children.find((t=>e.map((e=>e.index)).includes(t.index))),m=((e,t)=>t.parent?l(e,t.parent):a)(e,i),f=l(e,i),T=i.children.filter((t=>e.map((e=>e.index)).includes(t.index))).some((e=>"output"===e.exitAction||"unwrap"===e.exitAction));let h="0";const I=Array(i.children.length).fill("0");switch(o&&T&&(n?i.children.forEach(((e,a)=>{let n;"unwrap"===e.exitAction?(n=y.indexOf(e.children[0]),h=t.WeiPerEther.mul(o[n]).div(e.priceRate).toString()):"output"===e.exitAction?(n=y.indexOf(e),h=o[n]):h="0",I[a]=h})):h="unwrap"===(null==b?void 0:b.exitAction)?t.WeiPerEther.mul(o[u]).div(b.priceRate).toString():o[u]),i.exitAction){case"unwrap":{const{modelRequest:e,encodedCall:t,assets:a,amounts:n}=this.createUnwrap(i,b,u,h,m,f);c.push(e),s.push(t),this.updateDeltas(d,a,n);break}case"batchSwap":{const{modelRequest:e,encodedCall:t,assets:a,amounts:n}=this.createSwap(i,b,u,h,m,f);c.push(e),s.push(t),this.updateDeltas(d,a,n);break}case"exitPool":{let e;e=n?this.createExitPoolProportional(i,I,m,f):this.createExitPool(i,b,u,h,m,f);const{modelRequest:t,encodedCall:a,bptIn:o,tokensOut:r,amountsOut:p}=e;c.push(t),s.push(a),this.updateDeltas(d,[i.address,...r],[o,...p]);break}case"output":p&&(s.push(es.encodePeekChainedReferenceValue(es.toChainedReference(this.getOutputRef(u,i.index),!1))),r.push(s.length-1));break;default:return}})),i.push(c)})),{multiRequests:i,calls:s,outputIndexes:r,deltas:d}}createSwap(e,t,n,o,i,s){const r=!e.parent,p=r?e.index:es.toChainedReference(this.getOutputRef(n,e.index)).toString(),d=t.address,l=[d,e.address],u=o,c={poolId:e.id,kind:exports.SwapType.SwapExactIn,assetIn:e.address,assetOut:d,amount:p,userData:"0x"},y={sender:i,recipient:s,fromInternalBalance:this.receivesFromInternal(e),toInternalBalance:this.receivesFromInternal(t)},b=es.toChainedReference(this.getOutputRef(n,t.index)),m={request:c,funds:y,limit:u,deadline:a.BigNumber.from(Math.ceil(Date.now()/1e3)+3600),value:"0",outputReference:b};qs(),qs(JSON.stringify(m));const f=es.encodeSwap(m),T=r?p:"0";return{modelRequest:Fs.mapSwapRequest(m),encodedCall:f,assets:l,amounts:["output"!==t.exitAction?"0":a.BigNumber.from(o).mul(-1).toString(),T]}}createBatchSwap(e,n,o,i,s,r){const p=!e.parent,d=p?e.index:es.toChainedReference(this.getOutputRef(o,e.index)).toString(),l=[...n.map((e=>e.address)),e.address],u=[...i];u.push(d);const c=[],y=[];n.forEach(((a,n)=>{const o=a.proportionOfParent.mul(d).div(t.WeiPerEther).toString(),i={poolId:e.id,assetInIndex:l.length-1,assetOutIndex:n,amount:o,userData:"0x"};c.push(i),y.push({index:n,key:es.toChainedReference(this.getOutputRef(0,a.index))})}));const b=c.reduce(((e,t)=>e.add(t.amount)),a.BigNumber.from(0)),m=a.BigNumber.from(d).sub(b);c[0].amount=m.add(c[0].amount).toString();const f={sender:s,recipient:r,fromInternalBalance:this.receivesFromInternal(e),toInternalBalance:this.receivesFromInternal(n[0])},T={swapType:exports.SwapType.SwapExactIn,swaps:c,assets:l,funds:f,limits:u,deadline:a.BigNumber.from(Math.ceil(Date.now()/1e3)+3600),value:"0",outputReferences:y};qs(),qs(JSON.stringify(T));const h=es.encodeBatchSwap(T),I=Fs.mapBatchSwapRequest(T),g=p?d:"0",x=[...n.map(((e,t)=>"output"!==e.exitAction?"0":a.BigNumber.from(i[t]).mul(-1).toString())),g];return{modelRequest:I,encodedCall:h,assets:l,amounts:x}}createExitPool(e,a,n,o,i,s){const r=a.address,p=!e.parent,d=p?e.index:es.toChainedReference(this.getOutputRef(n,e.index)).toString(),l=[],u=[];e.children.forEach((e=>{l.push(e.address),u.push(e.address===r?o:"0")})),e.type===exports.PoolType.ComposableStable&&(l.push(e.address),u.push("0"));const c=new j(this.wrappedNativeAsset),[y,b]=c.sortTokens(l,u);let m=[];const f=y.map((e=>e.toLowerCase())).indexOf(e.address.toLowerCase());let T;m=-1===f?y:[...y.slice(0,f),...y.slice(f+1)],T=e.type===exports.PoolType.Weighted?S.exitExactBPTInForOneTokenOut(d,m.indexOf(r)):v.exitExactBPTInForOneTokenOut(d,m.indexOf(r));const h=[{index:y.map((e=>e.toLowerCase())).indexOf(r.toLowerCase()),key:es.toChainedReference(this.getOutputRef(n,a.index))}],I=this.receivesFromInternal(a),g=es.formatExitPoolInput({poolId:e.id,poolKind:0,sender:i,recipient:s,outputReferences:h,exitPoolRequest:{},assets:y,minAmountsOut:b,userData:T,toInternalBalance:I});qs(),qs(JSON.stringify(g));const x=es.encodeExitPool(g),_=Fs.mapExitPoolRequest(g),w=b.map((e=>es.isChainedReference(e)?"0":t.Zero.sub(e).toString())),P=es.isChainedReference(d)?"0":d;return{modelRequest:_,encodedCall:x,bptIn:p?P:t.Zero.toString(),tokensOut:"output"!==a.exitAction?[]:y,amountsOut:"output"!==a.exitAction?[]:w}}createExitPoolProportional(e,a,n,o){const i=!e.parent,s=i?e.index:es.toChainedReference(this.getOutputRef(0,e.index)).toString(),r=e.children.map((e=>e.address)),p=[...a];e.type===exports.PoolType.ComposableStable&&(r.push(e.address),p.push("0"));const d=new j(this.wrappedNativeAsset),[l,u]=d.sortTokens(r,p);let c;c=e.type===exports.PoolType.Weighted?S.exitExactBPTInForTokensOut(s):e.type===exports.PoolType.ComposableStable?C.exitExactBPTInForAllTokensOut(s):v.exitExactBPTInForTokensOut(s);const y=e.children.map((e=>({index:l.map((e=>e.toLowerCase())).indexOf(e.address.toLowerCase()),key:es.toChainedReference(this.getOutputRef(0,e.index))})));let b=0;e.type===exports.PoolType.ComposableStable&&(b=3);const m=e.children.every((e=>this.receivesFromInternal(e))),f=es.formatExitPoolInput({poolId:e.id,poolKind:b,sender:n,recipient:o,outputReferences:y,exitPoolRequest:{},assets:l,minAmountsOut:u,userData:c,toInternalBalance:m});qs(),qs(JSON.stringify(f));const T=es.encodeExitPool(f),h=Fs.mapExitPoolRequest(f),I=u.map((e=>es.isChainedReference(e)?"0":t.Zero.sub(e).toString())),g=es.isChainedReference(s)?"0":s,x=i?g:t.Zero.toString(),_=l.filter((t=>e.children.filter((e=>"output"===e.exitAction)).map((e=>e.address)).includes(t))),w=I.filter(((e,t)=>_.includes(l[t])));return{modelRequest:h,encodedCall:T,bptIn:x,tokensOut:_,amountsOut:w}}}class $s{constructor(e){this.yesterdaysPools=e}async last24h(e){let t;return this.yesterdaysPools&&(t=await this.yesterdaysPools.find(e.id)),e.totalSwapVolume?(null==t?void 0:t.totalSwapVolume)?parseFloat(e.totalSwapVolume)-parseFloat(t.totalSwapVolume):e.createTime&&is(e.createTime)?parseFloat(e.totalSwapVolume):0:0}}class Hs{constructor(e,t){this.checkCreateInputs=({tokenAddresses:e,tokenRateCacheDurations:t,exemptFromYieldProtocolFeeFlags:a,rateProviders:n,swapFeeEvm:o})=>{if(e.length!==t.length||t.length!==a.length||a.length!==n.length)throw new Ba(exports.BalancerErrorCode.INPUT_LENGTH_MISMATCH);if(BigInt(o)<=BigInt(0)||BigInt(o)>BigInt(1e17))throw new Ba(exports.BalancerErrorCode.INVALID_SWAP_FEE_PERCENTAGE)},this.parseCreateParamsForEncoding=({name:e,symbol:t,tokenAddresses:a,amplificationParameter:n,rateProviders:o,tokenRateCacheDurations:i,exemptFromYieldProtocolFeeFlags:s,swapFeeEvm:r,owner:p,salt:d})=>{const l=new j(this.wrappedNativeAsset),[u,c,y,b]=l.sortTokens(a,o,i,s);return[e,t,u,n,c,y,b,r.toString(),p,d||et()]},this.encodeCreateFunctionData=e=>Et.createInterface().encodeFunctionData("create",e),this.checkInitJoinInputs=({poolId:e,poolAddress:t,tokensIn:a,amountsIn:n})=>{if(!e||!t)throw new Ba(exports.BalancerErrorCode.NO_POOL_DATA);if(a.length!==n.length)throw new Ba(exports.BalancerErrorCode.INPUT_LENGTH_MISMATCH)},this.parseParamsForInitJoin=({joiner:e,poolId:t,poolAddress:a,tokensIn:n,amountsIn:o})=>{const i=new j(this.wrappedNativeAsset),s=[...n,a],r=[...o,"0"],p=[...o,BigInt.asUintN(256,BigInt(-1)).toString()],[d,l,u]=i.sortTokens(s,r,p),c={poolId:t,sender:e,recipient:e,joinPoolRequest:{assets:d,maxAmountsIn:u,userData:C.joinInit(l),fromInternalBalance:!1}};return{attributes:c,params:[c.poolId,c.sender,c.recipient,c.joinPoolRequest]}},this.encodeInitJoinFunctionData=e=>{const t="joinPool";return{functionName:t,data:da.createInterface().encodeFunctionData(t,e)}},this.getPoolAddressAndIdWithReceipt=async(e,t)=>{var a;const n=Qe({receipt:t,to:(null===(a=this.contracts.composableStablePoolFactory)||void 0===a?void 0:a.address)||"",contractInterface:Et.createInterface(),logName:"PoolCreated"}).args.pool,o=this.getPoolInterface(),i=new y.Contract(n,o,e);return{poolAddress:n,poolId:await i.getPoolId()}};const{tokens:a}=Oa(e.chainId);this.wrappedNativeAsset=a.wrappedNativeAsset,this.contracts=t}create({name:e,symbol:t,tokenAddresses:a,amplificationParameter:n,rateProviders:o,tokenRateCacheDurations:i,exemptFromYieldProtocolFeeFlags:s,swapFeeEvm:r,owner:p,salt:d}){var l;this.checkCreateInputs({rateProviders:o,tokenAddresses:a,tokenRateCacheDurations:i,exemptFromYieldProtocolFeeFlags:s,swapFeeEvm:r});const u=this.parseCreateParamsForEncoding({name:e,symbol:t,tokenAddresses:a,amplificationParameter:n,rateProviders:o,tokenRateCacheDurations:i,exemptFromYieldProtocolFeeFlags:s,swapFeeEvm:r,owner:p,salt:d}),c=this.encodeCreateFunctionData(u);return{to:null===(l=this.contracts.composableStablePoolFactory)||void 0===l?void 0:l.address,data:c}}buildInitJoin({joiner:e,poolId:t,poolAddress:a,tokensIn:n,amountsIn:o}){this.checkInitJoinInputs({tokensIn:n,amountsIn:o,poolId:t,poolAddress:a});const{attributes:i,params:s}=this.parseParamsForInitJoin({joiner:e,poolId:t,poolAddress:a,tokensIn:n,amountsIn:o}),{functionName:r,data:p}=this.encodeInitJoinFunctionData(s);return{to:Aa,functionName:r,data:p,attributes:i}}getPoolInterface(){return wt.createInterface()}}class Ks{constructor(e,t){this.parseCreateParamsForEncoding=({name:e,symbol:t,tokenAddresses:a,normalizedWeights:n,rateProviders:o,swapFeeEvm:i,owner:s,salt:r})=>{const p=new j(this.wrappedNativeAsset),[d,l,u]=p.sortTokens(a,n,o);return[e,t,d,l,u,i.toString(),s,r||et()]},this.encodeCreateFunctionData=e=>ya.createInterface().encodeFunctionData("create",e),this.parseParamsForInitJoin=({joiner:e,poolId:t,tokensIn:a,amountsIn:n})=>{const o=new j(this.wrappedNativeAsset),[i,s]=o.sortTokens(a,n),r={poolId:t,sender:e,recipient:e,joinPoolRequest:{assets:i,maxAmountsIn:s,userData:S.joinInit(s),fromInternalBalance:!1}};return{attributes:r,params:[r.poolId,r.sender,r.recipient,r.joinPoolRequest]}},this.encodeInitJoinFunctionData=e=>{const t="joinPool";return{functionName:t,data:da.createInterface().encodeFunctionData(t,e)}},this.checkInitJoinInputs=({poolId:e,tokensIn:t,amountsIn:a})=>{if(!e)throw new Ba(exports.BalancerErrorCode.NO_POOL_DATA);if(t.length!==a.length)throw new Ba(exports.BalancerErrorCode.INPUT_LENGTH_MISMATCH)};const{tokens:a}=Oa(e.chainId);this.wrappedNativeAsset=a.wrappedNativeAsset,this.contracts=t}create({name:e,symbol:t,tokenAddresses:a,normalizedWeights:n,rateProviders:o,swapFeeEvm:i,owner:s,salt:r}){var p;this.checkCreateInputs({tokenAddresses:a,normalizedWeights:n,swapFeeEvm:i,rateProviders:o});const d=this.parseCreateParamsForEncoding({name:e,symbol:t,tokenAddresses:a,normalizedWeights:n,rateProviders:o,swapFeeEvm:i,owner:s,salt:r}),l=this.encodeCreateFunctionData(d);return{to:null===(p=this.contracts.weightedPoolFactory)||void 0===p?void 0:p.address,data:l}}checkCreateInputs({tokenAddresses:e,normalizedWeights:t,swapFeeEvm:a,rateProviders:n}){if(e.length!==t.length||t.length!==n.length)throw new Ba(exports.BalancerErrorCode.INPUT_LENGTH_MISMATCH);if(e.length<2)throw new Ba(exports.BalancerErrorCode.BELOW_MIN_TOKENS);if(e.length>8)throw new Ba(exports.BalancerErrorCode.ABOVE_MAX_TOKENS);if(BigInt(a)<=BigInt(0)||BigInt(a)>BigInt(1e17))throw new Ba(exports.BalancerErrorCode.INVALID_SWAP_FEE_PERCENTAGE);if(t.reduce(((e,t)=>ce.add(e,BigInt(t))),BigInt(0))!==BigInt(1e18))throw new Ba(exports.BalancerErrorCode.INVALID_WEIGHTS)}buildInitJoin({joiner:e,poolId:t,tokensIn:a,amountsIn:n}){this.checkInitJoinInputs({poolId:t,tokensIn:a,amountsIn:n});const{attributes:o,params:i}=this.parseParamsForInitJoin({joiner:e,poolId:t,tokensIn:a,amountsIn:n}),{functionName:s,data:r}=this.encodeInitJoinFunctionData(i);return{to:Aa,functionName:s,data:r,attributes:o}}async getPoolAddressAndIdWithReceipt(e,t){var a;const n=Qe({receipt:t,to:(null===(a=this.contracts.weightedPoolFactory)||void 0===a?void 0:a.address)||"",contractInterface:ya.createInterface(),logName:"PoolCreated"}).args.pool,o=this.getPoolInterface(),i=new y.Contract(n,o,e);return{poolAddress:n,poolId:await i.getPoolId()}}getPoolInterface(){return ua.createInterface()}}var Js;exports.ProtocolId=void 0,(Js=exports.ProtocolId||(exports.ProtocolId={}))[Js.AAVE_V1=0]="AAVE_V1",Js[Js.AAVE_V2=1]="AAVE_V2",Js[Js.AAVE_V3=2]="AAVE_V3",Js[Js.AMPLEFORTH=3]="AMPLEFORTH",Js[Js.BEEFY=4]="BEEFY",Js[Js.EULER=5]="EULER",Js[Js.GEARBOX=6]="GEARBOX",Js[Js.IDLE=7]="IDLE",Js[Js.MORPHO=8]="MORPHO",Js[Js.RADIANT=9]="RADIANT",Js[Js.REAPER=10]="REAPER",Js[Js.SILO=11]="SILO",Js[Js.STARGATE=12]="STARGATE",Js[Js.STURDY=13]="STURDY",Js[Js.TESSERA=14]="TESSERA",Js[Js.TETU=15]="TETU",Js[Js.YEARN=16]="YEARN",Js[Js.MIDAS=17]="MIDAS",Js[Js.AGAVE=18]="AGAVE";class Xs{constructor(e,t){this.getPoolFactoryInterface=()=>{switch(this.poolType){case exports.PoolType.AaveLinear:return rt.createInterface();case exports.PoolType.Linear:case exports.PoolType.ERC4626Linear:return Mt.createInterface();case exports.PoolType.EulerLinear:return Dt.createInterface();case exports.PoolType.GearboxLinear:return Ht.createInterface();case exports.PoolType.YearnLinear:return Ta.createInterface();default:throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE)}},this.getPoolInterface=()=>{switch(this.poolType){case exports.PoolType.AaveLinear:return it.createInterface();case exports.PoolType.Linear:case exports.PoolType.ERC4626Linear:return Ct.createInterface();case exports.PoolType.EulerLinear:return Rt.createInterface();case exports.PoolType.GearboxLinear:return Wt.createInterface();case exports.PoolType.YearnLinear:return ma.createInterface();default:throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE)}},this.checkCreateInputs=({swapFeeEvm:e,protocolId:t})=>{if(!exports.ProtocolId[t])throw new Ba(exports.BalancerErrorCode.INVALID_PROTOCOL_ID);if(BigInt(e)<=BigInt(0)||BigInt(e)>BigInt(1e17))throw new Ba(exports.BalancerErrorCode.INVALID_SWAP_FEE_PERCENTAGE);this.getFactoryAddress()},this.parseCreateParamsForEncoding=({name:e,symbol:t,mainToken:a,wrappedToken:n,upperTargetEvm:o,swapFeeEvm:i,owner:s,protocolId:r,salt:p})=>this.poolType===exports.PoolType.EulerLinear?[e,t,a,n,o,i,s,r.toString()]:[e,t,a,n,o,i,s,r.toString(),p||et()],this.encodeCreateFunctionData=e=>{const t=this.getPoolFactoryInterface();return this.poolType,exports.PoolType.EulerLinear,t.encodeFunctionData("create",e)},this.getFactoryAddress=()=>{switch(this.poolType){case exports.PoolType.AaveLinear:if(this.contracts.aaveLinearPoolFactory)return this.contracts.aaveLinearPoolFactory.address;throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE);case exports.PoolType.Linear:case exports.PoolType.ERC4626Linear:if(this.contracts.erc4626LinearPoolFactory)return this.contracts.erc4626LinearPoolFactory.address;throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE);case exports.PoolType.EulerLinear:if(this.contracts.eulerLinearPoolFactory)return this.contracts.eulerLinearPoolFactory.address;throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE);case exports.PoolType.GearboxLinear:if(this.contracts.gearboxLinearPoolFactory)return this.contracts.gearboxLinearPoolFactory.address;throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE);case exports.PoolType.YearnLinear:if(this.contracts.yearnLinearPoolFactory)return this.contracts.yearnLinearPoolFactory.address;throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE);default:throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE)}},this.getPoolAddressAndIdWithReceipt=async(e,t)=>{const a=Qe({receipt:t,to:this.getFactoryAddress()||"",contractInterface:this.getPoolFactoryInterface(),logName:"PoolCreated"}).args.pool,n=this.getPoolInterface(),o=new y.Contract(a,n,e);return{poolAddress:a,poolId:await o.getPoolId()}},this.contracts=e,this.poolType=t}buildInitJoin(){throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE)}create({name:e,symbol:t,mainToken:a,wrappedToken:n,upperTargetEvm:o,swapFeeEvm:i,owner:s,protocolId:r,salt:p}){this.checkCreateInputs({swapFeeEvm:i,protocolId:r});const d=this.parseCreateParamsForEncoding({name:e,symbol:t,mainToken:a,wrappedToken:n,upperTargetEvm:o,swapFeeEvm:i,owner:s,protocolId:r,salt:p}),l=this.encodeCreateFunctionData(d);return{to:this.getFactoryAddress(),data:l}}}class Ys{constructor(e,t){this.networkConfig=e,this.contracts=t.contracts}of(e){switch(e){case"Weighted":return new Ks(this.networkConfig,this.contracts);case"Investment":case"LiquidityBootstrapping":case"Stable":case"MetaStable":case"StablePhantom":default:throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE);case"ComposableStable":return new Hs(this.networkConfig,this.contracts);case"Linear":case"AaveLinear":case"ERC4626Linear":case"EulerLinear":case"GearboxLinear":case"YearnLinear":return new Xs(this.contracts,e)}}}class js{constructor(e){this.pool=e;const t=(e=>{switch(e){case exports.PoolType.Weighted:return S;case exports.PoolType.Stable:case exports.PoolType.MetaStable:case exports.PoolType.StablePhantom:case exports.PoolType.Element:case exports.PoolType.Gyro2:case exports.PoolType.Gyro3:return v;case exports.PoolType.ComposableStable:return C;default:if(Ze(e))return v}})(e.poolType);if(!t)throw"Pool type not supported";this.encoder=t}buildQueryJoinExactIn({maxAmountsInByToken:e,minimumBPT:n=t.Zero}){const o=this.pool.tokensList.findIndex((e=>this.pool.id.includes(e))),i=[...this.pool.tokensList],s=this.pool.tokensList.map((t=>{var n;return null!==(n=e.get(t))&&void 0!==n?n:a.BigNumber.from("0")}));let r;r=o>-1?je(s,o):s;const p=this.encoder.joinExactTokensInForBPTOut(r,n);return[this.pool.id,t.AddressZero,t.AddressZero,{assets:i,maxAmountsIn:s,userData:p,fromInternalBalance:!1}]}buildQueryJoinExactOut({maxAmountIn:e,bptOut:a,tokenIn:n}){const o=this.pool.tokensList.findIndex((e=>this.pool.id.includes(e)));let i=[...this.pool.tokensList];o>-1&&(i=je(this.pool.tokensList,o));const s=i.indexOf(n),r=this.encoder.joinTokenInForExactBPTOut(a,s),p=e?this.pool.tokensList.map((t=>t===n?e:"0")):[];return[this.pool.id,t.AddressZero,t.AddressZero,{assets:this.pool.tokensList,maxAmountsIn:p,userData:r,fromInternalBalance:!1}]}buildQueryExitToSingleToken({minAmountOut:e,bptIn:a,tokenOut:n}){const o=this.pool.tokensList.findIndex((e=>this.pool.id.includes(e)));let i=[...this.pool.tokensList];o>-1&&(i=je(this.pool.tokensList,o));const s=i.indexOf(n),r=this.encoder.exitExactBPTInForOneTokenOut(a,s),p=e?this.pool.tokensList.map((t=>t===n?e:"0")):[];return[this.pool.id,t.AddressZero,t.AddressZero,{assets:this.pool.tokensList,minAmountsOut:p,userData:r,toInternalBalance:!1}]}buildQueryExitProportionally({minAmountsOut:e=[],bptIn:a}){if(!this.encoder.exitExactBPTInForTokensOut)throw"Proportional exit not implemented";const n=this.encoder.exitExactBPTInForTokensOut(a);return[this.pool.id,t.AddressZero,t.AddressZero,{assets:this.pool.tokensList,minAmountsOut:e,userData:n,toInternalBalance:!1}]}buildQueryExitExactOut({minAmountsOut:e,maxBptIn:a=t.MaxUint256}){const n=this.pool.tokensList.findIndex((e=>this.pool.id.includes(e)));let o=[...e];n>-1&&(o=je(e,n));const i=this.encoder.exitBPTInForExactTokensOut(o,a);return[this.pool.id,t.AddressZero,t.AddressZero,{assets:this.pool.tokensList,minAmountsOut:e,userData:i,toInternalBalance:!1}]}}class zs{constructor(e){this.liquidityGaugesRepository=e}async relativeWeight(e){const t=await this.liquidityGaugesRepository.findBy("poolId",e);return t?t.relativeWeight:0}async weekly(e){return bs()*await this.relativeWeight(e)}}const Zs=(e,t,n)=>{const o=e.tokens.filter((t=>!e.id.toLowerCase().includes(t.address.toLowerCase()))),i=o.findIndex((e=>e.address.toLowerCase()===t.toLowerCase()));if(-1==i)throw new Error("Token not found in pool");const s=o.map((e=>Ce(e.balance,e.decimals))),r=a.BigNumber.from(n),p=s.map((e=>e.mul(r).div(s[i])));return{tokens:o.map((e=>e.address)),amounts:p.map((e=>e.toString()))}},Qs=(e,t)=>()=>{throw`${t} for poolType ${e} not implemented`};class er{constructor(e,t,a){this.networkConfig=e,this.repositories=t,this.balancerContracts=a,this.aprService=new Is(this.repositories.pools,this.repositories.tokenPrices,this.repositories.tokenMeta,this.repositories.tokenYields,this.repositories.feeCollector,this.repositories.yesterdaysPools,this.repositories.liquidityGauges,this.repositories.feeDistributor,this.repositories.gyroConfigRepository),this.liquidityService=new vn(t.pools,t.tokenPrices),this.simulationService=new Vs(e,this.repositories.poolsForSimulations),this.graphService=new ws(this.repositories.poolsOnChain),this.joinService=new Ds(this.graphService,e,this.simulationService),this.exitService=new Ws(this.graphService,e,this.simulationService),this.feesService=new hs(t.yesterdaysPools),this.volumeService=new $s(t.yesterdaysPools),this.poolFactory=new Ys(e,a),this.impermanentLossService=new ds(t.tokenPrices,t.tokenHistoricalPrices),t.liquidityGauges&&(this.emissionsService=new zs(t.liquidityGauges)),this.proportionalAmounts=Zs}static wrap(e,t){let a,n,o;try{a=En.from(e.poolType),o={buildJoin:(t,n,o,s)=>a.join.buildJoin({joiner:t,pool:e,tokensIn:n,amountsIn:o,slippage:s,wrappedNativeAsset:i}),calcPriceImpact:async(t,n,o)=>a.priceImpactCalculator.calcPriceImpact(e,t.map(BigInt),BigInt(n),o),buildExitExactBPTIn:(t,n,o,s=!1,r,p=!1)=>{if(a.exit.buildExitExactBPTIn)return a.exit.buildExitExactBPTIn({exiter:t,pool:e,bptIn:n,slippage:o,shouldUnwrapNativeAsset:s,wrappedNativeAsset:i,singleTokenOut:r,toInternalBalance:p});throw"ExitExactBPTIn not supported"},buildExitExactTokensOut:(t,n,o,s,r=!1)=>a.exit.buildExitExactTokensOut({exiter:t,pool:e,tokensOut:n,amountsOut:o,slippage:s,wrappedNativeAsset:i,toInternalBalance:r}),buildRecoveryExit:(t,n,o,i=!1)=>a.exit.buildRecoveryExit({exiter:t,pool:e,bptIn:n,slippage:o,toInternalBalance:i}),calcSpotPrice:(t,n)=>a.spotPriceCalculator.calcPoolSpotPrice(t,n,e),calcProportionalAmounts:(t,a)=>Zs(e,t,a)}}catch(t){if("UNSUPPORTED_POOL_TYPE"!=t.code){X.getInstance().warn(t)}o={buildJoin:Qs(e.poolType,"buildJoin"),calcPriceImpact:Qs(e.poolType,"calcPriceImpact"),buildExitExactBPTIn:Qs(e.poolType,"buildExitExactBPTIn"),buildExitExactTokensOut:Qs(e.poolType,"buildExitExactTokensOut"),calcSpotPrice:Qs(e.poolType,"calcSpotPrice"),buildRecoveryExit:Qs(e.poolType,"buildRecoveryExit")}}try{n=new js(e),o={...o,buildQueryJoinExactIn:n.buildQueryJoinExactIn.bind(n),buildQueryJoinExactOut:n.buildQueryJoinExactOut.bind(n),buildQueryExitExactOut:n.buildQueryExitExactOut.bind(n),buildQueryExitToSingleToken:n.buildQueryExitToSingleToken.bind(n),buildQueryExitProportionally:n.buildQueryExitProportionally.bind(n)}}catch(t){o={...o,buildQueryJoinExactIn:Qs(e.poolType,"buildQueryJoinExactIn"),buildQueryJoinExactOut:Qs(e.poolType,"buildQueryJoinExactOut"),buildQueryExitExactOut:Qs(e.poolType,"buildQueryExitExactOut"),buildQueryExitToSingleToken:Qs(e.poolType,"buildQueryExitToSingleToken"),buildQueryExitProportionally:Qs(e.poolType,"buildQueryExitProportionally")}}const i=t.addresses.tokens.wrappedNativeAsset.toLowerCase(),s=e.tokensList.indexOf(e.address);return{...e,...o,bptIndex:s}}dataSource(){return this.repositories.pools}async apr(e){return this.aprService.apr(e)}async impermanentLoss(e,t){return this.impermanentLossService.calcImpLoss(e,t)}async liquidity(e){return this.liquidityService.getLiquidity(e)}async bptPrice(e){return this.liquidityService.getBptPrice(e)}buildJoin({pool:e,tokensIn:t,amountsIn:a,userAddress:n,slippage:o}){const i=En.from(e.poolType);if(!i)throw`buildJoin for poolType ${e.poolType} not implemented`;return i.join.buildJoin({joiner:n,pool:e,tokensIn:t,amountsIn:a,slippage:o,wrappedNativeAsset:this.networkConfig.addresses.tokens.wrappedNativeAsset.toLowerCase()})}buildExitExactBPTIn({pool:e,bptAmount:t,userAddress:a,slippage:n,shouldUnwrapNativeAsset:o,singleTokenOut:i}){const s=En.from(e.poolType);if(!s||!s.exit.buildExitExactBPTIn)throw`buildExit for poolType ${e.poolType} not implemented`;return s.exit.buildExitExactBPTIn({pool:e,exiter:a,bptIn:t,slippage:n,wrappedNativeAsset:this.networkConfig.addresses.tokens.wrappedNativeAsset.toLowerCase(),shouldUnwrapNativeAsset:null!=o&&o,singleTokenOut:null!=i?i:void 0,toInternalBalance:!1})}buildRecoveryExit({pool:e,bptAmount:t,userAddress:a,slippage:n,toInternalBalance:o}){const i=En.from(e.poolType);if(!i||!i.exit.buildRecoveryExit)throw`buildRecoveryExit for poolType ${e.poolType} not implemented`;return i.exit.buildRecoveryExit({exiter:a,pool:e,bptIn:t,slippage:n,toInternalBalance:!!o})}async generalisedJoin(e,t,a,n,o,i,s,r){return this.joinService.joinPool(e,t,a,n,o,i,s,r)}async generalisedExit(e,t,a,n,o,i,s,r){return this.exitService.buildExitCall(e,t,a,n,o,i,s,r)}calcPriceImpact({pool:e,tokenAmounts:t,bptAmount:a,isJoin:n}){return En.from(e.poolType).priceImpactCalculator.calcPriceImpact(e,t.map(BigInt),BigInt(a),n)}async getExitInfo(e,t,a,n){return this.exitService.getExitInfo(e,t,a,n)}async fees(e){return this.feesService.last24h(e)}async volume(e){return this.volumeService.last24h(e)}async find(e){const t=await this.dataSource().find(e);if(t)return er.wrap(t,this.networkConfig)}async findBy(e,t){if("id"==e)return this.find(t);if("address"==e){const e=await this.dataSource().findBy("address",t);if(!e)return;return er.wrap(e,this.networkConfig)}throw`search by ${e} not implemented`}async all(){const e=await this.dataSource().all();return e?e.map((e=>er.wrap(e,this.networkConfig))).filter((e=>e)):[]}async where(e){const t=await this.dataSource().where(e);if(!t)return[];return t.map((e=>er.wrap(e,this.networkConfig))).filter((e=>e))}}const tr=new Se("strings/5.7.0");var ar,nr;function or(e,t,a,n,o){if(e===nr.BAD_PREFIX||e===nr.UNEXPECTED_CONTINUE){let e=0;for(let n=t+1;n<a.length&&a[n]>>6==2;n++)e++;return e}return e===nr.OVERRUN?a.length-t-1:0}function ir(e,t=ar.current){t!=ar.current&&(tr.checkNormalize(),e=e.normalize(t));let a=[];for(let t=0;t<e.length;t++){const n=e.charCodeAt(t);if(n<128)a.push(n);else if(n<2048)a.push(n>>6|192),a.push(63&n|128);else if(55296==(64512&n)){t++;const o=e.charCodeAt(t);if(t>=e.length||56320!=(64512&o))throw new Error("invalid utf-8 string");const i=65536+((1023&n)<<10)+(1023&o);a.push(i>>18|240),a.push(i>>12&63|128),a.push(i>>6&63|128),a.push(63&i|128)}else a.push(n>>12|224),a.push(n>>6&63|128),a.push(63&n|128)}return o.arrayify(a)}function sr(e){const a=ir(e);if(a.length>31)throw new Error("bytes32 string must be less than 32 bytes");return o.hexlify(o.concat([a,t.HashZero]).slice(0,32))}!function(e){e.current="",e.NFC="NFC",e.NFD="NFD",e.NFKC="NFKC",e.NFKD="NFKD"}(ar||(ar={})),function(e){e.UNEXPECTED_CONTINUE="unexpected continuation byte",e.BAD_PREFIX="bad codepoint prefix",e.OVERRUN="string overrun",e.MISSING_CONTINUE="missing continuation byte",e.OUT_OF_RANGE="out of UTF-8 range",e.UTF16_SURROGATE="UTF-16 surrogate",e.OVERLONG="overlong representation"}(nr||(nr={})),Object.freeze({error:function(e,t,a,n,o){return tr.throwArgumentError(`invalid codepoint at offset ${t}; ${e}`,"bytes",a)},ignore:or,replace:function(e,t,a,n,o){return e===nr.OVERLONG?(n.push(o),0):(n.push(65533),or(e,t,a))}});var rr,pr="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},dr={exports:{}};rr=dr,function(){var e="input is invalid type",t="object"==typeof window,a=t?window:{};a.JS_SHA3_NO_WINDOW&&(t=!1);var n=!t&&"object"==typeof self;!a.JS_SHA3_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node?a=pr:n&&(a=self);var o=!a.JS_SHA3_NO_COMMON_JS&&rr.exports,i=!a.JS_SHA3_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,s="0123456789abcdef".split(""),r=[4,1024,262144,67108864],p=[0,8,16,24],d=[1,0,32898,0,32906,2147483648,2147516416,2147483648,32907,0,2147483649,0,2147516545,2147483648,32777,2147483648,138,0,136,0,2147516425,0,2147483658,0,2147516555,0,139,2147483648,32905,2147483648,32771,2147483648,32770,2147483648,128,2147483648,32778,0,2147483658,2147483648,2147516545,2147483648,32896,2147483648,2147483649,0,2147516424,2147483648],l=[224,256,384,512],u=[128,256],c=["hex","buffer","arrayBuffer","array","digest"],y={128:168,256:136};!a.JS_SHA3_NO_NODE_JS&&Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),!i||!a.JS_SHA3_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(e){return"object"==typeof e&&e.buffer&&e.buffer.constructor===ArrayBuffer});for(var b=function(e,t,a){return function(n){return new k(e,t,e).update(n)[a]()}},m=function(e,t,a){return function(n,o){return new k(e,t,o).update(n)[a]()}},f=function(e,t,a){return function(t,n,o,i){return x["cshake"+e].update(t,n,o,i)[a]()}},T=function(e,t,a){return function(t,n,o,i){return x["kmac"+e].update(t,n,o,i)[a]()}},h=function(e,t,a,n){for(var o=0;o<c.length;++o){var i=c[o];e[i]=t(a,n,i)}return e},I=function(e,t){var a=b(e,t,"hex");return a.create=function(){return new k(e,t,e)},a.update=function(e){return a.create().update(e)},h(a,b,e,t)},g=[{name:"keccak",padding:[1,256,65536,16777216],bits:l,createMethod:I},{name:"sha3",padding:[6,1536,393216,100663296],bits:l,createMethod:I},{name:"shake",padding:[31,7936,2031616,520093696],bits:u,createMethod:function(e,t){var a=m(e,t,"hex");return a.create=function(a){return new k(e,t,a)},a.update=function(e,t){return a.create(t).update(e)},h(a,m,e,t)}},{name:"cshake",padding:r,bits:u,createMethod:function(e,t){var a=y[e],n=f(e,0,"hex");return n.create=function(n,o,i){return o||i?new k(e,t,n).bytepad([o,i],a):x["shake"+e].create(n)},n.update=function(e,t,a,o){return n.create(t,a,o).update(e)},h(n,f,e,t)}},{name:"kmac",padding:r,bits:u,createMethod:function(e,t){var a=y[e],n=T(e,0,"hex");return n.create=function(n,o,i){return new O(e,t,o).bytepad(["KMAC",i],a).bytepad([n],a)},n.update=function(e,t,a,o){return n.create(e,a,o).update(t)},h(n,T,e,t)}}],x={},_=[],w=0;w<g.length;++w)for(var P=g[w],E=P.bits,v=0;v<E.length;++v){var S=P.name+"_"+E[v];if(_.push(S),x[S]=P.createMethod(E[v],P.padding),"sha3"!==P.name){var A=P.name+E[v];_.push(A),x[A]=x[S]}}function k(e,t,a){this.blocks=[],this.s=[],this.padding=t,this.outputBits=a,this.reset=!0,this.finalized=!1,this.block=0,this.start=0,this.blockCount=1600-(e<<1)>>5,this.byteCount=this.blockCount<<2,this.outputBlocks=a>>5,this.extraBytes=(31&a)>>3;for(var n=0;n<50;++n)this.s[n]=0}function O(e,t,a){k.call(this,e,t,a)}k.prototype.update=function(t){if(this.finalized)throw new Error("finalize already called");var a,n=typeof t;if("string"!==n){if("object"!==n)throw new Error(e);if(null===t)throw new Error(e);if(i&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||i&&ArrayBuffer.isView(t)))throw new Error(e);a=!0}for(var o,s,r=this.blocks,d=this.byteCount,l=t.length,u=this.blockCount,c=0,y=this.s;c<l;){if(this.reset)for(this.reset=!1,r[0]=this.block,o=1;o<u+1;++o)r[o]=0;if(a)for(o=this.start;c<l&&o<d;++c)r[o>>2]|=t[c]<<p[3&o++];else for(o=this.start;c<l&&o<d;++c)(s=t.charCodeAt(c))<128?r[o>>2]|=s<<p[3&o++]:s<2048?(r[o>>2]|=(192|s>>6)<<p[3&o++],r[o>>2]|=(128|63&s)<<p[3&o++]):s<55296||s>=57344?(r[o>>2]|=(224|s>>12)<<p[3&o++],r[o>>2]|=(128|s>>6&63)<<p[3&o++],r[o>>2]|=(128|63&s)<<p[3&o++]):(s=65536+((1023&s)<<10|1023&t.charCodeAt(++c)),r[o>>2]|=(240|s>>18)<<p[3&o++],r[o>>2]|=(128|s>>12&63)<<p[3&o++],r[o>>2]|=(128|s>>6&63)<<p[3&o++],r[o>>2]|=(128|63&s)<<p[3&o++]);if(this.lastByteIndex=o,o>=d){for(this.start=o-d,this.block=r[u],o=0;o<u;++o)y[o]^=r[o];C(y),this.reset=!0}else this.start=o}return this},k.prototype.encode=function(e,t){var a=255&e,n=1,o=[a];for(a=255&(e>>=8);a>0;)o.unshift(a),a=255&(e>>=8),++n;return t?o.push(n):o.unshift(n),this.update(o),o.length},k.prototype.encodeString=function(t){var a,n=typeof t;if("string"!==n){if("object"!==n)throw new Error(e);if(null===t)throw new Error(e);if(i&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||i&&ArrayBuffer.isView(t)))throw new Error(e);a=!0}var o=0,s=t.length;if(a)o=s;else for(var r=0;r<t.length;++r){var p=t.charCodeAt(r);p<128?o+=1:p<2048?o+=2:p<55296||p>=57344?o+=3:(p=65536+((1023&p)<<10|1023&t.charCodeAt(++r)),o+=4)}return o+=this.encode(8*o),this.update(t),o},k.prototype.bytepad=function(e,t){for(var a=this.encode(t),n=0;n<e.length;++n)a+=this.encodeString(e[n]);var o=t-a%t,i=[];return i.length=o,this.update(i),this},k.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex,a=this.blockCount,n=this.s;if(e[t>>2]|=this.padding[3&t],this.lastByteIndex===this.byteCount)for(e[0]=e[a],t=1;t<a+1;++t)e[t]=0;for(e[a-1]|=2147483648,t=0;t<a;++t)n[t]^=e[t];C(n)}},k.prototype.toString=k.prototype.hex=function(){this.finalize();for(var e,t=this.blockCount,a=this.s,n=this.outputBlocks,o=this.extraBytes,i=0,r=0,p="";r<n;){for(i=0;i<t&&r<n;++i,++r)e=a[i],p+=s[e>>4&15]+s[15&e]+s[e>>12&15]+s[e>>8&15]+s[e>>20&15]+s[e>>16&15]+s[e>>28&15]+s[e>>24&15];r%t==0&&(C(a),i=0)}return o&&(e=a[i],p+=s[e>>4&15]+s[15&e],o>1&&(p+=s[e>>12&15]+s[e>>8&15]),o>2&&(p+=s[e>>20&15]+s[e>>16&15])),p},k.prototype.arrayBuffer=function(){this.finalize();var e,t=this.blockCount,a=this.s,n=this.outputBlocks,o=this.extraBytes,i=0,s=0,r=this.outputBits>>3;e=o?new ArrayBuffer(n+1<<2):new ArrayBuffer(r);for(var p=new Uint32Array(e);s<n;){for(i=0;i<t&&s<n;++i,++s)p[s]=a[i];s%t==0&&C(a)}return o&&(p[i]=a[i],e=e.slice(0,r)),e},k.prototype.buffer=k.prototype.arrayBuffer,k.prototype.digest=k.prototype.array=function(){this.finalize();for(var e,t,a=this.blockCount,n=this.s,o=this.outputBlocks,i=this.extraBytes,s=0,r=0,p=[];r<o;){for(s=0;s<a&&r<o;++s,++r)e=r<<2,t=n[s],p[e]=255&t,p[e+1]=t>>8&255,p[e+2]=t>>16&255,p[e+3]=t>>24&255;r%a==0&&C(n)}return i&&(e=r<<2,t=n[s],p[e]=255&t,i>1&&(p[e+1]=t>>8&255),i>2&&(p[e+2]=t>>16&255)),p},O.prototype=new k,O.prototype.finalize=function(){return this.encode(this.outputBits,!0),k.prototype.finalize.call(this)};var C=function(e){var t,a,n,o,i,s,r,p,l,u,c,y,b,m,f,T,h,I,g,x,_,w,P,E,v,S,A,k,O,C,B,M,F,R,N,D,L,U,V,G,q,W,$,H,K,J,X,Y,j,z,Z,Q,ee,te,ae,ne,oe,ie,se,re,pe,de,le;for(n=0;n<48;n+=2)o=e[0]^e[10]^e[20]^e[30]^e[40],i=e[1]^e[11]^e[21]^e[31]^e[41],s=e[2]^e[12]^e[22]^e[32]^e[42],r=e[3]^e[13]^e[23]^e[33]^e[43],p=e[4]^e[14]^e[24]^e[34]^e[44],l=e[5]^e[15]^e[25]^e[35]^e[45],u=e[6]^e[16]^e[26]^e[36]^e[46],c=e[7]^e[17]^e[27]^e[37]^e[47],t=(y=e[8]^e[18]^e[28]^e[38]^e[48])^(s<<1|r>>>31),a=(b=e[9]^e[19]^e[29]^e[39]^e[49])^(r<<1|s>>>31),e[0]^=t,e[1]^=a,e[10]^=t,e[11]^=a,e[20]^=t,e[21]^=a,e[30]^=t,e[31]^=a,e[40]^=t,e[41]^=a,t=o^(p<<1|l>>>31),a=i^(l<<1|p>>>31),e[2]^=t,e[3]^=a,e[12]^=t,e[13]^=a,e[22]^=t,e[23]^=a,e[32]^=t,e[33]^=a,e[42]^=t,e[43]^=a,t=s^(u<<1|c>>>31),a=r^(c<<1|u>>>31),e[4]^=t,e[5]^=a,e[14]^=t,e[15]^=a,e[24]^=t,e[25]^=a,e[34]^=t,e[35]^=a,e[44]^=t,e[45]^=a,t=p^(y<<1|b>>>31),a=l^(b<<1|y>>>31),e[6]^=t,e[7]^=a,e[16]^=t,e[17]^=a,e[26]^=t,e[27]^=a,e[36]^=t,e[37]^=a,e[46]^=t,e[47]^=a,t=u^(o<<1|i>>>31),a=c^(i<<1|o>>>31),e[8]^=t,e[9]^=a,e[18]^=t,e[19]^=a,e[28]^=t,e[29]^=a,e[38]^=t,e[39]^=a,e[48]^=t,e[49]^=a,m=e[0],f=e[1],J=e[11]<<4|e[10]>>>28,X=e[10]<<4|e[11]>>>28,k=e[20]<<3|e[21]>>>29,O=e[21]<<3|e[20]>>>29,re=e[31]<<9|e[30]>>>23,pe=e[30]<<9|e[31]>>>23,W=e[40]<<18|e[41]>>>14,$=e[41]<<18|e[40]>>>14,R=e[2]<<1|e[3]>>>31,N=e[3]<<1|e[2]>>>31,T=e[13]<<12|e[12]>>>20,h=e[12]<<12|e[13]>>>20,Y=e[22]<<10|e[23]>>>22,j=e[23]<<10|e[22]>>>22,C=e[33]<<13|e[32]>>>19,B=e[32]<<13|e[33]>>>19,de=e[42]<<2|e[43]>>>30,le=e[43]<<2|e[42]>>>30,te=e[5]<<30|e[4]>>>2,ae=e[4]<<30|e[5]>>>2,D=e[14]<<6|e[15]>>>26,L=e[15]<<6|e[14]>>>26,I=e[25]<<11|e[24]>>>21,g=e[24]<<11|e[25]>>>21,z=e[34]<<15|e[35]>>>17,Z=e[35]<<15|e[34]>>>17,M=e[45]<<29|e[44]>>>3,F=e[44]<<29|e[45]>>>3,E=e[6]<<28|e[7]>>>4,v=e[7]<<28|e[6]>>>4,ne=e[17]<<23|e[16]>>>9,oe=e[16]<<23|e[17]>>>9,U=e[26]<<25|e[27]>>>7,V=e[27]<<25|e[26]>>>7,x=e[36]<<21|e[37]>>>11,_=e[37]<<21|e[36]>>>11,Q=e[47]<<24|e[46]>>>8,ee=e[46]<<24|e[47]>>>8,H=e[8]<<27|e[9]>>>5,K=e[9]<<27|e[8]>>>5,S=e[18]<<20|e[19]>>>12,A=e[19]<<20|e[18]>>>12,ie=e[29]<<7|e[28]>>>25,se=e[28]<<7|e[29]>>>25,G=e[38]<<8|e[39]>>>24,q=e[39]<<8|e[38]>>>24,w=e[48]<<14|e[49]>>>18,P=e[49]<<14|e[48]>>>18,e[0]=m^~T&I,e[1]=f^~h&g,e[10]=E^~S&k,e[11]=v^~A&O,e[20]=R^~D&U,e[21]=N^~L&V,e[30]=H^~J&Y,e[31]=K^~X&j,e[40]=te^~ne&ie,e[41]=ae^~oe&se,e[2]=T^~I&x,e[3]=h^~g&_,e[12]=S^~k&C,e[13]=A^~O&B,e[22]=D^~U&G,e[23]=L^~V&q,e[32]=J^~Y&z,e[33]=X^~j&Z,e[42]=ne^~ie&re,e[43]=oe^~se&pe,e[4]=I^~x&w,e[5]=g^~_&P,e[14]=k^~C&M,e[15]=O^~B&F,e[24]=U^~G&W,e[25]=V^~q&$,e[34]=Y^~z&Q,e[35]=j^~Z&ee,e[44]=ie^~re&de,e[45]=se^~pe&le,e[6]=x^~w&m,e[7]=_^~P&f,e[16]=C^~M&E,e[17]=B^~F&v,e[26]=G^~W&R,e[27]=q^~$&N,e[36]=z^~Q&H,e[37]=Z^~ee&K,e[46]=re^~de&te,e[47]=pe^~le&ae,e[8]=w^~m&T,e[9]=P^~f&h,e[18]=M^~E&S,e[19]=F^~v&A,e[28]=W^~R&D,e[29]=$^~N&L,e[38]=Q^~H&J,e[39]=ee^~K&X,e[48]=de^~te&ne,e[49]=le^~ae&oe,e[0]^=d[n],e[1]^=d[n+1]};if(o)rr.exports=x;else for(w=0;w<_.length;++w)a[_[w]]=x[_[w]]}();var lr=dr.exports;const ur=new RegExp("^bytes([0-9]+)$"),cr=new RegExp("^(u?int)([0-9]*)$"),yr=new RegExp("^(.*)\\[([0-9]*)\\]$"),br=new Se("solidity/5.7.0");function mr(e,t,n){switch(e){case"address":return n?o.zeroPad(t,32):o.arrayify(t);case"string":return ir(t);case"bytes":return o.arrayify(t);case"bool":return t=t?"0x01":"0x00",n?o.zeroPad(t,32):o.arrayify(t)}let i=e.match(cr);if(i){let s=parseInt(i[2]||"256");return(i[2]&&String(s)!==i[2]||s%8!=0||0===s||s>256)&&br.throwArgumentError("invalid number type","type",e),n&&(s=256),t=a.BigNumber.from(t).toTwos(s),o.zeroPad(t,s/8)}if(i=e.match(ur),i){const a=parseInt(i[1]);return(String(a)!==i[1]||0===a||a>32)&&br.throwArgumentError("invalid bytes type","type",e),o.arrayify(t).byteLength!==a&&br.throwArgumentError(`invalid value for ${e}`,"value",t),n?o.arrayify((t+"0000000000000000000000000000000000000000000000000000000000000000").substring(0,66)):t}if(i=e.match(yr),i&&Array.isArray(t)){const a=i[1];parseInt(i[2]||String(t.length))!=t.length&&br.throwArgumentError(`invalid array length for ${e}`,"value",t);const n=[];return t.forEach((function(e){n.push(mr(a,e,!0))})),o.concat(n)}return br.throwArgumentError("invalid type","type",e)}function fr(e,t){e.length!=t.length&&br.throwArgumentError("wrong number of values; expected ${ types.length }","values",t);const a=[];return e.forEach((function(e,n){a.push(mr(e,t[n]))})),o.hexlify(o.concat(a))}function Tr(e,t){return a=fr(e,t),"0x"+lr.keccak_256(o.arrayify(a));var a}const hr=sr("PROTOCOL_SWAP_FEE_PERC"),Ir=sr("E-CLP"),gr=Tr(["bytes"],[e.defaultAbiCoder.encode(["bytes32","bytes32"],[hr,Ir])]);class xr{constructor(e,t,a){this.gyroConfigAddress=e,this.multicall=t,this.gyroConfigInterface=Jt.createInterface(),this.gyroConfig=Jt.connect(e,a)}async getGyroProtocolFee(t){let n;const o=Tr(["bytes"],[e.defaultAbiCoder.encode(["bytes32","uint256"],[hr,t])]),i=[{target:this.gyroConfigAddress,callData:this.gyroConfigInterface.encodeFunctionData("hasKey",[o])},{target:this.gyroConfigAddress,callData:this.gyroConfigInterface.encodeFunctionData("hasKey",[gr])},{target:this.gyroConfigAddress,callData:this.gyroConfigInterface.encodeFunctionData("hasKey",[hr])}],[,[s,r,p]]=await this.multicall.callStatic.aggregate(i),d=a.BigNumber.from(s).eq(1),l=a.BigNumber.from(r).eq(1),u=a.BigNumber.from(p).eq(1);return n=d?parseFloat(a.formatFixed(await this.gyroConfig.getUint(o),18)):l?parseFloat(a.formatFixed(await this.gyroConfig.getUint(gr),18)):u?parseFloat(a.formatFixed(await this.gyroConfig.getUint(hr),18)):0,n}}const _r=new e.Interface(["function gauge_relative_weight(address gauge, uint timestamp) view returns (uint)"]),wr=new e.Interface(["function gauge_relative_weight(address gauge) view returns (uint)"]);class Pr{constructor(e,t,a){this.multicall=e,this.gaugeControllerAddress=t,this.gaugeControllerCheckpointerAddress=a}async getRelativeWeights(e,t){const a=e.map((e=>this.gaugeControllerCheckpointerAddress&&!t?{target:this.gaugeControllerCheckpointerAddress,callData:wr.encodeFunctionData("gauge_relative_weight",[n.getAddress(e)])}:{target:this.gaugeControllerAddress,callData:_r.encodeFunctionData("gauge_relative_weight",[n.getAddress(e),t||Math.floor(Date.now()/1e3)])})),[,o]=await this.multicall.callStatic.aggregate(a);return e.reduce(((e,t,a)=>(e[t]||(e[t]=parseFloat(Oe(o[a],18))),e)),{})}}class Er{async get(e){const t=await this.query(e);return(null==t?void 0:t.length)>0?t[0]:void 0}async find(e){return this.get({where:{id:e}})}async findBy(e,t){return this.get({where:{[String(e)]:t}})}async findAllBy(e,t,a=1e3,n=0){const o={where:{[String(e)]:t},first:a,skip:n};return this.query(o)}}class vr extends Er{constructor(e,t,a){super(),this.chainId=t,this.blockHeight=a,this.client=xi(e)}}class Sr extends Er{constructor(e,t,a){super(),this.chainId=t,this.blockHeight=a,this.client=_i(e)}}class Ar extends Sr{async query(e){e.orderBy||(e.orderBy=Qo.balance),e.orderDirection||(e.orderDirection=oi.desc),!e.block&&this.blockHeight&&(e.block={number:await this.blockHeight()});const{gaugeShares:t}=await this.client.GaugeShares(e);return t.map(this.mapType)}mapType(e){var t;return{id:e.id,balance:e.balance,userAddress:null===(t=e.user)||void 0===t?void 0:t.id,gauge:{id:e.gauge.id,poolId:e.gauge.poolId||void 0,isKilled:e.gauge.isKilled,totalSupply:e.gauge.totalSupply}}}async findByUser(e,t,a){return this.findAllBy(exports.GaugeShareAttributes.UserAddress,e,t,a)}async findByGauge(e,t,a){return this.findAllBy(exports.GaugeShareAttributes.GaugeId,e,t,a)}}const kr=new e.Interface(["function totalSupply() view returns (uint)","function working_supply() view returns (uint)","function reward_count() view returns (uint)","function reward_tokens(uint rewardIndex) view returns (address)","function reward_data(address rewardToken) view returns (tuple(address token, address distributor, uint period_finish, uint rate, uint last_update, uint integral) data)"]),Or=new e.Interface(["function inflation_rate(uint currentWeekTimestamp) view returns (uint)"]);class Cr{constructor(e,t){this.multicall=e,this.chainId=t}async getTotalSupplies(e){const t=e.map((e=>({target:e,callData:kr.encodeFunctionData("totalSupply",[])}))),[,a]=await this.multicall.callStatic.aggregate(t),n=a.map((e=>"0x"==e?"0x0":e));return e.reduce(((e,t,a)=>(e[t]||(e[t]=parseFloat(Oe(n[a],18))),e)),{})}async getWorkingSupplies(e){const t=e.map((e=>({target:e,callData:kr.encodeFunctionData("working_supply",[])}))),[,a]=await this.multicall.callStatic.aggregate(t),n=a.map((e=>"0x"==e?"0x0":e));return e.reduce(((e,t,a)=>(e[t]||(e[t]=parseFloat(Oe(n[a],18))),e)),{})}async getInflationRates(e){const t=Math.floor(Date.now()/1e3/604800),a=e.map((e=>({target:e,callData:Or.encodeFunctionData("inflation_rate",[t])}))),[,n]=await this.multicall.callStatic.aggregate(a),o=n.map((e=>"0x"==e?"0x0":e));return e.reduce(((e,t,a)=>(e[t]||(e[t]=parseFloat(Oe(o[a],18))),e)),{})}async getRewardCounts(e){let t;if(1==this.chainId){const a=e.map((e=>({target:e,callData:kr.encodeFunctionData("reward_count",[])}))),[,n]=await this.multicall.callStatic.aggregate(a),o=n.map((e=>"0x"==e?"0x0":e));t=e.reduce(((e,t,a)=>(e[t]||(e[t]=parseInt(o[a])),e)),{})}else t=e.reduce(((e,t)=>(e[t]||(e[t]=1),e)),{});return t}async getRewardTokens(e,t){const a=t||await this.getRewardCounts(e),n=e.filter((e=>a[e]>0)),o=[0],i=n.map(((e,t)=>{const n=[];for(let t=0;t<a[e];t++)n.push({target:e,callData:kr.encodeFunctionData("reward_tokens",[t])});return o[t+1]=o[t]+a[e],n})).flat(),[,s]=await this.multicall.callStatic.aggregate(i);return n.reduce(((e,t,a)=>{const n=o[a],i=o[a+1],r=[];for(let e=n;e<i;e++)r.push(kr.decodeFunctionResult("reward_tokens",s[e])[0]);return e[t]||(e[t]=r),e}),{})}async getRewardData(e,t){const a=t||await this.getRewardTokens(e),n=[0],o=Object.keys(a).map(((e,t)=>{const o=[];for(let t=0;t<a[e].length;t++)o.push({target:e,callData:kr.encodeFunctionData("reward_data",[a[e][t]])});return n[t+1]=n[t]+a[e].length,o})).flat(),[,i]=await this.multicall.callStatic.aggregate(o),s=i.map((e=>kr.decodeFunctionResult("reward_data",e)[0]));return Object.keys(a).reduce(((e,t,o)=>{const i=n[o],r=a[t].reduce(((e,t,a)=>(e[t]||(e[t]=s[i+a]),e)),{});return e[t]||(e[t]=r),e}),{})}}class Br{constructor(e){this.gauges=[],this.client=_i(e)}async fetch(){const e=(await this.client.Pools({where:{preferentialGauge_not:null}})).pools.map((e=>e.preferentialGauge));return this.gauges=e,this.gauges}async find(e){return 0==this.gauges.length&&await this.fetch(),this.gauges.find((t=>t.id==e))}async findBy(e,t){if(0==this.gauges.length&&await this.fetch(),"id"==e)return this.find(t);if("poolId"==e)return this.gauges.find((e=>e.poolId==t));if("poolAddress"==e)return this.gauges.find((e=>e.poolAddress==t));throw`search by ${e} not implemented`}}class Mr{constructor(e,t,a,n,o){this.chainId=n,this.workingSupplies={},this.relativeWeights={},this.inflationRates={},this.rewardData={},a&&(this.gaugeController=new Pr(t,a,o)),this.multicall=new Cr(t,n),this.subgraph=new Br(e)}async fetch(){const e=await this.subgraph.fetch(),t=e.map((e=>e.id));if(1==this.chainId)this.workingSupplies=await this.multicall.getWorkingSupplies(t);else{const t=["0x3b8ca519122cdd8efb272b0d3085453404b25bd0","0xb08e16cfc07c684daa2f93c70323badb2a6cbfd2","0x2e96068b3d5b5bae3d7515da4a1d2e52d08a2647","0x809b79b53f18e9bc08a961ed4678b901ac93213a"],a=e.filter((e=>!t.includes(e.factory.id.toLowerCase()))).map((e=>e.id));a.length>0&&(this.inflationRates=await this.multicall.getInflationRates(a))}return this.gaugeController&&(this.relativeWeights=await this.gaugeController.getRelativeWeights(t)),this.rewardData=e.reduce(((e,t)=>{var n;return e[n=t.id]||(e[n]=t.tokens?Object.fromEntries(t.tokens.map((e=>[e.id.split("-")[0],{distributor:"",last_update:a.BigNumber.from(0),integral:a.BigNumber.from(0),token:e.id.split("-")[0],decimals:e.decimals,rate:Ce(e.rate||"0",e.decimals),period_finish:a.BigNumber.from(e.periodFinish||"0")}]))):{}),e}),{}),e.map(this.compose.bind(this))}async find(e){return this.gauges||(this.gauges=this.fetch()),(await this.gauges).find((t=>t.id==e))}async findBy(e,t){let a;if(this.gauges||(this.gauges=this.fetch()),"id"==e)return this.find(t);if("address"==e)return this.find(t);if("poolId"==e)a=(await this.gauges).find((e=>e.poolId==t));else{if("poolAddress"!=e)throw`search by ${e} not implemented`;a=(await this.gauges).find((e=>e.poolAddress==t))}return a}compose(e){return{id:e.id,address:e.id,name:e.symbol,poolId:e.poolId,poolAddress:e.poolAddress,totalSupply:parseFloat(e.totalSupply),workingSupply:this.workingSupplies[e.id],relativeWeight:this.relativeWeights[e.id],rewardTokens:this.rewardData[e.id],balInflationRate:this.inflationRates[e.id]}}}class Fr{constructor(e,t){this.url=e,this.apiKey=t}async get(e){try{const t=this.toPayload(e),{data:a}=await P.default.post(this.url,t,{headers:{"x-api-key":this.apiKey}});if(a.errors)throw new Error(a.errors.map((e=>e.message)).join(","));return a.data}catch(e){throw console.error(e),e}return[]}toPayload(e){return JSON.stringify({query:b.jsonToGraphQLQuery({query:e})})}}function Rr(e){return new Promise((t=>setTimeout(t,e)))}const Nr=(e,t)=>{var a,n,o,i,s,r,p,d,l,u,c;return{id:e.id,name:e.name||"",address:e.address,chainId:t,poolType:e.poolType,poolTypeVersion:e.poolTypeVersion||1,swapFee:e.swapFee,swapEnabled:e.swapEnabled,protocolYieldFeeCache:e.protocolYieldFeeCache||"0.5",protocolSwapFeeCache:e.protocolSwapFeeCache||"0.5",amp:null!==(a=e.amp)&&void 0!==a?a:void 0,owner:null!==(n=e.owner)&&void 0!==n?n:void 0,factory:null!==(o=e.factory)&&void 0!==o?o:void 0,symbol:null!==(i=e.symbol)&&void 0!==i?i:void 0,tokens:(e.tokens||[]).map(Dr),tokensList:e.tokensList,tokenAddresses:(e.tokens||[]).map((e=>e.address)),totalLiquidity:e.totalLiquidity,totalShares:e.totalShares,totalSwapFee:e.totalSwapFee,totalSwapVolume:e.totalSwapVolume,priceRateProviders:null!==(s=e.priceRateProviders)&&void 0!==s?s:void 0,createTime:e.createTime,mainIndex:null!==(r=e.mainIndex)&&void 0!==r?r:void 0,wrappedIndex:null!==(p=e.wrappedIndex)&&void 0!==p?p:void 0,totalWeight:e.totalWeight||"1",lowerTarget:null!==(d=e.lowerTarget)&&void 0!==d?d:"0",upperTarget:null!==(l=e.upperTarget)&&void 0!==l?l:"0",isInRecoveryMode:null!==(u=e.isInRecoveryMode)&&void 0!==u&&u,isPaused:null!==(c=e.isPaused)&&void 0!==c&&c}},Dr=e=>{const t=Lr(e.token);return{...e,isExemptFromYieldProtocolFee:e.isExemptFromYieldProtocolFee||!1,token:t}},Lr=e=>{let t=null;return e.pool&&(t={id:e.pool.id,address:e.pool.address,totalShares:e.pool.totalShares,poolType:e.pool.poolType,mainIndex:e.pool.mainIndex||0},(null==e?void 0:e.pool.tokens)&&(t.tokens=e.pool.tokens.map(Ur))),{pool:t,latestUSDPrice:e.latestUSDPrice||void 0}},Ur=e=>({address:e.address,decimals:e.decimals,symbol:e.symbol,balance:e.balance,priceRate:e.priceRate,weight:e.weight,isExemptFromYieldProtocolFee:e.isExemptFromYieldProtocolFee||void 0,token:e.token?Lr(e.token):void 0});class Vr{constructor(e){var t,a;this.skip=0,this.client=xi(e.url),this.blockHeight=e.blockHeight,this.chainId=e.chainId;const n={orderBy:yo.TotalLiquidity,orderDirection:so.Desc,where:{totalShares:{gt:1e-12}}},o=Object.assign({},(null===(t=e.query)||void 0===t?void 0:t.args)||n),i=Object.assign({},(null===(a=e.query)||void 0===a?void 0:a.attrs)||{});this.query={args:o,attrs:i}}async fetchAllPools(){const e=X.getInstance();e.time("fetching pools"),this.blockHeight&&(this.query.args.block={number:await this.blockHeight()});const t=new nt(this.query.args).format(new at),{pool0:a,pool1000:n,pool2000:o}=await this.client.AllPools(t);return e.timeEnd("fetching pools"),[...a,...n,...o].map((e=>Nr(e,this.chainId)))}async fetch(e){const t=X.getInstance();t.time("fetching pools"),(null==e?void 0:e.skip)&&(this.query.args.skip=e.skip),this.blockHeight&&(this.query.args.block={number:await this.blockHeight()}),this.query.args.first=(null==e?void 0:e.first)||this.query.args.first||1e3;const a=new nt(this.query.args).format(new at),{pools:n}=await this.client.Pools(a);return this.skip=((null==e?void 0:e.skip)||0)+n.length,t.timeEnd("fetching pools"),n.map((e=>Nr(e,this.chainId)))}async find(e){return await this.findBy("id",e)}async findBy(e,t){return this.pools||(this.pools=this.fetchAllPools()),(await this.pools).find((a=>a[e]==t))}async all(){return this.pools||(this.pools=this.fetchAllPools()),this.pools}async block(){return this.blockHeight?{number:await this.blockHeight()}:void 0}async where(e){return this.pools||(this.pools=this.fetchAllPools()),(await this.pools).filter(e)}}var Gr,qr,Wr;async function $r(e,t,n,o){if(0===e.length)return e;const i=Object.values(Object.fromEntries([...da.abi,...ra.abi,...ua.abi,...ia.abi,...St.abi,...zt.abi,...wt.abi,...Ia.abi,...Ut.abi].map((e=>[e.name,e])))),s=ta.connect(t,o),r=new os(s,i),p=Object.values(exports.PoolType),d=[];e.forEach((e=>{if(p.includes(e.poolType)&&"Managed"!==e.poolType)switch(d.push(e),r.call(`${e.id}.poolTokens`,n,"getPoolTokens",[e.id]),r.call(`${e.id}.totalSupply`,e.address,"totalSupply"),e.poolType){case"LiquidityBootstrapping":case"Investment":case"Weighted":r.call(`${e.id}.swapFee`,e.address,"getSwapFeePercentage"),r.call(`${e.id}.weights`,e.address,"getNormalizedWeights");break;case"StablePhantom":r.call(`${e.id}.virtualSupply`,e.address,"getVirtualSupply"),r.call(`${e.id}.amp`,e.address,"getAmplificationParameter"),r.call(`${e.id}.swapFee`,e.address,"getSwapFeePercentage");break;case"MetaStable":case"Stable":r.call(`${e.id}.amp`,e.address,"getAmplificationParameter"),r.call(`${e.id}.swapFee`,e.address,"getSwapFeePercentage");break;case"ComposableStable":r.call(`${e.id}.actualSupply`,e.address,"getActualSupply"),r.call(`${e.id}.amp`,e.address,"getAmplificationParameter"),r.call(`${e.id}.swapFee`,e.address,"getSwapFeePercentage");break;case"Element":r.call(`${e.id}.swapFee`,e.address,"percentFee");break;case"FX":r.call(`${e.id}.swapFee`,e.address,"protocolPercentFee");break;case"Gyro2":case"Gyro3":r.call(`${e.id}.poolTokens`,n,"getPoolTokens",[e.id]),r.call(`${e.id}.totalSupply`,e.address,"totalSupply"),r.call(`${e.id}.swapFee`,e.address,"getSwapFeePercentage");break;case"GyroE":r.call(`${e.id}.swapFee`,e.address,"getSwapFeePercentage"),e.poolTypeVersion&&2===e.poolTypeVersion&&r.call(`${e.id}.tokenRates`,e.address,"getTokenRates");break;default:e.poolType.toString().includes("Linear")&&(r.call(`${e.id}.virtualSupply`,e.address,"getVirtualSupply"),r.call(`${e.id}.swapFee`,e.address,"getSwapFeePercentage"),r.call(`${e.id}.targets`,e.address,"getTargets"),"AaveLinear"===e.poolType&&1===e.poolTypeVersion&&r.call(`${e.id}.rate`,e.address,"getWrappedTokenRate"))}else{X.getInstance().warn(`Unknown pool type: ${e.poolType} ${e.id}`)}}));let l={};try{l=await r.execute()}catch(e){throw new Error("Issue with multicall execution.")}const u=[];return Object.entries(l).forEach((([e,t],n)=>{try{const{poolTokens:o,swapFee:i,weights:s,totalSupply:r,virtualSupply:p,actualSupply:l,tokenRates:c}=t;if("Stable"===d[n].poolType||"MetaStable"===d[n].poolType||"StablePhantom"===d[n].poolType||"ComposableStable"===d[n].poolType){if(!t.amp)return void console.error(`Stable Pool Missing Amp: ${e}`);d[n].amp=a.formatFixed(t.amp[0],3)}if(d[n].poolType.includes("Linear")){if(!t.targets)return void console.error(`Linear Pool Missing Targets: ${e}`);if(d[n].lowerTarget=a.formatFixed(t.targets[0],18),d[n].upperTarget=a.formatFixed(t.targets[1],18),"AaveLinear"===d[n].poolType&&1===d[n].poolTypeVersion){const o=d[n].wrappedIndex;if(void 0===o||void 0===t.rate)return void console.error(`Linear Pool Missing WrappedIndex or PriceRate: ${e}`);d[n].tokens[o].priceRate=a.formatFixed(t.rate,18)}}if(d[n].swapFee=a.formatFixed(i,18),o.tokens.forEach(((t,i)=>{const r=d[n].tokens.find((e=>Je(e.address,t)));if(!r)throw`Pool Missing Expected Token: ${e} ${t}`;r.balance=a.formatFixed(o.balances[i],r.decimals),s&&(r.weight=a.formatFixed(s[i],18))})),d[n].poolType.includes("Linear")||"StablePhantom"===d[n].poolType){if(void 0===p){return void X.getInstance().warn(`Pool with pre-minted BPT missing Virtual Supply: ${e}`)}d[n].totalShares=a.formatFixed(p,18)}else if("ComposableStable"===d[n].poolType){if(void 0===l){return void X.getInstance().warn(`ComposableStable missing Actual Supply: ${e}`)}d[n].totalShares=a.formatFixed(l,18)}else d[n].totalShares=a.formatFixed(r,18);if("GyroE"===d[n].poolType&&2==d[n].poolTypeVersion){if(!Array.isArray(c)||2!==c.length)return void console.error(`GyroEV2 pool with missing or invalid tokenRates: ${e}`);d[n].tokenRates=c.map((e=>a.formatFixed(e,18)))}u.push(d[n])}catch(e){throw new Error(`Issue with pool onchain data: ${e}`)}})),u}!function(e){e[e.SWAP_FEE_PERCENTAGE=0]="SWAP_FEE_PERCENTAGE",e[e.PERCENT_FEE=1]="PERCENT_FEE"}(Gr||(Gr={})),function(e){e[e.TOTAL_SUPPLY=0]="TOTAL_SUPPLY",e[e.VIRTUAL_SUPPLY=1]="VIRTUAL_SUPPLY",e[e.ACTUAL_SUPPLY=2]="ACTUAL_SUPPLY"}(qr||(qr={}));class Hr{constructor(e,t,a){this.poolsSubgraph=e,this.poolsToIgnore=a,this.skip=0,this.provider=t.provider,this.multicall=t.multicall,this.vault=t.vault}filterPools(e){return e.filter((e=>{if(!1===e.swapEnabled)return!1;if(!this.poolsToIgnore)return!0;return-1===this.poolsToIgnore.findIndex((t=>Je(t,e.address)))}))}async fetchDefault(){const e=await this.poolsSubgraph.all(),t=this.filterPools(e),a=X.getInstance();a.time(`fetching onchain ${t.length} pools`);const n=await $r(t,this.multicall,this.vault,this.provider);return a.timeEnd(`fetching onchain ${t.length} pools`),n}async fetch(e){const t=await this.poolsSubgraph.fetch(e),a=this.filterPools(t),n=X.getInstance();n.time(`fetching onchain ${a.length} pools`);const o=await $r(a,this.multicall,this.vault,this.provider);return n.timeEnd(`fetching onchain ${a.length} pools`),o}async find(e,t=!1){return await this.findBy("id",e,t)}async findBy(e,t,a=!1){return this.pools&&!a||(this.pools=this.fetchDefault()),(await this.pools).find((a=>a[e]==t))}async all(){return this.pools||(this.pools=this.fetchDefault()),this.pools}async where(e){return this.pools||(this.pools=this.fetchDefault()),(await this.pools).filter(e)}async refresh(e){const t=await $r([e],this.multicall,this.vault,this.provider);if(this.pools){const a=(await this.pools).findIndex((t=>t.address===e.address));-1!==a&&(this.pools=Promise.resolve([...(await this.pools).splice(a,1),t[0]]))}return t[0]}}class Kr extends Sr{async query(e){!e.block&&this.blockHeight&&(e.block={number:await this.blockHeight()});const{pools:t}=await this.client.PoolGauges(e);return t.map(this.mapType)}mapType(e){return e}}exports.PoolJoinExitAttributes=void 0,(Wr=exports.PoolJoinExitAttributes||(exports.PoolJoinExitAttributes={})).Pool="pool",Wr.Sender="sender";class Jr extends vr{async query(e){e.orderBy||(e.orderBy=ao.Timestamp),e.orderDirection||(e.orderDirection=so.Asc),!e.block&&this.blockHeight&&(e.block={number:await this.blockHeight()});const{joinExits:t}=await this.client.JoinExits(e);return t.map(this.mapType)}mapType(e){return{id:e.id,userAddress:e.user.id,poolId:e.pool.id,timestamp:e.timestamp,type:e.type,amounts:e.amounts,tokens:e.pool.tokensList}}async findByUser(e,t,a){return this.findAllBy(exports.PoolJoinExitAttributes.Sender,e,t,a)}async findJoins(e,t){return this.query({where:{sender:e,pool:t,type:"Join"}})}async findExits(e,t){return this.query({where:{sender:e,pool:t,type:"Exit"}})}async findByPool(e,t,a){return this.findAllBy(exports.PoolJoinExitAttributes.Pool,e,t,a)}}class Xr extends vr{async query(e){e.orderBy||(e.orderBy=lo.Balance),e.orderDirection||(e.orderDirection=so.Desc),!e.block&&this.blockHeight&&(e.block={number:await this.blockHeight()});const{poolShares:t}=await this.client.PoolShares(e);return t.map(this.mapType)}mapType(e){return{id:e.id,userAddress:e.userAddress.id,poolId:e.poolId.id,balance:e.balance}}async findByUser(e,t,a){return this.findAllBy(exports.PoolShareAttributes.UserAddress,e,t,a)}async findByPool(e,t,a){return this.findAllBy(exports.PoolShareAttributes.PoolId,e,t,a)}}class Yr{constructor(e){this.tokens=e}async find(e){return this.tokens.find((t=>t.address.toLowerCase()===e.toLowerCase()))}async findBy(e,t){return this.tokens.find((a=>a[e]===t))}}class jr{constructor(e,t=1){this.chainId=t,this.prices={},this.baseTokenAddresses=e.map(Ne),this.urlBase=`https://api.coingecko.com/api/v3/simple/token_price/${this.platform(t)}?vs_currencies=usd,eth`,this.debouncer=new Ve(this.fetch.bind(this),200)}fetch(e,{signal:t}={}){return e.length,P.default.get(this.url(e),{signal:t}).then((({data:e})=>e)).catch((e=>{var t;const a=["Error fetching token prices from coingecko"];return e.isAxiosError?(null===(t=e.response)||void 0===t?void 0:t.status)&&a.push(`with status ${e.response.status}`):a.push(e),Promise.reject(a.join(" "))})).finally((()=>{e.length}))}fetchNative({signal:e}={}){let t;!function(e){e.ETH="ethereum",e.MATIC="matic-network",e.XDAI="xdai"}(t||(t={}));let a=t.ETH;return 137===this.chainId&&(a=t.MATIC),100===this.chainId&&(a=t.XDAI),P.default.get(`https://api.coingecko.com/api/v3/simple/price/?vs_currencies=eth,usd&ids=${a}`,{signal:e}).then((({data:e})=>e[a])).catch((e=>{var t;const a=["Error fetching native token from coingecko"];return e.isAxiosError?(null===(t=e.response)||void 0===t?void 0:t.status)&&a.push(`with status ${e.response.status}`):a.push(e),Promise.reject(a.join(" "))})).finally((()=>{}))}find(e){const t=Ne(e,this.chainId);if(!this.prices[t]){if(0===Object.keys(this.prices).length)for(const e of this.baseTokenAddresses)this.prices[e]=this.debouncer.fetch(e).then((t=>t[e]));if(t===Te(this.chainId).Addresses.nativeAsset.toLowerCase())return this.nativePrice||(this.prices[t]=this.fetchNative()),this.prices[t];this.prices[t]=this.debouncer.fetch(t).then((e=>e[t]))}return this.prices[t]}async findBy(e,t){if("address"==e)return this.find(t)}platform(e){switch(e){case 1:case 5:case 42:case 31337:return"ethereum";case 100:return"xdai";case 137:return"polygon-pos";case 250:return"fantom";case 1101:return"polygon-zkevm";case 42161:return"arbitrum-one";case 43114:return"avalanche"}return"2"}url(e){return`${this.urlBase}&contract_addresses=${e.join(",")}`}}class zr{constructor(e=1){this.chainId=e,this.prices={},this.urlBase=`https://api.coingecko.com/api/v3/coins/${this.platform(e)}/contract/%TOKEN_ADDRESS%/market_chart/range?vs_currency=usd`}fetch(e,t,{signal:a}={}){const n=this.urlRange(e,t);return P.default.get(n,{signal:a}).then((({data:e})=>e)).catch((e=>{var t;const a=["Error fetching historical token prices from coingecko"];return e.isAxiosError?(null===(t=e.response)||void 0===t?void 0:t.status)&&a.push(`with status ${e.response.status}`):a.push(e),Promise.reject(a.join(" "))})).finally((()=>{}))}async find(e){throw"Historic price requires point-in-time timestamp, please use findBy(address, timestamp)"}async findBy(e,t){const a=Ne(e,this.chainId);return{usd:`${(await this.fetch(a,t)).prices[0][1]}`}}platform(e){switch(e){case 1:case 5:case 42:case 31337:return"ethereum";case 137:return"polygon-pos";case 42161:return"arbitrum-one";case 100:return"xdai"}return"2"}urlRange(e,t){const a=t-3600,n=t+3600;return`${this.urlBase.replace("%TOKEN_ADDRESS%",e)}&from=${a}&to=${n}`}}class Zr{constructor(e,t=1){this.subgraphUrl=e,this.chainId=t,this.prices={},this.debouncer=new Ve(this.fetch.bind(this),200)}async fetch(e,{signal:t}={}){return e.length,P.default.post(this.subgraphUrl,{variables:{addresses:e},query:"query($addresses: [String!]) {\n            tokens(\n              where: {\n                id_in: $addresses\n              }\n            ) {\n              address\n              latestUSDPrice\n            }\n          }"},{signal:t}).then((e=>e.data.data)).then((({tokens:e})=>Object.fromEntries(e.map((e=>[e.address,{usd:e.latestUSDPrice||void 0}]))))).finally((()=>{e.length}))}async find(e){const t=Ne(e,this.chainId);return this.prices[t]||(this.prices[t]=this.debouncer.fetch(t).then((e=>e[t]))),this.prices[t]}async findBy(e,t){if("address"==e)return this.find(t)}}class Qr{constructor(e,t,a){this.coingeckoRepository=e,this.subgraphRepository=t,this.aaveRates=a}async find(e){let t;try{if(t=await this.coingeckoRepository.find(e),!(null==t?void 0:t.usd))throw new Error("Price not found")}catch(a){X.getInstance().warn(a),t=await this.subgraphRepository.find(e)}const a=await this.aaveRates.getRate(e)||1;return t&&t.usd?{...t,usd:(parseFloat(t.usd)*a).toString()}:t}async findBy(e,t){if("address"===e)return this.find(t);throw`Token price search by ${e} not implemented`}}class ep{constructor(e,t){this.coingeckoRepository=e,this.aaveRates=t}async find(e){return this.findBy(e,Math.floor(Date.now()/1e3))}async findBy(e,t){const a=await this.coingeckoRepository.findBy(e,t),n=await this.aaveRates.getRate(e)||1;return a&&a.usd?{...a,usd:(parseFloat(a.usd)*n).toString()}:a}}const tp=["function claimTokens(address user, address[] tokens) returns (uint256[])","function claimToken(address user, address token) returns (uint256)"],ap=new e.Interface(["function getTokensDistributedInWeek(address token, uint timestamp) view returns (uint)","function claimTokens(address user, address[] tokens) returns (uint256[])","function claimToken(address user, address token) returns (uint256)"]),np=new e.Interface(["function totalSupply() view returns (uint)"]);class op{constructor(e,t,a,n,o,i){this.multicall=e,this.feeDistributorAddress=t,this.balAddress=a,this.veBalAddress=n,this.bbAUsdAddress=o,this.feeDistributor=((e,t)=>new y.Contract(e,tp,t))(t,i)}async fetch(e){const t=this.getPreviousWeek(e),a=[{target:this.feeDistributorAddress,callData:ap.encodeFunctionData("getTokensDistributedInWeek",[n.getAddress(this.balAddress),t])},{target:this.feeDistributorAddress,callData:ap.encodeFunctionData("getTokensDistributedInWeek",[n.getAddress(this.bbAUsdAddress),t])},{target:this.veBalAddress,callData:np.encodeFunctionData("totalSupply",[])}],[,o]=await this.multicall.callStatic.aggregate(a);return{balAmount:parseFloat(Oe(o[0],18)),bbAUsdAmount:parseFloat(Oe(o[1],18)),veBalSupply:parseFloat(Oe(o[2],18)),bbAUsdPrice:parseFloat("1.0"),balAddress:this.balAddress}}async multicallData(e){return this.data||(this.data=await this.fetch(e)),this.data}getPreviousWeek(e){const t=new Date(e);t.setUTCHours(0),t.setUTCMinutes(0),t.setUTCSeconds(0),t.setUTCMilliseconds(0);let a=t.getUTCDay()-4;return a<0&&(a+=7),a+=7,Math.floor(t.getTime()/1e3)-86400*a}async getClaimableBalances(e,t){try{const a=await this.feeDistributor.callStatic.claimTokens(e,t);return this.extractTokenBalance(t,a)}catch(e){return{}}}claimBalances(e,t){return ap.encodeFunctionData("claimTokens",[e,t])}extractTokenBalance(e,t){return e.reduce(((e,n,o)=>{var i;return e[n]=null!==(i=t[o])&&void 0!==i?i:a.BigNumber.from(0),e}),{})}}const ip=new e.Interface(["function getProtocolFeesCollector() view returns (address)"]),sp=new e.Interface(["function getSwapFeePercentage() view returns (uint)"]);let rp;class pp{constructor(e,t){this.provider=t,this.vault=new y.Contract(e,ip,this.provider)}async fetch(){const e=await this.vault.getProtocolFeesCollector(),t=new y.Contract(e,sp,this.provider),a=await t.getSwapFeePercentage();return parseFloat(Oe(a,18))}async find(){return rp||(rp=this.fetch()),this.swapFeePercentage=await rp,this.swapFeePercentage}async findBy(){return this.find()}}const dp=new e.Interface(["function getSwapFeePercentage() view returns (uint)"]);let lp;class up{constructor(e,t){this.multicall=e,this.protocolFeePercentagesProviderAddress=t}async fetch(){const e=[{target:this.protocolFeePercentagesProviderAddress,callData:dp.encodeFunctionData("getFeeTypePercentage",[0])},{target:this.protocolFeePercentagesProviderAddress,callData:dp.encodeFunctionData("getFeeTypePercentage",[2])}],[,t]=await this.multicall.callStatic.aggregate(e);return{swapFee:parseFloat(Oe(t[0],18)),yieldFee:parseFloat(Oe(t[2],18))}}async getFees(){return lp||(lp=this.fetch()),this.protocolFees=await lp,this.protocolFees}}class cp{constructor(e="https://yield-tokens.balancer.workers.dev/"){this.url=e}async fetch(){let e={};try{e=(await P.default.get(this.url)).data}catch(e){X.getInstance().warn(`Failed to fetch yield tokens: ${e}`)}return e}async find(e){const t=e.toLocaleLowerCase();return this.yields||(this.yields=this.fetch()),this.yields.then((e=>e[t]&&e[t]>0?e[t]:0))}async findBy(e,t){return"address"!=e?0:this.find(t)}}const yp=e=>`{\n  blocks(first: 1, orderBy: timestamp, orderDirection: asc, where: { timestamp_gt: ${e} }) {\n    number\n  }\n}`,bp=async(e,t)=>{const a={query:yp(t)},n=await P.default.post(e,a),{data:{blocks:o}}=n.data;return parseInt(o[0].number)};class mp{constructor(e){this.endpoint=e,this.blocks={}}async find(e){if("dayAgo"==e){const e=""+(Math.floor(Date.now()/1e3)-86400);return this.blocks[e]||(this.blocks={...this.blocks,[e]:bp(this.endpoint,e)}),this.blocks[e]}}async findBy(e="",t=""){}}var fp=[{chainId:1,address:"0x8888801af4d980682e47f1a9036e589479e835c5",symbol:"mph"},{chainId:1,address:"0x27054b13b1b798b345b591a4d22e6562d47ea75a",symbol:"ast"},{chainId:1,address:"0x3301ee63fb29f863f2333bd4466acb46cd8323e6",symbol:"akita"},{chainId:1,address:"0x616e8bfa43f920657b3497dbf40d6b1a02d4608d",symbol:"aurabal"},{chainId:1,address:"0xc0c293ce456ff0ed870add98a0828dd4d2903dbf",symbol:"aura"},{chainId:1,address:"0x3472a5a71965499acd81997a54bba8d852c6e53d",symbol:"badger"},{chainId:1,address:"0xba100000625a3754423978a60c9317c58a424e3d",symbol:"bal"},{chainId:1,address:"0x804cdb9116a10bb78768d3252355a1b18067bf8f",symbol:"bb-a-dai"},{chainId:1,address:"0x9210f1204b5a24742eba12f710636d76240df3d0",symbol:"bb-a-usdc"},{chainId:1,address:"0x2bbf681cc4eb09218bee85ea2a5d3d13fa40fc0c",symbol:"bb-a-usdt"},{chainId:1,address:"0x7b50775383d3d6f0215a8f290f2c9e2eebbeceb2",symbol:"bb-a-usd"},{chainId:1,address:"0x2d94aa3e47d9d5024503ca8491fce9a2fb4da198",symbol:"bank"},{chainId:1,address:"0x0d8775f648430679a709e98d2b0cb6250d2887ef",symbol:"bat"},{chainId:1,address:"0xf17e65822b568b3903685a7c9f496cf7656cc6c2",symbol:"bico"},{chainId:1,address:"0x799ebfabe77a6e34311eeee9825190b9ece32824",symbol:"btrst"},{chainId:1,address:"0x514910771af9ca656af840dff83e8264ecf986ca",symbol:"link"},{chainId:1,address:"0x3506424f91fd33084466f402d5d97f05f8e3b4af",symbol:"chz"},{chainId:1,address:"0x41e5560054824ea6b0732e656e3ad64e20e94e45",symbol:"cvc"},{chainId:1,address:"0xc00e94cb662c3520282e6f5717214004a7f26888",symbol:"comp"},{chainId:1,address:"0xdef1ca1fb7fbcdc777520aa7f396b4e015f497ab",symbol:"cow"},{chainId:1,address:"0xd533a949740bb3306d119cc777fa900ba034cd52",symbol:"crv"},{chainId:1,address:"0x6b175474e89094c44da98b954eedeac495271d0f",symbol:"dai"},{chainId:1,address:"0xf2051511b9b121394fa75b8f7d4e7424337af687",symbol:"haus"},{chainId:1,address:"0x888888435fde8e7d4c54cab67f206e4199454c60",symbol:"dfx"},{chainId:1,address:"0x798d1be841a82a273720ce31c822c61a67a601c3",symbol:"digg"},{chainId:1,address:"0xf629cbd94d3791c9250152bd8dfbdf380e2a3b9c",symbol:"enj"},{chainId:1,address:"0xc18360217d8f7ab5e7c516566761ea12ce7f9d72",symbol:"ens"},{chainId:1,address:"0x4e15361fd6b4bb609fa63c81a2be19d873717870",symbol:"ftm"},{chainId:1,address:"0x956f47f50a910163d8bf957cf5846d573e7f87ca",symbol:"fei"},{chainId:1,address:"0xed1480d12be41d92f36f5f7bdd88212e381a3677",symbol:"fdt"},{chainId:1,address:"0x586aa273f262909eef8fa02d90ab65f5015e0516",symbol:"fiat"},{chainId:1,address:"0xde30da39c46104798bb5aa3fe8b9e0e1f348163f",symbol:"gtc"},{chainId:1,address:"0x900db999074d9277c5da2a43f252d74366230da0",symbol:"giv"},{chainId:1,address:"0x6810e776880c02933d47db1b9fc05908e5386b96",symbol:"gno"},{chainId:1,address:"0xba485b556399123261a5f9c95d413b4f93107407",symbol:"graviaura"},{chainId:1,address:"0x3ec8798b81485a254928b70cda1cf0a2bb0b74d7",symbol:"gro"},{chainId:1,address:"0xc011a73ee8576fb46f5e1c5751ca3b9fe0af2a6f",symbol:"snx"},{chainId:1,address:"0x5a98fcbea516cf06857215779fd812ca3bef1b32",symbol:"ldo"},{chainId:1,address:"0x6dea81c8171d0ba574754ef6f8b412f2ed88c54d",symbol:"lqty"},{chainId:1,address:"0x5f98805a4e8be255a32880fdec7f6728c6568ba0",symbol:"lusd"},{chainId:1,address:"0x965d79f1a1016b574a62986e13ca8ab04dfdd15c",symbol:"m2"},{chainId:1,address:"0x9f8f72aa9304c8b593d555f12ef6589cc3a579a2",symbol:"mkr"},{chainId:1,address:"0xd084944d3c05cd115c09d072b9f44ba3e0e45921",symbol:"fold"},{chainId:1,address:"0x7d1afa7b718fb893db30a3abc0cfc608aacfebb0",symbol:"matic"},{chainId:1,address:"0xa3bed4e1c75d00fa6f4e5e6922db7261b5e9acd2",symbol:"mta"},{chainId:1,address:"0x4b13006980acb09645131b91d259eaa111eaf5ba",symbol:"myc"},{chainId:1,address:"0x333a4823466879eef910a04d473505da62142069",symbol:"nation"},{chainId:1,address:"0xcfeaead4947f0705a14ec42ac3d44129e1ef3ed5",symbol:"note"},{chainId:1,address:"0x967da4048cd07ab37855c090aaf366e4ce1b9f48",symbol:"ocean"},{chainId:1,address:"0x64aa3364f17a4d01c6f1751fd97c2bd3d7e7f1d5",symbol:"ohm"},{chainId:1,address:"0xab846fb6c81370327e784ae7cbb6d6a6af6ff4bf",symbol:"pal"},{chainId:1,address:"0xcafe001067cdef266afb7eb5a286dcfd277f3de5",symbol:"psp"},{chainId:1,address:"0x68037790a0229e9ce6eaa8a99ea92964106c4703",symbol:"par"},{chainId:1,address:"0x45804880de22913dafe09f4980848ece6ecbaf78",symbol:"paxg"},{chainId:1,address:"0x89ab32156e46f46d02ade3fecbe5fc4243b9aaed",symbol:"pnt"},{chainId:1,address:"0x9992ec3cf6a55b00978cddf2b27bc6882d88d1ec",symbol:"poly"},{chainId:1,address:"0x43d4a3cd90ddd2f8f4f693170c9c8098163502ad",symbol:"d2d"},{chainId:1,address:"0xeb4c2781e4eba804ce9a9803c67d0893436bb27d",symbol:"renbtc"},{chainId:1,address:"0x408e41876cccdc0f92210600ef50372656052a38",symbol:"ren"},{chainId:1,address:"0xfb5453340c03db5ade474b27e68b6a9c6b2823eb",symbol:"robot"},{chainId:1,address:"0xd33526068d116ce69f19a9ee46f0bd304f21a51f",symbol:"rpl"},{chainId:1,address:"0xae78736cd615f374d3085123a210448e74fc6393",symbol:"reth"},{chainId:1,address:"0xfe18be6b3bd88a2d2a7f928d00292e7a9963cfc6",symbol:"sbtc"},{chainId:1,address:"0x476c5e26a75bd202a9683ffd34359c0cc15be0ff",symbol:"srm"},{chainId:1,address:"0x35e78b3982e87ecfd5b3f3265b601c046cdbe232",symbol:"xai"},{chainId:1,address:"0x3affcca64c2a6f4e3b6bd9c64cd2c969efd1ecbe",symbol:"dsla"},{chainId:1,address:"0xf24d8651578a55b0c119b9910759a351a3458895",symbol:"sdbal"},{chainId:1,address:"0x11c1a6b3ed6bb362954b29d3183cfa97a0c806aa",symbol:"str"},{chainId:1,address:"0x8f693ca8d21b157107184d29d398a8d082b38b76",symbol:"data"},{chainId:1,address:"0x470ebf5f030ed85fc1ed4c2d36b9dd02e77cf1b7",symbol:"temple"},{chainId:1,address:"0xa36fdbbae3c9d55a1d67ee5821d53b50b63a1ab9",symbol:"temp"},{chainId:1,address:"0xdac17f958d2ee523a2206206994597c13d831ec7",symbol:"usdt"},{chainId:1,address:"0x9c4a4204b79dd291d6b6571c5be8bbcd0622f050",symbol:"tcr"},{chainId:1,address:"0x226f7b842e0f0120b7e194d05432b3fd14773a9d",symbol:"unn"},{chainId:1,address:"0x1f9840a85d5af5bf1d1762f925bdaddc4201f984",symbol:"uni"},{chainId:1,address:"0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",symbol:"usdc"},{chainId:1,address:"0x81f8f0bb1cb2a06649e51913a151f0e7ef6fa321",symbol:"vita"},{chainId:1,address:"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2",symbol:"weth"},{chainId:1,address:"0xedb171c18ce90b633db442f2a6f72874093b49ef",symbol:"wampl"},{chainId:1,address:"0x2260fac5e5542a773aa44fbcfedf7c193bc2c599",symbol:"wbtc"},{chainId:1,address:"0xf203ca1769ca8e9e8fe1da9d147db68b6c919817",symbol:"wncg"},{chainId:1,address:"0x7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0",symbol:"wsteth"},{chainId:1,address:"0x79c71d3436f39ce382d0f58f1b011d88100b9d91",symbol:"xns"},{chainId:1,address:"0x0bc529c00c6401aef6d220be8c6ea1667f6ad93e",symbol:"yfi"},{chainId:1,address:"0xbcca60bb61934080951369a648fb03df4f96263c",symbol:"ausdc"},{chainId:1,address:"0x028171bca77440897b824ca71d1c56cac55b68a3",symbol:"adai"},{chainId:1,address:"0x3ed3b47dd13ec9a98b44e6204a523e766b225811",symbol:"ausdt"},{chainId:137,address:"0x9c2c5fd7b07e95ee044ddeba0e97a665f142394f",symbol:"1inch"},{chainId:137,address:"0xd6df932a45c0f255f85145f286ea0b292b21c90b",symbol:"aave"},{chainId:137,address:"0xc3fdbadc7c795ef1d6ba111e06ff8f16a20ea539",symbol:"addy"},{chainId:137,address:"0xf84bd51eab957c2e7b7d646a3427c5a50848281d",symbol:"agar"},{chainId:137,address:"0x033d942a6b495c4071083f4cde1f17e986fe856c",symbol:"aga"},{chainId:137,address:"0x0e9b89007eee9c958c0eda24ef70723c2c93dd58",symbol:"amaticc"},{chainId:137,address:"0x034b2090b579228482520c589dbd397c53fc51cc",symbol:"vision"},{chainId:137,address:"0x2c89bbc92bd86f8075d1decc58c7f4e0107f286b",symbol:"avax"},{chainId:137,address:"0x49690541e3f6e933a9aa3cffee6010a7bb5b72d7",symbol:"axiav3"},{chainId:137,address:"0x9a71012b13ca4d3d0cdc72a177df3ef03b0e76a3",symbol:"bal"},{chainId:137,address:"0xdb7cb471dd0b49b29cab4a1c14d070f27216a0ab",symbol:"bank"},{chainId:137,address:"0xfbdd194376de19a88118e84e279b977f165d01b8",symbol:"bifi"},{chainId:137,address:"0xd6ca869a4ec9ed2c7e618062cdc45306d8dbbc14",symbol:"btc2x-fli-p"},{chainId:137,address:"0x53e0bca35ec356bd5dddfebbd1fc0fd03fabad39",symbol:"link"},{chainId:137,address:"0x172370d5cd63279efa6d502dab29171933a610af",symbol:"crv"},{chainId:137,address:"0x8f3cf7ad23cd3cadbd9735aff958023239c6a063",symbol:"dai"},{chainId:137,address:"0x1d607faa0a51518a7728580c238d912747e71f7a",symbol:"data"},{chainId:137,address:"0x85955046df4668e1dd369d2de9f3aeb98dd2a369",symbol:"dpi"},{chainId:137,address:"0xe7804d91dfcde7f776c90043e03eaa6df87e6395",symbol:"dfx"},{chainId:137,address:"0xf28164a485b0b2c90639e47b0f377b4a438a16b1",symbol:"dquick"},{chainId:137,address:"0x45c32fa6df82ead1e2ef74d17b76547eddfaff89",symbol:"frax"},{chainId:137,address:"0x50b728d8d964fd00c2d0aad81718b71311fef68a",symbol:"snx"},{chainId:137,address:"0x72928d5436ff65e57f72d5566dcd3baedc649a88",symbol:"hdao"},{chainId:137,address:"0x3ad707da309f3845cd602059901e39c4dcd66473",symbol:"eth2x-fli-p"},{chainId:137,address:"0x4f025829c4b13df652f38abd2ab901185ff1e609",symbol:"ieth-fli-p"},{chainId:137,address:"0x340f412860da7b7823df372a2b59ff78b7ae6abc",symbol:"imatic-fli-p"},{chainId:137,address:"0xf287d97b6345bad3d88856b26fb7c0ab3f2c7976",symbol:"matic2x-fli-p"},{chainId:137,address:"0x130ce4e4f76c2265f94a961d70618562de0bb8d2",symbol:"ibtc-fli-p"},{chainId:137,address:"0x596ebe76e2db4470966ea395b0d063ac6197a8c5",symbol:"jrt"},{chainId:137,address:"0x3a58a54c066fdc0f2d55fc9c89f0415c92ebf3c4",symbol:"stmatic"},{chainId:137,address:"0xf501dd45a1198c2e1b5aef5314a68b9006d842e0",symbol:"mta"},{chainId:137,address:"0xeaecc18198a475c921b24b8a6c1c1f0f5f3f7ea0",symbol:"seed"},{chainId:137,address:"0xfe712251173a2cd5f5be2b46bb528328ea3565e1",symbol:"mvi"},{chainId:137,address:"0xa3fa99a148fa48d14ed51d610c367c61876997f1",symbol:"mimatic"},{chainId:137,address:"0xa486c6bc102f409180ccb8a94ba045d39f8fc7cb",symbol:"nex"},{chainId:137,address:"0xe2aa7db6da1dae97c5f5c6914d285fbfcc32a128",symbol:"par"},{chainId:137,address:"0x580a84c73811e1839f75d86d75d88cca0c241ff4",symbol:"qi"},{chainId:137,address:"0x831753dd7087cac61ab5644b308642cc1c33dc13",symbol:"quick"},{chainId:137,address:"0xb5c064f955d8e7f38fe0460c556a72987494ee17",symbol:"quick"},{chainId:137,address:"0x00e5646f60ac6fb446f621d146b6e1886f002905",symbol:"rai"},{chainId:137,address:"0x431cd3c9ac9fc73644bf68bf5691f4b83f9e104f",symbol:"rbw"},{chainId:137,address:"0xdbf31df14b66535af65aac99c32e9ea844e14501",symbol:"renbtc"},{chainId:137,address:"0x501ace9c35e60f03a2af4d484f49f9b1efde9f40",symbol:"solace"},{chainId:137,address:"0xfa68fb4628dff1028cfec22b4162fccd0d45efb6",symbol:"maticx"},{chainId:137,address:"0x0b3f868e0be5597d5db7feb59e1cadbb0fdda50a",symbol:"sushi"},{chainId:137,address:"0xdf7837de1f2fa4631d716cf2502f8b230f1dcc32",symbol:"tel"},{chainId:137,address:"0xe6469ba6d2fd6130788e0ea9c0a0515900563b59",symbol:"ust"},{chainId:137,address:"0xc2132d05d31c914a87c6611c10748aeb04b58e8f",symbol:"usdt"},{chainId:137,address:"0x5fe2b58c013d7601147dcdd68c143a77499f5531",symbol:"grt"},{chainId:137,address:"0xbbba073c31bf03b8acf7c28ef0738decf3695683",symbol:"sand"},{chainId:137,address:"0x2934b36ca9a4b31e633c5be670c8c8b28b6aa015",symbol:"thx"},{chainId:137,address:"0x2f800db0fdb5223b3c3f354886d907a671414a7f",symbol:"bct"},{chainId:137,address:"0x2e1ad108ff1d8c782fcbbb89aad783ac49586756",symbol:"tusd"},{chainId:137,address:"0x3809dcdd5dde24b37abe64a5a339784c3323c44f",symbol:"swap"},{chainId:137,address:"0x7fbc10850cae055b27039af31bd258430e714c62",symbol:"ubt"},{chainId:137,address:"0x2791bca1f2de4661ed88a30c99a7a9449aa84174",symbol:"usdc"},{chainId:137,address:"0x7ceb23fd6bc0add59e62ac25578270cff1b9f619",symbol:"weth"},{chainId:137,address:"0x0d500b1d8e8ef31e21c99d1db9a6444d3adf1270",symbol:"wmatic"},{chainId:137,address:"0x1bfd67037b42cf73acf2047067bd4f2c47d9bfd6",symbol:"wbtc"},{chainId:137,address:"0x24834bbec7e39ef42f4a75eaf8e5b6486d3f0e57",symbol:"lunc"},{chainId:137,address:"0xf153eff70dc0bf3b085134928daeea248d9b30d0",symbol:"xmark"},{chainId:42161,address:"0x9f20de1fc9b161b34089cbeae888168b44b03461",symbol:"arbis"},{chainId:42161,address:"0x040d1edc9569d4bab2d15287dc5a4f10f56a56b8",symbol:"bal"},{chainId:42161,address:"0x031d35296154279dc1984dcd93e392b1f946737b",symbol:"cap"},{chainId:42161,address:"0xf97f4df75117a78c1a5a0dbb814af92458539fb4",symbol:"link"},{chainId:42161,address:"0x354a6da3fcde098f8389cad84b0182725c6c91de",symbol:"comp"},{chainId:42161,address:"0xf4d48ce3ee1ac3651998971541badbb9a14d7234",symbol:"cream"},{chainId:42161,address:"0x11cdb42b0eb46d95f990bedd4695a6e3fa034978",symbol:"crv"},{chainId:42161,address:"0xda10009cbd5d07dd0cecc66161fc93d7c9000da1",symbol:"dai"},{chainId:42161,address:"0x8038f3c971414fd1fc220ba727f2d4a0fc98cb65",symbol:"dht"},{chainId:42161,address:"0xf0b5ceefc89684889e5f7e0a7775bd100fcd3709",symbol:"dusd"},{chainId:42161,address:"0x6c2c06790b3e3e3c38e12ee22f8183b37a13ee55",symbol:"dpx"},{chainId:42161,address:"0x32eb7902d4134bf98a28b963d26de779af92a212",symbol:"rdpx"},{chainId:42161,address:"0xc3ae0333f0f34aa734d5493276223d95b8f9cb37",symbol:"dxd"},{chainId:42161,address:"0xfc5a1a6eb076a2c7ad06ed22c90d7e710e35ad0a",symbol:"gmx"},{chainId:42161,address:"0xa0b862f60edef4452f25b4160f177db44deb6cf1",symbol:"gno"},{chainId:42161,address:"0xb965029343d55189c25a7f3e0c9394dc0f5d41b1",symbol:"ndx"},{chainId:42161,address:"0x539bde0d7dbd336b79148aa742883198bbf60342",symbol:"magic"},{chainId:42161,address:"0x4e352cf164e64adcbad318c3a1e222e9eba4ce42",symbol:"mcb"},{chainId:42161,address:"0x3f56e0c36d275367b8c502090edf38289b3dea0d",symbol:"mimatic"},{chainId:42161,address:"0x965772e0e9c84b6f359c8597c891108dcf1c5b1a",symbol:"pickle"},{chainId:42161,address:"0x6694340fc020c5e6b96567843da2df01b2ce1eb6",symbol:"stg"},{chainId:42161,address:"0xd4d42f0b6def4ce0383636770ef773390d85c61a",symbol:"sushi"},{chainId:42161,address:"0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9",symbol:"usdt"},{chainId:42161,address:"0x23a941036ae778ac51ab04cea08ed6e2fe103614",symbol:"grt"},{chainId:42161,address:"0xa72159fc390f0e3c6d415e658264c7c4051e9b87",symbol:"tcr"},{chainId:42161,address:"0x4d15a3a2286d883af0aa1b3f21367843fac63e07",symbol:"tusd"},{chainId:42161,address:"0xfa7f8980b0f1e64a2062791cc3b0871572f1f7f0",symbol:"uni"},{chainId:42161,address:"0xff970a61a04b1ca14834a43f5de4533ebddb5cc8",symbol:"usdc"},{chainId:42161,address:"0xa684cd057951541187f288294a1e1c2646aa2d24",symbol:"vsta"},{chainId:42161,address:"0x64343594ab9b56e99087bfa6f2335db24c2d1f17",symbol:"vst"},{chainId:42161,address:"0x82af49447d8a07e3bd95bd0d56f35241523fbab1",symbol:"weth"},{chainId:42161,address:"0x2f2a2543b76a4166549f7aab2e75bef0aefc5b0f",symbol:"wbtc"},{chainId:42161,address:"0x82e3a8f066a6989666b031d916c43672085b1582",symbol:"yfi"}];class Tp{constructor(e,t,a,n){if(this.pools=new Vr({url:e.urls.subgraph,chainId:e.chainId,query:n}),this.poolsForSimulations=new Ci(xi(e.urls.subgraph),t,e,void 0,n),this.poolsOnChain=new Hr(this.pools,{provider:t,multicall:e.addresses.contracts.multicall,vault:e.addresses.contracts.vault},e.poolsToIgnore),this.poolShares=new Xr(e.urls.subgraph,e.chainId),this.poolJoinExits=new Jr(e.urls.subgraph,e.chainId),e.urls.gaugesSubgraph&&(this.poolGauges=new Kr(e.urls.gaugesSubgraph,e.chainId),this.gaugeShares=new Ar(e.urls.gaugesSubgraph,e.chainId)),e.urls.blockNumberSubgraph){this.blockNumbers=new mp(e.urls.blockNumberSubgraph);const t=async()=>{if(this.blockNumbers)return await this.blockNumbers.find("dayAgo")};this.yesterdaysPools=new Vr({url:e.urls.subgraph,chainId:e.chainId,blockHeight:t,query:n})}else if(e.averageBlockTime){const a=async()=>await t.getBlockNumber()-Math.round(86400/(e.averageBlockTime||2));this.yesterdaysPools=new Vr({url:e.urls.subgraph,chainId:e.chainId,blockHeight:a,query:n})}const o=fp.filter((t=>t.chainId==e.chainId)).map((e=>e.address)),i=new jr(o,e.chainId),s=new Zr(e.urls.subgraph,e.chainId),r=new Re(a.contracts.multicall,e.chainId);this.tokenPrices=new Qr(i,s,r);const p=new zr(e.chainId);this.tokenHistoricalPrices=new ep(p,r),this.tokenMeta=new Yr([]),e.urls.gaugesSubgraph&&(this.liquidityGauges=new Mr(e.urls.gaugesSubgraph,a.contracts.multicall,e.addresses.contracts.gaugeController||"",e.chainId,e.addresses.contracts.gaugeControllerCheckpointer)),e.addresses.contracts.feeDistributor&&e.addresses.tokens.bal&&e.addresses.tokens.veBal&&e.addresses.tokens.bbaUsd&&(this.feeDistributor=new op(a.contracts.multicall,e.addresses.contracts.feeDistributor,e.addresses.tokens.bal,e.addresses.tokens.veBal,e.addresses.tokens.bbaUsd,t)),this.feeCollector=new pp(e.addresses.contracts.vault,t),e.addresses.contracts.protocolFeePercentagesProvider&&(this.protocolFees=new up(a.contracts.multicall,e.addresses.contracts.protocolFeePercentagesProvider)),this.tokenYields=new cp,e.addresses.contracts.gyroConfigProxy&&(this.gyroConfigRepository=new xr(e.addresses.contracts.gyroConfigProxy,a.contracts.multicall,t))}}const hp=(e,t)=>"Stable"===e?exports.PoolKind.LEGACY_STABLE:"ComposableStable"===e&&1===t?exports.PoolKind.COMPOSABLE_STABLE:"ComposableStable"===e?exports.PoolKind.COMPOSABLE_STABLE_V2:exports.PoolKind.WEIGHTED,Ip=es.encodeSetRelayerApproval,gp=es.encodeGaugeWithdraw,xp=es.encodeGaugeDeposit,_p=es.encodePeekChainedReferenceValue,wp=It.createInterface(),Pp=(e,t)=>{var a;return(null===(a=e.poolType)||void 0===a?void 0:a.match(/.*Linear.*/))?Ep(e,t):[]},Ep=(e,t)=>{if(!(e.id&&t.id&&e.tokens&&t.tokens&&e.mainIndex&&t.mainIndex))throw"Missing tokens";const a=e.tokens[e.mainIndex];return[{poolId:e.id,assetIn:e.address,assetOut:a.address},{poolId:t.id,assetIn:a.address,assetOut:t.address}]},vp=async(e,t)=>{const a=await t.find(e);if(!a)throw`Pool ${e} not found`;const n=async(e,a)=>{let o=[{address:e}];const i=await t.findBy("address",e);if(i&&e!=a){const t=i.tokens.sort(Sp),a=await Promise.all(t.map((({address:e})=>n(e,i.address))));o=[{address:e,id:i.id,poolType:i.poolType,poolTypeVersion:i.poolTypeVersion,mainIndex:i.mainIndex,tokens:a.flat()}]}return o},o=a.tokens.sort(Sp);return{id:e,address:a.address,tokens:(await Promise.all(o.map((({address:e})=>n(e,a.address))))).flat(),poolType:a.poolType,poolTypeVersion:a.poolTypeVersion,mainIndex:a.mainIndex}},Sp=(e,t)=>e.address.toLowerCase()>t.address.toLowerCase()?1:-1,Ap=(e,n,o,i,s,r,p=!1,d,l,u)=>{if(!(s.id&&r.id&&s.tokens&&r.tokens&&s.poolType&&r.poolType))throw"Pool data is missing";const c=s.tokens.flatMap((({address:e})=>e)),y=r.tokens.flatMap((({address:e})=>e)),b="ComposableStable"==s.poolType&&1==s.poolTypeVersion?0:-1;let m,f=[];b>-1?(m=[{index:b,key:es.toChainedReference(`10${b}`)}],f=[es.toChainedReference(`20${b}`)]):(m=c.map(((e,t)=>({index:t,key:es.toChainedReference(`10${t}`)}))),f=c.map(((e,t)=>es.toChainedReference(`20${t}`))));const T=es.toChainedReference("999"),h=[];let I=!1;"ComposableStable"===s.poolType&&(I=!0),u&&h.push(Ip(n,!0,u)),d&&h.push(gp(d,e,n,o)),h.push(((e,t,a,n,o=-1,i,s,r,p,d=!0)=>{let l;const u="ComposableStable"===t&&1===a;l=o>-1?v.exitExactBPTInForOneTokenOut(s,o):(u?C.exitExactBPTInForAllTokensOut:v.exitExactBPTInForTokensOut)(s);const c=hp(t,a);return es.encodeExitPool({poolId:e,poolKind:c,sender:r,recipient:p,outputReferences:i,exitPoolRequest:{assets:n,minAmountsOut:new Array(n.length).fill("0"),userData:l,toInternalBalance:d}})})(s.id,s.poolType,s.poolTypeVersion||1,c,b,m,o,d?n:e,n));const g=((e,t,a)=>{const n=({tokens:e,mainIndex:t})=>e&&t&&e[t].address||"",o=e.flatMap(n),i=t.flatMap(n),s=o.map(((e,t)=>e&&[t,i.indexOf(e)]||[-1,-1])).map((([a,n])=>{if(-1===a||-1===n)return[];const o=e[a],i=t[n];return Pp(o,i)}));return a>-1?[s[a]]:s})(s.tokens,r.tokens,b);if(g.flat().length>0){const e=g.map(((e,t)=>({path:e,inputAmount:String(m[t].key),outputReference:f[t]}))).filter((({path:e})=>e.length>0));h.push(((e,n,o,i,s=!0)=>{const r=[],p=[],d=[],l=[];o.forEach((e=>{const{path:a,inputAmount:n,outputReference:o}=e;for(let e=0;e<a.length;e++){const{poolId:o,assetIn:i,assetOut:s}=a[e];r.push(i),r.push(s),p.push(t.MaxInt256.toString()),p.push("0");const d={poolId:o,assetInIndex:2*e,assetOutIndex:2*e+1,amount:0===e?n:"0",userData:"0x"};l.push(d)}d.push({index:2*a.length-1,key:o})}));const u={sender:e,recipient:n,fromInternalBalance:!0,toInternalBalance:s};return es.encodeBatchSwap({swapType:exports.SwapType.SwapExactIn,swaps:l,assets:r,funds:u,limits:p,deadline:i||a.BigNumber.from(Math.ceil(Date.now()/1e3)+3600),value:"0",outputReferences:d})})(n,n,e))}const x=y.filter((e=>r.address!=e)).map((e=>{var t;const a=c.indexOf(e);return String(I&&f[a]||(null===(t=m[a])||void 0===t?void 0:t.key)||0)}));h.push(((e,a,n,o,i,s,r,p,d,l=!0)=>{const u=o.map((()=>t.MaxInt256)),c=v.joinExactTokensInForBPTOut(i,s),y=hp(a,n);return es.encodeJoinPool({poolId:e,kind:y,sender:p,recipient:d,joinPoolRequest:{assets:o,maxAmountsIn:u,userData:c,fromInternalBalance:l},value:"0",outputReference:r})})(r.id,r.poolType,r.poolTypeVersion||1,y,x,i,String(T),n,l?n:e,!0)),!0===p&&h.push(_p(String(T))),l&&h.push(xp(l,n,e,String(T)));return wp.encodeFunctionData("multicall",[h])};class kp{constructor({relayerAddress:e,poolsRepository:t,gaugesRepository:a,provider:n}){this.getExpectedBptOut=kp.getExpectedBptOut,this.relayerAddress=e,this.poolsRepository=t,this.gaugesRepository=a,this.provider=n}async pool2pool({user:e,from:t,to:a,balance:n,minBptOut:o="0",authorisation:i}){const s=await vp(t,this.poolsRepository),r=await vp(a,this.poolsRepository),p=Ap(e,this.relayerAddress,String(n),o,s,r,"0"==o,void 0,void 0,i);return{to:this.relayerAddress,data:p}}async pool2poolWithGauges({user:e,from:t,to:a,balance:n,minBptOut:o="0",authorisation:i}){const s=await this.gaugesRepository.findBy("poolId",t),r=await this.gaugesRepository.findBy("poolId",a);if(!(s&&s.poolId&&r&&r.poolId))throw new Error("Gauge not found");const p=await vp(s.poolId,this.poolsRepository),d=await vp(r.poolId,this.poolsRepository),l=Ap(e,this.relayerAddress,String(n),o,p,d,"0"==o,s.id,r.id,i);return{to:this.relayerAddress,data:l}}async gauge2gauge({user:e,from:t,to:a,balance:n,authorisation:o}){const i=[gp(t,e,this.relayerAddress,n),xp(a,this.relayerAddress,e,n)];o&&i.unshift(Ip(this.relayerAddress,!0,o));const s=wp.encodeFunctionData("multicall",[i]);return{to:this.relayerAddress,data:s}}}kp.getExpectedBptOut=e=>{const t=wp.decodeFunctionResult("multicall",e)[0].slice(-2).filter((e=>"0x"!==e));return String(BigInt(t))};var Op,Cp;!function(e){e[e.Direct=0]="Direct",e[e.TokenIn=1]="TokenIn",e[e.TokenOut=2]="TokenOut",e[e.Middle=3]="Middle"}(Op||(Op={})),function(e){e[e.BatchSwap=0]="BatchSwap",e[e.Join=1]="Join",e[e.Exit=2]="Exit"}(Cp||(Cp={}));class Bp{constructor(e,t,a,n,o,i,s,r,p,d){const l=this.getActionStep(e,t,a,n);this.amountIn=this.getActionAmount(o,Cp.BatchSwap,l,s),this.hasTokenIn=this.actionHasTokenIn(l),this.hasTokenOut=this.actionHasTokenOut(l);const u=this.hasTokenOut?i:"0";this.minOut=this.getActionMinOut(u,r);const[c,y]=this.getActionOutputRef(l,n,s);this.nextOpRefKey=y,this.opRefStart=c,this.sender=this.getSender(this.hasTokenIn,p,d),this.receiver=this.getReceiver(this.hasTokenOut,p,d)}getActionAmount(e,t,a,n){let o=e;return(a===Op.TokenOut||a===Op.Middle&&t===Cp.Join||a===Op.Middle&&t===Cp.Exit)&&(o=es.toChainedReference(n-1).toString()),o}getActionOutputRef(e,t,a){let n={};return e!==Op.TokenIn&&e!==Op.Middle||(n=this.getOutputRef(a,t),a++),[n,a]}getActionMinOut(e,t){return He(a.BigNumber.from(e),a.BigNumber.from(t)).toString()}getActionStep(e,t,a,n){let o;return o=a===e&&n===t?Op.Direct:a===e?Op.TokenIn:n===t?Op.TokenOut:Op.Middle,o}getOutputRef(e,t){return{index:t,key:es.toChainedReference(e)}}getFromInternal(e,t){return!e&&!t}getToInternal(e,t){return!e&&!t}actionHasTokenIn(e){return e===Op.Direct||e===Op.TokenIn}actionHasTokenOut(e){return e===Op.Direct||e===Op.TokenOut}getSender(e,t,a){return e?t:a}getReceiver(e,t,a){return e?t:a}getPoolKind(e){let t=0;return["MetaStable","Stable","StablePhantom"].includes(e)?t=1:"ComposableStable"===e&&(t=3),t}}class Mp extends Bp{constructor(e,t,a,n,o,i,s,r){var p;super(t,a,e.assetInIndex,e.assetOutIndex,e.amount,null!==(p=e.returnAmount)&&void 0!==p?p:"0",n,i,s,r),this.opRefKey=n,this.type=Cp.Exit,this.poolId=e.poolId,this.tokenOut=o[e.assetOutIndex],this.toInternalBalance=this.getToInternal(this.hasTokenOut),this.opRef=this.opRefStart}callData(e,t){const a=e.tokensList,n=new j(t),[o]=n.sortTokens(a),i=this.tokenOut,s=o.findIndex((e=>e.toLowerCase()===i.toLowerCase())),r=Array(a.length).fill("0");r[s]=this.minOut;const p=this.amountIn,d={assets:o,minAmountsOut:r,userData:S.exitExactBPTInForOneTokenOut(p,s),toInternalBalance:this.toInternalBalance,poolId:this.poolId,poolKind:this.getPoolKind(e.poolType),sender:this.sender,recipient:this.receiver,outputReferences:this.opRef.key?[this.opRef]:[],exitPoolRequest:{}},l=es.formatExitPoolInput(d);return{params:d,encoded:es.encodeExitPool(l)}}getAmountIn(){return this.hasTokenIn?this.amountIn:"0"}getAmountOut(){return this.hasTokenOut?this.minOut:"0"}}class Fp extends Bp{constructor(e,t,a,n,o,i,s,r){var p;super(t,a,e.assetInIndex,e.assetOutIndex,e.amount,null!==(p=e.returnAmount)&&void 0!==p?p:"0",n,i,s,r),this.opRefKey=n,this.type=Cp.Join,this.poolId=e.poolId,this.tokenIn=o[e.assetInIndex],this.fromInternal=this.getFromInternal(this.hasTokenIn),this.opRef=this.opRefStart}callData(e,t){const a=e.tokensList,n=new j(t),[o]=n.sortTokens(a),i=this.tokenIn,s=o.findIndex((e=>e.toLowerCase()===i.toLowerCase())),r=Array(a.length).fill("0");r[s]=this.amountIn;const p=this.minOut,d=S.joinExactTokensInForBPTOut(r,p),l={poolId:this.poolId,sender:this.sender,recipient:this.receiver,kind:this.getPoolKind(e.poolType),joinPoolRequest:{assets:o,maxAmountsIn:r,userData:d,fromInternalBalance:this.fromInternal},value:"0",outputReference:this.opRef.key?this.opRef.key.toString():"0"};return{params:l,encoded:es.encodeJoinPool(l)}}getAmountIn(){return this.hasTokenIn?this.amountIn:"0"}getAmountOut(){return this.hasTokenOut?this.minOut:"0"}}class Rp extends Bp{constructor(e,t,a,n,o,i,s,r,p){var d;super(t,a,e.assetInIndex,e.assetOutIndex,e.amount,null!==(d=e.returnAmount)&&void 0!==d?d:"0",n,i,r,p),this.mainTokenInIndex=t,this.mainTokenOutIndex=a,this.opRefKey=n,this.assets=o,this.slippage=i,this.pools=s,this.user=r,this.relayer=p,this.approveTokens=[],this.opRef=[],this.type=Cp.BatchSwap,this.swaps=[{...e,amount:this.amountIn}];const l=this.isBpt(s,o[e.assetInIndex]);l&&this.approveTokens.push(o[e.assetInIndex]),this.fromInternal=this.getFromInternal(this.hasTokenIn,l);const u=this.isBpt(s,o[e.assetOutIndex]);this.toInternal=this.getToInternal(this.hasTokenOut,u),this.limits=this.getLimits(o,e.assetInIndex,e.assetOutIndex,e.amount,this.hasTokenIn,this.hasTokenOut,this.minOut),this.opRefStart.index&&this.opRef.push(this.opRefStart)}getLimits(e,n,o,i,s,r,p){const d=e.map((()=>a.BigNumber.from(0)));return d[n]=s?a.BigNumber.from(i):t.MaxInt256,r&&(d[o]=a.BigNumber.from(p).mul(-1)),d}updateLimits(e,t){t.hasTokenIn&&(e[t.swaps[0].assetInIndex]=e[t.swaps[0].assetInIndex].add(t.amountIn)),t.hasTokenOut&&(e[t.swaps[0].assetOutIndex]=e[t.swaps[0].assetOutIndex].sub(t.minOut))}isChainedSwap(e){return this.opRef[this.swaps.length-1]&&this.toInternal===e.fromInternal&&this.receiver===e.sender&&this.opRef[this.swaps.length-1].key.toString()===e.amountIn}canAddSwap(e){return!!this.isChainedSwap(e)||e.fromInternal===this.fromInternal&&e.toInternal===this.toInternal&&e.receiver===this.receiver&&e.sender===this.sender}callData(){const e=[];for(const a of this.approveTokens){const n=es.encodeApproveVault(a,t.MaxUint256.toString());e.push(n)}const n={sender:this.sender,recipient:this.receiver,fromInternalBalance:this.fromInternal,toInternalBalance:this.toInternal},o={swapType:exports.SwapType.SwapExactIn,swaps:this.swaps,assets:this.assets,funds:n,limits:this.limits.map((e=>e.toString())),deadline:a.BigNumber.from(Math.ceil(Date.now()/1e3)+3600),value:"0",outputReferences:this.opRef},i=es.encodeBatchSwap(o);return e.push(i),{params:o,encoded:e}}getAmountIn(){return this.limits[this.mainTokenInIndex].toString()}getAmountOut(){return this.limits[this.mainTokenOutIndex].abs().toString()}copy(){return new Rp(this.swaps[0],this.mainTokenInIndex,this.mainTokenOutIndex,this.opRefKey,this.assets,this.slippage,this.pools,this.user,this.relayer)}addSwap(e){const t=this.isChainedSwap(e);this.swaps.push(e.swaps[0]),this.approveTokens=[...new Set([...this.approveTokens,...e.approveTokens])],this.toInternal=e.toInternal,this.receiver=e.receiver,this.hasTokenOut=e.hasTokenOut,this.minOut=e.minOut,this.opRef=[...this.opRef,...e.opRef],t||(this.amountIn=a.BigNumber.from(this.amountIn).add(e.amountIn).toString()),this.updateLimits(this.limits,e)}isBpt(e,t){return e.some((e=>e.address.toLowerCase()===t.toLowerCase()))}}function Np(e){const t=function(e){const t=[],a=[],n=[];for(const o of e)o.type===Cp.Exit||o.type===Cp.Join?o.hasTokenIn?t.push(o):o.hasTokenOut?a.push(o):n.push(o):n.push(o);return[...t,...n,...a]}(e);return function(e){const t=[];let a;for(const n of e)n.type===Cp.BatchSwap?a?a.canAddSwap(n)?a.addSwap(n):(t.push(a),a=n.copy()):a=n.copy():(a&&(t.push(a),a=void 0),t.push(n));return a&&t.push(a),t}(t)}const Dp=new e.Interface([{inputs:[{internalType:"contract IVault",name:"vault",type:"address"},{internalType:"address",name:"libraryAddress",type:"address"}],stateMutability:"nonpayable",type:"constructor"},{inputs:[],name:"getLibrary",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[],name:"getVault",outputs:[{internalType:"contract IVault",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes[]",name:"data",type:"bytes[]"}],name:"multicall",outputs:[{internalType:"bytes[]",name:"results",type:"bytes[]"}],stateMutability:"payable",type:"function"},{stateMutability:"payable",type:"receive"}]);function Lp(e){X.getInstance()}function Up(e,t,a){if("Weighted"!==a)return!1;const n=t[e.assetOutIndex],o=R(e.poolId);return n.toLowerCase()===o.toLowerCase()}function Vp(e,t,a){if("Weighted"!==a)return!1;const n=t[e.assetInIndex],o=R(e.poolId);return n.toLowerCase()===o.toLowerCase()}Object.defineProperty(exports,"PoolFilter",{enumerable:!0,get:function(){return p.PoolFilter}}),Object.defineProperty(exports,"SOR",{enumerable:!0,get:function(){return p.SOR}}),Object.defineProperty(exports,"SwapTypes",{enumerable:!0,get:function(){return p.SwapTypes}}),Object.defineProperty(exports,"stableBPTForTokensZeroPriceImpact",{enumerable:!0,get:function(){return p.stableBPTForTokensZeroPriceImpact}}),Object.defineProperty(exports,"weightedBPTForTokensZeroPriceImpact",{enumerable:!0,get:function(){return p.weightedBPTForTokensZeroPriceImpact}}),exports.AMP_PRECISION=3,exports.APR_THRESHOLD=1e4,exports.AaveLinearPoolFactory__factory=rt,exports.AaveLinearPool__factory=it,exports.AaveRates=Re,exports.AaveWrapping__factory=dt,exports.AssetHelpers=j,exports.Authoriser__factory=ut,exports.BALANCER_NETWORK_CONFIG=ka,exports.BalancerAPIArgsFormatter=tt,exports.BalancerError=Ba,exports.BalancerErrors=Z,exports.BalancerHelpers__factory=yt,exports.BalancerMinterAuthorization=ae,exports.BalancerMinter__factory=mt,exports.BalancerPoolDataQueries__factory=Tt,exports.BalancerRelayer__factory=It,exports.BalancerSDK=class{constructor(e,t=new Ni(e),a=new ts(e)){this.config=e,this.sor=t,this.subgraph=a;X.getInstance().setLoggingEnabled(!!e.enableLogging),this.networkConfig=Fi(e),this.provider=t.provider,this.balancerContracts=new ps(this.networkConfig.addresses.contracts,t.provider),this.data=new Tp(this.networkConfig,t.provider,this.balancerContracts,e.subgraphQuery),this.swaps=new zi(this.config),this.relayer=new es,this.pricing=new as(e,this.swaps),this.pools=new er(this.networkConfig,this.data,this.balancerContracts),this.data.liquidityGauges&&(this.claimService=new Fn(this.data.liquidityGauges,this.data.feeDistributor,this.networkConfig.chainId,this.contracts.multicall,this.networkConfig.addresses.contracts.gaugeClaimHelper,this.networkConfig.addresses.contracts.balancerMinter),this.migrationService=new kp({relayerAddress:this.networkConfig.addresses.contracts.balancerRelayer,poolsRepository:this.data.pools,gaugesRepository:this.data.liquidityGauges.subgraph,provider:this.provider})),this.vaultModel=new Fs(this.data.poolsForSimulations,this.networkConfig.addresses.tokens.wrappedNativeAsset)}get contracts(){return this.balancerContracts.contracts}},exports.BasePoolEncoder=E,exports.BatchRelayerLibrary__factory=xt,exports.BlockNumberRepository=mp,exports.CoingeckoHistoricalPriceRepository=zr,exports.CoingeckoPriceRepository=jr,exports.ComposableStablePoolEncoder=C,exports.ComposableStablePoolFactory__factory=Et,exports.ComposableStablePool__factory=wt,exports.ConvergentCurvePool__factory=St,exports.Data=Tp,exports.Debouncer=Ve,exports.ERC20__factory=kt,exports.ERC4626LinearPoolFactory__factory=Mt,exports.ERC4626LinearPool__factory=Ct,exports.EulerLinearPoolFactory__factory=Dt,exports.EulerLinearPool__factory=Rt,exports.FXPool__factory=Ut,exports.FeeCollectorRepository=pp,exports.FeeDistributorRepository=op,exports.GaugeClaimHelper__factory=Gt,exports.GaugeControllerMulticallRepository=Pr,exports.GaugeSharesRepository=Ar,exports.GearboxLinearPoolFactory__factory=Ht,exports.GearboxLinearPool__factory=Wt,exports.GraphQLArgsBuilder=nt,exports.GyroConfig__factory=Jt,exports.GyroEV2__factory=Ia,exports.HistoricalPriceProvider=ep,exports.LidoRelayer__factory=Yt,exports.LinearPool__factory=zt,exports.Liquidity=vn,exports.LiquidityGaugeSubgraphRPCProvider=Mr,exports.LiquidityGaugeV5__factory=Qt,exports.LiquidityGaugesMulticallRepository=Cr,exports.LiquidityGaugesSubgraphRepository=Br,exports.ManagedPoolEncoder=A,exports.Migrations=kp,exports.Multicall3__factory=na,exports.Multicall__factory=ta,exports.POOLS=function(e){return V[e]?V[e]:U},exports.PoolGaugesRepository=Kr,exports.PoolJoinExitRepository=Jr,exports.PoolSharesRepository=Xr,exports.Pools=er,exports.PoolsBalancerAPIRepository=class{constructor(e){var t,a;this.pools=[],this.skip=0,this.hasFetched=!1,this.isFetching=!1,this.client=new Fr(e.url,e.apiKey);this.query={args:Object.assign({},(null===(t=e.query)||void 0===t?void 0:t.args)||{chainId:1,orderBy:"totalLiquidity",orderDirection:"desc",where:{swapEnabled:{eq:!0},totalShares:{gt:.05}}}),attrs:Object.assign({},(null===(a=e.query)||void 0===a?void 0:a.attrs)||{id:!0,address:!0})},delete this.query.args.skip}fetchFromCache(e,t){return this.pools.slice(t,e+t)}async fetch(e){const t=(null==e?void 0:e.first)||10,a=(null==e?void 0:e.skip)||0;return this.hasFetched||this.fetchAll(e),await this.awaitEnoughPoolsFetched(t,a),this.fetchFromCache(t,a)}async fetchAll(e){this.isFetching=!0,this.hasFetched=!0,this.nextToken&&(this.query.args.nextToken=this.nextToken),this.query.args.first=1e3;const t=new nt(this.query.args).format(new tt),a=this.query.attrs;a.nextToken=!0;const n={pools:{__args:t,...a}},o=(await this.client.get(n)).pools;if(this.nextToken=o.nextToken,this.pools=this.pools.concat(o.pools.map(this.format)),this.nextToken)return await this.fetchAll(e);this.isFetching=!1}async awaitEnoughPoolsFetched(e,t){for(let a=0;a<1e3;a++){if(this.pools.length>e+t)return;if(!this.isFetching)return;await Rr(10)}}async find(e){return 0==this.pools.length&&await this.fetch(),this.findBy("id",e)}async findBy(e,t){0==this.pools.length&&await this.fetch();const a=this.pools.find((a=>a[e]==t));if(a)return this.format(a)}format(e){var t,a,n,o;if(null===(t=e.apr)||void 0===t?void 0:t.rewardAprs.breakdown){const t=JSON.parse(null===(a=e.apr)||void 0===a?void 0:a.rewardAprs.breakdown);e.apr.rewardAprs.breakdown=t}if(null===(n=e.apr)||void 0===n?void 0:n.tokenAprs.breakdown){const t=JSON.parse(null===(o=e.apr)||void 0===o?void 0:o.tokenAprs.breakdown);e.apr.tokenAprs.breakdown=t}return e}},exports.PoolsFallbackRepository=class{constructor(e,t={}){this.providers=e,this.currentProviderIdx=0,this.timeout=t.timeout||1e4}async fetch(e){return this.fallbackQuery("fetch",[e])}get currentProvider(){if(this.providers.length&&!(this.currentProviderIdx>=this.providers.length))return this.providers[this.currentProviderIdx]}async find(e){return this.fallbackQuery("find",[e])}async findBy(e,t){return this.fallbackQuery("findBy",[e,t])}async fallbackQuery(e,t){if(this.currentProviderIdx>=this.providers.length)throw new Error("No working providers found");let a;try{const n=this.providers[this.currentProviderIdx];a=await Promise.race([n[e].apply(n,t),new Promise(((e,t)=>setTimeout((()=>t(new Error("timeout"))),this.timeout)))])}catch(n){const o=n.message;if("timeout"===o){X.getInstance().warn("Provider "+this.currentProviderIdx+" timed out, falling back to next provider")}else{const e=X.getInstance();e.warn(`Provider ${this.currentProviderIdx} failed with error, falling back to next provider.`),e.warn(o)}this.currentProviderIdx++,a=await this.fallbackQuery.call(this,e,t)}return a}},exports.PoolsStaticRepository=class{constructor(e){this.pools=e}async find(e){return this.pools.find((t=>t.id.toLowerCase()===e.toLowerCase()))}async findBy(e,t){return this.pools.find((a=>a[e]===t))}async all(){return this.pools}async where(e){return(await this.all()).filter(e)}},exports.PoolsSubgraphOnChainRepository=Hr,exports.PoolsSubgraphRepository=Vr,exports.ProtocolFeesProvider=up,exports.Relayer=es,exports.RelayerAuthorization=te,exports.SHALLOW_COMPOSABLE_STABLE_BUFFER=1e6,exports.Sor=Ni,exports.StablePoolEncoder=v,exports.StablePool__factory=ia,exports.StaticATokenRateProvider__factory=ra,exports.StaticTokenPriceProvider=class{constructor(e){this.tokenPrices=Object.fromEntries(Object.entries(e).map((([e,t])=>[e.toLowerCase(),t])))}async find(e){const t=e.toLowerCase(),a=this.tokenPrices[t];if(a)return a}async findBy(e,t){if("address"==e)return this.find(t)}},exports.StaticTokenProvider=Yr,exports.Subgraph=ts,exports.SubgraphArgsFormatter=at,exports.SubgraphPriceRepository=Zr,exports.Swaps=zi,exports.TokenPriceProvider=Qr,exports.TokenYieldsRepository=cp,exports.Vault__factory=da,exports.VeBal__factory=xa,exports.VeDelegationProxy__factory=wa,exports.WeightedPoolEncoder=S,exports.WeightedPoolFactory__factory=ya,exports.WeightedPool__factory=ua,exports.YearnLinearPoolFactory__factory=Ta,exports.YearnLinearPool__factory=ma,exports.accountToAddress=Q,exports.addSlippage=Ke,exports.addressMapIn=De,exports.balEmissions=fs,exports.bn=e=>a.parseFixed(`${e}`,18),exports.buildRelayerCalls=function(e,t,n,o,i,s,r){const p=function(e,t,a,n,o,i,s,r){var p;const d=n.findIndex((t=>t.toLowerCase()===e.toLowerCase())),l=n.findIndex((e=>e.toLowerCase()===t.toLowerCase())),u=[];let c=0;for(const e of a){const t=null===(p=i.find((t=>t.id===e.poolId)))||void 0===p?void 0:p.poolType;if(Up(e,n,t)){const t=new Fp(e,d,l,c,n,o,s,r);c=t.nextOpRefKey,u.push(t)}else{if(!Vp(e,n,t)){const t=new Rp(e,d,l,c,n,o,i,s,r);c=t.nextOpRefKey,u.push(t);continue}{const t=new Mp(e,d,l,c,n,o,s,r);c=t.nextOpRefKey,u.push(t)}}}return u}(e.tokenIn,e.tokenOut,e.swaps,e.tokenAddresses,s,t,n,o),d=Np(p),l=[],u=[];r&&l.push(es.encodeSetRelayerApproval(o,!0,r));for(const e of d){if(e.type===Cp.Exit||e.type===Cp.Join){const a=t.find((t=>t.id===e.poolId));if(void 0===a)throw new Ba(exports.BalancerErrorCode.NO_POOL_DATA);const{params:n,encoded:o}=e.callData(a,i);l.push(o),u.push(n)}if(e.type===Cp.BatchSwap){const{params:t,encoded:a}=e.callData();l.push(...a),u.push(t)}}return function(e,t,n,o){const i=e.reduce(((e=a.BigNumber.from(0),t)=>e.add(t))),s=t.reduce(((e=a.BigNumber.from(0),t)=>e.add(t)));Lp(i.toString()),Lp(n.swapAmount.toString()),Lp(s.toString()),Lp(He(n.returnAmount,a.BigNumber.from(o)).toString()),Lp(n.returnAmount.toString());const r=s.sub(He(n.returnAmount,a.BigNumber.from(o)));if(!i.eq(n.swapAmount)||!r.lt("3"))throw new Ba(exports.BalancerErrorCode.RELAY_SWAP_AMOUNTS)}(d.map((e=>a.BigNumber.from(e.getAmountIn()))),d.map((e=>a.BigNumber.from(e.getAmountOut()))),e,s),{to:o,data:Dp.encodeFunctionData("multicall",[l]),rawCalls:l,inputs:u}},exports.canUseJoinExit=function(e,a,n){return e!==p.SwapTypes.SwapExactOut&&a.toLowerCase()!==t.AddressZero.toLowerCase()&&n.toLowerCase()!==t.AddressZero.toLowerCase()},exports.factories=Ea,exports.fetchOnChainPoolData=ki,exports.findEventInReceiptLogs=Qe,exports.formatFixed=qe,exports.formatFromBigInt18=function(e){return a.formatFixed(a.BigNumber.from(e),18)},exports.getEthValue=Ue,exports.getLimitsForSlippage=va,exports.getOnChainBalances=Oi,exports.getPoolAddress=R,exports.getPoolNonce=D,exports.getPoolSpecialization=N,exports.getRandomBytes32=et,exports.insert=Xe,exports.isLinearish=Ze,exports.isNormalizedWeights=e=>{const a=e.reduce(((e,t)=>e.add(t)),t.Zero);return a.eq(t.WeiPerEther)},exports.isSameAddress=Je,exports.mulSlippage=$e,exports.parseFixed=Ge,exports.parsePoolInfo=be,exports.parseToBigInt18=function(e){return Ge(e,18).toBigInt()},exports.removeItem=je,exports.reorderArrays=ze,exports.replace=Ye,exports.signPermit=async(e,n,i,s,r=t.MaxUint256,p)=>{const{chainId:d}=await e.provider.getNetwork(),l=await n.getAddress();p||(p=await e.nonces(l));const u={name:await e.name(),version:"1",chainId:d,verifyingContract:e.address},c={owner:l,spender:await Q(i),value:s,nonce:p,deadline:r},y=await n._signTypedData(u,{Permit:[{name:"owner",type:"address"},{name:"spender",type:"address"},{name:"value",type:"uint256"},{name:"nonce",type:"uint256"},{name:"deadline",type:"uint256"}]},c);return{...o.splitSignature(y),deadline:a.BigNumber.from(r),nonce:a.BigNumber.from(p)}},exports.someJoinExit=function(e,t,a){return t.some((t=>function(e,t,a){const n=e.find((e=>e.id===t.poolId));return"Weighted"===(null==n?void 0:n.poolType)&&[a[t.assetInIndex],a[t.assetOutIndex]].includes(n.address)}(e,t,a)))},exports.splitPoolId=e=>({address:R(e),specialization:N(e),nonce:D(e)}),exports.subSlippage=He,exports.toNormalizedWeights=function(e){if(100==e.length)return Array(100).fill(t.WeiPerEther.div(100));const a=e.reduce(((e,t)=>e.add(t)),t.Zero);if(a.eq(t.WeiPerEther))return e;const n=[];let o=t.Zero;for(let i=0;i<e.length;i++)i<e.length-1?(n[i]=e[i].mul(t.WeiPerEther).div(a),o=o.add(n[i])):n[i]=t.WeiPerEther.sub(o);return n},exports.tokenAddressForPricing=Ne,exports.tokensToTokenPrices=function(e){const t={};return e.forEach((e=>{e.price&&(t[e.address]=e.price)})),t},exports.truncateAddresses=function(e){return e.map((e=>`${e.slice(0,6)}...${e.slice(38,42)}`))},exports.unwrapToken=Le,exports.wrappedTokensMap=Me,exports.yieldTokens=Be;
+    `,gi=(e,t,a)=>e();function xi(e){return jo(new l.GraphQLClient(e))}function _i(e){return function(e,t=gi){return{GaugeShare:(a,n)=>t((t=>e.request(mi,a,{...n,...t})),"GaugeShare","query"),GaugeShares:(a,n)=>t((t=>e.request(fi,a,{...n,...t})),"GaugeShares","query"),LiquidityGauges:(a,n)=>t((t=>e.request(Ti,a,{...n,...t})),"LiquidityGauges","query"),Pools:(a,n)=>t((t=>e.request(hi,a,{...n,...t})),"Pools","query"),PoolGauges:(a,n)=>t((t=>e.request(Ii,a,{...n,...t})),"PoolGauges","query")}}(new l.GraphQLClient(e))}class wi{constructor(t,a,n={}){this.options=n,this.calls=[],this.paths=[],this.address="0xcA11bde05977b3631167028862bE2a173976CA11",this.interface=new e.Interface(t),this.multicall=na.connect(this.address,a)}call(e,t,a,n){return this.calls.push([t,a,n]),this.paths.push(e),this}async execute(e={},t=1024){const a=e;return(await this.executeMulticall(t)).forEach(((e,t)=>s.set(a,this.paths[t],e.length>1?e:e[0]))),this.calls=[],this.paths=[],a}async executeMulticall(e){const t=Math.ceil(this.calls.length/e),a=[],n=[];for(let a=0;a<t;a++){const t=this.calls.slice(a*e,(a+1)*e).map((([e,t,a])=>({target:e,allowFailure:!0,callData:this.interface.encodeFunctionData(t,a)})));n.push(this.multicall.callStatic.aggregate3(t,this.options))}return(await Promise.all(n)).forEach(((t,n)=>{const o=n*e;for(let e=0;e<t.length;e++){const n=o+e,{success:i,returnData:s}=t[e];if(i)try{const e=this.interface.decodeFunctionResult(this.calls[n][1],s);a[n]=e}catch(e){console.error("Multicall error",this.paths[n]),a[n]=[]}else console.error("Failed request in multicall",this.paths[n]),a[n]=[]}})),a}}const Pi=["function getSwapFeePercentage() view returns (uint256)","function percentFee() view returns (uint256)","function protocolPercentFee() view returns (uint256)","function getNormalizedWeights() view returns (uint256[])","function totalSupply() view returns (uint256)","function getVirtualSupply() view returns (uint256)","function getActualSupply() view returns (uint256)","function getTargets() view returns (uint256 lowerTarget, uint256 upperTarget)","function getTokenRates() view returns (uint256, uint256)","function getWrappedTokenRate() view returns (uint256)","function getAmplificationParameter() view returns (uint256 value, bool isUpdating, uint256 precision)","function getPausedState() view returns (bool)","function inRecoveryMode() view returns (bool)","function getRate() view returns (uint256)","function getScalingFactors() view returns (uint256[] memory)","function getPoolTokens(bytes32) view returns (address[], uint256[])"],Ei=(e,t,a)=>{a.call(`${e}.weights`,t,"getNormalizedWeights")},vi=(e,t,a)=>{a.call(`${e}.targets`,t,"getTargets"),a.call(`${e}.wrappedTokenRate`,t,"getWrappedTokenRate")},Si=(e,t,a)=>{a.call(`${e}.amp`,t,"getAmplificationParameter")},Ai=(e,t,a)=>{a.call(`${e}.tokenRates`,t,"getTokenRates")},ki=async(e,t,a)=>{if(0===e.length)return{};const n=new wi(Pi,a);e.forEach((({id:e,address:a,poolType:o,poolTypeVersion:i})=>{((e,t,a,n,o)=>{o.call(`${e}.poolTokens`,a,"getPoolTokens",[e]),o.call(`${e}.totalShares`,t,(e=>e.includes("Linear")||["StablePhantom"].includes(e)?"getVirtualSupply":"ComposableStable"===e?"getActualSupply":"totalSupply")(n)),o.call(`${e}.swapFee`,t,(e=>"Element"===e?"percentFee":"FX"===e?"protocolPercentFee":"getSwapFeePercentage")(n))})(e,a,t,o,n),((e,t=1)=>{const a=()=>({});switch(e){case"Weighted":case"LiquidityBootstrapping":case"Investment":return Ei;case"Stable":case"StablePhantom":case"MetaStable":case"ComposableStable":return Si;case"GyroE":return 2===t?Ai:a;case"AaveLinear":return 1===t?vi:a;default:return a}})(o,i)(e,a,n)}));return await n.execute({},128)};async function Oi(e,t,n,o){if(0===e.length)return e;const i=[],s=await ki(e,n,o);return e.forEach((e=>{const t=s[e.id];i.push(((e,t)=>({...e,tokens:e.tokens.map((n=>{const o=t.poolTokens[0].map((e=>e.toLowerCase())).indexOf(n.address),i=e.wrappedIndex&&e.tokensList[e.wrappedIndex];return{...n,balance:a.formatFixed(t.poolTokens[1][o],n.decimals||18),weight:t.weights&&a.formatFixed(t.weights[o],18)||n.weight,priceRate:t.wrappedTokenRate&&i&&i.toLowerCase()===n.address.toLowerCase()&&a.formatFixed(t.wrappedTokenRate,18)||n.priceRate}})),totalShares:t.totalShares?a.formatFixed(t.totalShares,18):e.totalShares,swapFee:a.formatFixed(t.swapFee,18),amp:t.amp&&t.amp[0]&&a.formatFixed(t.amp[0],String(t.amp[2]).length-1)||e.amp,lowerTarget:t.targets&&a.formatFixed(t.targets[0],18)||e.lowerTarget,upperTarget:t.targets&&a.formatFixed(t.targets[1],18)||e.upperTarget,tokenRates:t.tokenRates&&t.tokenRates.map((e=>a.formatFixed(e,18)))||e.tokenRates}))(e,t))})),i}class Ci{constructor(e,t,a,n,o){this.client=e,this.provider=t,this.network=a,this.sorConfig=n,this.defaultArgs=(null==o?void 0:o.args)||{orderBy:yo.TotalLiquidity,orderDirection:so.Desc,where:{swapEnabled:{eq:!0},totalShares:{gt:1e-12}}}}async getPools(e){const t=function(e){return e.map((e=>({...e,poolType:e.poolType||"",tokens:(e.tokens||[]).map((e=>({...e,weight:e.weight||null}))),totalWeight:e.totalWeight||void 0,amp:e.amp||void 0,expiryTime:e.expiryTime?s.parseInt(e.expiryTime):void 0,unitSeconds:e.unitSeconds?s.parseInt(e.unitSeconds):void 0,principalToken:e.principalToken||void 0,baseToken:e.baseToken||void 0})))}((await this.getSubgraphPools(e)).filter((e=>{if(!this.network.poolsToIgnore)return!0;return-1===this.network.poolsToIgnore.findIndex((t=>Je(t,e.address)))})));if(this.sorConfig&&!1===this.sorConfig.fetchOnChainBalances)return t;const a=X.getInstance();a.time(`fetching on-chain balances for ${t.length} pools`);const n=await Oi(t,this.network.addresses.contracts.multicall,this.network.addresses.contracts.vault,this.provider);return a.timeEnd(`fetching on-chain balances for ${t.length} pools`),n}async getSubgraphPools(e){const t=new nt(e||this.defaultArgs).format(new at);if(t.first){const{pools:e}=await this.client.Pools(t);return e}const{pool0:a,pool1000:n,pool2000:o}=await this.client.AllPools(t);return[...a,...n,...o]}}class Bi{constructor(e){this.chainId=e}async getNativeAssetPriceInToken(e){const t=await this.getTokenPriceInNativeAsset(e);return""+1/parseFloat(t)}async getTokenPriceInNativeAsset(e){const t=`https://api.coingecko.com/api/v3/simple/token_price/${this.platformId}?contract_addresses=${e}&vs_currencies=${this.nativeAssetId}`,{data:a}=await P.default.get(t,{headers:{Accept:"application/json","Content-Type":"application/json"}});if(void 0===a[e.toLowerCase()]||void 0===a[e.toLowerCase()][this.nativeAssetId])throw Error("No price returned from Coingecko");return a[e.toLowerCase()][this.nativeAssetId]}get platformId(){return ka[this.chainId].thirdParty.coingecko.platformId||"2"}get nativeAssetId(){return ka[this.chainId].thirdParty.coingecko.nativeAssetId||""}}class Mi{constructor(e,t){this.client=e,this.weth=t.toLowerCase()}async getNativeAssetPriceInToken(e){const t=await this.getLatestPriceInEthFromSubgraph(e);if(!t)throw Error("No price found in the subgraph");return""+1/t}async getLatestPriceInEthFromSubgraph(e){e=e.toLowerCase();const{latestPrices:t}=await this.client.TokenLatestPrices({where:{asset_in:[e,this.weth]}}),a=s.keyBy(t,"id");if(a[`${e}-${this.weth}`])return parseFloat(a[`${e}-${this.weth}`].price);const n=t.filter((t=>t.asset===e));for(const e of n){const t=a[`${e.pricingAsset}-${this.weth}`];if(t)return parseFloat(e.price)*parseFloat(t.price)}return null}}function Fi(e){var t,a;if("number"==typeof e.network){const a=ka[e.network];return{...a,urls:{...a.urls,subgraph:null!==(t=e.customSubgraphUrl)&&void 0!==t?t:a.urls.subgraph},tenderly:e.tenderly}}return{...e.network,urls:{...e.network.urls,subgraph:null!==(a=e.customSubgraphUrl)&&void 0!==a?a:e.network.urls.subgraph},tenderly:e.network.tenderly}}const Ri=["0x00c2a4be503869fa751c2dbcb7156cc970b5a8da000000000000000000000477","0x02d928e68d8f10c0358566152677db51e1e2dc8c00000000000000000000051e","0x04248aabca09e9a1a3d5129a7ba05b7f17de768400000000000000000000050e","0x05513ca725b6ce035ca2641075474eb469f05f4c00020000000000000000041f","0x0a0fb4ff697de5ac5b6770cd8ee1b72af80b57cf000000000000000000000496","0x0afbd58beca09545e4fb67772faf3858e610bcd00000000000000000000004b9","0x0d05aac44ac7dd3c7ba5d50be93eb884a057d23400000000000000000000051c","0x11839d635e2f0270da37e8ef4324d4d5d54329570002000000000000000004d8","0x126e7643235ec0ab9c103c507642dc3f4ca23c66000000000000000000000468","0x133d241f225750d2c92948e464a5a80111920331000000000000000000000476","0x159cb00338fb63f263fd6f621df619cef71da9540000000000000000000004d5","0x173063a30e095313eee39411f07e95a8a806014e0002000000000000000003ab","0x1bd2f176a812e312077bca87e37c08432bb09f3e0000000000000000000005a1","0x20b156776114e8a801e9767d90c6ccccc8adf398000000000000000000000499","0x246ffb4d928e394a02e45761fecdba6c2e79b8eb000000000000000000000541","0x25accb7943fd73dda5e23ba6329085a3c24bfb6a000200000000000000000387","0x26c2b83fc8535deead276f5cc3ad9c1a2192e02700020000000000000000056b","0x2b218683178d029bab6c9789b1073aa6c96e517600000000000000000000058c","0x2ba7aa2213fa2c909cd9e46fed5a0059542b36b00000000000000000000003a3","0x2bbf681cc4eb09218bee85ea2a5d3d13fa40fc0c0000000000000000000000fd","0x2e52c64fd319e380cdbcfc4577ea1fda558a32e40002000000000000000005ba","0x2f4eb100552ef93840d5adc30560e5513dfffacb000000000000000000000334","0x2ff1a9dbdacd55297452cfd8a4d94724bc22a5f7000000000000000000000484","0x3035917be42af437cbdd774be26b9ec90a2bd677000200000000000000000543","0x331d50e0b00fc1c32742f151e56b9b616227e23e00000000000000000000047c","0x334c96d792e4b26b841d28f53235281cec1be1f200020000000000000000038a","0x335d1709d4da9aca59d16328db5cd4ea66bfe06b0000000000000000000004d6","0x395d8a1d9ad82b5abe558f8abbfe183b27138af40000000000000000000004e5","0x3bb22fc9033b802f2ac47c18885f63476f158afc000000000000000000000483","0x3c640f0d3036ad85afa2d5a9e32be651657b874f00000000000000000000046b","0x3cdae4f12a67ba563499e102f309c73213cb241c000000000000000000000335","0x3dbb8d974b82e82ce79c20c0f5995f4f1f533ede000000000000000000000470","0x3f7a7fd7f214be45ec26820fd01ac3be4fc75aa70002000000000000000004c5","0x3fcb7085b8f2f473f80bf6d879cae99ea4de934400000000000000000000056d","0x41503c9d499ddbd1dcdf818a1b05e9774203bf46000000000000000000000594","0x4228290ee9cab692938ff0b4ba303fbcdb68e9f200020000000000000000057d","0x454ed96955d04d2f5cdd05e0fd1c77975bfe5307000000000000000000000410","0x481c5fc05d63a58aa2f0f2aa417c021b5d419cb200000000000000000000056a","0x483006684f422a9448023b2382615c57c5ecf18f000000000000000000000488","0x4a82b580365cff9b146281ab72500957a849abdc000000000000000000000494","0x4c81255cc9ed7062180ea99962fe05ac0d57350b0000000000000000000005a3","0x4c8d2e60863e8d7e1033eda2b3d84e92a641802000000000000000000000040f","0x4cbde5c4b4b53ebe4af4adb85404725985406163000000000000000000000595","0x4ce0bd7debf13434d3ae127430e9bd4291bfb61f00020000000000000000038b","0x4ce277df0feb5b4d07a0ca2adcf5326e4005239d000000000000000000000518","0x4fd4687ec38220f805b6363c3c1e52d0df3b5023000200000000000000000473","0x4fd63966879300cafafbb35d157dc5229278ed230000000000000000000000e9","0x50cf90b954958480b8df7958a9e965752f62712400000000000000000000046f","0x53bc3cba3832ebecbfa002c12023f8ab1aa3a3a0000000000000000000000411","0x5a6a8cffb4347ff7fc484bf5f0f8a2e234d34255000200000000000000000275","0x5b3240b6be3e7487d61cd1afdfc7fe4fa1d81e6400000000000000000000037b","0x60683b05e9a39e3509d8fdb9c959f23170f8a0fa000000000000000000000489","0x60d604890feaa0b5460b28a424407c24fe89374a0000000000000000000004fc","0x639883476960a23b38579acfd7d71561a0f408cf000200000000000000000505","0x652d486b80c461c397b0d95612a404da936f3db30000000000000000000000e7","0x6667c6fa9f2b3fc1cc8d85320b62703d938e43850000000000000000000004fb","0x6a1eb2e9b45e772f55bd9a34659a04b6f75da68700000000000000000000040d","0x6c56e72c551b5ac4bf54a620a76077ca768c8fe40002000000000000000004da","0x70b7d3b3209a59fb0400e17f67f3ee8c37363f4900020000000000000000018f","0x7337224d59cb16c2dc6938cd45a7b2c60c865d6a0000000000000000000004d4","0x74cbfaf94a3577c539a9dcee9870a6349a33b34f000000000000000000000534","0x779d01f939d78a918a3de18cc236ee89221dfd4e0000000000000000000004c7","0x7b50775383d3d6f0215a8f290f2c9e2eebbeceb20000000000000000000000fe","0x804cdb9116a10bb78768d3252355a1b18067bf8f0000000000000000000000fb","0x813e3fe1761f714c502d1d2d3a7cceb33f37f59d00000000000000000000040c","0x82698aecc9e28e9bb27608bd52cf57f704bd1b83000000000000000000000336","0x8a6b25e33b12d1bb6929a8793961076bd1f9d3eb0002000000000000000003e8","0x8e6ec57a822c2f527f2df7c7d7d361df3e7530a1000000000000000000000498","0x8f4063446f5011bc1c9f79a819efe87776f23704000000000000000000000197","0x9001cbbd96f54a658ff4e6e65ab564ded76a543100000000000000000000050a","0x9210f1204b5a24742eba12f710636d76240df3d00000000000000000000000fc","0x9516a2d25958edb8da246a320f2c7d94a0dbe25d000000000000000000000519","0x959216bb492b2efa72b15b7aacea5b5c984c3cca000200000000000000000472","0x968024662b9566b42d78af23a0f441bc8723fa83000200000000000000000418","0x99c88ad7dc566616548adde8ed3effa730eb6c3400000000000000000000049a","0x9b1c8407a360443a9e5eca004713e4088fab8ac0000000000000000000000497","0x9b692f571b256140a39a34676bffa30634c586e100000000000000000000059d","0x9d7f992c900fbea0ec314bdd71b7cc1becf76a33000200000000000000000573","0x9fb771d530b0ceba5160f7bfe2dd1e8b8aa1340300000000000000000000040e","0xa13a9247ea42d743238089903570127dda72fe4400000000000000000000035d","0xa1697f9af0875b63ddc472d6eebada8c1fab85680000000000000000000004f9","0xa3823e50f20982656557a4a6a9c06ba5467ae9080000000000000000000000e6","0xa718042e5622099e5f0ace4e7122058ab39e1bbe000200000000000000000475","0xa8b103a10a94f4f2d7ed2fdcd5545e807557330700000000000000000000048e","0xac5b4ef7ede2f2843a704e96dcaa637f4ba3dc3f00000000000000000000051d","0xac976bb42cb0c85635644e8c7c74d0e0286aa61c0000000000000000000003cb","0xae37d54ae477268b9997d4161b96b8200755935c000000000000000000000337","0xae8535c23afedda9304b03c68a3563b75fc8f92b0000000000000000000005a0","0xb0f75e97a114a4eb4a425edc48990e6760726709000000000000000000000198","0xb5e3de837f869b0248825e0175da73d4e8c3db6b000200000000000000000474","0xb841b062ea8ccf5c4cb78032e91de4ae875560420002000000000000000005b7","0xb9bd68a77ccf8314c0dfe51bc291c77590c4e9e6000200000000000000000385","0xbb6881874825e60e1160416d6c426eae65f2459e000000000000000000000592","0xbc0f2372008005471874e426e86ccfae7b4de79d000000000000000000000485","0xbf2ef8bdc2fc0f3203b3a01778e3ec5009aeef3300000000000000000000058d","0xbfa413a2ff0f20456d57b643746133f54bfe0cd20000000000000000000004c3","0xc2b021133d1b0cf07dba696fd5dd89338428225b000000000000000000000598","0xc443c15033fcb6cf72cc24f1bda0db070ddd9786000000000000000000000593","0xc50d4347209f285247bda8a09fc1c12ce42031c3000000000000000000000590","0xc5dc1316ab670a2eed5716d7f19ced321191f38200000000000000000000056e","0xc8c79fcd0e859e7ec81118e91ce8e4379a481ee6000000000000000000000196","0xcaa052584b462198a5a9356c28bce0634d65f65c0000000000000000000004db","0xcbfa4532d8b2ade2c261d3dd5ef2a2284f7926920000000000000000000004fa","0xcfae6e251369467f465f13836ac8135bd42f8a56000000000000000000000591","0xd4e7c1f3da1144c9e2cfd1b015eda7652b4a439900000000000000000000046a","0xd6e355036f41dc261b3f1ed3bbc6003e87aadb4f000000000000000000000495","0xd7edb56f63b2a0191742aea32df1f98ca81ed9c600000000000000000000058e","0xd997f35c9b1281b82c8928039d14cddab5e13c2000000000000000000000019c","0xdba274b4d04097b90a72b62467d828cefd708037000000000000000000000486","0xdc063deafce952160ec112fa382ac206305657e60000000000000000000004c4","0xdec02e6642e2c999af429f5ce944653cad15e093000000000000000000000469","0xe03af00fabe8401560c1ff7d242d622a5b601573000000000000000000000493","0xe0fcbf4d98f0ad982db260f86cf28b49845403c5000000000000000000000504","0xe2d16b0a39f3fbb4389a0e8f1efcbecfb3d1e6e10000000000000000000005a7","0xe4dc3c1998ac693d68f4c77476d7c815694c3e94000200000000000000000416","0xe6bcc79f328eec93d4ec8f7ed35534d9ab549faa0000000000000000000000e8","0xe8c56405bc405840154d9b572927f4197d110de10000000000000000000005a4","0xeb486af868aeb3b6e53066abc9623b1041b42bc000000000000000000000046c","0xeb567dde03f3da7fe185bdacd5ab495ab220769d000000000000000000000548","0xec3626fee40ef95e7c0cbb1d495c8b67b34d398300000000000000000000053d","0xf22ff21e17157340575158ad7394e068048dd98b0000000000000000000004b8","0xf57c794f42da72b38c8f610ff3b5e8502e48cbde00000000000000000000055c","0xf71d0774b214c4cf51e33eb3d30ef98132e4dbaa00000000000000000000046e","0xfa24a90a3f2bbe5feea92b95cd0d14ce709649f900000000000000000000058f","0xfd11ccdbdb7ab91cb9427a6d6bf570c95876d1950000000000000000000004c2","0xfebb0bbf162e64fb9d0dfe186e517d84c395f016000000000000000000000502","0xfef969638c52899f91781f1be594af6f40b99bad00000000000000000000047b","0x02e139d53ebf4033bf78ab66c6a1e7f1f204487f0002000000000000000009f9","0x03090a9811181a2afe830a3a0b467698ccf3a8b1000000000000000000000bf5","0x0320c1c5b6df19a194d48882aaec1c72940081d9000000000000000000000a7d","0x04b54ea92d73de2d62d651db7d9778f0c49157d8000200000000000000000ba2","0x0503dd6b2d3dd463c9bef67fb5156870af63393e00000000000000000000042e","0x0889b240a5876aae745ac19f1771853671dc5d36000000000000000000000b3f","0x0bc54e914f53f98d16035f4f0d948f3e09c2fac0000200000000000000000bac","0x0c06e87c7b88d998f645b91c1f53b51294b12bca000100000000000000000bb9","0x10b040038f87219d9b42e025e3bd9b8095c87dd9000000000000000000000b11","0x117a3d474976274b37b7b94af5dcade5c90c6e85000000000000000000000aca","0x11884da90fb4221b3aa288a7741c51ec4fc43b2f000000000000000000000a5f","0x1379b816b9be611431d693290289c204720ca56d000100000000000000000b6f","0x150e7b885bdfce974f2abe88a72fdbd692175c6f0002000000000000000009fd","0x178e029173417b1f9c8bc16dcec6f697bc323746000000000000000000000758","0x1aafc31091d93c3ff003cff5d2d8f7ba2e7284250000000000000000000003b3","0x216690738aac4aa0c4770253ca26a28f0115c595000000000000000000000b2c","0x216d6db0c28204014618482c369d7fbf0a8f3232000100000000000000000b60","0x230ecdb2a7cee56d6889965a023aa0473d6da507000000000000000000000bf3","0x252ff6a3a6fd7b5e8e999de8e3f5c3b306ed1401000200000000000000000bec","0x25e57f4612912614e6c99616bd2abb9b5ae71e99000000000000000000000bf0","0x2645b13fd2c5295296e94a76280b968bdcbbdfed000000000000000000000c11","0x284eb68520c8fa83361c1a3a5910aec7f873c18b000000000000000000000ac9","0x2c8dbe8eb86135d9f2f26d196748c088d47f73e7000200000000000000000a29","0x31bccf9e28b94e5dacebaa67fe8bc1603cecd904000000000000000000000a01","0x341068a547c3cde3c09e338714010dd01b32f93f000200000000000000000a34","0x3db543faf7a92052de7860c5c9debabee59ed5bd000000000000000000000a62","0x3dd0843a028c86e0b760b1a76929d1c5ef93a2dd00000000000000000000070d","0x3efb91c4f9b103ee45885695c67794591916f34e000200000000000000000b43","0x402cfdb7781fa85d52f425352661128250b79e12000000000000000000000be3","0x43894de14462b421372bcfe445fa51b1b4a0ff3d000000000000000000000b36","0x4739e50b59b552d490d3fdc60d200977a38510c0000000000000000000000b10","0x48e6b98ef6329f8f0a30ebb8c7c960330d64808500000000000000000000075b","0x4a0b73f0d13ff6d43e304a174697e3d5cfd310a400020000000000000000091c","0x4a77ef015ddcd972fd9ba2c7d5d658689d090f1a000000000000000000000b38","0x4ae3661afa119892f0cc8c43edaf6a94989ac171000000000000000000000c06","0x4ccb966d8246240afb7a1a24628efb930870b1c40002000000000000000009fc","0x52cc8389c6b93d740325729cc7c958066cee4262000000000000000000000b0f","0x5b77107fcdf2b41903bab2bc555d4fc14cf7667d000000000000000000000b32","0x5bae72b75caab1f260d21bc028c630140607d6e8000000000000000000000ac6","0x600bd01b6526611079e12e1ff93aba7a3e34226f0000000000000000000009e4","0x63ce19ccd39930725b8a3d2733627804718ab83d000000000000000000000bf2","0x64efad69f099813021b41f4cac6e749fd55e188f000000000000000000000b39","0x6933ec1ca55c06a894107860c92acdfd2dd8512f000000000000000000000428","0x6abe4e7a497b8293c258389c1b00d177e4f257ed00010000000000000000080d","0x6c8c7fc50247a47038015eb1fd5dc105d05dafba000200000000000000000ba0","0x7079a25dec33be61bbd81b2fb69b468e80d3e72c0000000000000000000009ff","0x71bd10c2a590b5858f5576550c163976a48af906000000000000000000000b27","0x7c82a23b4c48d796dee36a9ca215b641c6a8709d000000000000000000000acd","0x7f4f4942f2a14b6ab7b08b10ada1aacede4ee8d4000200000000000000000b44","0x86aef31951e0a3a54333bd9e72f9a95587d058c5000200000000000000000912","0x882c7a84231484b3e9f3fd45ac04b1eb5d35b076000200000000000000000a91","0x894c82800526e0391e709c0983a5aea3718b7f6d000000000000000000000ac5","0x89b28a9494589b09dbccb69911c189f74fdadc5a000000000000000000000b33","0x89bb15076c9f2d86aa98ec6cffc1a71e31c38953000000000000000000000bf1","0x89f1146fee52b5d9166e9c83cc388b6d8f69f1380001000000000000000009e7","0x8a819a4cabd6efcb4e5504fe8679a1abd831dd8f00000000000000000000042d","0x8b58a1e7fff52001c22386c2918d45938a6a9be30001000000000000000008d9","0x8b8225bfedebaf1708c55743acb4ad43fd4d0f21000200000000000000000918","0x8fbd0f8e490735cfc3abf4f29cbddd5c3289b9a7000000000000000000000b5b","0x8fd39252d683fdb60bddd4df4b53c9380b496d59000200000000000000000b45","0x9321e2250767d79bab5aa06daa8606a2b3b7b4c5000000000000000000000bf4","0x949a12b95ec5b80c375b98963a5d6b33b0d0efff0002000000000000000009fe","0x9a020bdc2faff5bd24c6acc2020d01ff9f2c627a000000000000000000000ae2","0x9cf9358300e34bf9373d30129a1e718d8d058b54000200000000000000000913","0x9e34631547adcf2f8cefa0f5f223955c7b137571000000000000000000000ad5","0xa5a935833f6a5312715f182733eab088452335d7000100000000000000000bee","0xa5fe91dde37d8bf2dacacc0168b115d28ed03f84000000000000000000000b35","0xa8bf1c584519be0184311c48adbdc4c15cb2e8c1000000000000000000000bf6","0xab269164a10fab22bc87c39946da06c870b172d6000000000000000000000bfc","0xac2cae8d2f78a4a8f92f20dbe74042cd0a8d5af3000000000000000000000be2","0xae646817e458c0be890b81e8d880206710e3c44e000000000000000000000acb","0xaef2c171dbe64b0c18977e16e70bfd29d4ee0256000000000000000000000ac8","0xb0c830dceb4ef55a60192472c20c8bf19df03488000000000000000000000be1","0xb266ac3b7c98d7bcb28731dac0ef42dba1b276be000000000000000000000be4","0xb371aa09f5a110ab69b39a84b5469d29f9b22b76000000000000000000000b37","0xb3d658d5b95bf04e2932370dd1ff976fe18dd66a000000000000000000000ace","0xb54b2125b711cd183edd3dd09433439d5396165200000000000000000000075e","0xb59be8f3c85a9dd6e2899103b6fbf6ea405b99a4000000000000000000000b34","0xb878ecce26838fbba4f78cb5b791a0e09152c067000000000000000000000427","0xb973ca96a3f0d61045f53255e319aedb6ed4924000000000000000000000042f","0xbd4e35784c832d0f9049b54cb3609e5907c5b495000100000000000000000b14","0xc55ec796a4debe625d95436a3531f4950b11bdcf000000000000000000000b3e","0xc7e6389e364f4275eb442ef215ed21877028e2af000000000000000000000ac7","0xc83b55bbd005f1f84906545fcdb145dee53523e0000200000000000000000b30","0xcb21a9e647c95127ed784626485b3104cb28d0e7000000000000000000000425","0xd00f9ca46ce0e4a63067c4657986f0167b0de1e5000000000000000000000b42","0xd2f3b9e67c69762dd1c88f1d3dadd1649a190761000200000000000000000bf7","0xd4accb350f9cf59fe3cf7a5ee6ed9ace6a568ea9000200000000000000000b75","0xda1cd1711743e57dd57102e9e61b75f3587703da000000000000000000000acc","0xdae301690004946424e41051ace1791083be42a1000000000000000000000b40","0xde0a77ab6689b980c30306b10f9131a007e1af81000200000000000000000ba1","0xe051605a83deae38d26a7346b100ef1ac2ef8a0b0000000000000000000003ce","0xe1fb90d0d3b47e551d494d7ebe8f209753526b01000000000000000000000ac4","0xe2272cddb2cc408e79e02a73d1db9acc24a843d5000200000000000000000ba7","0xe2dc0e0f2c358d6e31836dee69a558ab8d1390e70000000000000000000009fa","0xe4885ed2818cc9e840a25f94f9b2a28169d1aea7000000000000000000000b29","0xe6909c2f18a29d97217a6146f045e1780606991f000100000000000000000bfe","0xe78b25c06db117fdf8f98583cdaaa6c92b79e917000000000000000000000b2b","0xea11645ac7d8f2def94c9d8d86bd766296c9b6b6000000000000000000000b3a","0xeb480dbbdd921cd6c359e4cc4c65ddea6395e2a1000200000000000000000946","0xed35f28f837e96f81240ebb82e0e3f518c7e8a2f000100000000000000000bb5","0xf0211cceebe6fcc45052b4e57ee95d233f5669d2000100000000000000000c01","0xf22a66046b5307842f21b311ecb4c462c24c0635000000000000000000000b15","0xf28f17be00f8ca3c9b7f66a4aad5513757fb3341000200000000000000000b5a","0xf42ed61450458ee4620f5ef4f29adb25a6ef0fb6000000000000000000000bf8","0xf48f01dcb2cbb3ee1f6aab0e742c2d3941039d56000000000000000000000445","0xf93579002dbe8046c43fefe86ec78b1112247bb8000000000000000000000759","0xf984eb2b8a7ef780245a797a2fccd82f346409ca000000000000000000000a59","0xfa2c0bd8327c99db5bde4c9e9e5cbf30946351bb000000000000000000000948","0xff4ce5aaab5a627bf82f4a571ab1ce94aa365ea600000000000000000000075a","0x1ac55c31dac78ca943cb8ebfca5945ce09e036e2000000000000000000000024","0x225e0047671939a8d78e08ebd692788abe63f15c000000000000000000000009","0x41211bba6d37f5a74b22e667533f080c7c7f3f1300000000000000000000000b","0x4de21b365d6543661d0e105e579a34b963862497000200000000000000000045","0x581ec1f5e7ced12b186deae32256adb53bdd5b08000000000000000000000001","0x66f33ae36dd80327744207a48122f874634b3ada000100000000000000000013","0xa3ed6f78edc29f69df8a0d16b1d1ccf9871f918c000000000000000000000032","0xa611a551b95b205ccd9490657acf7899daee5db700000000000000000000002e","0xb95829adbacd8af89e291dee78bc09e24de51d6b000000000000000000000043","0xb973ca96a3f0d61045f53255e319aedb6ed49240000200000000000000000011","0xba1a5b19d09a79dada039b1f974015c5a989d5fd000100000000000000000046","0xbb9cd48d33033f5effbedec9dd700c7d7e1dcf5000000000000000000000000e","0xd16f72b02da5f51231fde542a8b9e2777a478c8800000000000000000000000f","0xd4015683b8153666190e0b2bec352580ebc4caca00000000000000000000000d","0xe15cac1df3621e001f76210ab12a7f1a1691481f000000000000000000000044","0xe7f88d7d4ef2eb18fcf9dd7216ba7da1c46f3dd600000000000000000000000a","0xf48f01dcb2cbb3ee1f6aab0e742c2d3941039d56000200000000000000000012","0xfedb19ec000d38d92af4b21436870f115db22725000000000000000000000010","0xffff76a3280e95dc855696111c2562da09db2ac000000000000000000000000c","0x00fcd3d55085e998e291a0005cedecf58ac14c4000020000000000000000047f","0x077794c30afeccdf5ad2abc0588e8cee7197b71a000000000000000000000352","0x117a3d474976274b37b7b94af5dcade5c90c6e85000000000000000000000381","0x11884da90fb4221b3aa288a7741c51ec4fc43b2f000000000000000000000353","0x19b1c92631405a0a9495ccba0becf4f2e8e908bd000000000000000000000410","0x1e550b7764da9638fdd32c8a701364de31f45ee800000000000000000000047c","0x1fa7f727934226aedab636d62a084931b97d366b000000000000000000000411","0x23ca0306b21ea71552b148cf3c4db4fc85ae19290000000000000000000000c9","0x284eb68520c8fa83361c1a3a5910aec7f873c18b000000000000000000000380","0x2a96254ca32020b20ed3506f8f75318da24709f9000200000000000000000456","0x36942963e3b6f37ecc45a4e72349558514233f0000000000000000000000048a","0x3f53a862919ccfa023cb6ace91378a79fb0f6bf500000000000000000000040f","0x40af308e3d07ec769d85eb80afb116525ff4ac99000000000000000000000485","0x418de00ae109e6f874d872658767866d680eaa1900000000000000000000047d","0x45c4d1376943ab28802b995acffc04903eb5223f000000000000000000000470","0x4689122d360c4725d244c5cfea22861333d862e6000100000000000000000468","0x4739e50b59b552d490d3fdc60d200977a38510c0000000000000000000000409","0x49a0e3334496442a9706e481617724e7e37eaa080000000000000000000003ff","0x519cce718fcd11ac09194cff4517f12d263be067000000000000000000000382","0x52cc8389c6b93d740325729cc7c958066cee4262000000000000000000000408","0x567ecfcb22205d279bb8eed3e066989902bf03d5000000000000000000000452","0x585d95df0231fa08aeee35ff0c16b92fd0ecdc3300020000000000000000045f","0x5a7f39435fd9c381e4932fa2047c9a5136a5e3e7000000000000000000000400","0x5bae72b75caab1f260d21bc028c630140607d6e8000000000000000000000350","0x6cb787a419c3e6ee2e9ff365856c29cd10659113000000000000000000000474","0x7c82a23b4c48d796dee36a9ca215b641c6a8709d000000000000000000000406","0x81fc12c60ee5b753cf5fd0adc342dfb5f3817e3200000000000000000000035d","0x894c82800526e0391e709c0983a5aea3718b7f6d00000000000000000000034f","0x970712708a08e8fb152be4d81b2dc586923f5369000200000000000000000479","0x9bf7c3b63c77b4b4f2717776f15a4bec1b532a280000000000000000000000c8","0x9cebf13bb702f253abf1579294694a1edad00eaa000000000000000000000486","0x9e34631547adcf2f8cefa0f5f223955c7b137571000000000000000000000407","0x9fb7d6dcac7b6aa20108bad226c35b85a9e31b63000200000000000000000412","0xa1ea76c42b2938cfa9abea12357881006c52851300000000000000000000048f","0xa50f89e9f439fde2a6fe05883721a00475da3c4500000000000000000000048b","0xa612b6aed2e7ca1a3a4f23fbca9128461bbb7718000000000000000000000274","0xa8af146d79ac0bb981e4e0d8b788ec5711b1d5d000000000000000000000047b","0xad28940024117b442a9efb6d0f25c8b59e1c950b00000000000000000000046f","0xae646817e458c0be890b81e8d880206710e3c44e00000000000000000000039d","0xaef2c171dbe64b0c18977e16e70bfd29d4ee0256000000000000000000000351","0xbbf9d705b75f408cfcaee91da32966124d2c6f7d00000000000000000000047e","0xbd724eb087d4cc0f61a5fed1fffaf937937e14de000000000000000000000473","0xbe0f30217be1e981add883848d0773a86d2d2cd4000000000000000000000471","0xc46be4b8bb6b5a3d3120660efae9c5416318ed40000000000000000000000472","0xc69771058481551261709d8db44977e9afde645000010000000000000000042a","0xc6eee8cb7643ec2f05f46d569e9ec8ef8b41b389000000000000000000000475","0xcba9ff45cfb9ce238afde32b0148eb82cbe635620000000000000000000003fd","0xcf8b555b7754556cf2ac2165e77ee23ed8517d7900020000000000000000045e","0xd0dc20e6342db2de82692b8dc842301ff9121805000200000000000000000454","0xd3d5d45f4edf82ba0dfaf061d230766032a10e07000200000000000000000413","0xd6d20527c7b0669989ee082b9d3a1c63af742290000000000000000000000483","0xda1cd1711743e57dd57102e9e61b75f3587703da0000000000000000000003fc","0xe1fb90d0d3b47e551d494d7ebe8f209753526b0100000000000000000000034e","0xee02583596aee94cccb7e8ccd3921d955f17982a00000000000000000000040a","0xf984eb2b8a7ef780245a797a2fccd82f346409ca00000000000000000000034d","0xff8f84e8c87532af96aef5582ee451572233678b000200000000000000000478","0x054e7b0c73e1ee5aed6864fa511658fc2b54bcaa000000000000000000000015","0x3f1a2c4a3a751f6626bd90ef16e104f0772d4d6b00020000000000000000001b","0x7275c131b1f67e8b53b4691f92b0e35a4c1c6e22000000000000000000000010","0xa154009870e9b6431305f19b09f9cfd7284d4e7a000000000000000000000013","0xa1d14d922a575232066520eda11e27760946c991000000000000000000000012","0xa826a114b0c7db4d1ff4a4be845a78998c64564c000000000000000000000008","0xea67626e1f0b59e0d172a04f5702ef90bcdf440c00000000000000000000000f","0xeb496161099d45b3ea4892408ef745c6182eb56e00000000000000000000000e","0xece571847897fd61e764d455dc15cf1cd9de8d6f000000000000000000000014","0xed3e2f496cbcd8e212192fb8d1499842f04a0d19000000000000000000000009","0x02c9dcb975262719a61f9b40bdf0987ead9add3a000000000000000000000006","0x16c9a4d841e88e52b51936106010f27085a529ec00000000000000000000000c","0x32be2d0ddeaf3333501b24a28668ce373ba8e763000200000000000000000014","0x32f03464fdf909fdf3798f87ff3712b10c59bd86000000000000000000000005","0x4b718e0e2fea1da68b763cd50c446fba03ceb2ea00000000000000000000000b","0x68a69c596b3839023c0e08d09682314f582314e5000200000000000000000011","0x6f34a44fce1506352a171232163e7716dd073ade000200000000000000000015","0x9e2d87f904862671eb49cb358e74284762cc9f42000200000000000000000013","0xac4b72c01072a52b73ca71105504f1372efcce0d000000000000000000000003","0xbfd65c6160cfd638a85c645e6e6d8acac5dac935000000000000000000000004","0xe274c9deb6ed34cfe4130f8d0a8a948dea5bb28600000000000000000000000d"];class Ni extends p.SOR{constructor(e){const t=Fi(e),a=Ni.getSorConfig(e),n=Ni.getSorNetworkConfig(t),o=new d.JsonRpcProvider(e.rpcUrl,e.network),i=xi(t.urls.subgraph);super(o,n,Ni.getPoolDataService(t,a,o,i),Ni.getTokenPriceService(t,a,i))}static getSorConfig(e){return{tokenPriceService:"coingecko",poolDataService:"subgraph",fetchOnChainBalances:!0,...e.sor}}static getSorNetworkConfig(e){var t;return{...e,vault:e.addresses.contracts.vault,weth:e.addresses.tokens.wrappedNativeAsset,lbpRaisingTokens:null===(t=e.addresses.tokens)||void 0===t?void 0:t.lbpRaisingTokens,wETHwstETH:e.pools.wETHwstETH,connectingTokens:e.sorConnectingTokens,triPathMidPoolIds:e.sorTriPathMidPoolIds}}static getPoolDataService(e,t,a,n){const o=Ri.map((e=>R(e))),i=e.poolsToIgnore?[...e.poolsToIgnore,...o]:o;return"object"==typeof t.poolDataService?t.poolDataService:new Ci(n,a,{...e,poolsToIgnore:i},t)}static getTokenPriceService(e,t,a){return"object"==typeof t.tokenPriceService?t.tokenPriceService:("subgraph"===t.tokenPriceService&&new Mi(a,e.addresses.tokens.wrappedNativeAsset),new Bi(e.chainId))}}function Di(e){if(e.poolIds.length>2)throw new Error("Simple flash swap only supports a maximum of two pools");if(e.assets.length>2)throw new Error("Simple flash swap only supports a maximum of to two assets (tokens)")}function Li(e,t){return[{poolId:e[0],assetInIndex:0,assetOutIndex:1,amount:t,userData:"0x"},{poolId:e[1],assetInIndex:1,assetOutIndex:0,amount:"0",userData:"0x"}]}function Ui(e){return-1*Number(e)}function Vi(e){return s.sum(e)}const Gi={"0xae7ab96520de3a18e5e111b5eaab095312d7fe84":"0x7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0","0xd46ba6d942050d489dbd938a2c909a5d5039a161":"0xedb171c18ce90b633db442f2a6f72874093b49ef","0x1e6bb68acec8fefbd87d192be09bb274170a0548":"0xF03387d8d0FF326ab586A58E0ab4121d106147DF"};function qi(e){let t=e;return Gi.hasOwnProperty(e)&&(t=Gi[e]),t}var Wi;function $i(e,t,a){const{tokens:n,contracts:o}=Oa(a);let i={id:Wi.vault,address:o.vault};return n.stETH&&o.lidoRelayer&&[e,t].includes(n.stETH)&&(i={id:Wi.lido,address:o.lidoRelayer}),i}function Hi(e){return e.id===Wi.lido?xt.abi.filter((e=>"function"===e.type&&e.name&&["swap","batchSwap"].includes(e.name))):da.abi.filter((e=>"function"===e.type&&e.name&&["swap","batchSwap"].includes(e.name)))}function Ki(e){return{amount:e,max:t=>e.mul(1e4+t).div(1e4),min:t=>e.mul(1e4-t).div(1e4)}}function Ji(e,t){const a=t===exports.SwapType.SwapExactIn?e.swapAmount:e.returnAmount,n=t===exports.SwapType.SwapExactIn?e.returnAmount:e.swapAmount,o=t===exports.SwapType.SwapExactIn?e.swapAmountForSwaps||e.swapAmount:e.returnAmountFromSwaps||e.returnAmount,i=t===exports.SwapType.SwapExactIn?e.returnAmountFromSwaps||e.returnAmount:e.swapAmountForSwaps||e.swapAmount,s=qi(e.tokenIn),r=qi(e.tokenOut);return{...e,amountIn:a,amountOut:n,amountInForLimits:Ki(o),amountOutForLimits:Ki(i),tokenInForSwaps:s,tokenOutFromSwaps:r}}!function(e){e[e.vault=1]="vault",e[e.lido=2]="lido"}(Wi||(Wi={}));class Xi{constructor(e,t,a){this.kind=t,this.chainId=a,this.functionName="swap",this.swapInfo=Ji(e,t),this.relayer=$i(this.swapInfo.tokenIn,this.swapInfo.tokenOut,this.chainId)}setFunds(e,t){this.funds={sender:e,recipient:t||e,fromInternalBalance:!1,toInternalBalance:!1}}setDeadline(e){this.deadline=e}get amount(){return this.kind===exports.SwapType.SwapExactOut?this.swapInfo.amountOutForLimits.amount:this.swapInfo.amountInForLimits.amount}setLimits(e){this.limit=this.kind===exports.SwapType.SwapExactIn?this.swapInfo.amountOutForLimits.min(e).toString():this.swapInfo.amountInForLimits.max(e).toString()}get singleSwap(){return{poolId:this.swapInfo.swaps[0].poolId,kind:this.kind,assetIn:this.swapInfo.tokenInForSwaps,assetOut:this.swapInfo.tokenOutFromSwaps,amount:this.amount.toString(),userData:"0x"}}attributes(){var e;if(!this.funds||!this.limit||!this.deadline)throw new Error("Uninitialized arguments");let t={request:this.singleSwap,funds:this.funds,limit:this.limit,deadline:this.deadline};const a=this.fragment();return a[0].inputs&&(null===(e=a[0].inputs)||void 0===e?void 0:e.length)>4&&(t={...t,value:"0",outputReference:"0"}),t}data(){return new e.Interface(this.fragment()).encodeFunctionData("swap",Object.values(this.attributes()))}value(e){let n=a.BigNumber.from(0);return this.swapInfo.tokenIn===t.AddressZero&&(n=this.kind===exports.SwapType.SwapExactIn?this.swapInfo.amountIn:this.swapInfo.amountInForLimits.max(e)),n}to(){return this.relayer.address}fragment(){return Hi(this.relayer).filter((e=>e.name===this.functionName))}}class Yi{constructor(e,t,a){this.kind=t,this.chainId=a,this.functionName="batchSwap",this.swapInfo=Ji(e,t),this.relayer=$i(this.swapInfo.tokenIn,this.swapInfo.tokenOut,this.chainId)}setFunds(e,t){this.funds={sender:e,recipient:t||e,fromInternalBalance:!1,toInternalBalance:!1}}setDeadline(e){this.deadline=e}minAmountOut(e){return this.kind===exports.SwapType.SwapExactIn?this.swapInfo.amountOutForLimits.min(e):this.swapInfo.amountOutForLimits.amount}maxAmountIn(e){return this.kind===exports.SwapType.SwapExactOut?this.swapInfo.amountInForLimits.max(e):this.swapInfo.amountInForLimits.amount}setLimits(e){this.limits=this.swapInfo.tokenAddresses.map((t=>{let n=a.BigNumber.from(0);return t===this.swapInfo.tokenInForSwaps&&(n=this.maxAmountIn(e)),t===this.swapInfo.tokenOutFromSwaps&&(n=this.minAmountOut(e).mul(-1)),n})).map((e=>e.toString().split(".")[0]))}attributes(){var e;if(!this.funds||!this.limits||!this.deadline)throw new Error("Uninitialized arguments");let t={kind:this.kind,swaps:this.swapInfo.swaps,assets:this.swapInfo.tokenAddresses,funds:this.funds,limits:this.limits,deadline:this.deadline};const a=this.fragment();return a[0].inputs&&(null===(e=a[0].inputs)||void 0===e?void 0:e.length)>6&&(t={...t,value:"0",outputReferences:[]}),t}data(){return new e.Interface(this.fragment()).encodeFunctionData("batchSwap",Object.values(this.attributes()))}value(e){let n=a.BigNumber.from(0);return this.swapInfo.tokenIn===t.AddressZero&&(n=this.maxAmountIn(e)),n}to(){return this.relayer.address}fragment(){return Hi(this.relayer).filter((e=>e.name===this.functionName))}}const ji={maxPools:4,gasPrice:"1",deadline:"999999999999999999",maxSlippage:10};class zi{constructor(e){e instanceof p.SOR?(this.sor=e,this.chainId=this.sor.provider._network.chainId):(this.sor=new Ni(e),"number"==typeof e.network?this.chainId=e.network:this.chainId=e.network.chainId),this.vaultContract=da.connect(Aa,this.sor.provider)}static getLimitsForSlippage(e,t,a,n,o,i){return va(e,t,a,n,o,i).map((e=>e.toString()))}async findRouteGivenIn({tokenIn:e,tokenOut:t,amount:a,gasPrice:n,maxPools:o=4}){return this.sor.getSwaps(e,t,p.SwapTypes.SwapExactIn,a,{gasPrice:n,maxPools:o})}async findRouteGivenOut({tokenIn:e,tokenOut:t,amount:a,gasPrice:n,maxPools:o=4}){return this.sor.getSwaps(e,t,p.SwapTypes.SwapExactOut,a,{gasPrice:n,maxPools:o})}buildSwap({userAddress:e,recipient:t,swapInfo:a,kind:n,deadline:o,maxSlippage:i}){if(!this.chainId)throw"Missing network configuration";const s=a.swaps.length>1?new Yi(a,n,this.chainId):new Xi(a,n,this.chainId);s.setFunds(e,t),s.setDeadline(o),s.setLimits(i);const r=s.to(),{functionName:p}=s;return{to:r,functionName:p,attributes:s.attributes(),data:s.data(),value:s.value(i)}}async buildRouteExactIn(e,t,n,o,i,s=ji){const r={...ji,...s},p=await this.findRouteGivenIn({tokenIn:n,tokenOut:o,amount:a.BigNumber.from(i),gasPrice:a.BigNumber.from(r.gasPrice),maxPools:r.maxPools});return this.buildSwap({userAddress:e,recipient:t,swapInfo:p,kind:exports.SwapType.SwapExactIn,deadline:r.deadline,maxSlippage:r.maxSlippage})}static encodeBatchSwap(e){return da.createInterface().encodeFunctionData("batchSwap",[e.kind,e.swaps,e.assets,e.funds,e.limits,e.deadline])}static encodeSimpleFlashSwap(e){return this.encodeBatchSwap(function({poolIds:e,assets:t,flashLoanAmount:a,walletAddress:n}){Di({poolIds:e,assets:t});const o=Li(e,a),i={sender:n,fromInternalBalance:!1,recipient:n,toInternalBalance:!1};return{kind:exports.SwapType.SwapExactIn,swaps:o,assets:t,funds:i,limits:["0","0"],deadline:"999999999999999999"}}(e))}async fetchPools(e){return this.sor.fetchPools(e)}getPools(){return this.sor.getPools()}async queryBatchSwap(e){return await Rn(this.vaultContract,e.kind,e.swaps,e.assets)}async querySimpleFlashSwap(e){return await async function(e){Di(e);const[t,a]=e.assets;try{const n=await Rn(e.vaultContract,exports.SwapType.SwapExactIn,Li(e.poolIds,e.flashLoanAmount),e.assets),o={[t]:Ui(n[0]).toString(),[a]:Ui(n[1]).toString()};return{profits:o,isProfitable:Vi([o[t],o[a]])>0}}catch(e){throw`Failed to querySimpleFlashSwap: ${e}`}}({...e,vaultContract:this.vaultContract})}async getSorSwap(e){return await async function(e,t,a,n,o){const i=a===exports.SwapType.SwapExactIn?p.SwapTypes.SwapExactIn:p.SwapTypes.SwapExactOut;return await o.getSwaps(e.toLowerCase(),t.toLowerCase(),i,n)}(e.tokenIn,e.tokenOut,e.swapType,e.amount,this.sor)}async queryExactIn(e){const t=await this.query(e,exports.SwapType.SwapExactIn);return this.assetDeltas(t.map(String),e.tokenAddresses)}async queryExactOut(e){const t=await this.query(e,exports.SwapType.SwapExactOut);return this.assetDeltas(t.map(String),e.tokenAddresses)}query(e,a){const{swaps:n,tokenAddresses:o}=e,i={sender:t.AddressZero,recipient:t.AddressZero,fromInternalBalance:!1,toInternalBalance:!1};return this.vaultContract.callStatic.queryBatchSwap(a,n,o,i)}assetDeltas(e,t){return Object.fromEntries(e.map(((e,a)=>[t[a],e])))}}var Zi;exports.PoolKind=void 0,(Zi=exports.PoolKind||(exports.PoolKind={}))[Zi.WEIGHTED=0]="WEIGHTED",Zi[Zi.LEGACY_STABLE=1]="LEGACY_STABLE",Zi[Zi.COMPOSABLE_STABLE=2]="COMPOSABLE_STABLE",Zi[Zi.COMPOSABLE_STABLE_V2=3]="COMPOSABLE_STABLE_V2";const Qi=xt.createInterface();class es{static encodeApproveVault(e,t){return Qi.encodeFunctionData("approveVault",[e,t])}static encodeSetRelayerApproval(e,t,a){return Qi.encodeFunctionData("setRelayerApproval",[e,t,a])}static encodeGaugeWithdraw(e,t,a,n){return Qi.encodeFunctionData("gaugeWithdraw",[e,t,a,n])}static encodeGaugeDeposit(e,t,a,n){return Qi.encodeFunctionData("gaugeDeposit",[e,t,a,n])}static encodeSwap(e){return Qi.encodeFunctionData("swap",[e.request,e.funds,e.limit,e.deadline,e.value,e.outputReference])}static encodeBatchSwap(e){return Qi.encodeFunctionData("batchSwap",[e.swapType,e.swaps,e.assets,e.funds,e.limits,e.deadline,e.value,e.outputReferences])}static encodeExitPool(e){return Qi.encodeFunctionData("exitPool",[e.poolId,e.poolKind,e.sender,e.recipient,e.exitPoolRequest,e.outputReferences])}static encodeJoinPool(e){return Qi.encodeFunctionData("joinPool",[e.poolId,e.kind,e.sender,e.recipient,e.joinPoolRequest,e.value,e.outputReference])}static encodeWrapAaveDynamicToken(e){return Qi.encodeFunctionData("wrapAaveDynamicToken",[e.staticToken,e.sender,e.recipient,e.amount,e.fromUnderlying,e.outputReference])}static encodeUnwrapAaveStaticToken(e){return Qi.encodeFunctionData("unwrapAaveStaticToken",[e.staticToken,e.sender,e.recipient,e.amount,e.toUnderlying,e.outputReference])}static encodeUnwrapWstETH(e){return Qi.encodeFunctionData("unwrapWstETH",[e.sender,e.recipient,e.amount,e.outputReference])}static encodeUnwrap(e,t){let a;switch(t){case"AaveLinear":return this.encodeUnwrapAaveStaticToken({staticToken:e.wrappedToken,sender:e.sender,recipient:e.recipient,amount:e.amount,toUnderlying:!0,outputReference:e.outputReference});case"BeefyLinear":case"ERC4626Linear":a="unwrapERC4626";break;case"EulerLinear":a="unwrapEuler";break;case"GearboxLinear":a="unwrapGearbox";break;case"ReaperLinear":a="unwrapReaperVaultToken";break;case"TetuLinear":a="unwrapTetu";break;case"YearnLinear":a="unwrapYearn";break;case"MidasLinear":a="unwrapCompoundV2";break;case"SiloLinear":a="unwrapShareToken";break;default:throw new Error("Unwrapping not supported for this pool type: "+t)}return Qi.encodeFunctionData(a,[e.wrappedToken,e.sender,e.recipient,e.amount,e.outputReference])}static encodePeekChainedReferenceValue(e){return Qi.encodeFunctionData("peekChainedReferenceValue",[e])}static toChainedReference(e,t=!0){const n=t?es.CHAINED_REFERENCE_TEMP_PREFIX:es.CHAINED_REFERENCE_READONLY_PREFIX,o=`0x${n}${"0".repeat(64-n.length)}`;return a.BigNumber.from(o).add(e)}static fromChainedReference(e,t=!0){const n=t?es.CHAINED_REFERENCE_TEMP_PREFIX:es.CHAINED_REFERENCE_READONLY_PREFIX,o=`0x${n}${"0".repeat(64-n.length)}`;return a.BigNumber.from(e).sub(a.BigNumber.from(o))}static isChainedReference(e){const t=a.BigNumber.from(e),n=a.BigNumber.from("0xfff0000000000000000000000000000000000000000000000000000000000000"),o=t.toBigInt()&n.toBigInt();return"0xba10000000000000000000000000000000000000000000000000000000000000"===a.BigNumber.from(o)._hex.toString()}static formatExitPoolInput(e){const{assets:t,minAmountsOut:a,userData:n,toInternalBalance:o,poolId:i,poolKind:s,sender:r,recipient:p,outputReferences:d}=e;return{poolId:i,poolKind:s,sender:r,recipient:p,outputReferences:d,exitPoolRequest:{assets:t,minAmountsOut:a,userData:n,toInternalBalance:o}}}static formatJoinPoolInput(e){const{assets:t,maxAmountsIn:a,userData:n,fromInternalBalance:o,poolId:i,kind:s,sender:r,recipient:p,value:d,outputReference:l}=e;return{poolId:i,kind:s,sender:r,recipient:p,value:d,outputReference:l,joinPoolRequest:{assets:t,maxAmountsIn:a,userData:n,fromInternalBalance:o}}}}es.CHAINED_REFERENCE_TEMP_PREFIX="ba10",es.CHAINED_REFERENCE_READONLY_PREFIX="ba11",es.signRelayerApproval=async(e,a,n,o)=>{const i=o.interface.encodeFunctionData("setRelayerApproval",[a,e,!0]),s=await te.signSetRelayerApprovalAuthorization(o,n,e,i);return te.encodeCalldataAuthorization("0x",t.MaxUint256,s)};class ts{constructor(e){this.url=Fi(e).urls.subgraph,this.client=this.initClient()}initClient(){return jo(new l.GraphQLClient(this.url))}}class as{constructor(e,t){this.swaps=t||new zi(e)}async fetchPools(){return this.swaps.fetchPools()}getPools(){return this.swaps.getPools()}async getSpotPrice(e,t,a=[]){0===a.length&&(await this.fetchPools(),a=this.getPools());const n=p.parseToPoolsDict(a,0),o=this.swaps.sor.routeProposer.getCandidatePathsFromDict(e,t,0,n,4);if(0===o.length)throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_PAIR);return p.getSpotPriceAfterSwapForPath(o[0],0,p.ZERO).toString()}}const ns=["function getPoolId() view returns (bytes32)","function getSwapFeePercentage() view returns (uint256)","function getProtocolFeesCollector() view returns (address)","function inRecoveryMode() view returns (bool)"];class os{constructor(t,a,n={}){this.multicall=t,this.options=n,this.calls=[],this.paths=[],this.interface=new e.Interface(a)}call(e,t,a,n){return this.calls.push([t,a,n]),this.paths.push(e),this}async execute(e={}){const t=e;return(await this.executeMulticall()).forEach(((e,a)=>s.set(t,this.paths[a],e.length>1?e:e[0]))),this.calls=[],this.paths=[],t}async executeMulticall(){const[,e]=await this.multicall.callStatic.aggregate(this.calls.map((([e,t,a])=>({target:e,callData:this.interface.encodeFunctionData(t,a)}))),this.options);return e.map(((e,t)=>this.interface.decodeFunctionResult(this.calls[t][1],e)))}}function is(e){return Math.round(Date.now()/1e3)-e<86400}class ss{constructor(e,t){this.veBalAddress=e,this.multicall=t}async getLockInfo(e){if(!this.veBalAddress)throw new Error("veBal address must be defined");const t=new os(this.multicall,[...xa.abi]);t.call("locked",this.veBalAddress,"locked",[e]),t.call("epoch",this.veBalAddress,"epoch"),t.call("totalSupply",this.veBalAddress,"totalSupply()");const a=await t.execute();return this.formatLockInfo(a)}formatLockInfo(e){const[t,a]=e.locked,n=t.gt(0),o=1e3*a.toNumber();const i=n&&Date.now()>o;return{lockedEndDate:o,lockedAmount:Oe(t),totalSupply:Oe(e.totalSupply),epoch:Oe(e.epoch,0),hasExistingLock:n,isExpired:i}}}class rs{constructor(e,t){if(!e.veBalProxy)throw new Error("veBalProxy address must be defined");this.instance=wa.connect(e.veBalProxy,t)}async getAdjustedBalance(e){return Oe(await this.instance.adjustedBalanceOf(e))}}class ps{constructor(e,t){this.getLiquidityGauge=Qt.connect,this.contractAddresses="number"==typeof e?ka[e].addresses.contracts:e;const a=da.connect(this.contractAddresses.vault,t),n=yt.connect(this.contractAddresses.balancerHelpers,t);let o;this.contractAddresses.lidoRelayer&&(o=Yt.connect(this.contractAddresses.lidoRelayer,t));const i=ta.connect(this.contractAddresses.multicall,t),s=It.connect(this.contractAddresses.balancerRelayer,t);let r,p,d,l,u,c,y,b,m,f,T;this.contractAddresses.veBal&&(r=new ss(this.contractAddresses.veBal,i)),this.contractAddresses.veBalProxy&&(p=new rs(this.contractAddresses,t)),this.contractAddresses.gaugeClaimHelper&&(d=Gt.connect(this.contractAddresses.gaugeClaimHelper,t)),this.contractAddresses.composableStablePoolFactory&&(l=Et.connect(this.contractAddresses.composableStablePoolFactory,t)),this.contractAddresses.weightedPoolFactory&&(u=ya.connect(this.contractAddresses.weightedPoolFactory,t)),this.contractAddresses.aaveLinearPoolFactory&&(c=rt.connect(this.contractAddresses.aaveLinearPoolFactory,t)),this.contractAddresses.erc4626LinearPoolFactory&&(y=Mt.connect(this.contractAddresses.erc4626LinearPoolFactory,t)),this.contractAddresses.eulerLinearPoolFactory&&(b=Dt.connect(this.contractAddresses.eulerLinearPoolFactory,t)),this.contractAddresses.gearboxLinearPoolFactory&&(m=Ht.connect(this.contractAddresses.gearboxLinearPoolFactory,t)),this.contractAddresses.yearnLinearPoolFactory&&(f=Ta.connect(this.contractAddresses.yearnLinearPoolFactory,t)),this.contractAddresses.gyroConfigProxy&&(T=Jt.connect(this.contractAddresses.gyroConfigProxy,t)),this.instances={aaveLinearPoolFactory:c,balancerHelpers:n,BasePool:this.getBasePool,composableStablePoolFactory:l,ERC20:this.getErc20,erc4626LinearPoolFactory:y,eulerLinearPoolFactory:b,gaugeClaimHelper:d,gearboxLinearPoolFactory:m,gyroConfig:T,liquidityGauge:this.getLiquidityGauge,lidoRelayer:o,multicall:i,relayer:s,veBal:r,veBalProxy:p,weightedPoolFactory:u,yearnLinearPoolFactory:f,vault:a}}get contracts(){return this.instances}getErc20(e,t){return kt.connect(e,t)}getBasePool(e,t){return((e,t)=>new y.Contract(e,ns,t))(e,t)}}class ds{constructor(e,t){this.tokenPrices=e,this.tokenHistoricalPrices=t}async calcImpLoss(e,t){if(1e3*e>=Date.now())throw console.error(`[ImpermanentLossService][calcImpLoss]Error: ${Ba.getMessage(exports.BalancerErrorCode.TIMESTAMP_IN_THE_FUTURE)}`),new Ba(exports.BalancerErrorCode.TIMESTAMP_IN_THE_FUTURE);const a=await this.prepareData(e,t),n=this.getPoolValueDelta(a),o=this.getHoldValueDelta(a);return this.calculateImpermanentLoss(n,o)}calculateImpermanentLoss(e,t){return Math.floor(100*Math.abs(e/t-1)*100)/100}getPoolValueDelta(e){return e.reduce(((e,t)=>e*Math.pow(Math.abs(t.priceDelta+1),t.weight)),1)}getHoldValueDelta(e){return e.reduce(((e,t)=>e+Math.abs(t.priceDelta+1)*t.weight),0)}async prepareData(e,t){const a=t.tokens.filter((e=>e.address!==t.address)),n=this.getWeights(a),o=a.map((e=>e.address)),i=await this.getEntryPrices(e,o),s=await this.getExitPrices(a);return this.getAssets(a,s,i,n)}getAssets(e,t,a,n){return e.map(((e,o)=>({priceDelta:this.getDelta(a[e.address],t[e.address]),weight:n[o]})))}getDelta(e,t){if(0===e)throw console.error(`[ImpermanentLossService][getDelta]Error: ${Ba.getMessage(exports.BalancerErrorCode.ILLEGAL_PARAMETER)}: entry price is 0`),new Ba(exports.BalancerErrorCode.ILLEGAL_PARAMETER);return(t-e)/e}getWeights(e){const t=e.every((e=>!e.weight)),a=Math.round(1/e.length*100)/100,n=t?e.map((()=>a)):e.map((e=>{var t;return Number(null!==(t=e.weight)&&void 0!==t?t:0)}));if(n.some((e=>0===e)))throw console.error(`[ImpermanentLossService][getWeights]Error: ${Ba.getMessage(exports.BalancerErrorCode.MISSING_WEIGHT)}`),new Ba(exports.BalancerErrorCode.MISSING_WEIGHT);return n}async getExitPrices(e){var t;const a=await Promise.all(e.map((e=>this.tokenPrices.find(e.address)))).catch((()=>[]));if(!a.length||a.some((e=>void 0===(null==e?void 0:e.usd))))throw console.error(`[ImpermanentLossService][getExitPrices]Error: ${Ba.getMessage(exports.BalancerErrorCode.MISSING_PRICE_RATE)}`),new Ba(exports.BalancerErrorCode.MISSING_PRICE_RATE);const n=e.map(((e,t)=>({...e,price:a[t]}))),o={};for(const e of n)(null===(t=e.price)||void 0===t?void 0:t.usd)&&(o[e.address]=+e.price.usd);return o}async getEntryPrices(e,t){const a={};for(const n of t){const t=await this.tokenHistoricalPrices.findBy(n,e).catch((e=>{X.getInstance().warn(`[ImpermanentLossService][getEntryPrices]Error: ${e.message}`)}));if(!(null==t?void 0:t.usd)){throw X.getInstance().warn(`[ImpermanentLossService][getEntryPrices]Error: ${Ba.getMessage(exports.BalancerErrorCode.MISSING_PRICE_RATE)}`),new Ba(exports.BalancerErrorCode.MISSING_PRICE_RATE)}a[n]=+t.usd}return a}}const ls=145e3,us=1648465251,cs=31536e3,ys=2**(1/4),bs=(e=Math.round((new Date).getTime()/1e3))=>{const t=Math.floor((e-us)/cs);return ls*ys**-t},ms=e=>365*(ls*ys**-e/7);var fs=Object.freeze({__proto__:null,INITIAL_RATE:ls,START_EPOCH_TIME:us,weekly:bs,total:ms,between:(e,t)=>{if(e<us)throw"start timestamp before emission schedule deployment";if(t<e)throw"cannot finish before starting";let a=0;const n=Math.floor((e-us)/cs),o=Math.floor((t-us)/cs);for(let e=n;e<=o;e++)a+=ms(e);const i=us+cs*(n+1)-e,s=t-(us+cs*o);return a-=ms(n)*(cs-i)/cs,a-=ms(o)*(cs-s)/cs,a}});class Ts{constructor(e,t){this.repository=e,this.tokenPrices=t}async data(e=Date.now()){const t=await this.repository.multicallData(e),a=await this.tokenPrices.find(t.balAddress);if(!a||!a.usd)throw"No BAL USD price found";return{lastWeekBalRevenue:t.balAmount*parseFloat(a.usd),lastWeekBBAUsdRevenue:t.bbAUsdAmount*t.bbAUsdPrice,veBalSupply:t.veBalSupply}}}class hs{constructor(e){this.yesterdaysPools=e}async last24h(e){let t;return this.yesterdaysPools&&(t=await this.yesterdaysPools.find(e.id)),e.totalSwapFee?(null==t?void 0:t.totalSwapFee)?parseFloat(e.totalSwapFee)-parseFloat(t.totalSwapFee):e.createTime&&is(e.createTime)?parseFloat(e.totalSwapFee):0:0}}class Is{constructor(e,t,a,n,o,i,s,r,p){this.pools=e,this.tokenPrices=t,this.tokenMeta=a,this.tokenYields=n,this.feeCollector=o,this.yesterdaysPools=i,this.liquidityGauges=s,this.feeDistributor=r,this.gyroConfigRepository=p}async swapFees(e){const t=await this.last24hFees(e),a=await this.totalLiquidity(e);if(!t||!a)return 0;const n=t*(1-await this.protocolSwapFeePercentage(e))/parseFloat(a)*1e4;return Math.round(365*n)}async tokenAprs(e){if(!e.tokens)return{total:0,breakdown:{}};const t=await this.totalLiquidity(e),a=e.tokens.filter((t=>t.address!==e.address)),n=await Promise.all(a.map((async t=>{let a=0;const n=await this.tokenYields.find(t.address);if(n)a="MetaStable"===e.poolType||e.poolType.includes("Gyro")?n*(1-await this.protocolSwapFeePercentage(e)):"ComposableStable"===e.poolType||"Weighted"===e.poolType&&e.poolTypeVersion>=2?t.isExemptFromYieldProtocolFee?n:n*(1-parseFloat(e.protocolYieldFeeCache||"0.5")):n;else{const n=await this.pools.findBy("address",t.address);if(n){const o=await this.swapFees(n);let i=(await this.tokenAprs(n)).total;("ComposableStable"===e.poolType||"Weighted"===e.poolType&&2===e.poolTypeVersion)&&(t.isExemptFromYieldProtocolFee||(i*=1-parseFloat(e.protocolYieldFeeCache||"0.5"))),a=o+i}}return a}))),o=async e=>{var a,n,o,i,s;let r;if(e.weight)return parseFloat(e.weight);if(null===(n=null===(a=e.token)||void 0===a?void 0:a.pool)||void 0===n?void 0:n.poolType){const t=await this.pools.findBy("address",e.address);t&&(r=(await this.bptPrice(t)).toString())}else r=(null===(o=e.price)||void 0===o?void 0:o.usd)||(null===(i=await this.tokenPrices.find(e.address))||void 0===i?void 0:i.usd)||(null===(s=e.token)||void 0===s?void 0:s.latestUSDPrice);if(r){return parseFloat(e.balance)*parseFloat(r)/parseFloat(t)}throw`No price for ${e.address}`},i=await Promise.all(a.map((async(e,t)=>{if(0===n[t])return 0;try{const a=await o(e);return Math.round(n[t]*a)}catch(e){return X.getInstance().error(e),0}})));return{total:i.reduce(((e,t)=>e+t),0),breakdown:s.pickBy(s.zipObject(a.map((e=>e.address)),i),s.identity)}}async stakingApr(e,t=1){if(!this.liquidityGauges)return 0;const a=await this.liquidityGauges.findBy("poolId",e.id);if(!a||1==e.chainId&&0===a.workingSupply||e.chainId>1&&0===a.totalSupply||e.chainId>1&&0===a.balInflationRate)return 0;const n=ka[e.chainId].addresses.tokens.bal;if(!n)return 0;const[o,i]=await Promise.all([this.tokenPrices.find(n),this.bptPrice(e)]);if(!(null==o?void 0:o.usd))throw"Missing BAL price";if(a.balInflationRate){const e=86400*a.balInflationRate*365*parseFloat(o.usd)/(a.totalSupply*i);return Math.round(1e4*t*e)}if(e.chainId>1){if(!a.rewardTokens)return 0;const e=n&&a.rewardTokens[n];if(e){const t=await this.rewardTokenApr(n,e),o=a.totalSupply*i,s=t.value/o;return Math.round(1e4*s)}return 0}const s=parseFloat(o.usd),r=Math.round((new Date).getTime()/1e3),p=bs(r)/7*365*a.relativeWeight*s,d=(a.workingSupply+.4)/.4*i;return Math.round(1e4*t*p/d)}async rewardAprs(e){if(!this.liquidityGauges)return{total:0,breakdown:{}};const t=await this.liquidityGauges.findBy("poolId",e.id);if(!t||!t.rewardTokens||Object.keys(t.rewardTokens).length<1)return{total:0,breakdown:{}};const a=ka[e.chainId].addresses.tokens.bal,n=Object.keys(t.rewardTokens).filter((e=>e!=a)).map((async e=>{const a=t.rewardTokens[e];return this.rewardTokenApr(e,a)})),o=await this.bptPrice(e),i=t.totalSupply*o;if(0==i)return{total:0,breakdown:{}};const s={};let r=0;for await(const e of Object.values(n)){const t=e.value/i,a=Math.round(1e4*t);r+=a,s[e.address]=a}return{total:r,breakdown:s}}async protocolApr(e){if("0x5c6ee304399dbdb9c8ef030ab642b10820db8f56000200000000000000000014"!=e.id||!this.feeDistributor)return 0;const t=new Ts(this.feeDistributor,this.tokenPrices),{lastWeekBalRevenue:a,lastWeekBBAUsdRevenue:n,veBalSupply:o}=await t.data(),i=await this.bptPrice(e);if(!i)throw"bptPrice for veBal pool missing";const s=(a+n)/7;return Math.round(365*s*1e4/(i*o))}async apr(e){if(Ri.includes(e.id))return{swapFees:0,tokenAprs:{total:0,breakdown:{}},stakingApr:{min:0,max:0},rewardAprs:{total:0,breakdown:{}},protocolApr:0,min:0,max:0};const[t,a,n,o,i,s]=await Promise.all([this.swapFees(e),this.tokenAprs(e),this.stakingApr(e),this.stakingApr(e,2.5),this.rewardAprs(e),this.protocolApr(e)]);return{swapFees:t,tokenAprs:a,stakingApr:{min:n,max:o},rewardAprs:i,protocolApr:s,min:t+a.total+i.total+n,max:t+a.total+i.total+s+o}}async last24hFees(e){return new hs(this.yesterdaysPools).last24h(e)}async totalLiquidity(e){try{const t=new vn(this.pools,this.tokenPrices);return await t.getLiquidity(e)}catch(t){return X.getInstance().warn("Liquidity calculcation failed, falling back to subgraph"),e.totalLiquidity}}async bptPrice(e){return parseFloat(await this.totalLiquidity(e))/parseFloat(e.totalShares)}async protocolSwapFeePercentage(e){let t;return t="ComposableStable"==e.poolType||"Weighted"==e.poolType&&2==e.poolTypeVersion?0:e.poolType.includes("Gyro")&&this.gyroConfigRepository?await this.gyroConfigRepository.getGyroProtocolFee(e.address):e.protocolSwapFeeCache?parseFloat(e.protocolSwapFeeCache):await this.feeCollector.find("")||0,t}async rewardTokenApr(e,t){if(t.period_finish.toNumber()<Date.now()/1e3)return{address:e,value:0};{const a=t.rate.mul(86400).mul(365),n=await this.tokenPrices.find(e);if(n&&n.usd){let o=18;if(t.decimals)o=t.decimals;else{const t=await this.tokenMeta.find(e);o=(null==t?void 0:t.decimals)||18}return{address:e,value:parseFloat(Oe(a,o))*parseFloat(n.usd)}}throw`No USD price for ${e}`}}}const gs=Object.values(exports.PoolType),xs=new Map;gs.forEach((e=>{e.includes("Linear")&&gs.includes(e)&&xs.set(e,"batchSwap")})),xs.set(exports.PoolType.Element,"batchSwap"),xs.set(exports.PoolType.Investment,"joinPool"),xs.set(exports.PoolType.LiquidityBootstrapping,"joinPool"),xs.set(exports.PoolType.MetaStable,"joinPool"),xs.set(exports.PoolType.Stable,"joinPool"),xs.set(exports.PoolType.StablePhantom,"batchSwap"),xs.set(exports.PoolType.Weighted,"joinPool"),xs.set(exports.PoolType.ComposableStable,"joinPool");const _s=new Map;gs.forEach((e=>{e.includes("Linear")&&gs.includes(e)&&_s.set(e,"batchSwap")})),_s.set(exports.PoolType.Element,"batchSwap"),_s.set(exports.PoolType.Investment,"exitPool"),_s.set(exports.PoolType.LiquidityBootstrapping,"exitPool"),_s.set(exports.PoolType.MetaStable,"exitPool"),_s.set(exports.PoolType.Stable,"exitPool"),_s.set(exports.PoolType.StablePhantom,"batchSwap"),_s.set(exports.PoolType.Weighted,"exitPool"),_s.set(exports.PoolType.ComposableStable,"exitPool");class ws{constructor(e){this.pools=e,this.getGraphNodes=async(e,t,a)=>{if(!await this.pools.find(t))throw new Ba(exports.BalancerErrorCode.POOL_DOESNT_EXIST);const n=await this.buildGraphFromRootPool(t,a);if(n.id!==t)throw new Error("Error creating graph nodes");return e?ws.orderByBfs(n).reverse():ws.orderByBfs(n)}}async buildGraphFromRootPool(e,a){const n=await this.pools.find(e);if(!n)throw new Ba(exports.BalancerErrorCode.POOL_DOESNT_EXIST);return(await this.buildGraphFromPool(n.address,0,void 0,t.WeiPerEther,a))[0]}getTokenTotal(e){const a=e.tokensList.indexOf(e.address);let n=t.Zero;const{balancesEvm:o}=be(e);return o.forEach(((e,t)=>{a!==t&&(n=n.add(e))})),n}async buildGraphFromPool(e,n,o,i,s){var r;const p=await this.pools.findBy("address",e);if(!p){if(o){const t=await this.pools.findBy("address",o.address),a=t.tokensList.indexOf(e),s=null!==(r=t.tokens[a].decimals)&&void 0!==r?r:18,{balancesEvm:p}=be(t);return ws.createInputTokenNode(n,e,s,o,i,p[a].toString())}throw new Ba(exports.BalancerErrorCode.POOL_DOESNT_EXIST)}const d=xs.get(p.poolType),l=_s.get(p.poolType);if(!d||!l)throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE);const u=this.getTokenTotal(p),{spotPriceCalculator:c}=En.from(p.poolType),y={};let b=18;p.tokens.forEach((e=>{if(Je(e.address,p.address))return void(b=e.decimals?e.decimals:18);const t=c.calcPoolSpotPrice(e.address,p.address,p);y[e.address]=t}));let m={address:p.address,id:p.id,type:p.poolType,joinAction:d,exitAction:l,isProportionalExit:!1,children:[],marked:!1,index:n.toString(),parent:o,proportionOfParent:i,isLeaf:!1,spotPrices:y,decimals:b,balance:p.totalShares,priceRate:t.WeiPerEther.toString()};if(this.updateNodeIfProportionalExit(p,m),n++,p.poolType.toString().includes("Linear"))[m,n]=this.createLinearNodeChildren(m,n,p,s);else{const{balancesEvm:e}=be(p);for(let t=0;t<p.tokens.length;t++){if(Je(p.tokens[t].address,p.address))continue;let o;if("Weighted"===p.poolType){const e=p.tokens[t].weight;o=a.parseFixed(e,18)}else o=a.BigNumber.from(e[t]).mul(1e18.toString()).div(u);const r=o.mul(i).div(1e18.toString()),d=await this.buildGraphFromPool(p.tokens[t].address,n,m,r,s);n=d[1],d[0]&&m.children.push(d[0])}}return[m,n]}updateNodeIfProportionalExit(e,t){(e.poolType===exports.PoolType.Weighted||e.poolType===exports.PoolType.ComposableStable&&e.poolTypeVersion>2)&&(t.isProportionalExit=!0)}createLinearNodeChildren(e,t,a,n){var o;if(void 0===a.mainIndex)throw new Error("Issue With Linear Pool");if(n.map((e=>e.toLowerCase())).includes(a.tokensList[a.mainIndex].toLowerCase())){const n=this.createWrappedTokenNode(a,t,e,e.proportionOfParent);return e.children.push(n[0]),[e,n[1]]}{const{balancesEvm:n}=be(a),i=null!==(o=a.tokens[a.mainIndex].decimals)&&void 0!==o?o:18,s=ws.createInputTokenNode(t,a.tokensList[a.mainIndex],i,e,e.proportionOfParent,n[a.mainIndex].toString());return e.children.push(s[0]),[e,t=s[1]]}}createWrappedTokenNode(e,t,a,n){var o;if(void 0===e.wrappedIndex||void 0===e.mainIndex)throw new Error("Issue With Linear Pool");const{balancesEvm:i,upScaledBalances:s,scalingFactorsRaw:r,priceRates:p}=be(e),d={type:"WrappedToken",address:e.tokensList[e.wrappedIndex],id:"N/A",children:[],marked:!1,joinAction:"wrap",exitAction:"unwrap",isProportionalExit:!1,index:t.toString(),parent:a,proportionOfParent:n,isLeaf:!1,spotPrices:{},decimals:18,balance:i[e.wrappedIndex].toString(),priceRate:p[e.wrappedIndex].toString()};t++;const l=null!==(o=e.tokens[e.mainIndex].decimals)&&void 0!==o?o:18,u=le(s[e.wrappedIndex],r[e.mainIndex]).toString(),c=ws.createInputTokenNode(t,e.tokensList[e.mainIndex],l,d,n,u);return d.children=[c[0]],[d,t=c[1]]}static createInputTokenNode(e,a,n,o,i,s){return[{address:a,id:"N/A",type:"Input",children:[],marked:!1,joinAction:"input",exitAction:"output",isProportionalExit:!1,index:e.toString(),parent:o,proportionOfParent:i,isLeaf:!0,spotPrices:{},decimals:n,balance:s,priceRate:t.WeiPerEther.toString()},e+1]}static orderByBfs(e){const t=[],a=[];for(e.marked=!0,t.push(e);t.length>0;){const e=t.shift();e&&a.push(e),null==e||e.children.forEach((e=>{e.marked||(e.marked=!0,t.push(e))}))}return a}static getLeafAddresses(e){return e.filter((e=>e.isLeaf)).map((e=>e.address))}static isProportionalPools(e){return e.every((e=>!(e.children.length>1)||e.isProportionalExit))}}class Ps{constructor(){}}Ps.joinInit=t=>e.defaultAbiCoder.decode(["uint256","uint256[]"],t),Ps.joinExactTokensInForBPTOut=t=>e.defaultAbiCoder.decode(["uint256","uint256[]","uint256"],t),Ps.joinTokenInForExactBPTOut=t=>e.defaultAbiCoder.decode(["uint256","uint256","uint256"],t),Ps.joinAllTokensInForExactBPTOut=t=>e.defaultAbiCoder.decode(["uint256","uint256"],t),Ps.exitExactBPTInForOneTokenOut=t=>e.defaultAbiCoder.decode(["uint256","uint256","uint256"],t),Ps.exitExactBPTInForTokensOut=t=>e.defaultAbiCoder.decode(["uint256","uint256"],t),Ps.exitBPTInForExactTokensOut=t=>e.defaultAbiCoder.decode(["uint256","uint256[]","uint256"],t);class Es{constructor(e){this.relayerModel=e}joinKind(t){const a=e.defaultAbiCoder.decode(["uint256"],t)[0];if(!a)throw new Error("No exit kind.");return a.toNumber()}decodeJoinData(e,t){if(t===exports.WeightedPoolJoinKind.ALL_TOKENS_IN_FOR_EXACT_BPT_OUT){return Ps.joinAllTokensInForExactBPTOut(e).toString()}if(t===exports.WeightedPoolJoinKind.EXACT_TOKENS_IN_FOR_BPT_OUT){const[,t]=Ps.joinExactTokensInForBPTOut(e);return t}if(t===exports.WeightedPoolJoinKind.TOKEN_IN_FOR_EXACT_BPT_OUT){const[,t,a]=Ps.joinTokenInForExactBPTOut(e);return[t.toString(),a]}throw new Error("Non supported join data")}allTokensInForExactBPTOut(){throw new Error("joinAllTokensInForExactBPTOut not supported")}joinExactTokensInForBPTOut(e,t){const n=this.decodeJoinData(e,exports.WeightedPoolJoinKind.EXACT_TOKENS_IN_FOR_BPT_OUT),o=this.relayerModel.doChainedRefReplacements(n),i=t._calcBptOutGivenExactTokensIn(o.map((e=>a.BigNumber.from(e))));if("StablePhantom"==t.SubgraphType||"ComposableStable"==t.SubgraphType){const e=t.tokens.find((e=>Je(e.address,t.address)));if(!e)throw new Error("Pool does not contain BPT as a token");const n=a.parseFixed(e.balance.toString(),e.decimals);t.updateTokenBalanceForPool(t.address,n.sub(i))}else t.updateTokenBalanceForPool(t.address,t.totalShares.add(i));const s=t.tokens.filter((e=>!Je(e.address,t.address)));return o.forEach(((e,n)=>{const o=a.parseFixed(s[n].balance.toString(),s[n].decimals);t.updateTokenBalanceForPool(s[n].address,o.add(e))})),[i.toString(),s.map((e=>e.address)),o]}joinTokenInForExactBPTOut(e,t){const[n,o]=this.decodeJoinData(e,exports.WeightedPoolJoinKind.TOKEN_IN_FOR_EXACT_BPT_OUT),i=this.relayerModel.doChainedRefReplacement(n),s=t.parsePoolPairData(t.tokensList[Number(o)],t.address),r=a.formatFixed(i,18),d=t._tokenInForExactTokenOut(s,p.bnum(r.toString())).dp(s.decimalsIn),l=a.parseFixed(d.toString(),s.decimalsIn);return t.updateTokenBalanceForPool(s.tokenIn,s.balanceIn.add(l)),t.updateTokenBalanceForPool(s.tokenOut,s.balanceOut.add(i)),[l.toString(),s.tokenIn,l.toString()]}async doJoinPool(e,a){const n=a[e.poolId],o=this.joinKind(e.encodedUserData);let i="0",s=[],r=[];if(o===exports.WeightedPoolJoinKind.ALL_TOKENS_IN_FOR_EXACT_BPT_OUT)i=this.allTokensInForExactBPTOut();else if(o===exports.WeightedPoolJoinKind.EXACT_TOKENS_IN_FOR_BPT_OUT)[i,s,r]=this.joinExactTokensInForBPTOut(e.encodedUserData,n);else{if(o!==exports.WeightedPoolJoinKind.TOKEN_IN_FOR_EXACT_BPT_OUT)throw new Error("Exit type not implemented");{let t,a;[i,t,a]=this.joinTokenInForExactBPTOut(e.encodedUserData,n),s.push(t),r.push(a)}}return s.push(n.address),r.push(t.Zero.sub(i).toString()),e.outputReference&&es.isChainedReference(e.outputReference)&&this.relayerModel.setChainedReferenceValue(e.outputReference,i),[s,r]}}class vs{constructor(e){this.relayerModel=e}exitKind(t,a){const n=e.defaultAbiCoder.decode(["uint256"],a)[0];if(!n)throw new Error("No exit kind.");return"ComposableStable"===t?n.toNumber()===exports.ComposableStablePoolExitKind.BPT_IN_FOR_EXACT_TOKENS_OUT?exports.WeightedPoolExitKind.BPT_IN_FOR_EXACT_TOKENS_OUT:n.toNumber()===exports.ComposableStablePoolExitKind.EXACT_BPT_IN_FOR_ALL_TOKENS_OUT?exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_TOKENS_OUT:exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_ONE_TOKEN_OUT:n.toNumber()}decodeExitData(e,t){if(t===exports.WeightedPoolExitKind.BPT_IN_FOR_EXACT_TOKENS_OUT){const[,t,a]=Ps.exitBPTInForExactTokensOut(e);return[t.toString(),a.toString()]}if(t===exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_ONE_TOKEN_OUT){const[,t,a]=Ps.exitExactBPTInForOneTokenOut(e);return[t.toString(),a.toString()]}if(t===exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_TOKENS_OUT){const[,t]=Ps.exitExactBPTInForTokensOut(e);return[t.toString()]}throw new Error("Non supported exit data")}exactBptInForTokensOut(e,t){const[n]=this.decodeExitData(e,exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_TOKENS_OUT),o=this.relayerModel.doChainedRefReplacement(n),i=t._calcTokensOutGivenExactBptIn(a.BigNumber.from(o)).map((e=>e.toString()));if("StablePhantom"==t.SubgraphType||"ComposableStable"==t.SubgraphType){const e=t.tokens.find((e=>Je(e.address,t.address)));if(!e)throw new Error("Pool does not contain BPT as a token");const n=a.parseFixed(e.balance.toString(),e.decimals);t.updateTokenBalanceForPool(t.address,n.add(o))}else t.updateTokenBalanceForPool(t.address,t.totalShares.sub(o));const s=t.tokens.filter((e=>!Je(e.address,t.address)));return i.forEach(((e,n)=>{const o=a.parseFixed(s[n].balance.toString(),s[n].decimals);t.updateTokenBalanceForPool(s[n].address,o.sub(e))})),[o,s.map((e=>e.address)),i]}exactBptInForOneTokenOut(e,t){const[n,o]=this.decodeExitData(e,exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_ONE_TOKEN_OUT),i=this.relayerModel.doChainedRefReplacement(n),s=t.parsePoolPairData(t.address,t.tokensList[Number(o)]),r=a.formatFixed(i,s.decimalsIn),d=t._exactTokenInForTokenOut(s,p.bnum(r)).dp(s.decimalsOut),l=a.parseFixed(d.toString(),s.decimalsOut),u=function(e,t){const n=[];return t.forEach((t=>{const o=e.tokens.findIndex((e=>Je(e.address,t)));if(o<0)throw"Pool does not contain tokenIn";n.push(a.parseFixed(e.tokens[o].balance,e.tokens[o].decimals).toString())})),n}(t,[t.address,s.tokenOut]);t.updateTokenBalanceForPool(s.tokenOut,a.BigNumber.from(u[1]).sub(l)),"StablePhantom"==t.SubgraphType||"ComposableStable"==t.SubgraphType?t.updateTokenBalanceForPool(t.address,a.BigNumber.from(u[0]).add(i)):t.updateTokenBalanceForPool(t.address,t.totalShares.sub(i));const c=t.tokensList.filter((e=>!Je(e,t.address))),y=new Array(c.length).fill("0");return y[Number(o)]=l.toString(),[i,c,y]}async doExitPool(e,a){const n=a[e.poolId],o=this.exitKind(n.SubgraphType,e.encodedUserData);let i,s=[],r=[];const p=[],d=[];if(o===exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_TOKENS_OUT)[i,r,s]=this.exactBptInForTokensOut(e.encodedUserData,n);else{if(o!==exports.WeightedPoolExitKind.EXACT_BPT_IN_FOR_ONE_TOKEN_OUT)throw new Error("Exit type not implemented");[i,r,s]=this.exactBptInForOneTokenOut(e.encodedUserData,n)}for(let t=0;t<e.outputReferences.length;t++){const a=n.tokensList[e.outputReferences[t].index],o=r.indexOf(a);if(-1===o)throw new Error("Token out not found");this.relayerModel.setChainedReferenceValue(e.outputReferences[t].key.toString(),s[o])}return p.push(n.address,...r),d.push(i,...s.map((e=>t.Zero.sub(e).toString()))),[p,d]}}class Ss{constructor(e){this.relayerModel=e}async doSingleSwap(e,a){const n=this.relayerModel.doChainedRefReplacement(e.request.amount.toString()),o=a[e.request.poolId],[,i]=this.doSwap(e.request.assetIn,e.request.assetOut,o,e.request.kind,n),s=t.Zero.sub(i);if(!e.outputReference)throw new Error("Missing outputReference");return this.relayerModel.setChainedReferenceValue(e.outputReference.toString(),s.abs().toString()),[s.toString(),n]}async doBatchSwap(e,a){const n=e.assets,o=new Array(n.length).fill(t.Zero);let i;for(let t=0;t<e.swaps.length;++t){const a=e.swaps[t].amount;es.isChainedReference(a)&&(e.swaps[t].amount=this.relayerModel.getChainedReferenceValue(a))}e.swaps.forEach((t=>{const s=n[t.assetInIndex],r=n[t.assetOutIndex],p=a[t.poolId];let d=t.amount;"0"===d&&(d=i);const[l,u]=this.doSwap(s,r,p,e.swapType,d);i=e.swapType===exports.SwapType.SwapExactIn?u.toString():l.toString(),o[t.assetInIndex]=o[t.assetInIndex].add(l),o[t.assetOutIndex]=o[t.assetOutIndex].sub(u)}));for(let t=0;t<e.outputReferences.length;t++)this.relayerModel.setChainedReferenceValue(e.outputReferences[t].key.toString(),o[e.outputReferences[t].index].abs().toString());return o.map((e=>e.toString()))}doSwap(e,n,o,i,s){const r=o.parsePoolPairData(e,n),d=i===exports.SwapType.SwapExactIn;let l=d?a.BigNumber.from(s):t.Zero,u=d?t.Zero:a.BigNumber.from(s);const c=a.formatFixed(l,r.decimalsIn),y=a.formatFixed(u,r.decimalsOut);if(d){const e=o._exactTokenInForTokenOut(r,p.bnum(c.toString())).dp(r.decimalsOut);u=a.parseFixed(e.toString(),r.decimalsOut)}else{const e=o._tokenInForExactTokenOut(r,p.bnum(y.toString())).dp(r.decimalsIn);l=a.parseFixed(e.toString(),r.decimalsIn)}return o.updateTokenBalanceForPool(r.tokenIn,r.balanceIn.add(l)),o.updateTokenBalanceForPool(r.tokenOut,r.balanceOut.sub(u)),[l,u]}}class As{constructor(e){this.relayerModel=e}async doUnwrap(e,n){const o=n[e.poolId],i=o.tokens[o.wrappedIndex],s=o.tokens[o.mainIndex],r=this.relayerModel.doChainedRefReplacement(e.amount.toString()),p=ce.divDownFixed(ce.mulDownFixed(BigInt(r),a.parseFixed(i.priceRate,18).toBigInt()),t.WeiPerEther.toBigInt()).toString();this.relayerModel.setChainedReferenceValue(e.outputReference.toString(),p);return[[i.address,s.address],[r,t.Zero.sub(p).toString()]]}}class ks{constructor(e){this.relayerModel=e,this.joinModel=new Es(e),this.exitModel=new vs(e),this.swapModel=new Ss(e),this.unwrapModel=new As(e)}async doJoin(e,t){return this.joinModel.doJoinPool(e,t)}async doExit(e,t){return this.exitModel.doExitPool(e,t)}async doBatchSwap(e,t){return this.swapModel.doBatchSwap(e,t)}async doSingleSwap(e,t){return this.swapModel.doSingleSwap(e,t)}async doUnwrap(e,t){return this.unwrapModel.doUnwrap(e,t)}}class Os{constructor(){this.chainedRefs={}}setChainedReferenceValue(e,t){this.chainedRefs[e]=t}getChainedReferenceValue(e){return this.chainedRefs[e]}doChainedRefReplacement(e){return es.isChainedReference(e.toString())?this.getChainedReferenceValue(e.toString()):e}doChainedRefReplacements(e){return e.map((e=>this.doChainedRefReplacement(e).toString()))}}class Cs{constructor(e,t){this.poolDataService=e,this.wrappedNativeAsset=t,this.poolsArray=[],this.poolsDict={}}dataSource(){return this.poolDataService}async all(e=!1){if(e||0===this.poolsArray.length){const e=s.cloneDeep(await this.dataSource().getPools());for(const t of e)if(["Weighted","Investment","Stable","LiquidityBootstrapping"].includes(t.poolType)){const e={address:t.address,balance:t.totalShares,decimals:18,priceRate:"1",weight:"0"};t.tokens.push(e),t.tokensList.push(t.address)}this.poolsArray=e}return this.poolsArray}parseToPoolsDict(e){return Object.fromEntries(s.cloneDeep(e).filter((e=>e.tokensList.length>0&&"0"!==e.tokens[0].balance)).map((e=>[e.id,this.parseNewPool(e)])).filter((([,e])=>void 0!==e)))}parseNewPool(e){if(!e.swapEnabled)return;let t={};try{if(["Weighted","Investment","LiquidityBootstrapping"].includes(e.poolType)){t=p.WeightedPool.fromPool(e,!1)}else if("Stable"===e.poolType){t=p.StablePool.fromPool(e)}else if("MetaStable"===e.poolType){t=p.MetaStablePool.fromPool(e)}else if(e.poolType.toString().includes("Linear")){t=p.LinearPool.fromPool(e)}else if("StablePhantom"===e.poolType){t=p.PhantomStablePool.fromPool(e)}else{if("ComposableStable"!==e.poolType){return void X.getInstance().warn(`Unknown pool type or type field missing: ${e.poolType} ${e.id}`)}t=p.ComposableStablePool.fromPool(e)}if(!t)throw new Error("Issue with Pool");t.SubgraphType=e.poolType}catch(e){return void console.error("Error parseNewPool")}return t}async poolsDictionary(e=!1){if(e||0===Object.keys(this.poolsDict).length){const t=await this.all(e);this.poolsDict=this.parseToPoolsDict(t)}return this.poolsDict}}var Bs,Ms;!function(e){e[e.BatchSwap=0]="BatchSwap",e[e.Join=1]="Join",e[e.Exit=2]="Exit",e[e.Swap=3]="Swap",e[e.Unwrap=4]="Unwrap"}(Bs||(Bs={}));class Fs{constructor(e,t){this.poolsSource=new Cs(e,t)}updateDeltas(e,a,n){return a.forEach(((a,o)=>{e[a]||(e[a]=t.Zero),e[a]=e[a].add(n[o])})),e}async multicall(e,t=!1){const a=new Os,n=new ks(a),o=await this.poolsSource.poolsDictionary(t),i={};for(const t of e){let e=[],a=[];switch(t.actionType){case Bs.Join:[e,a]=await n.doJoin(t,o);break;case Bs.Exit:[e,a]=await n.doExit(t,o);break;case Bs.BatchSwap:e=t.assets,a=await n.doBatchSwap(t,o);break;case Bs.Swap:e=[t.request.assetOut,t.request.assetIn],a=await n.doSingleSwap(t,o);break;case Bs.Unwrap:[e,a]=await n.doUnwrap(t,o)}this.updateDeltas(i,e,a)}return i}static mapSwapRequest(e){return{actionType:Bs.Swap,request:e.request,funds:e.funds,outputReference:e.outputReference}}static mapBatchSwapRequest(e){return{actionType:Bs.BatchSwap,swaps:e.swaps,assets:e.assets,funds:e.funds,swapType:e.swapType,outputReferences:e.outputReferences}}static mapJoinPoolRequest(e){return{actionType:Bs.Join,poolId:e.poolId,encodedUserData:e.joinPoolRequest.userData,outputReference:e.outputReference}}static mapExitPoolRequest(e){return{actionType:Bs.Exit,poolId:e.poolId,encodedUserData:e.exitPoolRequest.userData,outputReferences:e.outputReferences}}static mapUnwrapRequest(e,t,a){return{actionType:Bs.Unwrap,poolId:a,amount:e,outputReference:t}}}const Rs=It.createInterface();function Ns(e){X.getInstance()}class Ds{constructor(e,n,o){this.poolGraph=e,this.simulationService=o,this.createCalls=async(e,t,a,n,o)=>{const{multiRequests:i,encodedCalls:s,outputIndexes:r,deltas:p}=this.createActionCalls(e,t,a,n);o&&s.unshift(this.createSetRelayerApproval(o));return{multiRequests:i,encodedCall:Rs.encodeFunctionData("multicall",[s]),outputIndexes:o?r.map((e=>e+1)):r,deltas:p}},this.amountsOutByJoinPath=async(e,n,o,i,s,r,p,d)=>{const l=await this.simulationService.simulateGeneralisedJoin(this.relayer,n,o,s,e,i,r,p,d),u=l.reduce(((e,t)=>e.add(a.BigNumber.from(t))),t.Zero).toString();return{amountsOut:l,totalAmountOut:u}},this.minAmountsOutByJoinPath=(e,t,n)=>({minAmountsOut:t.map((t=>He(a.BigNumber.from(t),a.BigNumber.from(e)).toString())),totalMinAmountOut:He(a.BigNumber.from(n),a.BigNumber.from(e)).toString()}),this.createActionCalls=(e,t,a,n)=>{const o=[],i=[],s=[],r=!n,p={};return e.forEach(((e,d)=>{const l=e[0].isLeaf,u=[];if(e.forEach(((o,s)=>{var c,y;if(o.children.length>0&&0===o.children.filter((e=>this.shouldBeConsidered(e))).length)return void(o.index="0");const b=o.children.filter((e=>this.shouldBeConsidered(e))).some((e=>"input"===e.joinAction))?t:this.relayer,m=s===e.length-1,f=null!==(y=l&&(null===(c=o.parent)||void 0===c?void 0:c.children.filter((e=>this.shouldBeConsidered(e))).some((e=>"input"===e.joinAction))))&&void 0!==y&&y,T=m||f?t:this.relayer,h=m&&n?n[d]:"0";switch(o.joinAction){case"batchSwap":{const{modelRequest:e,encodedCall:t,assets:n,amounts:s}=this.createSwap(o,d,h,b,T,a,r);u.push(e),i.push(t),this.updateDeltas(p,n,s)}break;case"joinPool":{const{modelRequest:e,encodedCall:t,assets:n,amounts:s,minBptOut:l}=this.createJoinPool(o,d,h,b,T,a,r);u.push(e),i.push(t),this.updateDeltas(p,[o.address,...n],[l,...s])}break;default:return}})),r){const e=100*d,t=es.encodePeekChainedReferenceValue(es.toChainedReference(e,!1));i.push(t),s.push(i.indexOf(t))}o.push(u)})),{multiRequests:o,encodedCalls:i,outputIndexes:s,deltas:p}},this.createSetRelayerApproval=e=>es.encodeSetRelayerApproval(this.relayer,!0,e),this.createSwap=(e,n,o,i,s,r,p)=>{var d;if(1!==e.children.length)throw new Error("Unsupported swap");const l=e.children[0].address,u=this.getOutputRefValue(n,e.children[0]),c=o,y=r&&!p?this.replaceWrappedNativeAsset([l])[0]:l,b={poolId:e.id,kind:exports.SwapType.SwapExactIn,assetIn:y,assetOut:e.address,amount:u.value,userData:"0x"},m={sender:i,recipient:s,fromInternalBalance:this.allImmediateChildrenSendToInternal(e),toInternalBalance:this.allSiblingsSendToInternal(e)},f=a.BigNumber.from(this.getOutputRefValue(n,e).value),T=r&&!p?Ue([y],[u.value]):t.Zero,h={request:b,funds:m,limit:c,deadline:a.BigNumber.from(Math.ceil(Date.now()/1e3)+3600),value:T,outputReference:f},I=es.encodeSwap(h);Ns(),Ns(JSON.stringify(h)),Ns(JSON.stringify(null===(d=h.value)||void 0===d?void 0:d.toString()));const g=Fs.mapSwapRequest(h),x=e.children.some((e=>"input"===e.joinAction))?u.value:"0",_=null!=e.parent?"0":a.BigNumber.from(o).mul(-1).toString();return{modelRequest:g,encodedCall:I,assets:[e.address,l],amounts:[_,x]}},this.createJoinPool=(e,a,n,o,i,s,r)=>{var p;const d=[],l=[];e.children.forEach((e=>{d.push(e.address),this.shouldBeConsidered(e)?l.push(this.getOutputRefValue(a,e).value):l.push("0")})),e.type===exports.PoolType.ComposableStable&&(d.push(e.address),l.push("0"));const u=new j(this.wrappedNativeAsset),[c,y]=u.sortTokens(d,l);let b=[];const m=c.map((e=>e.toLowerCase())).indexOf(e.address.toLowerCase());let f;b=-1===m?y:[...y.slice(0,m),...y.slice(m+1)],f=e.type===exports.PoolType.Weighted?S.joinExactTokensInForBPTOut(b,n):v.joinExactTokensInForBPTOut(b,n);const T=s&&!r?Ue(this.replaceWrappedNativeAsset(c),y):t.Zero,h=this.allImmediateChildrenSendToInternal(e),I=es.formatJoinPoolInput({poolId:e.id,kind:0,sender:o,recipient:i,value:T,outputReference:this.getOutputRefValue(a,e).value,joinPoolRequest:{},assets:s&&!r?this.replaceWrappedNativeAsset(c):c,maxAmountsIn:y,userData:f,fromInternalBalance:h}),g=es.encodeJoinPool(I);Ns(),Ns(JSON.stringify(I)),Ns(JSON.stringify(null===(p=I.value)||void 0===p?void 0:p.toString()));const x=Fs.mapJoinPoolRequest(I),_=y.map((e=>es.isChainedReference(e)?"0":e)),w=es.isChainedReference(n)?"0":n,P=e.children.filter((e=>this.shouldBeConsidered(e))).some((e=>"input"===e.joinAction));return{modelRequest:x,encodedCall:g,assets:P?c:[],amounts:P?_:[],minBptOut:null!=e.parent?t.Zero.toString():t.Zero.sub(w).toString()}},this.getOutputRefValue=(e,t)=>"input"===t.joinAction?{value:t.index,isRef:!1}:"0"===t.index&&t.parent?{value:"0",isRef:!0}:{value:es.toChainedReference(a.BigNumber.from(t.index).add(100*e)).toString(),isRef:!0},this.shouldBeConsidered=e=>"0"!==e.index,this.sendsToInternalBalance=e=>"input"!==e.joinAction&&"joinPool"!==e.joinAction,this.allImmediateChildrenSendToInternal=e=>{const t=e.children.filter((e=>this.shouldBeConsidered(e)));return 0!==t.length&&t.filter((e=>this.sendsToInternalBalance(e))).length===t.length},this.allSiblingsSendToInternal=e=>{if(!e.parent)return!1;const t=e.parent.children.filter((e=>this.shouldBeConsidered(e)));return t.filter((e=>this.sendsToInternalBalance(e))).length===t.length},this.replaceWrappedNativeAsset=e=>{const a=e.findIndex((e=>e.toLowerCase()===this.wrappedNativeAsset.toLowerCase()));return Ye(e,a,t.AddressZero)};const{tokens:i,contracts:s}=Oa(n.chainId);this.relayer=s.balancerRelayer,this.wrappedNativeAsset=i.wrappedNativeAsset}checkInputs(e,a){if(0===e.length)throw new Ba(exports.BalancerErrorCode.MISSING_TOKENS);if(a.every((e=>"0"===e)))throw new Ba(exports.BalancerErrorCode.JOIN_WITH_ZERO_AMOUNT);if(e.length!=a.length)throw new Ba(exports.BalancerErrorCode.INPUT_LENGTH_MISMATCH);if(e.some((e=>e===t.AddressZero))&&e.some((e=>e.toLowerCase()===this.wrappedNativeAsset.toLowerCase())))throw new Ba(exports.BalancerErrorCode.INPUT_TOKEN_INVALID)}async joinPool(e,a,n,o,i,s,r,p){this.checkInputs(a,n);const d=await this.poolGraph.getGraphNodes(!0,e,[]),l=a.findIndex((e=>e===t.AddressZero)),u=-1!==l,c=Ye(a,l,this.wrappedNativeAsset.toLowerCase()),y=Ds.getJoinPaths(d,c,n),b=Ds.totalBptZeroPriceImpact(y);Ns();const{multiRequests:m,encodedCall:f,outputIndexes:T}=await this.createCalls(y,o,u,void 0,p),{amountsOut:h,totalAmountOut:I}=await this.amountsOutByJoinPath(o,m,f,c,T,s,r,"0"),{minAmountsOut:g,totalMinAmountOut:x}=this.minAmountsOutByJoinPath(i,h,I),_=Ma(BigInt(I),b.toBigInt(),!0).toString();Ns();const{encodedCall:w,deltas:P}=await this.createCalls(y,o,u,g,p),E=u?P[this.wrappedNativeAsset.toLowerCase()]:t.Zero;return Ns(E.toString()),this.assertDeltas(e,P,c,n,x),{to:this.relayer,encodedCall:w,expectedOut:I,minOut:x,priceImpact:_,value:E}}assertDeltas(e,t,n,o,i){var s;const r=R(e);if(t[r.toLowerCase()].add(i).abs().gt(3))throw console.error("join assertDeltas, bptOut: ",r,i,null===(s=t[r.toLowerCase()])||void 0===s?void 0:s.toString()),new Ba(exports.BalancerErrorCode.JOIN_DELTA_AMOUNTS);delete t[r.toLowerCase()],n.forEach(((e,n)=>{var i,s;if(!a.BigNumber.from(o[n]).eq(0)&&(null===(i=t[e.toLowerCase()])||void 0===i?void 0:i.toString())!==o[n])throw console.error("join assertDeltas, tokenIn: ",e,o[n],null===(s=t[e.toLowerCase()])||void 0===s?void 0:s.toString()),new Ba(exports.BalancerErrorCode.JOIN_DELTA_AMOUNTS);delete t[e.toLowerCase()]}));for(const e in t)if("0"!==t[e].toString())throw console.error("join assertDeltas, non-input token should be 0: ",e,t[e].toString()),new Ba(exports.BalancerErrorCode.JOIN_DELTA_AMOUNTS)}updateDeltas(e,a,n){return a.forEach(((a,o)=>{const i=a.toLowerCase();e[i]||(e[i]=t.Zero),e[i]=e[i].add(n[o])})),e}}Ms=Ds,Ds.getJoinPaths=(e,n,o)=>{const i=[],r=e.filter((e=>n.filter(((e,t)=>a.BigNumber.from(o[t]).gt(0))).map((e=>e.toLowerCase())).includes(e.address.toLowerCase())));r.some((e=>e.isLeaf))&&i.push(e);const p=r.filter((e=>!e.isLeaf));return p.forEach((e=>{const r=o.find(((t,a)=>Je(n[a],e.address))),d=p.filter((t=>Je(t.address,e.address))).reduce(((e,t)=>e.add(t.proportionOfParent)),a.BigNumber.from(0)),l=a.BigNumber.from(r).mul(e.proportionOfParent).div(d).toString(),[u]=ws.createInputTokenNode(0,e.address,e.decimals,e.parent,t.WeiPerEther,e.balance);u.index=l,u.isLeaf=!1;const c=[u];let y=u.parent,b=u;for(;y;){const e=s.cloneDeep(y);e.children=e.children.map((e=>e.address===b.address?b:{...e,index:"0"})),c.push(e),b=e,y=e.parent}i.push(c)})),Ms.updateInputAmounts(i,n,o),i},Ds.updateInputAmounts=(e,t,n)=>{const o=(e,t)=>{if(e.length>1){const n=e.reduce(((e,t)=>e.add(t.index)),a.BigNumber.from(0)),o=a.BigNumber.from(t).sub(n);e[0].index=o.add(e[0].index).toString()}},i=e.find((e=>e[0].isLeaf));if(i){const e=Ms.updateTotalProportions(i);i.forEach((a=>{"input"===a.joinAction&&(a=Ms.updateNodeAmount(a,t,n,e))})),t.forEach(((e,t)=>{const a=i.filter((t=>t.isLeaf&&Je(t.address,e)));o(a,n[t])}))}const s=e.filter((e=>!e[0].isLeaf));s.length>1&&t.forEach(((e,t)=>{const a=s.map((e=>e[0])).filter((t=>Je(t.address,e)));o(a,n[t])}))},Ds.totalBptZeroPriceImpact=e=>{let t=a.BigNumber.from("0");return e.forEach((e=>{if(e[0].isLeaf){e.filter((e=>e.isLeaf)).forEach((e=>{const a=Ms.bptOutZeroPiForInputNode(e);t=t.add(a)}))}else{const a=Ms.bptOutZeroPiForInputNode(e[0]);t=t.add(a)}})),t},Ds.bptOutZeroPiForInputNode=e=>{if("0"===e.index||"input"!==e.joinAction)return BigInt(0);let t=1,n=e.parent,o=e.address;for(;void 0!==n;){if("batchSwap"===n.joinAction||"joinPool"===n.joinAction){const e=n.spotPrices[o.toLowerCase()];t*=parseFloat(e),o=n.address}n=n.parent}const i=a.parseFixed(t.toFixed(18),18),s=re(BigInt(e.decimals)),r=pe(BigInt(e.index),s);return ce.divDownFixed(r,i.toBigInt())},Ds.updateTotalProportions=e=>{const t={};return e.forEach((e=>{t[e.address]?t[e.address]=t[e.address].add(e.proportionOfParent):t[e.address]=e.proportionOfParent})),t},Ds.updateNodeAmount=(e,t,a,n)=>{const o=t.map((e=>e.toLowerCase())).indexOf(e.address.toLowerCase());if(-1===o)return e.index="0",e;const i=n[e.address],s=e.proportionOfParent.mul(1e18.toString()).div(i).mul(a[o]).div(1e18.toString());return e.index=s.toString(),e};class Ls{constructor(e,n){this.chainId=e,this.simulateMulticall=async(e,t,a,n,o="0")=>{const i={...await this.encodeBalanceAndAllowanceOverrides(a,n),...await this.encodeRelayerApprovalOverride(a,e)};return this.simulateTransaction(e,t,a,i,o)},this.simulateTransaction=async(e,t,n,o,i)=>{const s=Object.fromEntries(Object.keys(o).map((e=>[e,{storage:o[e].value}]))),r={...s,[n]:{balance:a.parseFixed("100",18).toHexString()}},p={network_id:this.chainId.toString(),block_number:this.blockNumber,from:n,to:e,input:t,value:i,save_if_fails:!0,simulation_type:"quick",state_objects:r},d=this.tenderlyUrl+"simulate";return(await P.default.post(d,p,this.opts)).data.transaction.transaction_info.call_trace.output},this.encodeRelayerApprovalOverride=async(e,t)=>{const a={[`${this.vaultAddress}`]:{value:{[`_approvedRelayers[${e}][${t}]`]:(!0).toString()}}};return await this.requestStateOverrides(a)},this.encodeBalanceAndAllowanceOverrides=async(e,a)=>{const n=a.filter((e=>e!==t.AddressZero));if(0===n.length)return{};let o={};n.forEach((a=>o={...o,[`${a}`]:{value:{[`_balances[${e}]`]:t.MaxInt256.toString(),[`_allowances[${e}][${this.vaultAddress}]`]:t.MaxInt256.toString(),[`balanceOf[${e}]`]:t.MaxInt256.toString(),[`allowance[${e}][${this.vaultAddress}]`]:t.MaxInt256.toString(),[`balances[${e}]`]:t.MaxInt256.toString(),[`allowed[${e}][${this.vaultAddress}]`]:t.MaxInt256.toString()}}}));const i=await this.requestStateOverrides(o);if(Object.keys(i).some((e=>2!==Object.keys(i[e].value).length)))throw new Error("Couldn't encode state overrides - states should match the ones in the contracts");return i},this.requestStateOverrides=async e=>{const t=this.tenderlyUrl+"contracts/encode-states",a={networkID:this.chainId.toString(),stateOverrides:e},n=(await P.default.post(t,a,this.opts)).data.stateOverrides;if(!n||Object.keys(n).length!==Object.keys(e).length)throw new Error("Couldn't encode state overrides - contracts should be verified and whitelisted on Tenderly");return n};const{contracts:o}=Oa(this.chainId);this.vaultAddress=o.vault,this.tenderlyUrl=`https://api.tenderly.co/api/v1/account/${n.user}/project/${n.project}/`,this.opts={headers:{"X-Access-Key":n.accessKey}},this.blockNumber=n.blockNumber}}var Us;exports.SimulationType=void 0,(Us=exports.SimulationType||(exports.SimulationType={}))[Us.Tenderly=0]="Tenderly",Us[Us.VaultModel=1]="VaultModel",Us[Us.Static=2]="Static";class Vs{constructor(t,a){this.simulateGeneralisedJoin=async(e,t,a,n,o,i,s,r,p)=>{const d=[];switch(r){case exports.SimulationType.Tenderly:{if(!this.tenderlyHelper)throw new Error("Missing Tenderly config");const t=await this.tenderlyHelper.simulateMulticall(e,a,o,i,p);d.push(...this.decodeResult(t,n));break}case exports.SimulationType.VaultModel:{const e=await this.simulateRequests(t);d.push(...e);break}case exports.SimulationType.Static:{const t=await s.call({to:e,data:a,value:p});try{d.push(...this.decodeResult(t,n))}catch(e){const a=Buffer.from(t.split("x")[1],"hex").toString("utf8");throw new Error(`Transaction reverted with error: ${a}`)}break}default:throw new Error("Simulation type not supported")}return d},this.simulateGeneralisedExit=async(e,t,a,n,o,i,s,r)=>{const p=[];switch(r){case exports.SimulationType.Tenderly:{if(!this.tenderlyHelper)throw new Error("Missing Tenderly config");const t=await this.tenderlyHelper.simulateMulticall(e,a,o,[i]);p.push(...this.decodeResult(t,n));break}case exports.SimulationType.VaultModel:{const e=await this.simulateRequests(t);p.push(...e);break}case exports.SimulationType.Static:{const t=await s.call({to:e,data:a});try{p.push(...this.decodeResult(t,n))}catch(e){const a=Buffer.from(t.split("x")[1],"hex").toString("utf8");throw new Error(`Transaction reverted with error: ${a}`)}break}default:throw new Error("Simulation type not supported")}return p},this.decodeResult=(t,a)=>{const n=e.defaultAbiCoder.decode(["bytes[]"],t)[0];return a.map((t=>e.defaultAbiCoder.decode(["uint256"],n[t]).toString()))},this.simulateRequests=async e=>{if(void 0===this.vaultModel)throw new Error("Missing Vault Model Config.");const t=[];for(const[a,n]of e.entries()){const e=await this.vaultModel.multicall(n,0===a),o=Object.values(e).filter((e=>e.lt(0)));if(0===o.length)throw new Error("No delta found for token out.");t.push(...o.map((e=>e.mul(-1).toString())))}return t},t.tenderly&&(this.tenderlyHelper=new Ls(t.chainId,t.tenderly)),this.vaultModel=a?new Fs(a,t.addresses.tokens.wrappedNativeAsset):void 0}}const Gs=It.createInterface();function qs(e){X.getInstance()}class Ws{constructor(e,n,o){this.poolGraph=e,this.simulationService=o,this.amountsOutByExitPath=async(e,t,a,n,o,i,s)=>await this.simulationService.simulateGeneralisedExit(this.relayer,t,a,o,e,n,i,s),this.amountsOutByTokenOut=(e,a,n)=>{const o={};a.forEach(((e,a)=>{var i;return o[e]=(null!==(i=o[e])&&void 0!==i?i:t.Zero).add(n[a])}));return e.map((e=>o[e].toString()))},this.minAmountsOut=(e,t,n)=>({minAmountsOutByExitPath:e.map((e=>He(a.BigNumber.from(e),a.BigNumber.from(n)).toString())),minAmountsOutByTokenOut:t.map((e=>He(a.BigNumber.from(e),a.BigNumber.from(n)).toString()))}),this.getExitPaths=(e,n)=>{const o=e.map((e=>{const a=[e];for(;a[0].parent;)a.unshift(s.cloneDeep(a[0].parent));return a[0].index=a[a.length-1].proportionOfParent.mul(n).div(t.WeiPerEther).toString(),a})),i=o.reduce(((e,t)=>{const n=t[0].index;return a.BigNumber.from(n).add(e)}),t.Zero),r=a.BigNumber.from(n).sub(i);return o[o.length-1][0].index=r.add(o[o.length-1][0].index).toString(),o},this.createUnwrap=(e,a,n,o,i,s)=>{var r,p;const d=es.toChainedReference(this.getOutputRef(n,e.index)).toString(),l=es.toChainedReference(this.getOutputRef(n,a.index)),u=null===(r=e.parent)||void 0===r?void 0:r.type,c={wrappedToken:e.address,sender:i,recipient:s,amount:d,outputReference:l},y=es.encodeUnwrap(c,u);qs(),qs(),qs(JSON.stringify(c));return{modelRequest:Fs.mapUnwrapRequest(d,l,null===(p=e.parent)||void 0===p?void 0:p.id),encodedCall:y,assets:[a.address],amounts:[t.Zero.sub(o).toString()]}},this.getOutputRef=(e,t)=>100*e+parseInt(t),this.receivesFromInternal=e=>!!e.parent&&("output"!==e.exitAction&&"unwrap"!==e.exitAction&&"exitPool"!==e.exitAction);const{tokens:i,contracts:r}=Oa(n.chainId);this.wrappedNativeAsset=i.wrappedNativeAsset,this.relayer=r.balancerRelayer}async getExitInfo(e,t,a,n){qs();const o=await this.getExit(e,t,a,n,[],exports.SimulationType.VaultModel);return{tokensOut:o.tokensOut,estimatedAmountsOut:o.expectedAmountsOut,priceImpact:o.priceImpact,tokensToUnwrap:o.tokensToUnwrap}}async buildExitCall(e,t,a,n,o,i,s,r){qs();const p=await this.getExit(e,t,a,o,null!=r?r:[],i,s),{minAmountsOutByExitPath:d,minAmountsOutByTokenOut:l}=this.minAmountsOut(p.expectedAmountsOutByExitPath,p.expectedAmountsOut,n);qs();const{encodedCall:u,deltas:c}=await this.createCalls(p.exitPaths,a,p.isProportional,d,s);return this.assertDeltas(e,c,t,p.tokensOut,l),{to:this.relayer,encodedCall:u,tokensOut:p.tokensOut,expectedAmountsOut:p.expectedAmountsOut,minAmountsOut:l,priceImpact:p.priceImpact}}async getExit(e,t,n,o,i,s,r){const p=await this.poolGraph.getGraphNodes(!1,e,i),d=ws.isProportionalPools(p);qs();let l=[],u=[],c=[];const y=p.filter((e=>"output"===e.exitAction));if(u=y.map((e=>e.address.toLowerCase())),c=[...new Set(u)].sort(),d){const e=p.map(((e,a)=>(0===a&&(e.index=t),e)));l[0]=e}else l=this.getExitPaths(y,t);const{multiRequests:b,encodedCall:m,outputIndexes:f}=await this.createCalls(l,n,d,void 0,r),T=await this.amountsOutByExitPath(n,b,m,p[0].address,f,o,s),h=y.filter(((e,t)=>a.BigNumber.from(T[t]).gt(e.balance))).map((e=>e.address.toLowerCase()));if(i.some((e=>h.includes(e.toLowerCase()))))throw new Error("Insufficient pool balance to perform generalised exit - try exitting with smaller amounts");if(h.length>0)return await this.getExit(e,t,n,o,[...new Set(h)].sort(),s,r);{const a=this.amountsOutByTokenOut(c,u,T),n=await this.calculatePriceImpact(e,this.poolGraph,c,a,t);return{tokensToUnwrap:i,tokensOut:c,exitPaths:l,isProportional:d,expectedAmountsOut:a,expectedAmountsOutByExitPath:T,priceImpact:n}}}async calculatePriceImpact(e,t,a,n,o){const i=await t.getGraphNodes(!0,e,[]),s=Ds.getJoinPaths(i,a,n),r=Ds.totalBptZeroPriceImpact(s);return Ma(BigInt(o),r.toBigInt(),!1).toString()}assertDeltas(e,t,a,n,o){var i;const s=R(e);if(t[s.toLowerCase()].sub(a).abs().gt(3))throw console.error("exit assertDeltas, bptIn: ",s,a,null===(i=t[s.toLowerCase()])||void 0===i?void 0:i.toString()),new Ba(exports.BalancerErrorCode.EXIT_DELTA_AMOUNTS);delete t[s.toLowerCase()],n.forEach(((e,a)=>{var n;if(t[e.toLowerCase()].add(o[a]).abs().gt(1))throw console.error("exit assertDeltas, tokenOut: ",e,o[a],null===(n=t[e.toLowerCase()])||void 0===n?void 0:n.toString()),new Ba(exports.BalancerErrorCode.EXIT_DELTA_AMOUNTS);delete t[e.toLowerCase()]}));for(const e in t)if("0"!==t[e].toString())throw console.error("exit assertDeltas, non-input token should be 0: ",e,t[e].toString()),new Ba(exports.BalancerErrorCode.EXIT_DELTA_AMOUNTS)}async createCalls(e,t,a,n,o){const{multiRequests:i,calls:r,outputIndexes:p,deltas:d}=this.createActionCalls(s.cloneDeep(e),t,a,n);o&&r.unshift(es.encodeSetRelayerApproval(this.relayer,!0,o));return{multiRequests:i,encodedCall:Gs.encodeFunctionData("multicall",[r]),outputIndexes:o?p.map((e=>e+1)):p,deltas:d}}updateDeltas(e,a,n){return a.forEach(((a,o)=>{const i=a.toLowerCase();e[i]||(e[i]=t.Zero),e[i]=e[i].add(n[o])})),e}createActionCalls(e,a,n,o){const i=[],s=[],r=[],p=!o,d={},l=(e,t)=>t.children.filter((t=>e.map((e=>e.index)).includes(t.index))).some((e=>"output"===e.exitAction))?a:this.relayer;return e.forEach(((e,u)=>{const c=[],y=e.filter((e=>"output"===e.exitAction));e.forEach((i=>{const b=i.children.find((t=>e.map((e=>e.index)).includes(t.index))),m=((e,t)=>t.parent?l(e,t.parent):a)(e,i),f=l(e,i),T=i.children.filter((t=>e.map((e=>e.index)).includes(t.index))).some((e=>"output"===e.exitAction||"unwrap"===e.exitAction));let h="0";const I=Array(i.children.length).fill("0");switch(o&&T&&(n?i.children.forEach(((e,a)=>{let n;"unwrap"===e.exitAction?(n=y.indexOf(e.children[0]),h=t.WeiPerEther.mul(o[n]).div(e.priceRate).toString()):"output"===e.exitAction?(n=y.indexOf(e),h=o[n]):h="0",I[a]=h})):h="unwrap"===(null==b?void 0:b.exitAction)?t.WeiPerEther.mul(o[u]).div(b.priceRate).toString():o[u]),i.exitAction){case"unwrap":{const{modelRequest:e,encodedCall:t,assets:a,amounts:n}=this.createUnwrap(i,b,u,h,m,f);c.push(e),s.push(t),this.updateDeltas(d,a,n);break}case"batchSwap":{const{modelRequest:e,encodedCall:t,assets:a,amounts:n}=this.createSwap(i,b,u,h,m,f);c.push(e),s.push(t),this.updateDeltas(d,a,n);break}case"exitPool":{let e;e=n?this.createExitPoolProportional(i,I,m,f):this.createExitPool(i,b,u,h,m,f);const{modelRequest:t,encodedCall:a,bptIn:o,tokensOut:r,amountsOut:p}=e;c.push(t),s.push(a),this.updateDeltas(d,[i.address,...r],[o,...p]);break}case"output":p&&(s.push(es.encodePeekChainedReferenceValue(es.toChainedReference(this.getOutputRef(u,i.index),!1))),r.push(s.length-1));break;default:return}})),i.push(c)})),{multiRequests:i,calls:s,outputIndexes:r,deltas:d}}createSwap(e,t,n,o,i,s){const r=!e.parent,p=r?e.index:es.toChainedReference(this.getOutputRef(n,e.index)).toString(),d=t.address,l=[d,e.address],u=o,c={poolId:e.id,kind:exports.SwapType.SwapExactIn,assetIn:e.address,assetOut:d,amount:p,userData:"0x"},y={sender:i,recipient:s,fromInternalBalance:this.receivesFromInternal(e),toInternalBalance:this.receivesFromInternal(t)},b=es.toChainedReference(this.getOutputRef(n,t.index)),m={request:c,funds:y,limit:u,deadline:a.BigNumber.from(Math.ceil(Date.now()/1e3)+3600),value:"0",outputReference:b};qs(),qs(JSON.stringify(m));const f=es.encodeSwap(m),T=r?p:"0";return{modelRequest:Fs.mapSwapRequest(m),encodedCall:f,assets:l,amounts:["output"!==t.exitAction?"0":a.BigNumber.from(o).mul(-1).toString(),T]}}createBatchSwap(e,n,o,i,s,r){const p=!e.parent,d=p?e.index:es.toChainedReference(this.getOutputRef(o,e.index)).toString(),l=[...n.map((e=>e.address)),e.address],u=[...i];u.push(d);const c=[],y=[];n.forEach(((a,n)=>{const o=a.proportionOfParent.mul(d).div(t.WeiPerEther).toString(),i={poolId:e.id,assetInIndex:l.length-1,assetOutIndex:n,amount:o,userData:"0x"};c.push(i),y.push({index:n,key:es.toChainedReference(this.getOutputRef(0,a.index))})}));const b=c.reduce(((e,t)=>e.add(t.amount)),a.BigNumber.from(0)),m=a.BigNumber.from(d).sub(b);c[0].amount=m.add(c[0].amount).toString();const f={sender:s,recipient:r,fromInternalBalance:this.receivesFromInternal(e),toInternalBalance:this.receivesFromInternal(n[0])},T={swapType:exports.SwapType.SwapExactIn,swaps:c,assets:l,funds:f,limits:u,deadline:a.BigNumber.from(Math.ceil(Date.now()/1e3)+3600),value:"0",outputReferences:y};qs(),qs(JSON.stringify(T));const h=es.encodeBatchSwap(T),I=Fs.mapBatchSwapRequest(T),g=p?d:"0",x=[...n.map(((e,t)=>"output"!==e.exitAction?"0":a.BigNumber.from(i[t]).mul(-1).toString())),g];return{modelRequest:I,encodedCall:h,assets:l,amounts:x}}createExitPool(e,a,n,o,i,s){const r=a.address,p=!e.parent,d=p?e.index:es.toChainedReference(this.getOutputRef(n,e.index)).toString(),l=[],u=[];e.children.forEach((e=>{l.push(e.address),u.push(e.address===r?o:"0")})),e.type===exports.PoolType.ComposableStable&&(l.push(e.address),u.push("0"));const c=new j(this.wrappedNativeAsset),[y,b]=c.sortTokens(l,u);let m=[];const f=y.map((e=>e.toLowerCase())).indexOf(e.address.toLowerCase());let T;m=-1===f?y:[...y.slice(0,f),...y.slice(f+1)],T=e.type===exports.PoolType.Weighted?S.exitExactBPTInForOneTokenOut(d,m.indexOf(r)):v.exitExactBPTInForOneTokenOut(d,m.indexOf(r));const h=[{index:y.map((e=>e.toLowerCase())).indexOf(r.toLowerCase()),key:es.toChainedReference(this.getOutputRef(n,a.index))}],I=this.receivesFromInternal(a),g=es.formatExitPoolInput({poolId:e.id,poolKind:0,sender:i,recipient:s,outputReferences:h,exitPoolRequest:{},assets:y,minAmountsOut:b,userData:T,toInternalBalance:I});qs(),qs(JSON.stringify(g));const x=es.encodeExitPool(g),_=Fs.mapExitPoolRequest(g),w=b.map((e=>es.isChainedReference(e)?"0":t.Zero.sub(e).toString())),P=es.isChainedReference(d)?"0":d;return{modelRequest:_,encodedCall:x,bptIn:p?P:t.Zero.toString(),tokensOut:"output"!==a.exitAction?[]:y,amountsOut:"output"!==a.exitAction?[]:w}}createExitPoolProportional(e,a,n,o){const i=!e.parent,s=i?e.index:es.toChainedReference(this.getOutputRef(0,e.index)).toString(),r=e.children.map((e=>e.address)),p=[...a];e.type===exports.PoolType.ComposableStable&&(r.push(e.address),p.push("0"));const d=new j(this.wrappedNativeAsset),[l,u]=d.sortTokens(r,p);let c;c=e.type===exports.PoolType.Weighted?S.exitExactBPTInForTokensOut(s):e.type===exports.PoolType.ComposableStable?C.exitExactBPTInForAllTokensOut(s):v.exitExactBPTInForTokensOut(s);const y=e.children.map((e=>({index:l.map((e=>e.toLowerCase())).indexOf(e.address.toLowerCase()),key:es.toChainedReference(this.getOutputRef(0,e.index))})));let b=0;e.type===exports.PoolType.ComposableStable&&(b=3);const m=e.children.every((e=>this.receivesFromInternal(e))),f=es.formatExitPoolInput({poolId:e.id,poolKind:b,sender:n,recipient:o,outputReferences:y,exitPoolRequest:{},assets:l,minAmountsOut:u,userData:c,toInternalBalance:m});qs(),qs(JSON.stringify(f));const T=es.encodeExitPool(f),h=Fs.mapExitPoolRequest(f),I=u.map((e=>es.isChainedReference(e)?"0":t.Zero.sub(e).toString())),g=es.isChainedReference(s)?"0":s,x=i?g:t.Zero.toString(),_=l.filter((t=>e.children.filter((e=>"output"===e.exitAction)).map((e=>e.address)).includes(t))),w=I.filter(((e,t)=>_.includes(l[t])));return{modelRequest:h,encodedCall:T,bptIn:x,tokensOut:_,amountsOut:w}}}class $s{constructor(e){this.yesterdaysPools=e}async last24h(e){let t;return this.yesterdaysPools&&(t=await this.yesterdaysPools.find(e.id)),e.totalSwapVolume?(null==t?void 0:t.totalSwapVolume)?parseFloat(e.totalSwapVolume)-parseFloat(t.totalSwapVolume):e.createTime&&is(e.createTime)?parseFloat(e.totalSwapVolume):0:0}}class Hs{constructor(e,t){this.checkCreateInputs=({tokenAddresses:e,tokenRateCacheDurations:t,exemptFromYieldProtocolFeeFlags:a,rateProviders:n,swapFeeEvm:o})=>{if(e.length!==t.length||t.length!==a.length||a.length!==n.length)throw new Ba(exports.BalancerErrorCode.INPUT_LENGTH_MISMATCH);if(BigInt(o)<=BigInt(0)||BigInt(o)>BigInt(1e17))throw new Ba(exports.BalancerErrorCode.INVALID_SWAP_FEE_PERCENTAGE)},this.parseCreateParamsForEncoding=({name:e,symbol:t,tokenAddresses:a,amplificationParameter:n,rateProviders:o,tokenRateCacheDurations:i,exemptFromYieldProtocolFeeFlags:s,swapFeeEvm:r,owner:p,salt:d})=>{const l=new j(this.wrappedNativeAsset),[u,c,y,b]=l.sortTokens(a,o,i,s);return[e,t,u,n,c,y,b,r.toString(),p,d||et()]},this.encodeCreateFunctionData=e=>Et.createInterface().encodeFunctionData("create",e),this.checkInitJoinInputs=({poolId:e,poolAddress:t,tokensIn:a,amountsIn:n})=>{if(!e||!t)throw new Ba(exports.BalancerErrorCode.NO_POOL_DATA);if(a.length!==n.length)throw new Ba(exports.BalancerErrorCode.INPUT_LENGTH_MISMATCH)},this.parseParamsForInitJoin=({joiner:e,poolId:t,poolAddress:a,tokensIn:n,amountsIn:o})=>{const i=new j(this.wrappedNativeAsset),s=[...n,a],r=[...o,"0"],p=[...o,BigInt.asUintN(256,BigInt(-1)).toString()],[d,l,u]=i.sortTokens(s,r,p),c={poolId:t,sender:e,recipient:e,joinPoolRequest:{assets:d,maxAmountsIn:u,userData:C.joinInit(l),fromInternalBalance:!1}};return{attributes:c,params:[c.poolId,c.sender,c.recipient,c.joinPoolRequest]}},this.encodeInitJoinFunctionData=e=>{const t="joinPool";return{functionName:t,data:da.createInterface().encodeFunctionData(t,e)}},this.getPoolAddressAndIdWithReceipt=async(e,t)=>{var a;const n=Qe({receipt:t,to:(null===(a=this.contracts.composableStablePoolFactory)||void 0===a?void 0:a.address)||"",contractInterface:Et.createInterface(),logName:"PoolCreated"}).args.pool,o=this.getPoolInterface(),i=new y.Contract(n,o,e);return{poolAddress:n,poolId:await i.getPoolId()}};const{tokens:a}=Oa(e.chainId);this.wrappedNativeAsset=a.wrappedNativeAsset,this.contracts=t}create({name:e,symbol:t,tokenAddresses:a,amplificationParameter:n,rateProviders:o,tokenRateCacheDurations:i,exemptFromYieldProtocolFeeFlags:s,swapFeeEvm:r,owner:p,salt:d}){var l;this.checkCreateInputs({rateProviders:o,tokenAddresses:a,tokenRateCacheDurations:i,exemptFromYieldProtocolFeeFlags:s,swapFeeEvm:r});const u=this.parseCreateParamsForEncoding({name:e,symbol:t,tokenAddresses:a,amplificationParameter:n,rateProviders:o,tokenRateCacheDurations:i,exemptFromYieldProtocolFeeFlags:s,swapFeeEvm:r,owner:p,salt:d}),c=this.encodeCreateFunctionData(u);return{to:null===(l=this.contracts.composableStablePoolFactory)||void 0===l?void 0:l.address,data:c}}buildInitJoin({joiner:e,poolId:t,poolAddress:a,tokensIn:n,amountsIn:o}){this.checkInitJoinInputs({tokensIn:n,amountsIn:o,poolId:t,poolAddress:a});const{attributes:i,params:s}=this.parseParamsForInitJoin({joiner:e,poolId:t,poolAddress:a,tokensIn:n,amountsIn:o}),{functionName:r,data:p}=this.encodeInitJoinFunctionData(s);return{to:Aa,functionName:r,data:p,attributes:i}}getPoolInterface(){return wt.createInterface()}}class Ks{constructor(e,t){this.parseCreateParamsForEncoding=({name:e,symbol:t,tokenAddresses:a,normalizedWeights:n,rateProviders:o,swapFeeEvm:i,owner:s,salt:r})=>{const p=new j(this.wrappedNativeAsset),[d,l,u]=p.sortTokens(a,n,o);return[e,t,d,l,u,i.toString(),s,r||et()]},this.encodeCreateFunctionData=e=>ya.createInterface().encodeFunctionData("create",e),this.parseParamsForInitJoin=({joiner:e,poolId:t,tokensIn:a,amountsIn:n})=>{const o=new j(this.wrappedNativeAsset),[i,s]=o.sortTokens(a,n),r={poolId:t,sender:e,recipient:e,joinPoolRequest:{assets:i,maxAmountsIn:s,userData:S.joinInit(s),fromInternalBalance:!1}};return{attributes:r,params:[r.poolId,r.sender,r.recipient,r.joinPoolRequest]}},this.encodeInitJoinFunctionData=e=>{const t="joinPool";return{functionName:t,data:da.createInterface().encodeFunctionData(t,e)}},this.checkInitJoinInputs=({poolId:e,tokensIn:t,amountsIn:a})=>{if(!e)throw new Ba(exports.BalancerErrorCode.NO_POOL_DATA);if(t.length!==a.length)throw new Ba(exports.BalancerErrorCode.INPUT_LENGTH_MISMATCH)};const{tokens:a}=Oa(e.chainId);this.wrappedNativeAsset=a.wrappedNativeAsset,this.contracts=t}create({name:e,symbol:t,tokenAddresses:a,normalizedWeights:n,rateProviders:o,swapFeeEvm:i,owner:s,salt:r}){var p;this.checkCreateInputs({tokenAddresses:a,normalizedWeights:n,swapFeeEvm:i,rateProviders:o});const d=this.parseCreateParamsForEncoding({name:e,symbol:t,tokenAddresses:a,normalizedWeights:n,rateProviders:o,swapFeeEvm:i,owner:s,salt:r}),l=this.encodeCreateFunctionData(d);return{to:null===(p=this.contracts.weightedPoolFactory)||void 0===p?void 0:p.address,data:l}}checkCreateInputs({tokenAddresses:e,normalizedWeights:t,swapFeeEvm:a,rateProviders:n}){if(e.length!==t.length||t.length!==n.length)throw new Ba(exports.BalancerErrorCode.INPUT_LENGTH_MISMATCH);if(e.length<2)throw new Ba(exports.BalancerErrorCode.BELOW_MIN_TOKENS);if(e.length>8)throw new Ba(exports.BalancerErrorCode.ABOVE_MAX_TOKENS);if(BigInt(a)<=BigInt(0)||BigInt(a)>BigInt(1e17))throw new Ba(exports.BalancerErrorCode.INVALID_SWAP_FEE_PERCENTAGE);if(t.reduce(((e,t)=>ce.add(e,BigInt(t))),BigInt(0))!==BigInt(1e18))throw new Ba(exports.BalancerErrorCode.INVALID_WEIGHTS)}buildInitJoin({joiner:e,poolId:t,tokensIn:a,amountsIn:n}){this.checkInitJoinInputs({poolId:t,tokensIn:a,amountsIn:n});const{attributes:o,params:i}=this.parseParamsForInitJoin({joiner:e,poolId:t,tokensIn:a,amountsIn:n}),{functionName:s,data:r}=this.encodeInitJoinFunctionData(i);return{to:Aa,functionName:s,data:r,attributes:o}}async getPoolAddressAndIdWithReceipt(e,t){var a;const n=Qe({receipt:t,to:(null===(a=this.contracts.weightedPoolFactory)||void 0===a?void 0:a.address)||"",contractInterface:ya.createInterface(),logName:"PoolCreated"}).args.pool,o=this.getPoolInterface(),i=new y.Contract(n,o,e);return{poolAddress:n,poolId:await i.getPoolId()}}getPoolInterface(){return ua.createInterface()}}var Js;exports.ProtocolId=void 0,(Js=exports.ProtocolId||(exports.ProtocolId={}))[Js.AAVE_V1=0]="AAVE_V1",Js[Js.AAVE_V2=1]="AAVE_V2",Js[Js.AAVE_V3=2]="AAVE_V3",Js[Js.AMPLEFORTH=3]="AMPLEFORTH",Js[Js.BEEFY=4]="BEEFY",Js[Js.EULER=5]="EULER",Js[Js.GEARBOX=6]="GEARBOX",Js[Js.IDLE=7]="IDLE",Js[Js.MORPHO=8]="MORPHO",Js[Js.RADIANT=9]="RADIANT",Js[Js.REAPER=10]="REAPER",Js[Js.SILO=11]="SILO",Js[Js.STARGATE=12]="STARGATE",Js[Js.STURDY=13]="STURDY",Js[Js.TESSERA=14]="TESSERA",Js[Js.TETU=15]="TETU",Js[Js.YEARN=16]="YEARN",Js[Js.MIDAS=17]="MIDAS",Js[Js.AGAVE=18]="AGAVE";class Xs{constructor(e,t){this.getPoolFactoryInterface=()=>{switch(this.poolType){case exports.PoolType.AaveLinear:return rt.createInterface();case exports.PoolType.Linear:case exports.PoolType.ERC4626Linear:return Mt.createInterface();case exports.PoolType.EulerLinear:return Dt.createInterface();case exports.PoolType.GearboxLinear:return Ht.createInterface();case exports.PoolType.YearnLinear:return Ta.createInterface();default:throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE)}},this.getPoolInterface=()=>{switch(this.poolType){case exports.PoolType.AaveLinear:return it.createInterface();case exports.PoolType.Linear:case exports.PoolType.ERC4626Linear:return Ct.createInterface();case exports.PoolType.EulerLinear:return Rt.createInterface();case exports.PoolType.GearboxLinear:return Wt.createInterface();case exports.PoolType.YearnLinear:return ma.createInterface();default:throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE)}},this.checkCreateInputs=({swapFeeEvm:e,protocolId:t})=>{if(!exports.ProtocolId[t])throw new Ba(exports.BalancerErrorCode.INVALID_PROTOCOL_ID);if(BigInt(e)<=BigInt(0)||BigInt(e)>BigInt(1e17))throw new Ba(exports.BalancerErrorCode.INVALID_SWAP_FEE_PERCENTAGE);this.getFactoryAddress()},this.parseCreateParamsForEncoding=({name:e,symbol:t,mainToken:a,wrappedToken:n,upperTargetEvm:o,swapFeeEvm:i,owner:s,protocolId:r,salt:p})=>this.poolType===exports.PoolType.EulerLinear?[e,t,a,n,o,i,s,r.toString()]:[e,t,a,n,o,i,s,r.toString(),p||et()],this.encodeCreateFunctionData=e=>{const t=this.getPoolFactoryInterface();return this.poolType,exports.PoolType.EulerLinear,t.encodeFunctionData("create",e)},this.getFactoryAddress=()=>{switch(this.poolType){case exports.PoolType.AaveLinear:if(this.contracts.aaveLinearPoolFactory)return this.contracts.aaveLinearPoolFactory.address;throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE);case exports.PoolType.Linear:case exports.PoolType.ERC4626Linear:if(this.contracts.erc4626LinearPoolFactory)return this.contracts.erc4626LinearPoolFactory.address;throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE);case exports.PoolType.EulerLinear:if(this.contracts.eulerLinearPoolFactory)return this.contracts.eulerLinearPoolFactory.address;throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE);case exports.PoolType.GearboxLinear:if(this.contracts.gearboxLinearPoolFactory)return this.contracts.gearboxLinearPoolFactory.address;throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE);case exports.PoolType.YearnLinear:if(this.contracts.yearnLinearPoolFactory)return this.contracts.yearnLinearPoolFactory.address;throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE);default:throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE)}},this.getPoolAddressAndIdWithReceipt=async(e,t)=>{const a=Qe({receipt:t,to:this.getFactoryAddress()||"",contractInterface:this.getPoolFactoryInterface(),logName:"PoolCreated"}).args.pool,n=this.getPoolInterface(),o=new y.Contract(a,n,e);return{poolAddress:a,poolId:await o.getPoolId()}},this.contracts=e,this.poolType=t}buildInitJoin(){throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE)}create({name:e,symbol:t,mainToken:a,wrappedToken:n,upperTargetEvm:o,swapFeeEvm:i,owner:s,protocolId:r,salt:p}){this.checkCreateInputs({swapFeeEvm:i,protocolId:r});const d=this.parseCreateParamsForEncoding({name:e,symbol:t,mainToken:a,wrappedToken:n,upperTargetEvm:o,swapFeeEvm:i,owner:s,protocolId:r,salt:p}),l=this.encodeCreateFunctionData(d);return{to:this.getFactoryAddress(),data:l}}}class Ys{constructor(e,t){this.networkConfig=e,this.contracts=t.contracts}of(e){switch(e){case"Weighted":return new Ks(this.networkConfig,this.contracts);case"Investment":case"LiquidityBootstrapping":case"Stable":case"MetaStable":case"StablePhantom":default:throw new Ba(exports.BalancerErrorCode.UNSUPPORTED_POOL_TYPE);case"ComposableStable":return new Hs(this.networkConfig,this.contracts);case"Linear":case"AaveLinear":case"ERC4626Linear":case"EulerLinear":case"GearboxLinear":case"YearnLinear":return new Xs(this.contracts,e)}}}class js{constructor(e){this.pool=e;const t=(e=>{switch(e){case exports.PoolType.Weighted:return S;case exports.PoolType.Stable:case exports.PoolType.MetaStable:case exports.PoolType.StablePhantom:case exports.PoolType.Element:case exports.PoolType.Gyro2:case exports.PoolType.Gyro3:return v;case exports.PoolType.ComposableStable:return C;default:if(Ze(e))return v}})(e.poolType);if(!t)throw"Pool type not supported";this.encoder=t}buildQueryJoinExactIn({maxAmountsInByToken:e,minimumBPT:n=t.Zero}){const o=this.pool.tokensList.findIndex((e=>this.pool.id.includes(e))),i=[...this.pool.tokensList],s=this.pool.tokensList.map((t=>{var n;return null!==(n=e.get(t))&&void 0!==n?n:a.BigNumber.from("0")}));let r;r=o>-1?je(s,o):s;const p=this.encoder.joinExactTokensInForBPTOut(r,n);return[this.pool.id,t.AddressZero,t.AddressZero,{assets:i,maxAmountsIn:s,userData:p,fromInternalBalance:!1}]}buildQueryJoinExactOut({maxAmountIn:e,bptOut:a,tokenIn:n}){const o=this.pool.tokensList.findIndex((e=>this.pool.id.includes(e)));let i=[...this.pool.tokensList];o>-1&&(i=je(this.pool.tokensList,o));const s=i.indexOf(n),r=this.encoder.joinTokenInForExactBPTOut(a,s),p=e?this.pool.tokensList.map((t=>t===n?e:"0")):[];return[this.pool.id,t.AddressZero,t.AddressZero,{assets:this.pool.tokensList,maxAmountsIn:p,userData:r,fromInternalBalance:!1}]}buildQueryExitToSingleToken({minAmountOut:e,bptIn:a,tokenOut:n}){const o=this.pool.tokensList.findIndex((e=>this.pool.id.includes(e)));let i=[...this.pool.tokensList];o>-1&&(i=je(this.pool.tokensList,o));const s=i.indexOf(n),r=this.encoder.exitExactBPTInForOneTokenOut(a,s),p=e?this.pool.tokensList.map((t=>t===n?e:"0")):[];return[this.pool.id,t.AddressZero,t.AddressZero,{assets:this.pool.tokensList,minAmountsOut:p,userData:r,toInternalBalance:!1}]}buildQueryExitProportionally({minAmountsOut:e=[],bptIn:a}){if(!this.encoder.exitExactBPTInForTokensOut)throw"Proportional exit not implemented";const n=this.encoder.exitExactBPTInForTokensOut(a);return[this.pool.id,t.AddressZero,t.AddressZero,{assets:this.pool.tokensList,minAmountsOut:e,userData:n,toInternalBalance:!1}]}buildQueryExitExactOut({minAmountsOut:e,maxBptIn:a=t.MaxUint256}){const n=this.pool.tokensList.findIndex((e=>this.pool.id.includes(e)));let o=[...e];n>-1&&(o=je(e,n));const i=this.encoder.exitBPTInForExactTokensOut(o,a);return[this.pool.id,t.AddressZero,t.AddressZero,{assets:this.pool.tokensList,minAmountsOut:e,userData:i,toInternalBalance:!1}]}}class zs{constructor(e){this.liquidityGaugesRepository=e}async relativeWeight(e){const t=await this.liquidityGaugesRepository.findBy("poolId",e);return t?t.relativeWeight:0}async weekly(e){return bs()*await this.relativeWeight(e)}}const Zs=(e,t,n)=>{const o=e.tokens.filter((t=>!e.id.toLowerCase().includes(t.address.toLowerCase()))),i=o.findIndex((e=>e.address.toLowerCase()===t.toLowerCase()));if(-1==i)throw new Error("Token not found in pool");const s=o.map((e=>Ce(e.balance,e.decimals))),r=a.BigNumber.from(n),p=s.map((e=>e.mul(r).div(s[i])));return{tokens:o.map((e=>e.address)),amounts:p.map((e=>e.toString()))}},Qs=(e,t)=>()=>{throw`${t} for poolType ${e} not implemented`};class er{constructor(e,t,a){this.networkConfig=e,this.repositories=t,this.balancerContracts=a,this.aprService=new Is(this.repositories.pools,this.repositories.tokenPrices,this.repositories.tokenMeta,this.repositories.tokenYields,this.repositories.feeCollector,this.repositories.yesterdaysPools,this.repositories.liquidityGauges,this.repositories.feeDistributor,this.repositories.gyroConfigRepository),this.liquidityService=new vn(t.pools,t.tokenPrices),this.simulationService=new Vs(e,this.repositories.poolsForSimulations),this.graphService=new ws(this.repositories.poolsOnChain),this.joinService=new Ds(this.graphService,e,this.simulationService),this.exitService=new Ws(this.graphService,e,this.simulationService),this.feesService=new hs(t.yesterdaysPools),this.volumeService=new $s(t.yesterdaysPools),this.poolFactory=new Ys(e,a),this.impermanentLossService=new ds(t.tokenPrices,t.tokenHistoricalPrices),t.liquidityGauges&&(this.emissionsService=new zs(t.liquidityGauges)),this.proportionalAmounts=Zs}static wrap(e,t){let a,n,o;try{a=En.from(e.poolType),o={buildJoin:(t,n,o,s)=>a.join.buildJoin({joiner:t,pool:e,tokensIn:n,amountsIn:o,slippage:s,wrappedNativeAsset:i}),calcPriceImpact:async(t,n,o)=>a.priceImpactCalculator.calcPriceImpact(e,t.map(BigInt),BigInt(n),o),buildExitExactBPTIn:(t,n,o,s=!1,r,p=!1)=>{if(a.exit.buildExitExactBPTIn)return a.exit.buildExitExactBPTIn({exiter:t,pool:e,bptIn:n,slippage:o,shouldUnwrapNativeAsset:s,wrappedNativeAsset:i,singleTokenOut:r,toInternalBalance:p});throw"ExitExactBPTIn not supported"},buildExitExactTokensOut:(t,n,o,s,r=!1)=>a.exit.buildExitExactTokensOut({exiter:t,pool:e,tokensOut:n,amountsOut:o,slippage:s,wrappedNativeAsset:i,toInternalBalance:r}),buildRecoveryExit:(t,n,o,i=!1)=>a.exit.buildRecoveryExit({exiter:t,pool:e,bptIn:n,slippage:o,toInternalBalance:i}),calcSpotPrice:(t,n)=>a.spotPriceCalculator.calcPoolSpotPrice(t,n,e),calcProportionalAmounts:(t,a)=>Zs(e,t,a)}}catch(t){if("UNSUPPORTED_POOL_TYPE"!=t.code){X.getInstance().warn(t)}o={buildJoin:Qs(e.poolType,"buildJoin"),calcPriceImpact:Qs(e.poolType,"calcPriceImpact"),buildExitExactBPTIn:Qs(e.poolType,"buildExitExactBPTIn"),buildExitExactTokensOut:Qs(e.poolType,"buildExitExactTokensOut"),calcSpotPrice:Qs(e.poolType,"calcSpotPrice"),buildRecoveryExit:Qs(e.poolType,"buildRecoveryExit")}}try{n=new js(e),o={...o,buildQueryJoinExactIn:n.buildQueryJoinExactIn.bind(n),buildQueryJoinExactOut:n.buildQueryJoinExactOut.bind(n),buildQueryExitExactOut:n.buildQueryExitExactOut.bind(n),buildQueryExitToSingleToken:n.buildQueryExitToSingleToken.bind(n),buildQueryExitProportionally:n.buildQueryExitProportionally.bind(n)}}catch(t){o={...o,buildQueryJoinExactIn:Qs(e.poolType,"buildQueryJoinExactIn"),buildQueryJoinExactOut:Qs(e.poolType,"buildQueryJoinExactOut"),buildQueryExitExactOut:Qs(e.poolType,"buildQueryExitExactOut"),buildQueryExitToSingleToken:Qs(e.poolType,"buildQueryExitToSingleToken"),buildQueryExitProportionally:Qs(e.poolType,"buildQueryExitProportionally")}}const i=t.addresses.tokens.wrappedNativeAsset.toLowerCase(),s=e.tokensList.indexOf(e.address);return{...e,...o,bptIndex:s}}dataSource(){return this.repositories.pools}async apr(e){return this.aprService.apr(e)}async impermanentLoss(e,t){return this.impermanentLossService.calcImpLoss(e,t)}async liquidity(e){return this.liquidityService.getLiquidity(e)}async bptPrice(e){return this.liquidityService.getBptPrice(e)}buildJoin({pool:e,tokensIn:t,amountsIn:a,userAddress:n,slippage:o}){const i=En.from(e.poolType);if(!i)throw`buildJoin for poolType ${e.poolType} not implemented`;return i.join.buildJoin({joiner:n,pool:e,tokensIn:t,amountsIn:a,slippage:o,wrappedNativeAsset:this.networkConfig.addresses.tokens.wrappedNativeAsset.toLowerCase()})}buildExitExactBPTIn({pool:e,bptAmount:t,userAddress:a,slippage:n,shouldUnwrapNativeAsset:o,singleTokenOut:i}){const s=En.from(e.poolType);if(!s||!s.exit.buildExitExactBPTIn)throw`buildExit for poolType ${e.poolType} not implemented`;return s.exit.buildExitExactBPTIn({pool:e,exiter:a,bptIn:t,slippage:n,wrappedNativeAsset:this.networkConfig.addresses.tokens.wrappedNativeAsset.toLowerCase(),shouldUnwrapNativeAsset:null!=o&&o,singleTokenOut:null!=i?i:void 0,toInternalBalance:!1})}buildRecoveryExit({pool:e,bptAmount:t,userAddress:a,slippage:n,toInternalBalance:o}){const i=En.from(e.poolType);if(!i||!i.exit.buildRecoveryExit)throw`buildRecoveryExit for poolType ${e.poolType} not implemented`;return i.exit.buildRecoveryExit({exiter:a,pool:e,bptIn:t,slippage:n,toInternalBalance:!!o})}async generalisedJoin(e,t,a,n,o,i,s,r){return this.joinService.joinPool(e,t,a,n,o,i,s,r)}async generalisedExit(e,t,a,n,o,i,s,r){return this.exitService.buildExitCall(e,t,a,n,o,i,s,r)}calcPriceImpact({pool:e,tokenAmounts:t,bptAmount:a,isJoin:n}){return En.from(e.poolType).priceImpactCalculator.calcPriceImpact(e,t.map(BigInt),BigInt(a),n)}async getExitInfo(e,t,a,n){return this.exitService.getExitInfo(e,t,a,n)}async fees(e){return this.feesService.last24h(e)}async volume(e){return this.volumeService.last24h(e)}async find(e){const t=await this.dataSource().find(e);if(t)return er.wrap(t,this.networkConfig)}async findBy(e,t){if("id"==e)return this.find(t);if("address"==e){const e=await this.dataSource().findBy("address",t);if(!e)return;return er.wrap(e,this.networkConfig)}throw`search by ${e} not implemented`}async all(){const e=await this.dataSource().all();return e?e.map((e=>er.wrap(e,this.networkConfig))).filter((e=>e)):[]}async where(e){const t=await this.dataSource().where(e);if(!t)return[];return t.map((e=>er.wrap(e,this.networkConfig))).filter((e=>e))}}const tr=new Se("strings/5.7.0");var ar,nr;function or(e,t,a,n,o){if(e===nr.BAD_PREFIX||e===nr.UNEXPECTED_CONTINUE){let e=0;for(let n=t+1;n<a.length&&a[n]>>6==2;n++)e++;return e}return e===nr.OVERRUN?a.length-t-1:0}function ir(e,t=ar.current){t!=ar.current&&(tr.checkNormalize(),e=e.normalize(t));let a=[];for(let t=0;t<e.length;t++){const n=e.charCodeAt(t);if(n<128)a.push(n);else if(n<2048)a.push(n>>6|192),a.push(63&n|128);else if(55296==(64512&n)){t++;const o=e.charCodeAt(t);if(t>=e.length||56320!=(64512&o))throw new Error("invalid utf-8 string");const i=65536+((1023&n)<<10)+(1023&o);a.push(i>>18|240),a.push(i>>12&63|128),a.push(i>>6&63|128),a.push(63&i|128)}else a.push(n>>12|224),a.push(n>>6&63|128),a.push(63&n|128)}return o.arrayify(a)}function sr(e){const a=ir(e);if(a.length>31)throw new Error("bytes32 string must be less than 32 bytes");return o.hexlify(o.concat([a,t.HashZero]).slice(0,32))}!function(e){e.current="",e.NFC="NFC",e.NFD="NFD",e.NFKC="NFKC",e.NFKD="NFKD"}(ar||(ar={})),function(e){e.UNEXPECTED_CONTINUE="unexpected continuation byte",e.BAD_PREFIX="bad codepoint prefix",e.OVERRUN="string overrun",e.MISSING_CONTINUE="missing continuation byte",e.OUT_OF_RANGE="out of UTF-8 range",e.UTF16_SURROGATE="UTF-16 surrogate",e.OVERLONG="overlong representation"}(nr||(nr={})),Object.freeze({error:function(e,t,a,n,o){return tr.throwArgumentError(`invalid codepoint at offset ${t}; ${e}`,"bytes",a)},ignore:or,replace:function(e,t,a,n,o){return e===nr.OVERLONG?(n.push(o),0):(n.push(65533),or(e,t,a))}});var rr,pr="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},dr={exports:{}};rr=dr,function(){var e="input is invalid type",t="object"==typeof window,a=t?window:{};a.JS_SHA3_NO_WINDOW&&(t=!1);var n=!t&&"object"==typeof self;!a.JS_SHA3_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node?a=pr:n&&(a=self);var o=!a.JS_SHA3_NO_COMMON_JS&&rr.exports,i=!a.JS_SHA3_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,s="0123456789abcdef".split(""),r=[4,1024,262144,67108864],p=[0,8,16,24],d=[1,0,32898,0,32906,2147483648,2147516416,2147483648,32907,0,2147483649,0,2147516545,2147483648,32777,2147483648,138,0,136,0,2147516425,0,2147483658,0,2147516555,0,139,2147483648,32905,2147483648,32771,2147483648,32770,2147483648,128,2147483648,32778,0,2147483658,2147483648,2147516545,2147483648,32896,2147483648,2147483649,0,2147516424,2147483648],l=[224,256,384,512],u=[128,256],c=["hex","buffer","arrayBuffer","array","digest"],y={128:168,256:136};!a.JS_SHA3_NO_NODE_JS&&Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),!i||!a.JS_SHA3_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(e){return"object"==typeof e&&e.buffer&&e.buffer.constructor===ArrayBuffer});for(var b=function(e,t,a){return function(n){return new k(e,t,e).update(n)[a]()}},m=function(e,t,a){return function(n,o){return new k(e,t,o).update(n)[a]()}},f=function(e,t,a){return function(t,n,o,i){return x["cshake"+e].update(t,n,o,i)[a]()}},T=function(e,t,a){return function(t,n,o,i){return x["kmac"+e].update(t,n,o,i)[a]()}},h=function(e,t,a,n){for(var o=0;o<c.length;++o){var i=c[o];e[i]=t(a,n,i)}return e},I=function(e,t){var a=b(e,t,"hex");return a.create=function(){return new k(e,t,e)},a.update=function(e){return a.create().update(e)},h(a,b,e,t)},g=[{name:"keccak",padding:[1,256,65536,16777216],bits:l,createMethod:I},{name:"sha3",padding:[6,1536,393216,100663296],bits:l,createMethod:I},{name:"shake",padding:[31,7936,2031616,520093696],bits:u,createMethod:function(e,t){var a=m(e,t,"hex");return a.create=function(a){return new k(e,t,a)},a.update=function(e,t){return a.create(t).update(e)},h(a,m,e,t)}},{name:"cshake",padding:r,bits:u,createMethod:function(e,t){var a=y[e],n=f(e,0,"hex");return n.create=function(n,o,i){return o||i?new k(e,t,n).bytepad([o,i],a):x["shake"+e].create(n)},n.update=function(e,t,a,o){return n.create(t,a,o).update(e)},h(n,f,e,t)}},{name:"kmac",padding:r,bits:u,createMethod:function(e,t){var a=y[e],n=T(e,0,"hex");return n.create=function(n,o,i){return new O(e,t,o).bytepad(["KMAC",i],a).bytepad([n],a)},n.update=function(e,t,a,o){return n.create(e,a,o).update(t)},h(n,T,e,t)}}],x={},_=[],w=0;w<g.length;++w)for(var P=g[w],E=P.bits,v=0;v<E.length;++v){var S=P.name+"_"+E[v];if(_.push(S),x[S]=P.createMethod(E[v],P.padding),"sha3"!==P.name){var A=P.name+E[v];_.push(A),x[A]=x[S]}}function k(e,t,a){this.blocks=[],this.s=[],this.padding=t,this.outputBits=a,this.reset=!0,this.finalized=!1,this.block=0,this.start=0,this.blockCount=1600-(e<<1)>>5,this.byteCount=this.blockCount<<2,this.outputBlocks=a>>5,this.extraBytes=(31&a)>>3;for(var n=0;n<50;++n)this.s[n]=0}function O(e,t,a){k.call(this,e,t,a)}k.prototype.update=function(t){if(this.finalized)throw new Error("finalize already called");var a,n=typeof t;if("string"!==n){if("object"!==n)throw new Error(e);if(null===t)throw new Error(e);if(i&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||i&&ArrayBuffer.isView(t)))throw new Error(e);a=!0}for(var o,s,r=this.blocks,d=this.byteCount,l=t.length,u=this.blockCount,c=0,y=this.s;c<l;){if(this.reset)for(this.reset=!1,r[0]=this.block,o=1;o<u+1;++o)r[o]=0;if(a)for(o=this.start;c<l&&o<d;++c)r[o>>2]|=t[c]<<p[3&o++];else for(o=this.start;c<l&&o<d;++c)(s=t.charCodeAt(c))<128?r[o>>2]|=s<<p[3&o++]:s<2048?(r[o>>2]|=(192|s>>6)<<p[3&o++],r[o>>2]|=(128|63&s)<<p[3&o++]):s<55296||s>=57344?(r[o>>2]|=(224|s>>12)<<p[3&o++],r[o>>2]|=(128|s>>6&63)<<p[3&o++],r[o>>2]|=(128|63&s)<<p[3&o++]):(s=65536+((1023&s)<<10|1023&t.charCodeAt(++c)),r[o>>2]|=(240|s>>18)<<p[3&o++],r[o>>2]|=(128|s>>12&63)<<p[3&o++],r[o>>2]|=(128|s>>6&63)<<p[3&o++],r[o>>2]|=(128|63&s)<<p[3&o++]);if(this.lastByteIndex=o,o>=d){for(this.start=o-d,this.block=r[u],o=0;o<u;++o)y[o]^=r[o];C(y),this.reset=!0}else this.start=o}return this},k.prototype.encode=function(e,t){var a=255&e,n=1,o=[a];for(a=255&(e>>=8);a>0;)o.unshift(a),a=255&(e>>=8),++n;return t?o.push(n):o.unshift(n),this.update(o),o.length},k.prototype.encodeString=function(t){var a,n=typeof t;if("string"!==n){if("object"!==n)throw new Error(e);if(null===t)throw new Error(e);if(i&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||i&&ArrayBuffer.isView(t)))throw new Error(e);a=!0}var o=0,s=t.length;if(a)o=s;else for(var r=0;r<t.length;++r){var p=t.charCodeAt(r);p<128?o+=1:p<2048?o+=2:p<55296||p>=57344?o+=3:(p=65536+((1023&p)<<10|1023&t.charCodeAt(++r)),o+=4)}return o+=this.encode(8*o),this.update(t),o},k.prototype.bytepad=function(e,t){for(var a=this.encode(t),n=0;n<e.length;++n)a+=this.encodeString(e[n]);var o=t-a%t,i=[];return i.length=o,this.update(i),this},k.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex,a=this.blockCount,n=this.s;if(e[t>>2]|=this.padding[3&t],this.lastByteIndex===this.byteCount)for(e[0]=e[a],t=1;t<a+1;++t)e[t]=0;for(e[a-1]|=2147483648,t=0;t<a;++t)n[t]^=e[t];C(n)}},k.prototype.toString=k.prototype.hex=function(){this.finalize();for(var e,t=this.blockCount,a=this.s,n=this.outputBlocks,o=this.extraBytes,i=0,r=0,p="";r<n;){for(i=0;i<t&&r<n;++i,++r)e=a[i],p+=s[e>>4&15]+s[15&e]+s[e>>12&15]+s[e>>8&15]+s[e>>20&15]+s[e>>16&15]+s[e>>28&15]+s[e>>24&15];r%t==0&&(C(a),i=0)}return o&&(e=a[i],p+=s[e>>4&15]+s[15&e],o>1&&(p+=s[e>>12&15]+s[e>>8&15]),o>2&&(p+=s[e>>20&15]+s[e>>16&15])),p},k.prototype.arrayBuffer=function(){this.finalize();var e,t=this.blockCount,a=this.s,n=this.outputBlocks,o=this.extraBytes,i=0,s=0,r=this.outputBits>>3;e=o?new ArrayBuffer(n+1<<2):new ArrayBuffer(r);for(var p=new Uint32Array(e);s<n;){for(i=0;i<t&&s<n;++i,++s)p[s]=a[i];s%t==0&&C(a)}return o&&(p[i]=a[i],e=e.slice(0,r)),e},k.prototype.buffer=k.prototype.arrayBuffer,k.prototype.digest=k.prototype.array=function(){this.finalize();for(var e,t,a=this.blockCount,n=this.s,o=this.outputBlocks,i=this.extraBytes,s=0,r=0,p=[];r<o;){for(s=0;s<a&&r<o;++s,++r)e=r<<2,t=n[s],p[e]=255&t,p[e+1]=t>>8&255,p[e+2]=t>>16&255,p[e+3]=t>>24&255;r%a==0&&C(n)}return i&&(e=r<<2,t=n[s],p[e]=255&t,i>1&&(p[e+1]=t>>8&255),i>2&&(p[e+2]=t>>16&255)),p},O.prototype=new k,O.prototype.finalize=function(){return this.encode(this.outputBits,!0),k.prototype.finalize.call(this)};var C=function(e){var t,a,n,o,i,s,r,p,l,u,c,y,b,m,f,T,h,I,g,x,_,w,P,E,v,S,A,k,O,C,B,M,F,R,N,D,L,U,V,G,q,W,$,H,K,J,X,Y,j,z,Z,Q,ee,te,ae,ne,oe,ie,se,re,pe,de,le;for(n=0;n<48;n+=2)o=e[0]^e[10]^e[20]^e[30]^e[40],i=e[1]^e[11]^e[21]^e[31]^e[41],s=e[2]^e[12]^e[22]^e[32]^e[42],r=e[3]^e[13]^e[23]^e[33]^e[43],p=e[4]^e[14]^e[24]^e[34]^e[44],l=e[5]^e[15]^e[25]^e[35]^e[45],u=e[6]^e[16]^e[26]^e[36]^e[46],c=e[7]^e[17]^e[27]^e[37]^e[47],t=(y=e[8]^e[18]^e[28]^e[38]^e[48])^(s<<1|r>>>31),a=(b=e[9]^e[19]^e[29]^e[39]^e[49])^(r<<1|s>>>31),e[0]^=t,e[1]^=a,e[10]^=t,e[11]^=a,e[20]^=t,e[21]^=a,e[30]^=t,e[31]^=a,e[40]^=t,e[41]^=a,t=o^(p<<1|l>>>31),a=i^(l<<1|p>>>31),e[2]^=t,e[3]^=a,e[12]^=t,e[13]^=a,e[22]^=t,e[23]^=a,e[32]^=t,e[33]^=a,e[42]^=t,e[43]^=a,t=s^(u<<1|c>>>31),a=r^(c<<1|u>>>31),e[4]^=t,e[5]^=a,e[14]^=t,e[15]^=a,e[24]^=t,e[25]^=a,e[34]^=t,e[35]^=a,e[44]^=t,e[45]^=a,t=p^(y<<1|b>>>31),a=l^(b<<1|y>>>31),e[6]^=t,e[7]^=a,e[16]^=t,e[17]^=a,e[26]^=t,e[27]^=a,e[36]^=t,e[37]^=a,e[46]^=t,e[47]^=a,t=u^(o<<1|i>>>31),a=c^(i<<1|o>>>31),e[8]^=t,e[9]^=a,e[18]^=t,e[19]^=a,e[28]^=t,e[29]^=a,e[38]^=t,e[39]^=a,e[48]^=t,e[49]^=a,m=e[0],f=e[1],J=e[11]<<4|e[10]>>>28,X=e[10]<<4|e[11]>>>28,k=e[20]<<3|e[21]>>>29,O=e[21]<<3|e[20]>>>29,re=e[31]<<9|e[30]>>>23,pe=e[30]<<9|e[31]>>>23,W=e[40]<<18|e[41]>>>14,$=e[41]<<18|e[40]>>>14,R=e[2]<<1|e[3]>>>31,N=e[3]<<1|e[2]>>>31,T=e[13]<<12|e[12]>>>20,h=e[12]<<12|e[13]>>>20,Y=e[22]<<10|e[23]>>>22,j=e[23]<<10|e[22]>>>22,C=e[33]<<13|e[32]>>>19,B=e[32]<<13|e[33]>>>19,de=e[42]<<2|e[43]>>>30,le=e[43]<<2|e[42]>>>30,te=e[5]<<30|e[4]>>>2,ae=e[4]<<30|e[5]>>>2,D=e[14]<<6|e[15]>>>26,L=e[15]<<6|e[14]>>>26,I=e[25]<<11|e[24]>>>21,g=e[24]<<11|e[25]>>>21,z=e[34]<<15|e[35]>>>17,Z=e[35]<<15|e[34]>>>17,M=e[45]<<29|e[44]>>>3,F=e[44]<<29|e[45]>>>3,E=e[6]<<28|e[7]>>>4,v=e[7]<<28|e[6]>>>4,ne=e[17]<<23|e[16]>>>9,oe=e[16]<<23|e[17]>>>9,U=e[26]<<25|e[27]>>>7,V=e[27]<<25|e[26]>>>7,x=e[36]<<21|e[37]>>>11,_=e[37]<<21|e[36]>>>11,Q=e[47]<<24|e[46]>>>8,ee=e[46]<<24|e[47]>>>8,H=e[8]<<27|e[9]>>>5,K=e[9]<<27|e[8]>>>5,S=e[18]<<20|e[19]>>>12,A=e[19]<<20|e[18]>>>12,ie=e[29]<<7|e[28]>>>25,se=e[28]<<7|e[29]>>>25,G=e[38]<<8|e[39]>>>24,q=e[39]<<8|e[38]>>>24,w=e[48]<<14|e[49]>>>18,P=e[49]<<14|e[48]>>>18,e[0]=m^~T&I,e[1]=f^~h&g,e[10]=E^~S&k,e[11]=v^~A&O,e[20]=R^~D&U,e[21]=N^~L&V,e[30]=H^~J&Y,e[31]=K^~X&j,e[40]=te^~ne&ie,e[41]=ae^~oe&se,e[2]=T^~I&x,e[3]=h^~g&_,e[12]=S^~k&C,e[13]=A^~O&B,e[22]=D^~U&G,e[23]=L^~V&q,e[32]=J^~Y&z,e[33]=X^~j&Z,e[42]=ne^~ie&re,e[43]=oe^~se&pe,e[4]=I^~x&w,e[5]=g^~_&P,e[14]=k^~C&M,e[15]=O^~B&F,e[24]=U^~G&W,e[25]=V^~q&$,e[34]=Y^~z&Q,e[35]=j^~Z&ee,e[44]=ie^~re&de,e[45]=se^~pe&le,e[6]=x^~w&m,e[7]=_^~P&f,e[16]=C^~M&E,e[17]=B^~F&v,e[26]=G^~W&R,e[27]=q^~$&N,e[36]=z^~Q&H,e[37]=Z^~ee&K,e[46]=re^~de&te,e[47]=pe^~le&ae,e[8]=w^~m&T,e[9]=P^~f&h,e[18]=M^~E&S,e[19]=F^~v&A,e[28]=W^~R&D,e[29]=$^~N&L,e[38]=Q^~H&J,e[39]=ee^~K&X,e[48]=de^~te&ne,e[49]=le^~ae&oe,e[0]^=d[n],e[1]^=d[n+1]};if(o)rr.exports=x;else for(w=0;w<_.length;++w)a[_[w]]=x[_[w]]}();var lr=dr.exports;const ur=new RegExp("^bytes([0-9]+)$"),cr=new RegExp("^(u?int)([0-9]*)$"),yr=new RegExp("^(.*)\\[([0-9]*)\\]$"),br=new Se("solidity/5.7.0");function mr(e,t,n){switch(e){case"address":return n?o.zeroPad(t,32):o.arrayify(t);case"string":return ir(t);case"bytes":return o.arrayify(t);case"bool":return t=t?"0x01":"0x00",n?o.zeroPad(t,32):o.arrayify(t)}let i=e.match(cr);if(i){let s=parseInt(i[2]||"256");return(i[2]&&String(s)!==i[2]||s%8!=0||0===s||s>256)&&br.throwArgumentError("invalid number type","type",e),n&&(s=256),t=a.BigNumber.from(t).toTwos(s),o.zeroPad(t,s/8)}if(i=e.match(ur),i){const a=parseInt(i[1]);return(String(a)!==i[1]||0===a||a>32)&&br.throwArgumentError("invalid bytes type","type",e),o.arrayify(t).byteLength!==a&&br.throwArgumentError(`invalid value for ${e}`,"value",t),n?o.arrayify((t+"0000000000000000000000000000000000000000000000000000000000000000").substring(0,66)):t}if(i=e.match(yr),i&&Array.isArray(t)){const a=i[1];parseInt(i[2]||String(t.length))!=t.length&&br.throwArgumentError(`invalid array length for ${e}`,"value",t);const n=[];return t.forEach((function(e){n.push(mr(a,e,!0))})),o.concat(n)}return br.throwArgumentError("invalid type","type",e)}function fr(e,t){e.length!=t.length&&br.throwArgumentError("wrong number of values; expected ${ types.length }","values",t);const a=[];return e.forEach((function(e,n){a.push(mr(e,t[n]))})),o.hexlify(o.concat(a))}function Tr(e,t){return a=fr(e,t),"0x"+lr.keccak_256(o.arrayify(a));var a}const hr=sr("PROTOCOL_SWAP_FEE_PERC"),Ir=sr("E-CLP"),gr=Tr(["bytes"],[e.defaultAbiCoder.encode(["bytes32","bytes32"],[hr,Ir])]);class xr{constructor(e,t,a){this.gyroConfigAddress=e,this.multicall=t,this.gyroConfigInterface=Jt.createInterface(),this.gyroConfig=Jt.connect(e,a)}async getGyroProtocolFee(t){let n;const o=Tr(["bytes"],[e.defaultAbiCoder.encode(["bytes32","uint256"],[hr,t])]),i=[{target:this.gyroConfigAddress,callData:this.gyroConfigInterface.encodeFunctionData("hasKey",[o])},{target:this.gyroConfigAddress,callData:this.gyroConfigInterface.encodeFunctionData("hasKey",[gr])},{target:this.gyroConfigAddress,callData:this.gyroConfigInterface.encodeFunctionData("hasKey",[hr])}],[,[s,r,p]]=await this.multicall.callStatic.aggregate(i),d=a.BigNumber.from(s).eq(1),l=a.BigNumber.from(r).eq(1),u=a.BigNumber.from(p).eq(1);return n=d?parseFloat(a.formatFixed(await this.gyroConfig.getUint(o),18)):l?parseFloat(a.formatFixed(await this.gyroConfig.getUint(gr),18)):u?parseFloat(a.formatFixed(await this.gyroConfig.getUint(hr),18)):0,n}}const _r=new e.Interface(["function gauge_relative_weight(address gauge, uint timestamp) view returns (uint)"]),wr=new e.Interface(["function gauge_relative_weight(address gauge) view returns (uint)"]);class Pr{constructor(e,t,a){this.multicall=e,this.gaugeControllerAddress=t,this.gaugeControllerCheckpointerAddress=a}async getRelativeWeights(e,t){const a=e.map((e=>this.gaugeControllerCheckpointerAddress&&!t?{target:this.gaugeControllerCheckpointerAddress,callData:wr.encodeFunctionData("gauge_relative_weight",[n.getAddress(e)])}:{target:this.gaugeControllerAddress,callData:_r.encodeFunctionData("gauge_relative_weight",[n.getAddress(e),t||Math.floor(Date.now()/1e3)])})),[,o]=await this.multicall.callStatic.aggregate(a);return e.reduce(((e,t,a)=>(e[t]||(e[t]=parseFloat(Oe(o[a],18))),e)),{})}}class Er{async get(e){const t=await this.query(e);return(null==t?void 0:t.length)>0?t[0]:void 0}async find(e){return this.get({where:{id:e}})}async findBy(e,t){return this.get({where:{[String(e)]:t}})}async findAllBy(e,t,a=1e3,n=0){const o={where:{[String(e)]:t},first:a,skip:n};return this.query(o)}}class vr extends Er{constructor(e,t,a){super(),this.chainId=t,this.blockHeight=a,this.client=xi(e)}}class Sr extends Er{constructor(e,t,a){super(),this.chainId=t,this.blockHeight=a,this.client=_i(e)}}class Ar extends Sr{async query(e){e.orderBy||(e.orderBy=Qo.balance),e.orderDirection||(e.orderDirection=oi.desc),!e.block&&this.blockHeight&&(e.block={number:await this.blockHeight()});const{gaugeShares:t}=await this.client.GaugeShares(e);return t.map(this.mapType)}mapType(e){var t;return{id:e.id,balance:e.balance,userAddress:null===(t=e.user)||void 0===t?void 0:t.id,gauge:{id:e.gauge.id,poolId:e.gauge.poolId||void 0,isKilled:e.gauge.isKilled,totalSupply:e.gauge.totalSupply}}}async findByUser(e,t,a){return this.findAllBy(exports.GaugeShareAttributes.UserAddress,e,t,a)}async findByGauge(e,t,a){return this.findAllBy(exports.GaugeShareAttributes.GaugeId,e,t,a)}}const kr=new e.Interface(["function totalSupply() view returns (uint)","function working_supply() view returns (uint)","function reward_count() view returns (uint)","function reward_tokens(uint rewardIndex) view returns (address)","function reward_data(address rewardToken) view returns (tuple(address token, address distributor, uint period_finish, uint rate, uint last_update, uint integral) data)"]),Or=new e.Interface(["function inflation_rate(uint currentWeekTimestamp) view returns (uint)"]);class Cr{constructor(e,t){this.multicall=e,this.chainId=t}async getTotalSupplies(e){const t=e.map((e=>({target:e,callData:kr.encodeFunctionData("totalSupply",[])}))),[,a]=await this.multicall.callStatic.aggregate(t),n=a.map((e=>"0x"==e?"0x0":e));return e.reduce(((e,t,a)=>(e[t]||(e[t]=parseFloat(Oe(n[a],18))),e)),{})}async getWorkingSupplies(e){const t=e.map((e=>({target:e,callData:kr.encodeFunctionData("working_supply",[])}))),[,a]=await this.multicall.callStatic.aggregate(t),n=a.map((e=>"0x"==e?"0x0":e));return e.reduce(((e,t,a)=>(e[t]||(e[t]=parseFloat(Oe(n[a],18))),e)),{})}async getInflationRates(e){const t=Math.floor(Date.now()/1e3/604800),a=e.map((e=>({target:e,callData:Or.encodeFunctionData("inflation_rate",[t])}))),[,n]=await this.multicall.callStatic.aggregate(a),o=n.map((e=>"0x"==e?"0x0":e));return e.reduce(((e,t,a)=>(e[t]||(e[t]=parseFloat(Oe(o[a],18))),e)),{})}async getRewardCounts(e){let t;if(1==this.chainId){const a=e.map((e=>({target:e,callData:kr.encodeFunctionData("reward_count",[])}))),[,n]=await this.multicall.callStatic.aggregate(a),o=n.map((e=>"0x"==e?"0x0":e));t=e.reduce(((e,t,a)=>(e[t]||(e[t]=parseInt(o[a])),e)),{})}else t=e.reduce(((e,t)=>(e[t]||(e[t]=1),e)),{});return t}async getRewardTokens(e,t){const a=t||await this.getRewardCounts(e),n=e.filter((e=>a[e]>0)),o=[0],i=n.map(((e,t)=>{const n=[];for(let t=0;t<a[e];t++)n.push({target:e,callData:kr.encodeFunctionData("reward_tokens",[t])});return o[t+1]=o[t]+a[e],n})).flat(),[,s]=await this.multicall.callStatic.aggregate(i);return n.reduce(((e,t,a)=>{const n=o[a],i=o[a+1],r=[];for(let e=n;e<i;e++)r.push(kr.decodeFunctionResult("reward_tokens",s[e])[0]);return e[t]||(e[t]=r),e}),{})}async getRewardData(e,t){const a=t||await this.getRewardTokens(e),n=[0],o=Object.keys(a).map(((e,t)=>{const o=[];for(let t=0;t<a[e].length;t++)o.push({target:e,callData:kr.encodeFunctionData("reward_data",[a[e][t]])});return n[t+1]=n[t]+a[e].length,o})).flat(),[,i]=await this.multicall.callStatic.aggregate(o),s=i.map((e=>kr.decodeFunctionResult("reward_data",e)[0]));return Object.keys(a).reduce(((e,t,o)=>{const i=n[o],r=a[t].reduce(((e,t,a)=>(e[t]||(e[t]=s[i+a]),e)),{});return e[t]||(e[t]=r),e}),{})}}class Br{constructor(e){this.gauges=[],this.client=_i(e)}async fetch(){const e=(await this.client.Pools({where:{preferentialGauge_not:null}})).pools.map((e=>e.preferentialGauge));return this.gauges=e,this.gauges}async find(e){return 0==this.gauges.length&&await this.fetch(),this.gauges.find((t=>t.id==e))}async findBy(e,t){if(0==this.gauges.length&&await this.fetch(),"id"==e)return this.find(t);if("poolId"==e)return this.gauges.find((e=>e.poolId==t));if("poolAddress"==e)return this.gauges.find((e=>e.poolAddress==t));throw`search by ${e} not implemented`}}class Mr{constructor(e,t,a,n,o){this.chainId=n,this.workingSupplies={},this.relativeWeights={},this.inflationRates={},this.rewardData={},a&&(this.gaugeController=new Pr(t,a,o)),this.multicall=new Cr(t,n),this.subgraph=new Br(e)}async fetch(){const e=await this.subgraph.fetch(),t=e.map((e=>e.id));if(1==this.chainId)this.workingSupplies=await this.multicall.getWorkingSupplies(t);else{const t=["0x3b8ca519122cdd8efb272b0d3085453404b25bd0","0xb08e16cfc07c684daa2f93c70323badb2a6cbfd2","0x2e96068b3d5b5bae3d7515da4a1d2e52d08a2647","0x809b79b53f18e9bc08a961ed4678b901ac93213a"],a=e.filter((e=>!t.includes(e.factory.id.toLowerCase()))).map((e=>e.id));a.length>0&&(this.inflationRates=await this.multicall.getInflationRates(a))}return this.gaugeController&&(this.relativeWeights=await this.gaugeController.getRelativeWeights(t)),this.rewardData=e.reduce(((e,t)=>{var n;return e[n=t.id]||(e[n]=t.tokens?Object.fromEntries(t.tokens.map((e=>[e.id.split("-")[0],{distributor:"",last_update:a.BigNumber.from(0),integral:a.BigNumber.from(0),token:e.id.split("-")[0],decimals:e.decimals,rate:Ce(e.rate||"0",e.decimals),period_finish:a.BigNumber.from(e.periodFinish||"0")}]))):{}),e}),{}),e.map(this.compose.bind(this))}async find(e){return this.gauges||(this.gauges=this.fetch()),(await this.gauges).find((t=>t.id==e))}async findBy(e,t){let a;if(this.gauges||(this.gauges=this.fetch()),"id"==e)return this.find(t);if("address"==e)return this.find(t);if("poolId"==e)a=(await this.gauges).find((e=>e.poolId==t));else{if("poolAddress"!=e)throw`search by ${e} not implemented`;a=(await this.gauges).find((e=>e.poolAddress==t))}return a}compose(e){return{id:e.id,address:e.id,name:e.symbol,poolId:e.poolId,poolAddress:e.poolAddress,totalSupply:parseFloat(e.totalSupply),workingSupply:this.workingSupplies[e.id],relativeWeight:this.relativeWeights[e.id],rewardTokens:this.rewardData[e.id],balInflationRate:this.inflationRates[e.id]}}}class Fr{constructor(e,t){this.url=e,this.apiKey=t}async get(e){try{const t=this.toPayload(e),{data:a}=await P.default.post(this.url,t,{headers:{"x-api-key":this.apiKey}});if(a.errors)throw new Error(a.errors.map((e=>e.message)).join(","));return a.data}catch(e){throw console.error(e),e}return[]}toPayload(e){return JSON.stringify({query:b.jsonToGraphQLQuery({query:e})})}}function Rr(e){return new Promise((t=>setTimeout(t,e)))}const Nr=(e,t)=>{var a,n,o,i,s,r,p,d,l,u,c;return{id:e.id,name:e.name||"",address:e.address,chainId:t,poolType:e.poolType,poolTypeVersion:e.poolTypeVersion||1,swapFee:e.swapFee,swapEnabled:e.swapEnabled,protocolYieldFeeCache:e.protocolYieldFeeCache||"0.5",protocolSwapFeeCache:e.protocolSwapFeeCache||"0.5",amp:null!==(a=e.amp)&&void 0!==a?a:void 0,owner:null!==(n=e.owner)&&void 0!==n?n:void 0,factory:null!==(o=e.factory)&&void 0!==o?o:void 0,symbol:null!==(i=e.symbol)&&void 0!==i?i:void 0,tokens:(e.tokens||[]).map(Dr),tokensList:e.tokensList,tokenAddresses:(e.tokens||[]).map((e=>e.address)),totalLiquidity:e.totalLiquidity,totalShares:e.totalShares,totalSwapFee:e.totalSwapFee,totalSwapVolume:e.totalSwapVolume,priceRateProviders:null!==(s=e.priceRateProviders)&&void 0!==s?s:void 0,createTime:e.createTime,mainIndex:null!==(r=e.mainIndex)&&void 0!==r?r:void 0,wrappedIndex:null!==(p=e.wrappedIndex)&&void 0!==p?p:void 0,totalWeight:e.totalWeight||"1",lowerTarget:null!==(d=e.lowerTarget)&&void 0!==d?d:"0",upperTarget:null!==(l=e.upperTarget)&&void 0!==l?l:"0",isInRecoveryMode:null!==(u=e.isInRecoveryMode)&&void 0!==u&&u,isPaused:null!==(c=e.isPaused)&&void 0!==c&&c}},Dr=e=>{const t=Lr(e.token);return{...e,isExemptFromYieldProtocolFee:e.isExemptFromYieldProtocolFee||!1,token:t}},Lr=e=>{let t=null;return e.pool&&(t={id:e.pool.id,address:e.pool.address,totalShares:e.pool.totalShares,poolType:e.pool.poolType,mainIndex:e.pool.mainIndex||0},(null==e?void 0:e.pool.tokens)&&(t.tokens=e.pool.tokens.map(Ur))),{pool:t,latestUSDPrice:e.latestUSDPrice||void 0}},Ur=e=>({address:e.address,decimals:e.decimals,symbol:e.symbol,balance:e.balance,priceRate:e.priceRate,weight:e.weight,isExemptFromYieldProtocolFee:e.isExemptFromYieldProtocolFee||void 0,token:e.token?Lr(e.token):void 0});class Vr{constructor(e){var t,a;this.skip=0,this.client=xi(e.url),this.blockHeight=e.blockHeight,this.chainId=e.chainId;const n={orderBy:yo.TotalLiquidity,orderDirection:so.Desc,where:{totalShares:{gt:1e-12}}},o=Object.assign({},(null===(t=e.query)||void 0===t?void 0:t.args)||n),i=Object.assign({},(null===(a=e.query)||void 0===a?void 0:a.attrs)||{});this.query={args:o,attrs:i}}async fetchAllPools(){const e=X.getInstance();e.time("fetching pools"),this.blockHeight&&(this.query.args.block={number:await this.blockHeight()});const t=new nt(this.query.args).format(new at),{pool0:a,pool1000:n,pool2000:o}=await this.client.AllPools(t);return e.timeEnd("fetching pools"),[...a,...n,...o].map((e=>Nr(e,this.chainId)))}async fetch(e){const t=X.getInstance();t.time("fetching pools"),(null==e?void 0:e.skip)&&(this.query.args.skip=e.skip),this.blockHeight&&(this.query.args.block={number:await this.blockHeight()}),this.query.args.first=(null==e?void 0:e.first)||this.query.args.first||1e3;const a=new nt(this.query.args).format(new at),{pools:n}=await this.client.Pools(a);return this.skip=((null==e?void 0:e.skip)||0)+n.length,t.timeEnd("fetching pools"),n.map((e=>Nr(e,this.chainId)))}async find(e){return await this.findBy("id",e)}async findBy(e,t){return this.pools||(this.pools=this.fetchAllPools()),(await this.pools).find((a=>a[e]==t))}async all(){return this.pools||(this.pools=this.fetchAllPools()),this.pools}async block(){return this.blockHeight?{number:await this.blockHeight()}:void 0}async where(e){return this.pools||(this.pools=this.fetchAllPools()),(await this.pools).filter(e)}}var Gr,qr,Wr;async function $r(e,t,n,o){if(0===e.length)return e;const i=Object.values(Object.fromEntries([...da.abi,...ra.abi,...ua.abi,...ia.abi,...St.abi,...zt.abi,...wt.abi,...Ia.abi,...Ut.abi].map((e=>[e.name,e])))),s=ta.connect(t,o),r=new os(s,i),p=Object.values(exports.PoolType),d=[];e.forEach((e=>{if(p.includes(e.poolType)&&"Managed"!==e.poolType)switch(d.push(e),r.call(`${e.id}.poolTokens`,n,"getPoolTokens",[e.id]),r.call(`${e.id}.totalSupply`,e.address,"totalSupply"),e.poolType){case"LiquidityBootstrapping":case"Investment":case"Weighted":r.call(`${e.id}.swapFee`,e.address,"getSwapFeePercentage"),r.call(`${e.id}.weights`,e.address,"getNormalizedWeights");break;case"StablePhantom":r.call(`${e.id}.virtualSupply`,e.address,"getVirtualSupply"),r.call(`${e.id}.amp`,e.address,"getAmplificationParameter"),r.call(`${e.id}.swapFee`,e.address,"getSwapFeePercentage");break;case"MetaStable":case"Stable":r.call(`${e.id}.amp`,e.address,"getAmplificationParameter"),r.call(`${e.id}.swapFee`,e.address,"getSwapFeePercentage");break;case"ComposableStable":r.call(`${e.id}.actualSupply`,e.address,"getActualSupply"),r.call(`${e.id}.amp`,e.address,"getAmplificationParameter"),r.call(`${e.id}.swapFee`,e.address,"getSwapFeePercentage");break;case"Element":r.call(`${e.id}.swapFee`,e.address,"percentFee");break;case"FX":r.call(`${e.id}.swapFee`,e.address,"protocolPercentFee");break;case"Gyro2":case"Gyro3":r.call(`${e.id}.poolTokens`,n,"getPoolTokens",[e.id]),r.call(`${e.id}.totalSupply`,e.address,"totalSupply"),r.call(`${e.id}.swapFee`,e.address,"getSwapFeePercentage");break;case"GyroE":r.call(`${e.id}.swapFee`,e.address,"getSwapFeePercentage"),e.poolTypeVersion&&2===e.poolTypeVersion&&r.call(`${e.id}.tokenRates`,e.address,"getTokenRates");break;default:e.poolType.toString().includes("Linear")&&(r.call(`${e.id}.virtualSupply`,e.address,"getVirtualSupply"),r.call(`${e.id}.swapFee`,e.address,"getSwapFeePercentage"),r.call(`${e.id}.targets`,e.address,"getTargets"),"AaveLinear"===e.poolType&&1===e.poolTypeVersion&&r.call(`${e.id}.rate`,e.address,"getWrappedTokenRate"))}else{X.getInstance().warn(`Unknown pool type: ${e.poolType} ${e.id}`)}}));let l={};try{l=await r.execute()}catch(e){throw new Error("Issue with multicall execution.")}const u=[];return Object.entries(l).forEach((([e,t],n)=>{try{const{poolTokens:o,swapFee:i,weights:s,totalSupply:r,virtualSupply:p,actualSupply:l,tokenRates:c}=t;if("Stable"===d[n].poolType||"MetaStable"===d[n].poolType||"StablePhantom"===d[n].poolType||"ComposableStable"===d[n].poolType){if(!t.amp)return void console.error(`Stable Pool Missing Amp: ${e}`);d[n].amp=a.formatFixed(t.amp[0],3)}if(d[n].poolType.includes("Linear")){if(!t.targets)return void console.error(`Linear Pool Missing Targets: ${e}`);if(d[n].lowerTarget=a.formatFixed(t.targets[0],18),d[n].upperTarget=a.formatFixed(t.targets[1],18),"AaveLinear"===d[n].poolType&&1===d[n].poolTypeVersion){const o=d[n].wrappedIndex;if(void 0===o||void 0===t.rate)return void console.error(`Linear Pool Missing WrappedIndex or PriceRate: ${e}`);d[n].tokens[o].priceRate=a.formatFixed(t.rate,18)}}if(d[n].swapFee=a.formatFixed(i,18),o.tokens.forEach(((t,i)=>{const r=d[n].tokens.find((e=>Je(e.address,t)));if(!r)throw`Pool Missing Expected Token: ${e} ${t}`;r.balance=a.formatFixed(o.balances[i],r.decimals),s&&(r.weight=a.formatFixed(s[i],18))})),d[n].poolType.includes("Linear")||"StablePhantom"===d[n].poolType){if(void 0===p){return void X.getInstance().warn(`Pool with pre-minted BPT missing Virtual Supply: ${e}`)}d[n].totalShares=a.formatFixed(p,18)}else if("ComposableStable"===d[n].poolType){if(void 0===l){return void X.getInstance().warn(`ComposableStable missing Actual Supply: ${e}`)}d[n].totalShares=a.formatFixed(l,18)}else d[n].totalShares=a.formatFixed(r,18);if("GyroE"===d[n].poolType&&2==d[n].poolTypeVersion){if(!Array.isArray(c)||2!==c.length)return void console.error(`GyroEV2 pool with missing or invalid tokenRates: ${e}`);d[n].tokenRates=c.map((e=>a.formatFixed(e,18)))}u.push(d[n])}catch(e){throw new Error(`Issue with pool onchain data: ${e}`)}})),u}!function(e){e[e.SWAP_FEE_PERCENTAGE=0]="SWAP_FEE_PERCENTAGE",e[e.PERCENT_FEE=1]="PERCENT_FEE"}(Gr||(Gr={})),function(e){e[e.TOTAL_SUPPLY=0]="TOTAL_SUPPLY",e[e.VIRTUAL_SUPPLY=1]="VIRTUAL_SUPPLY",e[e.ACTUAL_SUPPLY=2]="ACTUAL_SUPPLY"}(qr||(qr={}));class Hr{constructor(e,t,a){this.poolsSubgraph=e,this.poolsToIgnore=a,this.skip=0,this.provider=t.provider,this.multicall=t.multicall,this.vault=t.vault}filterPools(e){return e.filter((e=>{if(!1===e.swapEnabled)return!1;if(!this.poolsToIgnore)return!0;return-1===this.poolsToIgnore.findIndex((t=>Je(t,e.address)))}))}async fetchDefault(){const e=await this.poolsSubgraph.all(),t=this.filterPools(e),a=X.getInstance();a.time(`fetching onchain ${t.length} pools`);const n=await $r(t,this.multicall,this.vault,this.provider);return a.timeEnd(`fetching onchain ${t.length} pools`),n}async fetch(e){const t=await this.poolsSubgraph.fetch(e),a=this.filterPools(t),n=X.getInstance();n.time(`fetching onchain ${a.length} pools`);const o=await $r(a,this.multicall,this.vault,this.provider);return n.timeEnd(`fetching onchain ${a.length} pools`),o}async find(e,t=!1){return await this.findBy("id",e,t)}async findBy(e,t,a=!1){return this.pools&&!a||(this.pools=this.fetchDefault()),(await this.pools).find((a=>a[e]==t))}async all(){return this.pools||(this.pools=this.fetchDefault()),this.pools}async where(e){return this.pools||(this.pools=this.fetchDefault()),(await this.pools).filter(e)}async refresh(e){const t=await $r([e],this.multicall,this.vault,this.provider);if(this.pools){const a=(await this.pools).findIndex((t=>t.address===e.address));-1!==a&&(this.pools=Promise.resolve([...(await this.pools).splice(a,1),t[0]]))}return t[0]}}class Kr extends Sr{async query(e){!e.block&&this.blockHeight&&(e.block={number:await this.blockHeight()});const{pools:t}=await this.client.PoolGauges(e);return t.map(this.mapType)}mapType(e){return e}}exports.PoolJoinExitAttributes=void 0,(Wr=exports.PoolJoinExitAttributes||(exports.PoolJoinExitAttributes={})).Pool="pool",Wr.Sender="sender";class Jr extends vr{async query(e){e.orderBy||(e.orderBy=ao.Timestamp),e.orderDirection||(e.orderDirection=so.Asc),!e.block&&this.blockHeight&&(e.block={number:await this.blockHeight()});const{joinExits:t}=await this.client.JoinExits(e);return t.map(this.mapType)}mapType(e){return{id:e.id,userAddress:e.user.id,poolId:e.pool.id,timestamp:e.timestamp,type:e.type,amounts:e.amounts,tokens:e.pool.tokensList}}async findByUser(e,t,a){return this.findAllBy(exports.PoolJoinExitAttributes.Sender,e,t,a)}async findJoins(e,t){return this.query({where:{sender:e,pool:t,type:"Join"}})}async findExits(e,t){return this.query({where:{sender:e,pool:t,type:"Exit"}})}async findByPool(e,t,a){return this.findAllBy(exports.PoolJoinExitAttributes.Pool,e,t,a)}}class Xr extends vr{async query(e){e.orderBy||(e.orderBy=lo.Balance),e.orderDirection||(e.orderDirection=so.Desc),!e.block&&this.blockHeight&&(e.block={number:await this.blockHeight()});const{poolShares:t}=await this.client.PoolShares(e);return t.map(this.mapType)}mapType(e){return{id:e.id,userAddress:e.userAddress.id,poolId:e.poolId.id,balance:e.balance}}async findByUser(e,t,a){return this.findAllBy(exports.PoolShareAttributes.UserAddress,e,t,a)}async findByPool(e,t,a){return this.findAllBy(exports.PoolShareAttributes.PoolId,e,t,a)}}class Yr{constructor(e){this.tokens=e}async find(e){return this.tokens.find((t=>t.address.toLowerCase()===e.toLowerCase()))}async findBy(e,t){return this.tokens.find((a=>a[e]===t))}}class jr{constructor(e,t=1){this.chainId=t,this.prices={},this.baseTokenAddresses=[e.map(Ne)[0]],this.urlBase=`https://api.coingecko.com/api/v3/simple/token_price/${this.platform(t)}?vs_currencies=usd,eth`,this.debouncer=new Ve(this.fetch.bind(this),200)}fetch(e,{signal:t}={}){return e.length,P.default.get(this.url(e),{signal:t}).then((({data:e})=>e)).catch((e=>{var t;console.log(e);const a=["Error fetching token prices from coingecko"];return e.isAxiosError?(null===(t=e.response)||void 0===t?void 0:t.status)&&a.push(`with status ${e.response.status}`):a.push(e),Promise.reject(a.join(" "))})).finally((()=>{e.length}))}fetchNative({signal:e}={}){let t;!function(e){e.ETH="ethereum",e.MATIC="matic-network",e.XDAI="xdai"}(t||(t={}));let a=t.ETH;return 137===this.chainId&&(a=t.MATIC),100===this.chainId&&(a=t.XDAI),P.default.get(`https://api.coingecko.com/api/v3/simple/price/?vs_currencies=eth,usd&ids=${a}`,{signal:e}).then((({data:e})=>e[a])).catch((e=>{var t;const a=["Error fetching native token from coingecko"];return e.isAxiosError?(null===(t=e.response)||void 0===t?void 0:t.status)&&a.push(`with status ${e.response.status}`):a.push(e),Promise.reject(a.join(" "))})).finally((()=>{}))}find(e){const t=Ne(e,this.chainId);if(!this.prices[t]){if(0===Object.keys(this.prices).length)for(const e of this.baseTokenAddresses)this.prices[e]=this.debouncer.fetch(e).then((t=>t[e]));if(t===Te(this.chainId).Addresses.nativeAsset.toLowerCase())return this.nativePrice||(this.prices[t]=this.fetchNative()),this.prices[t];this.prices[t]=this.debouncer.fetch(t).then((e=>e[t]))}return this.prices[t]}async findBy(e,t){if("address"==e)return this.find(t)}platform(e){switch(e){case 1:case 5:case 42:case 31337:return"ethereum";case 100:return"xdai";case 137:return"polygon-pos";case 250:return"fantom";case 1101:return"polygon-zkevm";case 42161:return"arbitrum-one";case 43114:return"avalanche"}return"2"}url(e){return`${this.urlBase}&contract_addresses=${e.join(",")}`}}class zr{constructor(e=1){this.chainId=e,this.prices={},this.urlBase=`https://api.coingecko.com/api/v3/coins/${this.platform(e)}/contract/%TOKEN_ADDRESS%/market_chart/range?vs_currency=usd`}fetch(e,t,{signal:a}={}){const n=this.urlRange(e,t);return P.default.get(n,{signal:a}).then((({data:e})=>e)).catch((e=>{var t;const a=["Error fetching historical token prices from coingecko"];return e.isAxiosError?(null===(t=e.response)||void 0===t?void 0:t.status)&&a.push(`with status ${e.response.status}`):a.push(e),Promise.reject(a.join(" "))})).finally((()=>{}))}async find(e){throw"Historic price requires point-in-time timestamp, please use findBy(address, timestamp)"}async findBy(e,t){const a=Ne(e,this.chainId);return{usd:`${(await this.fetch(a,t)).prices[0][1]}`}}platform(e){switch(e){case 1:case 5:case 42:case 31337:return"ethereum";case 137:return"polygon-pos";case 42161:return"arbitrum-one";case 100:return"xdai"}return"2"}urlRange(e,t){const a=t-3600,n=t+3600;return`${this.urlBase.replace("%TOKEN_ADDRESS%",e)}&from=${a}&to=${n}`}}class Zr{constructor(e,t=1){this.subgraphUrl=e,this.chainId=t,this.prices={},this.debouncer=new Ve(this.fetch.bind(this),200)}async fetch(e,{signal:t}={}){return e.length,P.default.post(this.subgraphUrl,{variables:{addresses:e},query:"query($addresses: [String!]) {\n            tokens(\n              where: {\n                id_in: $addresses\n              }\n            ) {\n              address\n              latestUSDPrice\n            }\n          }"},{signal:t}).then((e=>e.data.data)).then((({tokens:e})=>Object.fromEntries(e.map((e=>[e.address,{usd:e.latestUSDPrice||void 0}]))))).finally((()=>{e.length}))}async find(e){const t=Ne(e,this.chainId);return this.prices[t]||(this.prices[t]=this.debouncer.fetch(t).then((e=>e[t]))),this.prices[t]}async findBy(e,t){if("address"==e)return this.find(t)}}class Qr{constructor(e,t,a){this.coingeckoRepository=e,this.subgraphRepository=t,this.aaveRates=a}async find(e){let t;try{if(t=await this.coingeckoRepository.find(e),!(null==t?void 0:t.usd))throw new Error("Price not found")}catch(a){X.getInstance().warn(a),t=await this.subgraphRepository.find(e)}const a=await this.aaveRates.getRate(e)||1;return t&&t.usd?{...t,usd:(parseFloat(t.usd)*a).toString()}:t}async findBy(e,t){if("address"===e)return this.find(t);throw`Token price search by ${e} not implemented`}}class ep{constructor(e,t){this.coingeckoRepository=e,this.aaveRates=t}async find(e){return this.findBy(e,Math.floor(Date.now()/1e3))}async findBy(e,t){const a=await this.coingeckoRepository.findBy(e,t),n=await this.aaveRates.getRate(e)||1;return a&&a.usd?{...a,usd:(parseFloat(a.usd)*n).toString()}:a}}const tp=["function claimTokens(address user, address[] tokens) returns (uint256[])","function claimToken(address user, address token) returns (uint256)"],ap=new e.Interface(["function getTokensDistributedInWeek(address token, uint timestamp) view returns (uint)","function claimTokens(address user, address[] tokens) returns (uint256[])","function claimToken(address user, address token) returns (uint256)"]),np=new e.Interface(["function totalSupply() view returns (uint)"]);class op{constructor(e,t,a,n,o,i){this.multicall=e,this.feeDistributorAddress=t,this.balAddress=a,this.veBalAddress=n,this.bbAUsdAddress=o,this.feeDistributor=((e,t)=>new y.Contract(e,tp,t))(t,i)}async fetch(e){const t=this.getPreviousWeek(e),a=[{target:this.feeDistributorAddress,callData:ap.encodeFunctionData("getTokensDistributedInWeek",[n.getAddress(this.balAddress),t])},{target:this.feeDistributorAddress,callData:ap.encodeFunctionData("getTokensDistributedInWeek",[n.getAddress(this.bbAUsdAddress),t])},{target:this.veBalAddress,callData:np.encodeFunctionData("totalSupply",[])}],[,o]=await this.multicall.callStatic.aggregate(a);return{balAmount:parseFloat(Oe(o[0],18)),bbAUsdAmount:parseFloat(Oe(o[1],18)),veBalSupply:parseFloat(Oe(o[2],18)),bbAUsdPrice:parseFloat("1.0"),balAddress:this.balAddress}}async multicallData(e){return this.data||(this.data=await this.fetch(e)),this.data}getPreviousWeek(e){const t=new Date(e);t.setUTCHours(0),t.setUTCMinutes(0),t.setUTCSeconds(0),t.setUTCMilliseconds(0);let a=t.getUTCDay()-4;return a<0&&(a+=7),a+=7,Math.floor(t.getTime()/1e3)-86400*a}async getClaimableBalances(e,t){try{const a=await this.feeDistributor.callStatic.claimTokens(e,t);return this.extractTokenBalance(t,a)}catch(e){return{}}}claimBalances(e,t){return ap.encodeFunctionData("claimTokens",[e,t])}extractTokenBalance(e,t){return e.reduce(((e,n,o)=>{var i;return e[n]=null!==(i=t[o])&&void 0!==i?i:a.BigNumber.from(0),e}),{})}}const ip=new e.Interface(["function getProtocolFeesCollector() view returns (address)"]),sp=new e.Interface(["function getSwapFeePercentage() view returns (uint)"]);let rp;class pp{constructor(e,t){this.provider=t,this.vault=new y.Contract(e,ip,this.provider)}async fetch(){const e=await this.vault.getProtocolFeesCollector(),t=new y.Contract(e,sp,this.provider),a=await t.getSwapFeePercentage();return parseFloat(Oe(a,18))}async find(){return rp||(rp=this.fetch()),this.swapFeePercentage=await rp,this.swapFeePercentage}async findBy(){return this.find()}}const dp=new e.Interface(["function getSwapFeePercentage() view returns (uint)"]);let lp;class up{constructor(e,t){this.multicall=e,this.protocolFeePercentagesProviderAddress=t}async fetch(){const e=[{target:this.protocolFeePercentagesProviderAddress,callData:dp.encodeFunctionData("getFeeTypePercentage",[0])},{target:this.protocolFeePercentagesProviderAddress,callData:dp.encodeFunctionData("getFeeTypePercentage",[2])}],[,t]=await this.multicall.callStatic.aggregate(e);return{swapFee:parseFloat(Oe(t[0],18)),yieldFee:parseFloat(Oe(t[2],18))}}async getFees(){return lp||(lp=this.fetch()),this.protocolFees=await lp,this.protocolFees}}class cp{constructor(e="https://yield-tokens.balancer.workers.dev/"){this.url=e}async fetch(){let e={};try{e=(await P.default.get(this.url)).data}catch(e){X.getInstance().warn(`Failed to fetch yield tokens: ${e}`)}return e}async find(e){const t=e.toLocaleLowerCase();return this.yields||(this.yields=this.fetch()),this.yields.then((e=>e[t]&&e[t]>0?e[t]:0))}async findBy(e,t){return"address"!=e?0:this.find(t)}}const yp=e=>`{\n  blocks(first: 1, orderBy: timestamp, orderDirection: asc, where: { timestamp_gt: ${e} }) {\n    number\n  }\n}`,bp=async(e,t)=>{const a={query:yp(t)},n=await P.default.post(e,a),{data:{blocks:o}}=n.data;return parseInt(o[0].number)};class mp{constructor(e){this.endpoint=e,this.blocks={}}async find(e){if("dayAgo"==e){const e=""+(Math.floor(Date.now()/1e3)-86400);return this.blocks[e]||(this.blocks={...this.blocks,[e]:bp(this.endpoint,e)}),this.blocks[e]}}async findBy(e="",t=""){}}var fp=[{chainId:1,address:"0x8888801af4d980682e47f1a9036e589479e835c5",symbol:"mph"},{chainId:1,address:"0x27054b13b1b798b345b591a4d22e6562d47ea75a",symbol:"ast"},{chainId:1,address:"0x3301ee63fb29f863f2333bd4466acb46cd8323e6",symbol:"akita"},{chainId:1,address:"0x616e8bfa43f920657b3497dbf40d6b1a02d4608d",symbol:"aurabal"},{chainId:1,address:"0xc0c293ce456ff0ed870add98a0828dd4d2903dbf",symbol:"aura"},{chainId:1,address:"0x3472a5a71965499acd81997a54bba8d852c6e53d",symbol:"badger"},{chainId:1,address:"0xba100000625a3754423978a60c9317c58a424e3d",symbol:"bal"},{chainId:1,address:"0x804cdb9116a10bb78768d3252355a1b18067bf8f",symbol:"bb-a-dai"},{chainId:1,address:"0x9210f1204b5a24742eba12f710636d76240df3d0",symbol:"bb-a-usdc"},{chainId:1,address:"0x2bbf681cc4eb09218bee85ea2a5d3d13fa40fc0c",symbol:"bb-a-usdt"},{chainId:1,address:"0x7b50775383d3d6f0215a8f290f2c9e2eebbeceb2",symbol:"bb-a-usd"},{chainId:1,address:"0x2d94aa3e47d9d5024503ca8491fce9a2fb4da198",symbol:"bank"},{chainId:1,address:"0x0d8775f648430679a709e98d2b0cb6250d2887ef",symbol:"bat"},{chainId:1,address:"0xf17e65822b568b3903685a7c9f496cf7656cc6c2",symbol:"bico"},{chainId:1,address:"0x799ebfabe77a6e34311eeee9825190b9ece32824",symbol:"btrst"},{chainId:1,address:"0x514910771af9ca656af840dff83e8264ecf986ca",symbol:"link"},{chainId:1,address:"0x3506424f91fd33084466f402d5d97f05f8e3b4af",symbol:"chz"},{chainId:1,address:"0x41e5560054824ea6b0732e656e3ad64e20e94e45",symbol:"cvc"},{chainId:1,address:"0xc00e94cb662c3520282e6f5717214004a7f26888",symbol:"comp"},{chainId:1,address:"0xdef1ca1fb7fbcdc777520aa7f396b4e015f497ab",symbol:"cow"},{chainId:1,address:"0xd533a949740bb3306d119cc777fa900ba034cd52",symbol:"crv"},{chainId:1,address:"0x6b175474e89094c44da98b954eedeac495271d0f",symbol:"dai"},{chainId:1,address:"0xf2051511b9b121394fa75b8f7d4e7424337af687",symbol:"haus"},{chainId:1,address:"0x888888435fde8e7d4c54cab67f206e4199454c60",symbol:"dfx"},{chainId:1,address:"0x798d1be841a82a273720ce31c822c61a67a601c3",symbol:"digg"},{chainId:1,address:"0xf629cbd94d3791c9250152bd8dfbdf380e2a3b9c",symbol:"enj"},{chainId:1,address:"0xc18360217d8f7ab5e7c516566761ea12ce7f9d72",symbol:"ens"},{chainId:1,address:"0x4e15361fd6b4bb609fa63c81a2be19d873717870",symbol:"ftm"},{chainId:1,address:"0x956f47f50a910163d8bf957cf5846d573e7f87ca",symbol:"fei"},{chainId:1,address:"0xed1480d12be41d92f36f5f7bdd88212e381a3677",symbol:"fdt"},{chainId:1,address:"0x586aa273f262909eef8fa02d90ab65f5015e0516",symbol:"fiat"},{chainId:1,address:"0xde30da39c46104798bb5aa3fe8b9e0e1f348163f",symbol:"gtc"},{chainId:1,address:"0x900db999074d9277c5da2a43f252d74366230da0",symbol:"giv"},{chainId:1,address:"0x6810e776880c02933d47db1b9fc05908e5386b96",symbol:"gno"},{chainId:1,address:"0xba485b556399123261a5f9c95d413b4f93107407",symbol:"graviaura"},{chainId:1,address:"0x3ec8798b81485a254928b70cda1cf0a2bb0b74d7",symbol:"gro"},{chainId:1,address:"0xc011a73ee8576fb46f5e1c5751ca3b9fe0af2a6f",symbol:"snx"},{chainId:1,address:"0x5a98fcbea516cf06857215779fd812ca3bef1b32",symbol:"ldo"},{chainId:1,address:"0x6dea81c8171d0ba574754ef6f8b412f2ed88c54d",symbol:"lqty"},{chainId:1,address:"0x5f98805a4e8be255a32880fdec7f6728c6568ba0",symbol:"lusd"},{chainId:1,address:"0x965d79f1a1016b574a62986e13ca8ab04dfdd15c",symbol:"m2"},{chainId:1,address:"0x9f8f72aa9304c8b593d555f12ef6589cc3a579a2",symbol:"mkr"},{chainId:1,address:"0xd084944d3c05cd115c09d072b9f44ba3e0e45921",symbol:"fold"},{chainId:1,address:"0x7d1afa7b718fb893db30a3abc0cfc608aacfebb0",symbol:"matic"},{chainId:1,address:"0xa3bed4e1c75d00fa6f4e5e6922db7261b5e9acd2",symbol:"mta"},{chainId:1,address:"0x4b13006980acb09645131b91d259eaa111eaf5ba",symbol:"myc"},{chainId:1,address:"0x333a4823466879eef910a04d473505da62142069",symbol:"nation"},{chainId:1,address:"0xcfeaead4947f0705a14ec42ac3d44129e1ef3ed5",symbol:"note"},{chainId:1,address:"0x967da4048cd07ab37855c090aaf366e4ce1b9f48",symbol:"ocean"},{chainId:1,address:"0x64aa3364f17a4d01c6f1751fd97c2bd3d7e7f1d5",symbol:"ohm"},{chainId:1,address:"0xab846fb6c81370327e784ae7cbb6d6a6af6ff4bf",symbol:"pal"},{chainId:1,address:"0xcafe001067cdef266afb7eb5a286dcfd277f3de5",symbol:"psp"},{chainId:1,address:"0x68037790a0229e9ce6eaa8a99ea92964106c4703",symbol:"par"},{chainId:1,address:"0x45804880de22913dafe09f4980848ece6ecbaf78",symbol:"paxg"},{chainId:1,address:"0x89ab32156e46f46d02ade3fecbe5fc4243b9aaed",symbol:"pnt"},{chainId:1,address:"0x9992ec3cf6a55b00978cddf2b27bc6882d88d1ec",symbol:"poly"},{chainId:1,address:"0x43d4a3cd90ddd2f8f4f693170c9c8098163502ad",symbol:"d2d"},{chainId:1,address:"0xeb4c2781e4eba804ce9a9803c67d0893436bb27d",symbol:"renbtc"},{chainId:1,address:"0x408e41876cccdc0f92210600ef50372656052a38",symbol:"ren"},{chainId:1,address:"0xfb5453340c03db5ade474b27e68b6a9c6b2823eb",symbol:"robot"},{chainId:1,address:"0xd33526068d116ce69f19a9ee46f0bd304f21a51f",symbol:"rpl"},{chainId:1,address:"0xae78736cd615f374d3085123a210448e74fc6393",symbol:"reth"},{chainId:1,address:"0xfe18be6b3bd88a2d2a7f928d00292e7a9963cfc6",symbol:"sbtc"},{chainId:1,address:"0x476c5e26a75bd202a9683ffd34359c0cc15be0ff",symbol:"srm"},{chainId:1,address:"0x35e78b3982e87ecfd5b3f3265b601c046cdbe232",symbol:"xai"},{chainId:1,address:"0x3affcca64c2a6f4e3b6bd9c64cd2c969efd1ecbe",symbol:"dsla"},{chainId:1,address:"0xf24d8651578a55b0c119b9910759a351a3458895",symbol:"sdbal"},{chainId:1,address:"0x11c1a6b3ed6bb362954b29d3183cfa97a0c806aa",symbol:"str"},{chainId:1,address:"0x8f693ca8d21b157107184d29d398a8d082b38b76",symbol:"data"},{chainId:1,address:"0x470ebf5f030ed85fc1ed4c2d36b9dd02e77cf1b7",symbol:"temple"},{chainId:1,address:"0xa36fdbbae3c9d55a1d67ee5821d53b50b63a1ab9",symbol:"temp"},{chainId:1,address:"0xdac17f958d2ee523a2206206994597c13d831ec7",symbol:"usdt"},{chainId:1,address:"0x9c4a4204b79dd291d6b6571c5be8bbcd0622f050",symbol:"tcr"},{chainId:1,address:"0x226f7b842e0f0120b7e194d05432b3fd14773a9d",symbol:"unn"},{chainId:1,address:"0x1f9840a85d5af5bf1d1762f925bdaddc4201f984",symbol:"uni"},{chainId:1,address:"0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",symbol:"usdc"},{chainId:1,address:"0x81f8f0bb1cb2a06649e51913a151f0e7ef6fa321",symbol:"vita"},{chainId:1,address:"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2",symbol:"weth"},{chainId:1,address:"0xedb171c18ce90b633db442f2a6f72874093b49ef",symbol:"wampl"},{chainId:1,address:"0x2260fac5e5542a773aa44fbcfedf7c193bc2c599",symbol:"wbtc"},{chainId:1,address:"0xf203ca1769ca8e9e8fe1da9d147db68b6c919817",symbol:"wncg"},{chainId:1,address:"0x7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0",symbol:"wsteth"},{chainId:1,address:"0x79c71d3436f39ce382d0f58f1b011d88100b9d91",symbol:"xns"},{chainId:1,address:"0x0bc529c00c6401aef6d220be8c6ea1667f6ad93e",symbol:"yfi"},{chainId:1,address:"0xbcca60bb61934080951369a648fb03df4f96263c",symbol:"ausdc"},{chainId:1,address:"0x028171bca77440897b824ca71d1c56cac55b68a3",symbol:"adai"},{chainId:1,address:"0x3ed3b47dd13ec9a98b44e6204a523e766b225811",symbol:"ausdt"},{chainId:137,address:"0x9c2c5fd7b07e95ee044ddeba0e97a665f142394f",symbol:"1inch"},{chainId:137,address:"0xd6df932a45c0f255f85145f286ea0b292b21c90b",symbol:"aave"},{chainId:137,address:"0xc3fdbadc7c795ef1d6ba111e06ff8f16a20ea539",symbol:"addy"},{chainId:137,address:"0xf84bd51eab957c2e7b7d646a3427c5a50848281d",symbol:"agar"},{chainId:137,address:"0x033d942a6b495c4071083f4cde1f17e986fe856c",symbol:"aga"},{chainId:137,address:"0x0e9b89007eee9c958c0eda24ef70723c2c93dd58",symbol:"amaticc"},{chainId:137,address:"0x034b2090b579228482520c589dbd397c53fc51cc",symbol:"vision"},{chainId:137,address:"0x2c89bbc92bd86f8075d1decc58c7f4e0107f286b",symbol:"avax"},{chainId:137,address:"0x49690541e3f6e933a9aa3cffee6010a7bb5b72d7",symbol:"axiav3"},{chainId:137,address:"0x9a71012b13ca4d3d0cdc72a177df3ef03b0e76a3",symbol:"bal"},{chainId:137,address:"0xdb7cb471dd0b49b29cab4a1c14d070f27216a0ab",symbol:"bank"},{chainId:137,address:"0xfbdd194376de19a88118e84e279b977f165d01b8",symbol:"bifi"},{chainId:137,address:"0xd6ca869a4ec9ed2c7e618062cdc45306d8dbbc14",symbol:"btc2x-fli-p"},{chainId:137,address:"0x53e0bca35ec356bd5dddfebbd1fc0fd03fabad39",symbol:"link"},{chainId:137,address:"0x172370d5cd63279efa6d502dab29171933a610af",symbol:"crv"},{chainId:137,address:"0x8f3cf7ad23cd3cadbd9735aff958023239c6a063",symbol:"dai"},{chainId:137,address:"0x1d607faa0a51518a7728580c238d912747e71f7a",symbol:"data"},{chainId:137,address:"0x85955046df4668e1dd369d2de9f3aeb98dd2a369",symbol:"dpi"},{chainId:137,address:"0xe7804d91dfcde7f776c90043e03eaa6df87e6395",symbol:"dfx"},{chainId:137,address:"0xf28164a485b0b2c90639e47b0f377b4a438a16b1",symbol:"dquick"},{chainId:137,address:"0x45c32fa6df82ead1e2ef74d17b76547eddfaff89",symbol:"frax"},{chainId:137,address:"0x50b728d8d964fd00c2d0aad81718b71311fef68a",symbol:"snx"},{chainId:137,address:"0x72928d5436ff65e57f72d5566dcd3baedc649a88",symbol:"hdao"},{chainId:137,address:"0x3ad707da309f3845cd602059901e39c4dcd66473",symbol:"eth2x-fli-p"},{chainId:137,address:"0x4f025829c4b13df652f38abd2ab901185ff1e609",symbol:"ieth-fli-p"},{chainId:137,address:"0x340f412860da7b7823df372a2b59ff78b7ae6abc",symbol:"imatic-fli-p"},{chainId:137,address:"0xf287d97b6345bad3d88856b26fb7c0ab3f2c7976",symbol:"matic2x-fli-p"},{chainId:137,address:"0x130ce4e4f76c2265f94a961d70618562de0bb8d2",symbol:"ibtc-fli-p"},{chainId:137,address:"0x596ebe76e2db4470966ea395b0d063ac6197a8c5",symbol:"jrt"},{chainId:137,address:"0x3a58a54c066fdc0f2d55fc9c89f0415c92ebf3c4",symbol:"stmatic"},{chainId:137,address:"0xf501dd45a1198c2e1b5aef5314a68b9006d842e0",symbol:"mta"},{chainId:137,address:"0xeaecc18198a475c921b24b8a6c1c1f0f5f3f7ea0",symbol:"seed"},{chainId:137,address:"0xfe712251173a2cd5f5be2b46bb528328ea3565e1",symbol:"mvi"},{chainId:137,address:"0xa3fa99a148fa48d14ed51d610c367c61876997f1",symbol:"mimatic"},{chainId:137,address:"0xa486c6bc102f409180ccb8a94ba045d39f8fc7cb",symbol:"nex"},{chainId:137,address:"0xe2aa7db6da1dae97c5f5c6914d285fbfcc32a128",symbol:"par"},{chainId:137,address:"0x580a84c73811e1839f75d86d75d88cca0c241ff4",symbol:"qi"},{chainId:137,address:"0x831753dd7087cac61ab5644b308642cc1c33dc13",symbol:"quick"},{chainId:137,address:"0xb5c064f955d8e7f38fe0460c556a72987494ee17",symbol:"quick"},{chainId:137,address:"0x00e5646f60ac6fb446f621d146b6e1886f002905",symbol:"rai"},{chainId:137,address:"0x431cd3c9ac9fc73644bf68bf5691f4b83f9e104f",symbol:"rbw"},{chainId:137,address:"0xdbf31df14b66535af65aac99c32e9ea844e14501",symbol:"renbtc"},{chainId:137,address:"0x501ace9c35e60f03a2af4d484f49f9b1efde9f40",symbol:"solace"},{chainId:137,address:"0xfa68fb4628dff1028cfec22b4162fccd0d45efb6",symbol:"maticx"},{chainId:137,address:"0x0b3f868e0be5597d5db7feb59e1cadbb0fdda50a",symbol:"sushi"},{chainId:137,address:"0xdf7837de1f2fa4631d716cf2502f8b230f1dcc32",symbol:"tel"},{chainId:137,address:"0xe6469ba6d2fd6130788e0ea9c0a0515900563b59",symbol:"ust"},{chainId:137,address:"0xc2132d05d31c914a87c6611c10748aeb04b58e8f",symbol:"usdt"},{chainId:137,address:"0x5fe2b58c013d7601147dcdd68c143a77499f5531",symbol:"grt"},{chainId:137,address:"0xbbba073c31bf03b8acf7c28ef0738decf3695683",symbol:"sand"},{chainId:137,address:"0x2934b36ca9a4b31e633c5be670c8c8b28b6aa015",symbol:"thx"},{chainId:137,address:"0x2f800db0fdb5223b3c3f354886d907a671414a7f",symbol:"bct"},{chainId:137,address:"0x2e1ad108ff1d8c782fcbbb89aad783ac49586756",symbol:"tusd"},{chainId:137,address:"0x3809dcdd5dde24b37abe64a5a339784c3323c44f",symbol:"swap"},{chainId:137,address:"0x7fbc10850cae055b27039af31bd258430e714c62",symbol:"ubt"},{chainId:137,address:"0x2791bca1f2de4661ed88a30c99a7a9449aa84174",symbol:"usdc"},{chainId:137,address:"0x7ceb23fd6bc0add59e62ac25578270cff1b9f619",symbol:"weth"},{chainId:137,address:"0x0d500b1d8e8ef31e21c99d1db9a6444d3adf1270",symbol:"wmatic"},{chainId:137,address:"0x1bfd67037b42cf73acf2047067bd4f2c47d9bfd6",symbol:"wbtc"},{chainId:137,address:"0x24834bbec7e39ef42f4a75eaf8e5b6486d3f0e57",symbol:"lunc"},{chainId:137,address:"0xf153eff70dc0bf3b085134928daeea248d9b30d0",symbol:"xmark"},{chainId:42161,address:"0x9f20de1fc9b161b34089cbeae888168b44b03461",symbol:"arbis"},{chainId:42161,address:"0x040d1edc9569d4bab2d15287dc5a4f10f56a56b8",symbol:"bal"},{chainId:42161,address:"0x031d35296154279dc1984dcd93e392b1f946737b",symbol:"cap"},{chainId:42161,address:"0xf97f4df75117a78c1a5a0dbb814af92458539fb4",symbol:"link"},{chainId:42161,address:"0x354a6da3fcde098f8389cad84b0182725c6c91de",symbol:"comp"},{chainId:42161,address:"0xf4d48ce3ee1ac3651998971541badbb9a14d7234",symbol:"cream"},{chainId:42161,address:"0x11cdb42b0eb46d95f990bedd4695a6e3fa034978",symbol:"crv"},{chainId:42161,address:"0xda10009cbd5d07dd0cecc66161fc93d7c9000da1",symbol:"dai"},{chainId:42161,address:"0x8038f3c971414fd1fc220ba727f2d4a0fc98cb65",symbol:"dht"},{chainId:42161,address:"0xf0b5ceefc89684889e5f7e0a7775bd100fcd3709",symbol:"dusd"},{chainId:42161,address:"0x6c2c06790b3e3e3c38e12ee22f8183b37a13ee55",symbol:"dpx"},{chainId:42161,address:"0x32eb7902d4134bf98a28b963d26de779af92a212",symbol:"rdpx"},{chainId:42161,address:"0xc3ae0333f0f34aa734d5493276223d95b8f9cb37",symbol:"dxd"},{chainId:42161,address:"0xfc5a1a6eb076a2c7ad06ed22c90d7e710e35ad0a",symbol:"gmx"},{chainId:42161,address:"0xa0b862f60edef4452f25b4160f177db44deb6cf1",symbol:"gno"},{chainId:42161,address:"0xb965029343d55189c25a7f3e0c9394dc0f5d41b1",symbol:"ndx"},{chainId:42161,address:"0x539bde0d7dbd336b79148aa742883198bbf60342",symbol:"magic"},{chainId:42161,address:"0x4e352cf164e64adcbad318c3a1e222e9eba4ce42",symbol:"mcb"},{chainId:42161,address:"0x3f56e0c36d275367b8c502090edf38289b3dea0d",symbol:"mimatic"},{chainId:42161,address:"0x965772e0e9c84b6f359c8597c891108dcf1c5b1a",symbol:"pickle"},{chainId:42161,address:"0x6694340fc020c5e6b96567843da2df01b2ce1eb6",symbol:"stg"},{chainId:42161,address:"0xd4d42f0b6def4ce0383636770ef773390d85c61a",symbol:"sushi"},{chainId:42161,address:"0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9",symbol:"usdt"},{chainId:42161,address:"0x23a941036ae778ac51ab04cea08ed6e2fe103614",symbol:"grt"},{chainId:42161,address:"0xa72159fc390f0e3c6d415e658264c7c4051e9b87",symbol:"tcr"},{chainId:42161,address:"0x4d15a3a2286d883af0aa1b3f21367843fac63e07",symbol:"tusd"},{chainId:42161,address:"0xfa7f8980b0f1e64a2062791cc3b0871572f1f7f0",symbol:"uni"},{chainId:42161,address:"0xff970a61a04b1ca14834a43f5de4533ebddb5cc8",symbol:"usdc"},{chainId:42161,address:"0xa684cd057951541187f288294a1e1c2646aa2d24",symbol:"vsta"},{chainId:42161,address:"0x64343594ab9b56e99087bfa6f2335db24c2d1f17",symbol:"vst"},{chainId:42161,address:"0x82af49447d8a07e3bd95bd0d56f35241523fbab1",symbol:"weth"},{chainId:42161,address:"0x2f2a2543b76a4166549f7aab2e75bef0aefc5b0f",symbol:"wbtc"},{chainId:42161,address:"0x82e3a8f066a6989666b031d916c43672085b1582",symbol:"yfi"}];class Tp{constructor(e,t,a,n){if(this.pools=new Vr({url:e.urls.subgraph,chainId:e.chainId,query:n}),this.poolsForSimulations=new Ci(xi(e.urls.subgraph),t,e,void 0,n),this.poolsOnChain=new Hr(this.pools,{provider:t,multicall:e.addresses.contracts.multicall,vault:e.addresses.contracts.vault},e.poolsToIgnore),this.poolShares=new Xr(e.urls.subgraph,e.chainId),this.poolJoinExits=new Jr(e.urls.subgraph,e.chainId),e.urls.gaugesSubgraph&&(this.poolGauges=new Kr(e.urls.gaugesSubgraph,e.chainId),this.gaugeShares=new Ar(e.urls.gaugesSubgraph,e.chainId)),e.urls.blockNumberSubgraph){this.blockNumbers=new mp(e.urls.blockNumberSubgraph);const t=async()=>{if(this.blockNumbers)return await this.blockNumbers.find("dayAgo")};this.yesterdaysPools=new Vr({url:e.urls.subgraph,chainId:e.chainId,blockHeight:t,query:n})}else if(e.averageBlockTime){const a=async()=>await t.getBlockNumber()-Math.round(86400/(e.averageBlockTime||2));this.yesterdaysPools=new Vr({url:e.urls.subgraph,chainId:e.chainId,blockHeight:a,query:n})}const o=fp.filter((t=>t.chainId==e.chainId)).map((e=>e.address)),i=new jr(o,e.chainId),s=new Zr(e.urls.subgraph,e.chainId),r=new Re(a.contracts.multicall,e.chainId);this.tokenPrices=new Qr(i,s,r);const p=new zr(e.chainId);this.tokenHistoricalPrices=new ep(p,r),this.tokenMeta=new Yr([]),e.urls.gaugesSubgraph&&(this.liquidityGauges=new Mr(e.urls.gaugesSubgraph,a.contracts.multicall,e.addresses.contracts.gaugeController||"",e.chainId,e.addresses.contracts.gaugeControllerCheckpointer)),e.addresses.contracts.feeDistributor&&e.addresses.tokens.bal&&e.addresses.tokens.veBal&&e.addresses.tokens.bbaUsd&&(this.feeDistributor=new op(a.contracts.multicall,e.addresses.contracts.feeDistributor,e.addresses.tokens.bal,e.addresses.tokens.veBal,e.addresses.tokens.bbaUsd,t)),this.feeCollector=new pp(e.addresses.contracts.vault,t),e.addresses.contracts.protocolFeePercentagesProvider&&(this.protocolFees=new up(a.contracts.multicall,e.addresses.contracts.protocolFeePercentagesProvider)),this.tokenYields=new cp,e.addresses.contracts.gyroConfigProxy&&(this.gyroConfigRepository=new xr(e.addresses.contracts.gyroConfigProxy,a.contracts.multicall,t))}}const hp=(e,t)=>"Stable"===e?exports.PoolKind.LEGACY_STABLE:"ComposableStable"===e&&1===t?exports.PoolKind.COMPOSABLE_STABLE:"ComposableStable"===e?exports.PoolKind.COMPOSABLE_STABLE_V2:exports.PoolKind.WEIGHTED,Ip=es.encodeSetRelayerApproval,gp=es.encodeGaugeWithdraw,xp=es.encodeGaugeDeposit,_p=es.encodePeekChainedReferenceValue,wp=It.createInterface(),Pp=(e,t)=>{var a;return(null===(a=e.poolType)||void 0===a?void 0:a.match(/.*Linear.*/))?Ep(e,t):[]},Ep=(e,t)=>{if(!(e.id&&t.id&&e.tokens&&t.tokens&&e.mainIndex&&t.mainIndex))throw"Missing tokens";const a=e.tokens[e.mainIndex];return[{poolId:e.id,assetIn:e.address,assetOut:a.address},{poolId:t.id,assetIn:a.address,assetOut:t.address}]},vp=async(e,t)=>{const a=await t.find(e);if(!a)throw`Pool ${e} not found`;const n=async(e,a)=>{let o=[{address:e}];const i=await t.findBy("address",e);if(i&&e!=a){const t=i.tokens.sort(Sp),a=await Promise.all(t.map((({address:e})=>n(e,i.address))));o=[{address:e,id:i.id,poolType:i.poolType,poolTypeVersion:i.poolTypeVersion,mainIndex:i.mainIndex,tokens:a.flat()}]}return o},o=a.tokens.sort(Sp);return{id:e,address:a.address,tokens:(await Promise.all(o.map((({address:e})=>n(e,a.address))))).flat(),poolType:a.poolType,poolTypeVersion:a.poolTypeVersion,mainIndex:a.mainIndex}},Sp=(e,t)=>e.address.toLowerCase()>t.address.toLowerCase()?1:-1,Ap=(e,n,o,i,s,r,p=!1,d,l,u)=>{if(!(s.id&&r.id&&s.tokens&&r.tokens&&s.poolType&&r.poolType))throw"Pool data is missing";const c=s.tokens.flatMap((({address:e})=>e)),y=r.tokens.flatMap((({address:e})=>e)),b="ComposableStable"==s.poolType&&1==s.poolTypeVersion?0:-1;let m,f=[];b>-1?(m=[{index:b,key:es.toChainedReference(`10${b}`)}],f=[es.toChainedReference(`20${b}`)]):(m=c.map(((e,t)=>({index:t,key:es.toChainedReference(`10${t}`)}))),f=c.map(((e,t)=>es.toChainedReference(`20${t}`))));const T=es.toChainedReference("999"),h=[];let I=!1;"ComposableStable"===s.poolType&&(I=!0),u&&h.push(Ip(n,!0,u)),d&&h.push(gp(d,e,n,o)),h.push(((e,t,a,n,o=-1,i,s,r,p,d=!0)=>{let l;const u="ComposableStable"===t&&1===a;l=o>-1?v.exitExactBPTInForOneTokenOut(s,o):(u?C.exitExactBPTInForAllTokensOut:v.exitExactBPTInForTokensOut)(s);const c=hp(t,a);return es.encodeExitPool({poolId:e,poolKind:c,sender:r,recipient:p,outputReferences:i,exitPoolRequest:{assets:n,minAmountsOut:new Array(n.length).fill("0"),userData:l,toInternalBalance:d}})})(s.id,s.poolType,s.poolTypeVersion||1,c,b,m,o,d?n:e,n));const g=((e,t,a)=>{const n=({tokens:e,mainIndex:t})=>e&&t&&e[t].address||"",o=e.flatMap(n),i=t.flatMap(n),s=o.map(((e,t)=>e&&[t,i.indexOf(e)]||[-1,-1])).map((([a,n])=>{if(-1===a||-1===n)return[];const o=e[a],i=t[n];return Pp(o,i)}));return a>-1?[s[a]]:s})(s.tokens,r.tokens,b);if(g.flat().length>0){const e=g.map(((e,t)=>({path:e,inputAmount:String(m[t].key),outputReference:f[t]}))).filter((({path:e})=>e.length>0));h.push(((e,n,o,i,s=!0)=>{const r=[],p=[],d=[],l=[];o.forEach((e=>{const{path:a,inputAmount:n,outputReference:o}=e;for(let e=0;e<a.length;e++){const{poolId:o,assetIn:i,assetOut:s}=a[e];r.push(i),r.push(s),p.push(t.MaxInt256.toString()),p.push("0");const d={poolId:o,assetInIndex:2*e,assetOutIndex:2*e+1,amount:0===e?n:"0",userData:"0x"};l.push(d)}d.push({index:2*a.length-1,key:o})}));const u={sender:e,recipient:n,fromInternalBalance:!0,toInternalBalance:s};return es.encodeBatchSwap({swapType:exports.SwapType.SwapExactIn,swaps:l,assets:r,funds:u,limits:p,deadline:i||a.BigNumber.from(Math.ceil(Date.now()/1e3)+3600),value:"0",outputReferences:d})})(n,n,e))}const x=y.filter((e=>r.address!=e)).map((e=>{var t;const a=c.indexOf(e);return String(I&&f[a]||(null===(t=m[a])||void 0===t?void 0:t.key)||0)}));h.push(((e,a,n,o,i,s,r,p,d,l=!0)=>{const u=o.map((()=>t.MaxInt256)),c=v.joinExactTokensInForBPTOut(i,s),y=hp(a,n);return es.encodeJoinPool({poolId:e,kind:y,sender:p,recipient:d,joinPoolRequest:{assets:o,maxAmountsIn:u,userData:c,fromInternalBalance:l},value:"0",outputReference:r})})(r.id,r.poolType,r.poolTypeVersion||1,y,x,i,String(T),n,l?n:e,!0)),!0===p&&h.push(_p(String(T))),l&&h.push(xp(l,n,e,String(T)));return wp.encodeFunctionData("multicall",[h])};class kp{constructor({relayerAddress:e,poolsRepository:t,gaugesRepository:a,provider:n}){this.getExpectedBptOut=kp.getExpectedBptOut,this.relayerAddress=e,this.poolsRepository=t,this.gaugesRepository=a,this.provider=n}async pool2pool({user:e,from:t,to:a,balance:n,minBptOut:o="0",authorisation:i}){const s=await vp(t,this.poolsRepository),r=await vp(a,this.poolsRepository),p=Ap(e,this.relayerAddress,String(n),o,s,r,"0"==o,void 0,void 0,i);return{to:this.relayerAddress,data:p}}async pool2poolWithGauges({user:e,from:t,to:a,balance:n,minBptOut:o="0",authorisation:i}){const s=await this.gaugesRepository.findBy("poolId",t),r=await this.gaugesRepository.findBy("poolId",a);if(!(s&&s.poolId&&r&&r.poolId))throw new Error("Gauge not found");const p=await vp(s.poolId,this.poolsRepository),d=await vp(r.poolId,this.poolsRepository),l=Ap(e,this.relayerAddress,String(n),o,p,d,"0"==o,s.id,r.id,i);return{to:this.relayerAddress,data:l}}async gauge2gauge({user:e,from:t,to:a,balance:n,authorisation:o}){const i=[gp(t,e,this.relayerAddress,n),xp(a,this.relayerAddress,e,n)];o&&i.unshift(Ip(this.relayerAddress,!0,o));const s=wp.encodeFunctionData("multicall",[i]);return{to:this.relayerAddress,data:s}}}kp.getExpectedBptOut=e=>{const t=wp.decodeFunctionResult("multicall",e)[0].slice(-2).filter((e=>"0x"!==e));return String(BigInt(t))};var Op,Cp;!function(e){e[e.Direct=0]="Direct",e[e.TokenIn=1]="TokenIn",e[e.TokenOut=2]="TokenOut",e[e.Middle=3]="Middle"}(Op||(Op={})),function(e){e[e.BatchSwap=0]="BatchSwap",e[e.Join=1]="Join",e[e.Exit=2]="Exit"}(Cp||(Cp={}));class Bp{constructor(e,t,a,n,o,i,s,r,p,d){const l=this.getActionStep(e,t,a,n);this.amountIn=this.getActionAmount(o,Cp.BatchSwap,l,s),this.hasTokenIn=this.actionHasTokenIn(l),this.hasTokenOut=this.actionHasTokenOut(l);const u=this.hasTokenOut?i:"0";this.minOut=this.getActionMinOut(u,r);const[c,y]=this.getActionOutputRef(l,n,s);this.nextOpRefKey=y,this.opRefStart=c,this.sender=this.getSender(this.hasTokenIn,p,d),this.receiver=this.getReceiver(this.hasTokenOut,p,d)}getActionAmount(e,t,a,n){let o=e;return(a===Op.TokenOut||a===Op.Middle&&t===Cp.Join||a===Op.Middle&&t===Cp.Exit)&&(o=es.toChainedReference(n-1).toString()),o}getActionOutputRef(e,t,a){let n={};return e!==Op.TokenIn&&e!==Op.Middle||(n=this.getOutputRef(a,t),a++),[n,a]}getActionMinOut(e,t){return He(a.BigNumber.from(e),a.BigNumber.from(t)).toString()}getActionStep(e,t,a,n){let o;return o=a===e&&n===t?Op.Direct:a===e?Op.TokenIn:n===t?Op.TokenOut:Op.Middle,o}getOutputRef(e,t){return{index:t,key:es.toChainedReference(e)}}getFromInternal(e,t){return!e&&!t}getToInternal(e,t){return!e&&!t}actionHasTokenIn(e){return e===Op.Direct||e===Op.TokenIn}actionHasTokenOut(e){return e===Op.Direct||e===Op.TokenOut}getSender(e,t,a){return e?t:a}getReceiver(e,t,a){return e?t:a}getPoolKind(e){let t=0;return["MetaStable","Stable","StablePhantom"].includes(e)?t=1:"ComposableStable"===e&&(t=3),t}}class Mp extends Bp{constructor(e,t,a,n,o,i,s,r){var p;super(t,a,e.assetInIndex,e.assetOutIndex,e.amount,null!==(p=e.returnAmount)&&void 0!==p?p:"0",n,i,s,r),this.opRefKey=n,this.type=Cp.Exit,this.poolId=e.poolId,this.tokenOut=o[e.assetOutIndex],this.toInternalBalance=this.getToInternal(this.hasTokenOut),this.opRef=this.opRefStart}callData(e,t){const a=e.tokensList,n=new j(t),[o]=n.sortTokens(a),i=this.tokenOut,s=o.findIndex((e=>e.toLowerCase()===i.toLowerCase())),r=Array(a.length).fill("0");r[s]=this.minOut;const p=this.amountIn,d={assets:o,minAmountsOut:r,userData:S.exitExactBPTInForOneTokenOut(p,s),toInternalBalance:this.toInternalBalance,poolId:this.poolId,poolKind:this.getPoolKind(e.poolType),sender:this.sender,recipient:this.receiver,outputReferences:this.opRef.key?[this.opRef]:[],exitPoolRequest:{}},l=es.formatExitPoolInput(d);return{params:d,encoded:es.encodeExitPool(l)}}getAmountIn(){return this.hasTokenIn?this.amountIn:"0"}getAmountOut(){return this.hasTokenOut?this.minOut:"0"}}class Fp extends Bp{constructor(e,t,a,n,o,i,s,r){var p;super(t,a,e.assetInIndex,e.assetOutIndex,e.amount,null!==(p=e.returnAmount)&&void 0!==p?p:"0",n,i,s,r),this.opRefKey=n,this.type=Cp.Join,this.poolId=e.poolId,this.tokenIn=o[e.assetInIndex],this.fromInternal=this.getFromInternal(this.hasTokenIn),this.opRef=this.opRefStart}callData(e,t){const a=e.tokensList,n=new j(t),[o]=n.sortTokens(a),i=this.tokenIn,s=o.findIndex((e=>e.toLowerCase()===i.toLowerCase())),r=Array(a.length).fill("0");r[s]=this.amountIn;const p=this.minOut,d=S.joinExactTokensInForBPTOut(r,p),l={poolId:this.poolId,sender:this.sender,recipient:this.receiver,kind:this.getPoolKind(e.poolType),joinPoolRequest:{assets:o,maxAmountsIn:r,userData:d,fromInternalBalance:this.fromInternal},value:"0",outputReference:this.opRef.key?this.opRef.key.toString():"0"};return{params:l,encoded:es.encodeJoinPool(l)}}getAmountIn(){return this.hasTokenIn?this.amountIn:"0"}getAmountOut(){return this.hasTokenOut?this.minOut:"0"}}class Rp extends Bp{constructor(e,t,a,n,o,i,s,r,p){var d;super(t,a,e.assetInIndex,e.assetOutIndex,e.amount,null!==(d=e.returnAmount)&&void 0!==d?d:"0",n,i,r,p),this.mainTokenInIndex=t,this.mainTokenOutIndex=a,this.opRefKey=n,this.assets=o,this.slippage=i,this.pools=s,this.user=r,this.relayer=p,this.approveTokens=[],this.opRef=[],this.type=Cp.BatchSwap,this.swaps=[{...e,amount:this.amountIn}];const l=this.isBpt(s,o[e.assetInIndex]);l&&this.approveTokens.push(o[e.assetInIndex]),this.fromInternal=this.getFromInternal(this.hasTokenIn,l);const u=this.isBpt(s,o[e.assetOutIndex]);this.toInternal=this.getToInternal(this.hasTokenOut,u),this.limits=this.getLimits(o,e.assetInIndex,e.assetOutIndex,e.amount,this.hasTokenIn,this.hasTokenOut,this.minOut),this.opRefStart.index&&this.opRef.push(this.opRefStart)}getLimits(e,n,o,i,s,r,p){const d=e.map((()=>a.BigNumber.from(0)));return d[n]=s?a.BigNumber.from(i):t.MaxInt256,r&&(d[o]=a.BigNumber.from(p).mul(-1)),d}updateLimits(e,t){t.hasTokenIn&&(e[t.swaps[0].assetInIndex]=e[t.swaps[0].assetInIndex].add(t.amountIn)),t.hasTokenOut&&(e[t.swaps[0].assetOutIndex]=e[t.swaps[0].assetOutIndex].sub(t.minOut))}isChainedSwap(e){return this.opRef[this.swaps.length-1]&&this.toInternal===e.fromInternal&&this.receiver===e.sender&&this.opRef[this.swaps.length-1].key.toString()===e.amountIn}canAddSwap(e){return!!this.isChainedSwap(e)||e.fromInternal===this.fromInternal&&e.toInternal===this.toInternal&&e.receiver===this.receiver&&e.sender===this.sender}callData(){const e=[];for(const a of this.approveTokens){const n=es.encodeApproveVault(a,t.MaxUint256.toString());e.push(n)}const n={sender:this.sender,recipient:this.receiver,fromInternalBalance:this.fromInternal,toInternalBalance:this.toInternal},o={swapType:exports.SwapType.SwapExactIn,swaps:this.swaps,assets:this.assets,funds:n,limits:this.limits.map((e=>e.toString())),deadline:a.BigNumber.from(Math.ceil(Date.now()/1e3)+3600),value:"0",outputReferences:this.opRef},i=es.encodeBatchSwap(o);return e.push(i),{params:o,encoded:e}}getAmountIn(){return this.limits[this.mainTokenInIndex].toString()}getAmountOut(){return this.limits[this.mainTokenOutIndex].abs().toString()}copy(){return new Rp(this.swaps[0],this.mainTokenInIndex,this.mainTokenOutIndex,this.opRefKey,this.assets,this.slippage,this.pools,this.user,this.relayer)}addSwap(e){const t=this.isChainedSwap(e);this.swaps.push(e.swaps[0]),this.approveTokens=[...new Set([...this.approveTokens,...e.approveTokens])],this.toInternal=e.toInternal,this.receiver=e.receiver,this.hasTokenOut=e.hasTokenOut,this.minOut=e.minOut,this.opRef=[...this.opRef,...e.opRef],t||(this.amountIn=a.BigNumber.from(this.amountIn).add(e.amountIn).toString()),this.updateLimits(this.limits,e)}isBpt(e,t){return e.some((e=>e.address.toLowerCase()===t.toLowerCase()))}}function Np(e){const t=function(e){const t=[],a=[],n=[];for(const o of e)o.type===Cp.Exit||o.type===Cp.Join?o.hasTokenIn?t.push(o):o.hasTokenOut?a.push(o):n.push(o):n.push(o);return[...t,...n,...a]}(e);return function(e){const t=[];let a;for(const n of e)n.type===Cp.BatchSwap?a?a.canAddSwap(n)?a.addSwap(n):(t.push(a),a=n.copy()):a=n.copy():(a&&(t.push(a),a=void 0),t.push(n));return a&&t.push(a),t}(t)}const Dp=new e.Interface([{inputs:[{internalType:"contract IVault",name:"vault",type:"address"},{internalType:"address",name:"libraryAddress",type:"address"}],stateMutability:"nonpayable",type:"constructor"},{inputs:[],name:"getLibrary",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[],name:"getVault",outputs:[{internalType:"contract IVault",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes[]",name:"data",type:"bytes[]"}],name:"multicall",outputs:[{internalType:"bytes[]",name:"results",type:"bytes[]"}],stateMutability:"payable",type:"function"},{stateMutability:"payable",type:"receive"}]);function Lp(e){X.getInstance()}function Up(e,t,a){if("Weighted"!==a)return!1;const n=t[e.assetOutIndex],o=R(e.poolId);return n.toLowerCase()===o.toLowerCase()}function Vp(e,t,a){if("Weighted"!==a)return!1;const n=t[e.assetInIndex],o=R(e.poolId);return n.toLowerCase()===o.toLowerCase()}Object.defineProperty(exports,"PoolFilter",{enumerable:!0,get:function(){return p.PoolFilter}}),Object.defineProperty(exports,"SOR",{enumerable:!0,get:function(){return p.SOR}}),Object.defineProperty(exports,"SwapTypes",{enumerable:!0,get:function(){return p.SwapTypes}}),Object.defineProperty(exports,"stableBPTForTokensZeroPriceImpact",{enumerable:!0,get:function(){return p.stableBPTForTokensZeroPriceImpact}}),Object.defineProperty(exports,"weightedBPTForTokensZeroPriceImpact",{enumerable:!0,get:function(){return p.weightedBPTForTokensZeroPriceImpact}}),exports.AMP_PRECISION=3,exports.APR_THRESHOLD=1e4,exports.AaveLinearPoolFactory__factory=rt,exports.AaveLinearPool__factory=it,exports.AaveRates=Re,exports.AaveWrapping__factory=dt,exports.AssetHelpers=j,exports.Authoriser__factory=ut,exports.BALANCER_NETWORK_CONFIG=ka,exports.BalancerAPIArgsFormatter=tt,exports.BalancerError=Ba,exports.BalancerErrors=Z,exports.BalancerHelpers__factory=yt,exports.BalancerMinterAuthorization=ae,exports.BalancerMinter__factory=mt,exports.BalancerPoolDataQueries__factory=Tt,exports.BalancerRelayer__factory=It,exports.BalancerSDK=class{constructor(e,t=new Ni(e),a=new ts(e)){this.config=e,this.sor=t,this.subgraph=a;X.getInstance().setLoggingEnabled(!!e.enableLogging),this.networkConfig=Fi(e),this.provider=t.provider,this.balancerContracts=new ps(this.networkConfig.addresses.contracts,t.provider),this.data=new Tp(this.networkConfig,t.provider,this.balancerContracts,e.subgraphQuery),this.swaps=new zi(this.config),this.relayer=new es,this.pricing=new as(e,this.swaps),this.pools=new er(this.networkConfig,this.data,this.balancerContracts),this.data.liquidityGauges&&(this.claimService=new Fn(this.data.liquidityGauges,this.data.feeDistributor,this.networkConfig.chainId,this.contracts.multicall,this.networkConfig.addresses.contracts.gaugeClaimHelper,this.networkConfig.addresses.contracts.balancerMinter),this.migrationService=new kp({relayerAddress:this.networkConfig.addresses.contracts.balancerRelayer,poolsRepository:this.data.pools,gaugesRepository:this.data.liquidityGauges.subgraph,provider:this.provider})),this.vaultModel=new Fs(this.data.poolsForSimulations,this.networkConfig.addresses.tokens.wrappedNativeAsset)}get contracts(){return this.balancerContracts.contracts}},exports.BasePoolEncoder=E,exports.BatchRelayerLibrary__factory=xt,exports.BlockNumberRepository=mp,exports.CoingeckoHistoricalPriceRepository=zr,exports.CoingeckoPriceRepository=jr,exports.ComposableStablePoolEncoder=C,exports.ComposableStablePoolFactory__factory=Et,exports.ComposableStablePool__factory=wt,exports.ConvergentCurvePool__factory=St,exports.Data=Tp,exports.Debouncer=Ve,exports.ERC20__factory=kt,exports.ERC4626LinearPoolFactory__factory=Mt,exports.ERC4626LinearPool__factory=Ct,exports.EulerLinearPoolFactory__factory=Dt,exports.EulerLinearPool__factory=Rt,exports.FXPool__factory=Ut,exports.FeeCollectorRepository=pp,exports.FeeDistributorRepository=op,exports.GaugeClaimHelper__factory=Gt,exports.GaugeControllerMulticallRepository=Pr,exports.GaugeSharesRepository=Ar,exports.GearboxLinearPoolFactory__factory=Ht,exports.GearboxLinearPool__factory=Wt,exports.GraphQLArgsBuilder=nt,exports.GyroConfig__factory=Jt,exports.GyroEV2__factory=Ia,exports.HistoricalPriceProvider=ep,exports.LidoRelayer__factory=Yt,exports.LinearPool__factory=zt,exports.Liquidity=vn,exports.LiquidityGaugeSubgraphRPCProvider=Mr,exports.LiquidityGaugeV5__factory=Qt,exports.LiquidityGaugesMulticallRepository=Cr,exports.LiquidityGaugesSubgraphRepository=Br,exports.ManagedPoolEncoder=A,exports.Migrations=kp,exports.Multicall3__factory=na,exports.Multicall__factory=ta,exports.POOLS=function(e){return V[e]?V[e]:U},exports.PoolGaugesRepository=Kr,exports.PoolJoinExitRepository=Jr,exports.PoolSharesRepository=Xr,exports.Pools=er,exports.PoolsBalancerAPIRepository=class{constructor(e){var t,a;this.pools=[],this.skip=0,this.hasFetched=!1,this.isFetching=!1,this.client=new Fr(e.url,e.apiKey);this.query={args:Object.assign({},(null===(t=e.query)||void 0===t?void 0:t.args)||{chainId:1,orderBy:"totalLiquidity",orderDirection:"desc",where:{swapEnabled:{eq:!0},totalShares:{gt:.05}}}),attrs:Object.assign({},(null===(a=e.query)||void 0===a?void 0:a.attrs)||{id:!0,address:!0})},delete this.query.args.skip}fetchFromCache(e,t){return this.pools.slice(t,e+t)}async fetch(e){const t=(null==e?void 0:e.first)||10,a=(null==e?void 0:e.skip)||0;return this.hasFetched||this.fetchAll(e),await this.awaitEnoughPoolsFetched(t,a),this.fetchFromCache(t,a)}async fetchAll(e){this.isFetching=!0,this.hasFetched=!0,this.nextToken&&(this.query.args.nextToken=this.nextToken),this.query.args.first=1e3;const t=new nt(this.query.args).format(new tt),a=this.query.attrs;a.nextToken=!0;const n={pools:{__args:t,...a}},o=(await this.client.get(n)).pools;if(this.nextToken=o.nextToken,this.pools=this.pools.concat(o.pools.map(this.format)),this.nextToken)return await this.fetchAll(e);this.isFetching=!1}async awaitEnoughPoolsFetched(e,t){for(let a=0;a<1e3;a++){if(this.pools.length>e+t)return;if(!this.isFetching)return;await Rr(10)}}async find(e){return 0==this.pools.length&&await this.fetch(),this.findBy("id",e)}async findBy(e,t){0==this.pools.length&&await this.fetch();const a=this.pools.find((a=>a[e]==t));if(a)return this.format(a)}format(e){var t,a,n,o;if(null===(t=e.apr)||void 0===t?void 0:t.rewardAprs.breakdown){const t=JSON.parse(null===(a=e.apr)||void 0===a?void 0:a.rewardAprs.breakdown);e.apr.rewardAprs.breakdown=t}if(null===(n=e.apr)||void 0===n?void 0:n.tokenAprs.breakdown){const t=JSON.parse(null===(o=e.apr)||void 0===o?void 0:o.tokenAprs.breakdown);e.apr.tokenAprs.breakdown=t}return e}},exports.PoolsFallbackRepository=class{constructor(e,t={}){this.providers=e,this.currentProviderIdx=0,this.timeout=t.timeout||1e4}async fetch(e){return this.fallbackQuery("fetch",[e])}get currentProvider(){if(this.providers.length&&!(this.currentProviderIdx>=this.providers.length))return this.providers[this.currentProviderIdx]}async find(e){return this.fallbackQuery("find",[e])}async findBy(e,t){return this.fallbackQuery("findBy",[e,t])}async fallbackQuery(e,t){if(this.currentProviderIdx>=this.providers.length)throw new Error("No working providers found");let a;try{const n=this.providers[this.currentProviderIdx];a=await Promise.race([n[e].apply(n,t),new Promise(((e,t)=>setTimeout((()=>t(new Error("timeout"))),this.timeout)))])}catch(n){const o=n.message;if("timeout"===o){X.getInstance().warn("Provider "+this.currentProviderIdx+" timed out, falling back to next provider")}else{const e=X.getInstance();e.warn(`Provider ${this.currentProviderIdx} failed with error, falling back to next provider.`),e.warn(o)}this.currentProviderIdx++,a=await this.fallbackQuery.call(this,e,t)}return a}},exports.PoolsStaticRepository=class{constructor(e){this.pools=e}async find(e){return this.pools.find((t=>t.id.toLowerCase()===e.toLowerCase()))}async findBy(e,t){return this.pools.find((a=>a[e]===t))}async all(){return this.pools}async where(e){return(await this.all()).filter(e)}},exports.PoolsSubgraphOnChainRepository=Hr,exports.PoolsSubgraphRepository=Vr,exports.ProtocolFeesProvider=up,exports.Relayer=es,exports.RelayerAuthorization=te,exports.SHALLOW_COMPOSABLE_STABLE_BUFFER=1e6,exports.Sor=Ni,exports.StablePoolEncoder=v,exports.StablePool__factory=ia,exports.StaticATokenRateProvider__factory=ra,exports.StaticTokenPriceProvider=class{constructor(e){this.tokenPrices=Object.fromEntries(Object.entries(e).map((([e,t])=>[e.toLowerCase(),t])))}async find(e){const t=e.toLowerCase(),a=this.tokenPrices[t];if(a)return a}async findBy(e,t){if("address"==e)return this.find(t)}},exports.StaticTokenProvider=Yr,exports.Subgraph=ts,exports.SubgraphArgsFormatter=at,exports.SubgraphPriceRepository=Zr,exports.Swaps=zi,exports.TokenPriceProvider=Qr,exports.TokenYieldsRepository=cp,exports.Vault__factory=da,exports.VeBal__factory=xa,exports.VeDelegationProxy__factory=wa,exports.WeightedPoolEncoder=S,exports.WeightedPoolFactory__factory=ya,exports.WeightedPool__factory=ua,exports.YearnLinearPoolFactory__factory=Ta,exports.YearnLinearPool__factory=ma,exports.accountToAddress=Q,exports.addSlippage=Ke,exports.addressMapIn=De,exports.balEmissions=fs,exports.bn=e=>a.parseFixed(`${e}`,18),exports.buildRelayerCalls=function(e,t,n,o,i,s,r){const p=function(e,t,a,n,o,i,s,r){var p;const d=n.findIndex((t=>t.toLowerCase()===e.toLowerCase())),l=n.findIndex((e=>e.toLowerCase()===t.toLowerCase())),u=[];let c=0;for(const e of a){const t=null===(p=i.find((t=>t.id===e.poolId)))||void 0===p?void 0:p.poolType;if(Up(e,n,t)){const t=new Fp(e,d,l,c,n,o,s,r);c=t.nextOpRefKey,u.push(t)}else{if(!Vp(e,n,t)){const t=new Rp(e,d,l,c,n,o,i,s,r);c=t.nextOpRefKey,u.push(t);continue}{const t=new Mp(e,d,l,c,n,o,s,r);c=t.nextOpRefKey,u.push(t)}}}return u}(e.tokenIn,e.tokenOut,e.swaps,e.tokenAddresses,s,t,n,o),d=Np(p),l=[],u=[];r&&l.push(es.encodeSetRelayerApproval(o,!0,r));for(const e of d){if(e.type===Cp.Exit||e.type===Cp.Join){const a=t.find((t=>t.id===e.poolId));if(void 0===a)throw new Ba(exports.BalancerErrorCode.NO_POOL_DATA);const{params:n,encoded:o}=e.callData(a,i);l.push(o),u.push(n)}if(e.type===Cp.BatchSwap){const{params:t,encoded:a}=e.callData();l.push(...a),u.push(t)}}return function(e,t,n,o){const i=e.reduce(((e=a.BigNumber.from(0),t)=>e.add(t))),s=t.reduce(((e=a.BigNumber.from(0),t)=>e.add(t)));Lp(i.toString()),Lp(n.swapAmount.toString()),Lp(s.toString()),Lp(He(n.returnAmount,a.BigNumber.from(o)).toString()),Lp(n.returnAmount.toString());const r=s.sub(He(n.returnAmount,a.BigNumber.from(o)));if(!i.eq(n.swapAmount)||!r.lt("3"))throw new Ba(exports.BalancerErrorCode.RELAY_SWAP_AMOUNTS)}(d.map((e=>a.BigNumber.from(e.getAmountIn()))),d.map((e=>a.BigNumber.from(e.getAmountOut()))),e,s),{to:o,data:Dp.encodeFunctionData("multicall",[l]),rawCalls:l,inputs:u}},exports.canUseJoinExit=function(e,a,n){return e!==p.SwapTypes.SwapExactOut&&a.toLowerCase()!==t.AddressZero.toLowerCase()&&n.toLowerCase()!==t.AddressZero.toLowerCase()},exports.factories=Ea,exports.fetchOnChainPoolData=ki,exports.findEventInReceiptLogs=Qe,exports.formatFixed=qe,exports.formatFromBigInt18=function(e){return a.formatFixed(a.BigNumber.from(e),18)},exports.getEthValue=Ue,exports.getLimitsForSlippage=va,exports.getOnChainBalances=Oi,exports.getPoolAddress=R,exports.getPoolNonce=D,exports.getPoolSpecialization=N,exports.getRandomBytes32=et,exports.insert=Xe,exports.isLinearish=Ze,exports.isNormalizedWeights=e=>{const a=e.reduce(((e,t)=>e.add(t)),t.Zero);return a.eq(t.WeiPerEther)},exports.isSameAddress=Je,exports.mulSlippage=$e,exports.parseFixed=Ge,exports.parsePoolInfo=be,exports.parseToBigInt18=function(e){return Ge(e,18).toBigInt()},exports.removeItem=je,exports.reorderArrays=ze,exports.replace=Ye,exports.signPermit=async(e,n,i,s,r=t.MaxUint256,p)=>{const{chainId:d}=await e.provider.getNetwork(),l=await n.getAddress();p||(p=await e.nonces(l));const u={name:await e.name(),version:"1",chainId:d,verifyingContract:e.address},c={owner:l,spender:await Q(i),value:s,nonce:p,deadline:r},y=await n._signTypedData(u,{Permit:[{name:"owner",type:"address"},{name:"spender",type:"address"},{name:"value",type:"uint256"},{name:"nonce",type:"uint256"},{name:"deadline",type:"uint256"}]},c);return{...o.splitSignature(y),deadline:a.BigNumber.from(r),nonce:a.BigNumber.from(p)}},exports.someJoinExit=function(e,t,a){return t.some((t=>function(e,t,a){const n=e.find((e=>e.id===t.poolId));return"Weighted"===(null==n?void 0:n.poolType)&&[a[t.assetInIndex],a[t.assetOutIndex]].includes(n.address)}(e,t,a)))},exports.splitPoolId=e=>({address:R(e),specialization:N(e),nonce:D(e)}),exports.subSlippage=He,exports.toNormalizedWeights=function(e){if(100==e.length)return Array(100).fill(t.WeiPerEther.div(100));const a=e.reduce(((e,t)=>e.add(t)),t.Zero);if(a.eq(t.WeiPerEther))return e;const n=[];let o=t.Zero;for(let i=0;i<e.length;i++)i<e.length-1?(n[i]=e[i].mul(t.WeiPerEther).div(a),o=o.add(n[i])):n[i]=t.WeiPerEther.sub(o);return n},exports.tokenAddressForPricing=Ne,exports.tokensToTokenPrices=function(e){const t={};return e.forEach((e=>{e.price&&(t[e.address]=e.price)})),t},exports.truncateAddresses=function(e){return e.map((e=>`${e.slice(0,6)}...${e.slice(38,42)}`))},exports.unwrapToken=Le,exports.wrappedTokensMap=Me,exports.yieldTokens=Be;
 //# sourceMappingURL=index.js.map
